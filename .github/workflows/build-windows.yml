name: Build Windows (x86_64)

on:
  workflow_call:
  # 分支推送：已禁用 - 仅在需要时手动触发
  # push:
  #   branches:
  #     - main
  #     - develop
  #   paths-ignore:
  #     - 'docs/**'
  #     - 'src/**/*.md'
  #     - '*.md'
  # 标签发布请通过 release.yml 复用该工作流（workflow_call）
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: Checkout code (exclude problematic docs)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            /*
            !/src/**/*.md
          sparse-checkout-cone-mode: false

      - name: Detect lockfiles
        id: lock
        shell: pwsh
        run: |
          $npm = (Test-Path package-lock.json) -or (Test-Path npm-shrinkwrap.json)
          $yarn = Test-Path yarn.lock
          "npm=$npm"   | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "yarn=$yarn" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Setup Node.js (npm cache)
        if: steps.lock.outputs.npm == 'True'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Setup Node.js (yarn cache)
        if: steps.lock.outputs.yarn == 'True'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: Setup Node.js (no cache)
        if: steps.lock.outputs.npm != 'True' && steps.lock.outputs.yarn != 'True'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Verify Node and npm versions
        run: |
          node --version
          npm --version

      - name: Install dependencies (npm ci)
        if: steps.lock.outputs.npm == 'True'
        run: npm ci --prefer-offline --no-audit

      - name: Install dependencies (yarn)
        if: steps.lock.outputs.yarn == 'True'
        shell: pwsh
        run: |
          corepack enable || true
          yarn install --frozen-lockfile

      - name: Install dependencies (no lockfile)
        if: steps.lock.outputs.npm != 'True' && steps.lock.outputs.yarn != 'True'
        run: npm install --no-audit

      - name: Build Vue application
        run: npm run build:prod
        env:
          VITE_APP_ENV: production

      - name: Verify build output
        run: |
          if (!(Test-Path "dist")) {
            Write-Error "Build failed: dist directory not found"
            exit 1
          }
          Write-Host "Build output verified"
          Get-ChildItem -Path dist -Recurse -Filter "*.md" | ForEach-Object {
            Write-Warning "Found markdown file in dist: $($_.FullName)"
          }

      - name: Build Electron main process
        run: npm run build:electron
        env:
          VITE_APP_ENV: electron
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Build Electron app (Windows x64)
        run: npm run dist:win
        env:
          VITE_APP_ENV: electron

      - name: Verify Electron build output
        run: |
          if (!(Test-Path "dist")) {
            Write-Error "Electron build failed: dist directory not found"
            exit 1
          }
          Write-Host "=== Electron Build Output ==="
          Get-ChildItem -Path dist -Filter "Haitang*" | ForEach-Object {
            Write-Host "$($_.Name) - $([Math]::Round($_.Length / 1MB, 2)) MB"
          }

      - name: Verify no documentation files in build
        run: |
          $mdFiles = Get-ChildItem -Path dist -Recurse -Filter "*.md" -ErrorAction SilentlyContinue
          if ($mdFiles) {
            Write-Error "Found markdown files in build output:"
            $mdFiles | ForEach-Object { Write-Error $_.FullName }
            exit 1
          }
          Write-Host "✓ No markdown files found in build output"

      - name: Create checksums
        run: |
          cd dist
          $files = Get-ChildItem -Filter "Haitang*.exe", "Haitang*.msi" -ErrorAction SilentlyContinue
          if ($files.Count -eq 0) {
            Write-Error "No executable files found in dist directory"
            exit 1
          }

          $null = New-Item -Name "checksums-windows.txt" -ItemType File -Force
          foreach ($file in $files) {
            $hash = (Get-FileHash -Path $file.FullName -Algorithm SHA256).Hash
            "$hash  $($file.Name)" | Add-Content checksums-windows.txt
          }
          Write-Host "=== Checksums ==="
          Get-Content checksums-windows.txt

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: |
            dist/Haitang*.exe
            dist/Haitang*.msi
            dist/checksums-windows.txt
          retention-days: 30
          if-no-files-found: error

