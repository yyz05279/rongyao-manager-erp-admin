name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # macOS Intel æž„å»ºï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
  # build-mac-intel:
  #   uses: ./.github/workflows/build-mac-intel.yml
  #   secrets: inherit

  # macOS ARM64 æž„å»ºï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
  # build-mac-arm64:
  #   uses: ./.github/workflows/build-mac-arm64.yml
  #   secrets: inherit

  # Windows æž„å»ºï¼ˆä¼˜å…ˆå®Œæˆï¼‰
  build-windows:
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display artifact structure
        run: |
          echo "=== Artifact Structure ==="
          find artifacts -type f -name "*.dmg" -o -name "*.exe" -o -name "*.msi" -o -name "*.txt"
      
      - name: Prepare release files
        run: |
          mkdir -p release

          # Copy Windows artifacts
          cp artifacts/windows-x64/* release/ 2>/dev/null || true

          # macOS artifacts æš‚æ—¶ç¦ç”¨
          # cp artifacts/macos-intel/* release/ 2>/dev/null || true
          # cp artifacts/macos-arm64/* release/ 2>/dev/null || true

          echo "=== Release Files ==="
          ls -lh release/

          echo ""
          echo "=== File Count ==="
          find release -type f | wc -l
      
      - name: Generate release notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "# æµ·æ£ ä¼ä¸šç®¡ç†ç³»ç»Ÿ $VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“¥ ä¸‹è½½" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Windows" >> RELEASE_NOTES.md
          echo "- **å®‰è£…ç¨‹åº**: Haitang-$VERSION.exe" >> RELEASE_NOTES.md
          echo "- **ä¾¿æºç‰ˆ**: Haitang-$VERSION-portable.exe" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ” æ ¡éªŒå’Œ" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Windows" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          cat release/checksums-windows.txt >> RELEASE_NOTES.md || true
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ’» ç³»ç»Ÿè¦æ±‚" >> RELEASE_NOTES.md
          echo "- **Windows**: Windows 7 æˆ–æ›´é«˜ç‰ˆæœ¬" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ðŸ“– å®‰è£…è¯´æ˜Ž" >> RELEASE_NOTES.md
          echo "### Windows" >> RELEASE_NOTES.md
          echo "1. ä¸‹è½½ .exe æ–‡ä»¶" >> RELEASE_NOTES.md
          echo "2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº" >> RELEASE_NOTES.md
          echo "3. æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## â„¹ï¸ è¯´æ˜Ž" >> RELEASE_NOTES.md
          echo "å½“å‰ç‰ˆæœ¬ä»…æä¾› Windows å¹³å°çš„æž„å»ºã€‚macOS ç‰ˆæœ¬å°†åœ¨åŽç»­ç‰ˆæœ¬ä¸­æä¾›ã€‚" >> RELEASE_NOTES.md
          
          cat RELEASE_NOTES.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/Haitang*.exe
            release/Haitang*.msi
            release/checksums-windows.txt
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to release summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -1 release/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

