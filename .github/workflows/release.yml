name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-mac-intel:
    uses: ./.github/workflows/build-mac-intel.yml
    secrets: inherit

  build-mac-arm64:
    uses: ./.github/workflows/build-mac-arm64.yml
    secrets: inherit

  build-windows:
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit

  create-release:
    needs: [build-mac-intel, build-mac-arm64, build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display artifact structure
        run: |
          echo "=== Artifact Structure ==="
          find artifacts -type f -name "*.dmg" -o -name "*.exe" -o -name "*.msi" -o -name "*.txt"
      
      - name: Prepare release files
        run: |
          mkdir -p release

          # Copy all artifacts
          cp artifacts/macos-intel/* release/ 2>/dev/null || true
          cp artifacts/macos-arm64/* release/ 2>/dev/null || true
          cp artifacts/windows-x64/* release/ 2>/dev/null || true

          echo "=== Release Files ==="
          ls -lh release/

          echo ""
          echo "=== File Count ==="
          find release -type f | wc -l
      
      - name: Generate release notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "# æµ·æ£ ä¼ä¸šç®¡ç†ç³»ç»Ÿ $VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ä¸‹è½½" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### macOS" >> RELEASE_NOTES.md
          echo "- **Intel (x86_64)**: Haitang-$VERSION-x64.dmg" >> RELEASE_NOTES.md
          echo "- **Apple Silicon (ARM64)**: Haitang-$VERSION-arm64.dmg" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Windows" >> RELEASE_NOTES.md
          echo "- **å®‰è£…ç¨‹åº**: Haitang-$VERSION.exe" >> RELEASE_NOTES.md
          echo "- **ä¾¿æºç‰ˆ**: Haitang-$VERSION-portable.exe" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## æ ¡éªŒå’Œ" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### macOS Intel" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          cat release/checksums-intel.txt >> RELEASE_NOTES.md || true
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### macOS ARM64" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          cat release/checksums-arm64.txt >> RELEASE_NOTES.md || true
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Windows" >> RELEASE_NOTES.md
          echo "\`\`\`" >> RELEASE_NOTES.md
          cat release/checksums-windows.txt >> RELEASE_NOTES.md || true
          echo "\`\`\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ç³»ç»Ÿè¦æ±‚" >> RELEASE_NOTES.md
          echo "- **macOS**: 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬" >> RELEASE_NOTES.md
          echo "- **Windows**: Windows 7 æˆ–æ›´é«˜ç‰ˆæœ¬" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## å®‰è£…è¯´æ˜Ž" >> RELEASE_NOTES.md
          echo "### macOS" >> RELEASE_NOTES.md
          echo "1. ä¸‹è½½ .dmg æ–‡ä»¶" >> RELEASE_NOTES.md
          echo "2. åŒå‡»æ‰“å¼€ DMG æ–‡ä»¶" >> RELEASE_NOTES.md
          echo "3. å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Windows" >> RELEASE_NOTES.md
          echo "1. ä¸‹è½½ .exe æ–‡ä»¶" >> RELEASE_NOTES.md
          echo "2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº" >> RELEASE_NOTES.md
          echo "3. æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…" >> RELEASE_NOTES.md
          
          cat RELEASE_NOTES.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/Haitang*.dmg
            release/Haitang*.exe
            release/Haitang*.msi
            release/checksums-*.txt
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to release summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -1 release/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

