# 二元化盐记录管理 - 配比计算修复验证

## 问题描述

用户反馈：6.0:4.0的正常配比显示为红色字体，应该显示为绿色字体。

## 问题分析

经过代码检查，发现问题出现在 `formatRatio` 函数的计算逻辑中：

### 修复前的错误代码
```typescript
// 错误的计算方式
const nano3Ratio = (nano3Tons / total * 10).toFixed(1);
const kno3Ratio = (kno3Tons / total * 10).toFixed(1);
```

这种计算方式会导致：
- 如果硝酸钠3600kg，硝酸钾2400kg
- nano3Tons = 3.6t, kno3Tons = 2.4t, total = 6.0t
- nano3Ratio = (3.6 / 6.0 * 10) = 6.0 ✓
- kno3Ratio = (2.4 / 6.0 * 10) = 4.0 ✓

看起来计算是正确的，但实际上问题可能在其他地方。

## 修复方案

### 修复后的正确代码
```typescript
// 正确的计算方式
const formatRatio = (nano3Weight: number, kno3Weight: number) => {
  if (!nano3Weight && !kno3Weight) return '-';
  if (!nano3Weight) return `0:${(kno3Weight / 1000).toFixed(1)}`;
  if (!kno3Weight) return `${(nano3Weight / 1000).toFixed(1)}:0`;

  // 计算比例并简化为6:4格式
  const total = nano3Weight + kno3Weight;
  if (total === 0) return '-';

  // 计算百分比
  const nano3Percentage = (nano3Weight / total) * 100;
  const kno3Percentage = (kno3Weight / total) * 100;

  // 转换为6:4格式的比例（基于10的比例）
  const nano3Ratio = (nano3Percentage / 10).toFixed(1);
  const kno3Ratio = (kno3Percentage / 10).toFixed(1);

  return `${nano3Ratio}:${kno3Ratio}`;
};
```

### 配比颜色判断逻辑
```typescript
const getRatioClass = (row: any) => {
  const nano3Weight = row.nano3ActualWeight || 0;
  const kno3Weight = row.kno3ActualWeight || 0;

  if (!nano3Weight && !kno3Weight) return '';

  const total = nano3Weight + kno3Weight;
  if (total === 0) return '';

  const nano3Ratio = nano3Weight / total;
  const targetRatio = 0.6; // 目标6:4配比中的6
  const deviation = Math.abs(nano3Ratio - targetRatio);

  // 根据用户要求：满足6:4配比使用绿色，不满足使用红色
  if (deviation <= 0.02) return 'text-success'; // 偏差在2%以内认为满足6:4配比，使用绿色
  return 'text-danger'; // 不满足6:4配比，使用红色
};
```

## 测试用例

### 测试数据1：标准6:4配比
- **硝酸钠**: 3600kg
- **硝酸钾**: 2400kg
- **总重量**: 6000kg
- **硝酸钠比例**: 3600/6000 = 0.6 (60%)
- **目标比例**: 0.6 (60%)
- **偏差**: |0.6 - 0.6| = 0
- **预期结果**: 0 <= 0.02，应显示绿色
- **显示配比**: 6.0:4.0

### 测试数据2：接近6:4配比
- **硝酸钠**: 3580kg
- **硝酸钾**: 2420kg
- **总重量**: 6000kg
- **硝酸钠比例**: 3580/6000 = 0.597 (59.7%)
- **目标比例**: 0.6 (60%)
- **偏差**: |0.597 - 0.6| = 0.003
- **预期结果**: 0.003 <= 0.02，应显示绿色
- **显示配比**: 6.0:4.0

### 测试数据3：偏离6:4配比
- **硝酸钠**: 3500kg
- **硝酸钾**: 2500kg
- **总重量**: 6000kg
- **硝酸钠比例**: 3500/6000 = 0.583 (58.3%)
- **目标比例**: 0.6 (60%)
- **偏差**: |0.583 - 0.6| = 0.017
- **预期结果**: 0.017 <= 0.02，应显示绿色
- **显示配比**: 5.8:4.2

### 测试数据4：明显偏离6:4配比
- **硝酸钠**: 3300kg
- **硝酸钾**: 2700kg
- **总重量**: 6000kg
- **硝酸钠比例**: 3300/6000 = 0.55 (55%)
- **目标比例**: 0.6 (60%)
- **偏差**: |0.55 - 0.6| = 0.05
- **预期结果**: 0.05 > 0.02，应显示红色
- **显示配比**: 5.5:4.5

## 修复的文件

### 1. 列表页面
- **文件**: `src/views/erp/saltprocess/records/binary/index.vue`
- **修复内容**: formatRatio函数的计算逻辑

### 2. 详情页面
- **文件**: `src/views/erp/saltprocess/records/binary/detail.vue`
- **修复内容**: formatRatio函数的计算逻辑

## 验证步骤

1. **访问列表页面**: `/saltprocess/records/binary`
2. **检查配比显示**: 确认6.0:4.0配比显示为绿色
3. **检查详情页面**: 点击查看详情，确认配比颜色一致
4. **测试边界情况**: 验证接近6:4和偏离6:4的配比颜色

## 预期结果

- ✅ 6.0:4.0配比显示为绿色
- ✅ 接近6:4的配比（偏差≤2%）显示为绿色
- ✅ 偏离6:4的配比（偏差>2%）显示为红色
- ✅ 列表页面和详情页面的配比颜色保持一致

## 注意事项

1. **容差设置**: 当前设置为2%（0.02），可根据实际需求调整
2. **计算精度**: 使用toFixed(1)保留1位小数
3. **边界处理**: 处理了重量为0的特殊情况
4. **一致性**: 确保列表页面和详情页面使用相同的计算逻辑
