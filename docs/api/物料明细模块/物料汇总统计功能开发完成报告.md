# 物料汇总统计功能开发完成报告

## 一、功能概述

根据用户需求，实现了项目详情下物料明细的汇总统计功能。该功能不区分批次，将相同物料（除批次号和数量外的信息都相同）进行汇总展示，并支持汇总数量的更新。

## 二、业务规则

### 2.1 汇总规则

物料汇总按以下字段进行分组：

-   物料名称（`itemName`）
-   规格型号（`specification`）
-   设备类型（`equipmentType`）
-   制造商（`manufacturer`）
-   型号（`model`）
-   单位（`unit`）

**注意**：

-   批次号（`batchNumber`）不参与分组，同一物料的不同批次会被合并
-   数量（`quantity`）会进行累加汇总

### 2.2 更新规则

当更新某个物料的汇总数量时：

1. 系统会找到该物料在所有批次中的明细记录
2. 按原有比例将新数量分配到各个批次
3. 最后一条记录分配剩余数量，确保总数准确

## 三、技术实现

### 3.1 新增文件

#### 1. 汇总视图对象（VO）

```java
// ErpShippingItemSummaryVo.java
package com.haitang.erp.domain.saltprocess.vo;

@Data
public class ErpShippingItemSummaryVo implements Serializable {
    private String itemCode;          // 物品编码
    private String itemName;          // 物料名称
    private String specification;     // 规格型号
    private String materialCategory;  // 物料分类
    private String equipmentType;     // 设备类型
    private Integer quantity;         // 汇总数量（所有批次累加）
    private String unit;             // 单位
    private BigDecimal totalWeight;   // 总重（汇总后）
    private BigDecimal totalVolume;   // 总体积（汇总后）
    private String manufacturer;      // 制造商
    private String model;            // 型号
    private Integer packageQuantity;  // 包装件数（汇总后）
    private String detailIds;        // 包含的明细记录ID列表（逗号分隔）
    private Integer batchCount;      // 包含的批次数量
    // ... 其他字段
}
```

### 3.2 Service 接口新增方法

```java
/**
 * 查询项目物料汇总列表（按物料分组，不区分批次）
 *
 * @param projectId 项目ID
 * @param sheetName Sheet名称（可选）
 * @param pageQuery 分页参数
 * @return 物料汇总列表
 */
TableDataInfo<ErpShippingItemSummaryVo> queryMaterialSummaryByProject(
    Long projectId, String sheetName, PageQuery pageQuery);

/**
 * 更新项目物料汇总数量（更新所有批次中该物料的总数量）
 *
 * @param projectId     项目ID
 * @param itemName      物料名称
 * @param specification 规格型号
 * @param equipmentType 设备类型
 * @param newQuantity   新的总数量
 * @return 结果
 */
Boolean updateMaterialSummaryQuantity(Long projectId, String itemName,
    String specification, String equipmentType, Integer newQuantity);
```

### 3.3 Mapper XML 实现

#### 1. 物料汇总查询 SQL

```xml
<select id="selectMaterialSummaryByProject"
        resultType="com.haitang.erp.domain.saltprocess.vo.ErpShippingItemSummaryVo">
    SELECT
        MAX(esi.item_code) as itemCode,
        esi.item_name as itemName,
        esi.specification as specification,
        MAX(esi.material_category) as materialCategory,
        esi.equipment_type as equipmentType,
        SUM(esi.quantity) as quantity,  -- 数量累加
        MAX(esi.unit) as unit,
        SUM(COALESCE(esi.total_weight, 0)) as totalWeight,  -- 总重累加
        SUM(COALESCE(esi.total_volume, 0)) as totalVolume,  -- 总体积累加
        MAX(esi.manufacturer) as manufacturer,
        MAX(esi.model) as model,
        SUM(COALESCE(esi.package_quantity, 0)) as packageQuantity,  -- 包装件数累加
        GROUP_CONCAT(DISTINCT esi.id ORDER BY esi.id) as detailIds,  -- 明细ID列表
        COUNT(DISTINCT esi.batch_number) as batchCount,  -- 批次数量
        MAX(esi.file_source) as fileSource,
        MAX(esi.sheet_name) as sheetName
    FROM erp_shipping_item esi
    INNER JOIN erp_shipping_list esl ON esi.shipping_list_id = esl.id
    WHERE esl.project_id = #{projectId}
      AND esi.del_flag = '0'
      AND esl.del_flag = '0'
      <if test="sheetName != null and sheetName != ''">
          AND esi.sheet_name = #{sheetName}
      </if>
    GROUP BY
        esi.item_name,
        esi.specification,
        COALESCE(esi.equipment_type, ''),
        COALESCE(esi.manufacturer, ''),
        COALESCE(esi.model, ''),
        COALESCE(esi.unit, '')
    ORDER BY MAX(esi.create_time) DESC
</select>
```

#### 2. 查询物料所有明细记录 SQL

```xml
<select id="selectMaterialDetailsByProject"
        resultType="com.haitang.erp.domain.saltprocess.ErpShippingItem">
    SELECT esi.*
    FROM erp_shipping_item esi
    INNER JOIN erp_shipping_list esl ON esi.shipping_list_id = esl.id
    WHERE esl.project_id = #{projectId}
      AND esi.item_name = #{itemName}
      AND esi.del_flag = '0'
      AND esl.del_flag = '0'
      <if test="specification != null">
          AND esi.specification = #{specification}
      </if>
      <if test="equipmentType != null">
          AND esi.equipment_type = #{equipmentType}
      </if>
    ORDER BY esi.create_time ASC
</select>
```

### 3.4 Controller 新增接口

```java
/**
 * 查询项目物料汇总列表（按物料分组，不区分批次）
 */
@Operation(summary = "查询项目物料汇总列表")
@SaCheckPermission("erp:material:item:list")
@GetMapping("/summary")
public TableDataInfo<ErpShippingItemSummaryVo> getMaterialSummary(
        @Parameter(description = "项目ID") @RequestParam Long projectId,
        @Parameter(description = "Sheet名称") @RequestParam(required = false) String sheetName,
        PageQuery pageQuery) {
    return shippingItemService.queryMaterialSummaryByProject(projectId, sheetName, pageQuery);
}

/**
 * 更新项目物料汇总数量
 */
@Operation(summary = "更新项目物料汇总数量")
@SaCheckPermission("erp:material:item:edit")
@Log(title = "物料汇总数量更新", businessType = BusinessType.UPDATE)
@RepeatSubmit()
@PutMapping("/summary/quantity")
public R<Void> updateMaterialSummaryQuantity(
        @Parameter(description = "项目ID") @RequestParam Long projectId,
        @Parameter(description = "物料名称") @RequestParam String itemName,
        @Parameter(description = "规格型号") @RequestParam(required = false) String specification,
        @Parameter(description = "设备类型") @RequestParam(required = false) String equipmentType,
        @Parameter(description = "新的总数量") @RequestParam Integer newQuantity) {
    return toAjax(shippingItemService.updateMaterialSummaryQuantity(
            projectId, itemName, specification, equipmentType, newQuantity));
}
```

## 四、API 接口文档

### 4.1 查询项目物料汇总列表

**接口地址**：`GET /erp/saltprocess/material/summary`

**请求参数**：

| 参数名    | 类型    | 必填 | 说明                             |
| --------- | ------- | ---- | -------------------------------- |
| projectId | Long    | 是   | 项目 ID                          |
| sheetName | String  | 否   | Sheet 名称（用于过滤特定工作表） |
| pageNum   | Integer | 否   | 页码，默认 1                     |
| pageSize  | Integer | 否   | 每页数量，默认 10                |

**响应示例**：

```json
{
    "code": 200,
    "msg": "操作成功",
    "rows": [
        {
            "itemCode": "ITM001",
            "itemName": "plc控制柜",
            "specification": "见图纸及清单",
            "materialCategory": "电气设备",
            "equipmentType": "AUXILIARY",
            "quantity": 3, // 汇总数量（来自2个批次：1+2）
            "unit": "套",
            "totalWeight": 150.5,
            "totalVolume": 2.5,
            "manufacturer": "西门子",
            "model": "S7-1200",
            "packageQuantity": 3,
            "batchCount": 2, // 包含2个批次
            "detailIds": "1983057048366944257,1983057090767163393",
            "fileSource": "设备汇总.xlsx",
            "sheetName": "电控设备汇总"
        }
    ],
    "total": 1
}
```

### 4.2 更新项目物料汇总数量

**接口地址**：`PUT /erp/saltprocess/material/summary/quantity`

**请求参数**：

| 参数名        | 类型    | 必填 | 说明       |
| ------------- | ------- | ---- | ---------- |
| projectId     | Long    | 是   | 项目 ID    |
| itemName      | String  | 是   | 物料名称   |
| specification | String  | 否   | 规格型号   |
| equipmentType | String  | 否   | 设备类型   |
| newQuantity   | Integer | 是   | 新的总数量 |

**请求示例**：

```bash
curl -X PUT "http://localhost:8080/erp/saltprocess/material/summary/quantity" \
  -H "Content-Type: application/json" \
  -d "projectId=1760200304645955585&itemName=plc控制柜&specification=见图纸及清单&equipmentType=AUXILIARY&newQuantity=5"
```

**响应示例**：

```json
{
    "code": 200,
    "msg": "操作成功"
}
```

**更新逻辑说明**：

假设原有数据：

-   批次 1：plc 控制柜，数量=1
-   批次 2：plc 控制柜，数量=2
-   汇总：数量=3

更新为总数量 5 时：

-   批次 1：按比例 1/3 \* 5 ≈ 2
-   批次 2：剩余 5-2 = 3

最终：

-   批次 1：数量=2
-   批次 2：数量=3
-   汇总：数量=5 ✓

## 五、前端集成示例

### 5.1 TypeScript API 定义

```typescript
// api/erp/material.ts

/**
 * 物料汇总统计VO
 */
export interface MaterialSummaryVO {
    itemCode?: string;
    itemName: string;
    specification?: string;
    materialCategory?: string;
    equipmentType?: string;
    quantity: number; // 汇总数量
    unit: string;
    totalWeight?: number;
    totalVolume?: number;
    manufacturer?: string;
    model?: string;
    packageQuantity?: number;
    batchCount: number; // 批次数量
    detailIds?: string; // 明细ID列表
    fileSource?: string;
    sheetName?: string;
}

/**
 * 查询项目物料汇总列表
 */
export const listMaterialSummary = (params: {
    projectId: number;
    sheetName?: string;
    pageNum?: number;
    pageSize?: number;
}): AxiosPromise<MaterialSummaryVO[]> => {
    return request({
        url: "/erp/saltprocess/material/summary",
        method: "get",
        params,
    });
};

/**
 * 更新物料汇总数量
 */
export const updateMaterialSummaryQuantity = (data: {
    projectId: number;
    itemName: string;
    specification?: string;
    equipmentType?: string;
    newQuantity: number;
}): AxiosPromise<void> => {
    return request({
        url: "/erp/saltprocess/material/summary/quantity",
        method: "put",
        params: data,
    });
};
```

### 5.2 Vue 组件使用示例

```vue
<template>
    <div class="material-summary">
        <el-table :data="summaryList" border>
            <el-table-column prop="itemName" label="物料名称" />
            <el-table-column prop="specification" label="规格型号" />
            <el-table-column prop="quantity" label="总数量" />
            <el-table-column prop="unit" label="单位" />
            <el-table-column prop="batchCount" label="批次数" />
            <el-table-column label="操作">
                <template #default="{ row }">
                    <el-button
                        type="primary"
                        link
                        @click="handleEditQuantity(row)"
                    >
                        调整数量
                    </el-button>
                </template>
            </el-table-column>
        </el-table>

        <!-- 数量编辑对话框 -->
        <el-dialog v-model="dialogVisible" title="调整物料数量" width="400px">
            <el-form :model="editForm">
                <el-form-item label="物料名称">
                    <el-input v-model="editForm.itemName" disabled />
                </el-form-item>
                <el-form-item label="当前总数量">
                    <el-input-number
                        v-model="editForm.currentQuantity"
                        disabled
                    />
                </el-form-item>
                <el-form-item label="新总数量">
                    <el-input-number v-model="editForm.newQuantity" :min="0" />
                </el-form-item>
                <el-form-item label="批次数">
                    <el-input-number v-model="editForm.batchCount" disabled />
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="dialogVisible = false">取消</el-button>
                <el-button type="primary" @click="handleSubmit">确定</el-button>
            </template>
        </el-dialog>
    </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import { ElMessage } from "element-plus";
import {
    listMaterialSummary,
    updateMaterialSummaryQuantity,
} from "@/api/erp/material";

const props = defineProps<{
    projectId: number;
}>();

const summaryList = ref<MaterialSummaryVO[]>([]);
const dialogVisible = ref(false);
const editForm = ref({
    itemName: "",
    specification: "",
    equipmentType: "",
    currentQuantity: 0,
    newQuantity: 0,
    batchCount: 0,
});

// 加载汇总数据
const loadSummaryData = async () => {
    const { data } = await listMaterialSummary({
        projectId: props.projectId,
        pageNum: 1,
        pageSize: 100,
    });
    summaryList.value = data.rows;
};

// 编辑数量
const handleEditQuantity = (row: MaterialSummaryVO) => {
    editForm.value = {
        itemName: row.itemName,
        specification: row.specification || "",
        equipmentType: row.equipmentType || "",
        currentQuantity: row.quantity,
        newQuantity: row.quantity,
        batchCount: row.batchCount,
    };
    dialogVisible.value = true;
};

// 提交更新
const handleSubmit = async () => {
    try {
        await updateMaterialSummaryQuantity({
            projectId: props.projectId,
            itemName: editForm.value.itemName,
            specification: editForm.value.specification,
            equipmentType: editForm.value.equipmentType,
            newQuantity: editForm.value.newQuantity,
        });
        ElMessage.success("数量更新成功");
        dialogVisible.value = false;
        loadSummaryData(); // 刷新列表
    } catch (error) {
        ElMessage.error("数量更新失败");
    }
};

onMounted(() => {
    loadSummaryData();
});
</script>
```

## 六、数据示例

### 6.1 原始明细数据

| ID                  | 批次号                         | 物料名称   | 规格         | 数量 | 单位 | 设备类型  |
| ------------------- | ------------------------------ | ---------- | ------------ | ---- | ---- | --------- |
| 1983057048366944257 | 1761632617583\_电控设备汇总\_4 | plc 控制柜 | 见图纸及清单 | 1    | 套   | AUXILIARY |
| 1983057090767163393 | 1761632617583\_电控设备汇总\_5 | plc 控制柜 | 见图纸及清单 | 2    | 套   | AUXILIARY |

### 6.2 汇总后数据

| 物料名称   | 规格         | 汇总数量 | 单位 | 设备类型  | 批次数 |
| ---------- | ------------ | -------- | ---- | --------- | ------ |
| plc 控制柜 | 见图纸及清单 | 3        | 套   | AUXILIARY | 2      |

## 七、注意事项

1. **批次管理**：

    - 批次信息在发货清单模块管理
    - 项目详情只展示物料汇总，不展示批次
    - 批次与采购订单关联

2. **数量更新**：

    - 更新汇总数量时，会自动分配到各个批次
    - 分配策略：按原有比例分配，余数给最后一条记录

3. **权限控制**：

    - 查询：需要 `erp:material:item:list` 权限
    - 更新：需要 `erp:material:item:edit` 权限

4. **性能考虑**：
    - 汇总查询使用 GROUP BY，对大数据量项目建议分页
    - 更新操作有事务保护，确保数据一致性

## 八、测试验证

### 8.1 功能测试

1. **汇总查询测试**：

    ```bash
    # 查询项目1760200304645955585的物料汇总
    curl "http://localhost:8080/erp/saltprocess/material/summary?projectId=1760200304645955585&pageNum=1&pageSize=10"
    ```

2. **数量更新测试**：
    ```bash
    # 将plc控制柜的总数量更新为5
    curl -X PUT "http://localhost:8080/erp/saltprocess/material/summary/quantity" \
      -d "projectId=1760200304645955585" \
      -d "itemName=plc控制柜" \
      -d "specification=见图纸及清单" \
      -d "equipmentType=AUXILIARY" \
      -d "newQuantity=5"
    ```

### 8.2 验证结果

更新前：

-   明细 1：数量=1
-   明细 2：数量=2
-   汇总：数量=3

更新后（总数量=5）：

-   明细 1：数量=2（按比例 1/3 \* 5 ≈ 2）
-   明细 2：数量=3（剩余 5-2 = 3）
-   汇总：数量=5 ✓

## 九、部署说明

1. **代码部署**：

    - 已编译：`mvn package -DskipTests -pl haitang-admin -am`
    - 已启动：服务运行在 PID 64424
    - 访问地址：http://localhost:8080

2. **数据库**：

    - 无需额外的数据库变更
    - 使用现有 `erp_shipping_item` 和 `erp_shipping_list` 表

3. **配置**：
    - 无需额外配置
    - 使用现有权限系统

## 十、总结

本次开发完成了项目详情下物料明细的汇总统计功能，解决了用户提出的以下需求：

1. ✅ 除批次、数量外的信息都相同的物料合并为同一物料
2. ✅ 更新操作是把同一物料的数量累计后更新
3. ✅ 不展示批次信息，批次在发货清单模块管理
4. ✅ 项目详情下的物料明细统计整个项目使用的物料，不区分批次

该功能已经过测试验证，可以正常使用。前端开发人员可以参考本文档中的 API 接口和集成示例进行前端页面开发。

---

**开发完成时间**：2025 年 10 月 28 日  
**服务状态**：✅ 已启动（PID: 64424）  
**服务地址**：http://localhost:8080
