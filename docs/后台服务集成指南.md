# åå°æœåŠ¡é›†æˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•å°†åå°æœåŠ¡ï¼ˆJava/Go/Python ç­‰ï¼‰ä¸ Electron å‰ç«¯åº”ç”¨é›†æˆï¼Œä½¿å…¶èƒ½å¤Ÿä½œä¸ºç‹¬ç«‹çš„æ¡Œé¢åº”ç”¨è¿è¡Œã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åº”ç”¨ç»“æ„

```
æµ·æ£ ä¼ä¸šç®¡ç†ç³»ç»Ÿ
â”œâ”€â”€ å‰ç«¯ï¼ˆElectron + Vue3ï¼‰
â”‚   â”œâ”€â”€ ä¸»è¿›ç¨‹ï¼ˆNode.jsï¼‰
â”‚   â”œâ”€â”€ æ¸²æŸ“è¿›ç¨‹ï¼ˆVue3 åº”ç”¨ï¼‰
â”‚   â””â”€â”€ é¢„åŠ è½½è„šæœ¬
â””â”€â”€ åå°æœåŠ¡ï¼ˆJava/Go/Pythonï¼‰
    â”œâ”€â”€ å¯æ‰§è¡Œæ–‡ä»¶
    â”œâ”€â”€ é…ç½®æ–‡ä»¶
    â””â”€â”€ æ•°æ®æ–‡ä»¶
```

### é€šä¿¡æ–¹å¼

```
Vue3 åº”ç”¨
    â†“ (HTTP/WebSocket)
Electron ä¸»è¿›ç¨‹
    â†“ (IPC)
åå°æœåŠ¡è¿›ç¨‹
    â†“ (æ•°æ®åº“æ“ä½œ)
æ•°æ®åº“
```

---

## ğŸ”§ é›†æˆæ­¥éª¤

### æ­¥éª¤ 1ï¼šå‡†å¤‡åå°æœåŠ¡

#### è¦æ±‚

1. **å¯æ‰§è¡Œæ–‡ä»¶**
   - Windows: `.exe` æ–‡ä»¶
   - macOS: å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶
   - Linux: å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶

2. **é…ç½®æ–‡ä»¶**
   - æ•°æ®åº“è¿æ¥é…ç½®
   - æœåŠ¡ç«¯å£é…ç½®
   - æ—¥å¿—é…ç½®

3. **å¯åŠ¨æ–¹å¼**
   - æ”¯æŒå‘½ä»¤è¡Œå¯åŠ¨
   - æ”¯æŒä¼˜é›…å…³é—­ï¼ˆSIGTERMï¼‰
   - æ”¯æŒå¥åº·æ£€æŸ¥

#### ç¤ºä¾‹ï¼šJava åå°æœåŠ¡

```bash
# æ‰“åŒ…ä¸º jar æ–‡ä»¶
mvn clean package

# æˆ–ä½¿ç”¨ GraalVM ç¼–è¯‘ä¸ºæœ¬åœ°å¯æ‰§è¡Œæ–‡ä»¶
native-image -jar app.jar app.exe
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºåå°æœåŠ¡ç®¡ç†å™¨

åœ¨ `src/main/backend.ts` ä¸­åˆ›å»ºï¼š

```typescript
import { spawn, ChildProcess } from 'child_process'
import path from 'path'
import { isDev } from './utils'

export class BackendService {
  private process: ChildProcess | null = null
  private port: number = 8080

  /**
   * å¯åŠ¨åå°æœåŠ¡
   */
  async start(): Promise<void> {
    return new Promise((resolve, reject) => {
      try {
        const executablePath = this.getExecutablePath()
        
        this.process = spawn(executablePath, [
          `--server.port=${this.port}`,
          '--spring.profiles.active=prod'
        ], {
          stdio: 'pipe',
          detached: false
        })

        // ç›‘å¬æ ‡å‡†è¾“å‡º
        this.process.stdout?.on('data', (data) => {
          console.log(`[Backend] ${data}`)
        })

        // ç›‘å¬æ ‡å‡†é”™è¯¯
        this.process.stderr?.on('data', (data) => {
          console.error(`[Backend Error] ${data}`)
        })

        // ç›‘å¬è¿›ç¨‹é€€å‡º
        this.process.on('exit', (code) => {
          console.log(`Backend process exited with code ${code}`)
          this.process = null
        })

        // ç­‰å¾…æœåŠ¡å¯åŠ¨
        await this.waitForHealthCheck(5000)
        resolve()
      } catch (error) {
        reject(error)
      }
    })
  }

  /**
   * åœæ­¢åå°æœåŠ¡
   */
  async stop(): Promise<void> {
    return new Promise((resolve) => {
      if (this.process) {
        this.process.on('exit', () => {
          resolve()
        })
        this.process.kill('SIGTERM')
        
        // 5 ç§’åå¼ºåˆ¶æ€æ­»
        setTimeout(() => {
          if (this.process) {
            this.process.kill('SIGKILL')
          }
          resolve()
        }, 5000)
      } else {
        resolve()
      }
    })
  }

  /**
   * è·å–å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
   */
  private getExecutablePath(): string {
    const platform = process.platform
    const arch = process.arch
    
    let executableName = 'backend'
    if (platform === 'win32') {
      executableName = 'backend.exe'
    }

    if (isDev) {
      // å¼€å‘ç¯å¢ƒï¼šä»é¡¹ç›®æ ¹ç›®å½•çš„ backend æ–‡ä»¶å¤¹
      return path.join(__dirname, '../../backend', executableName)
    } else {
      // ç”Ÿäº§ç¯å¢ƒï¼šä»åº”ç”¨èµ„æºç›®å½•
      return path.join(process.resourcesPath, 'backend', executableName)
    }
  }

  /**
   * å¥åº·æ£€æŸ¥
   */
  private async waitForHealthCheck(timeout: number): Promise<void> {
    const startTime = Date.now()
    
    while (Date.now() - startTime < timeout) {
      try {
        const response = await fetch(`http://localhost:${this.port}/health`)
        if (response.ok) {
          return
        }
      } catch (error) {
        // ç»§ç»­é‡è¯•
      }
      
      await new Promise(resolve => setTimeout(resolve, 100))
    }
    
    throw new Error('Backend service health check timeout')
  }

  /**
   * è·å–æœåŠ¡ URL
   */
  getServiceUrl(): string {
    return `http://localhost:${this.port}`
  }

  /**
   * æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
   */
  isRunning(): boolean {
    return this.process !== null && !this.process.killed
  }
}
```

### æ­¥éª¤ 3ï¼šåœ¨ä¸»è¿›ç¨‹ä¸­é›†æˆ

æ›´æ–° `src/main/index.ts`ï¼š

```typescript
import { app, BrowserWindow, Menu, ipcMain } from 'electron'
import path from 'path'
import { isDev, getAssetPath } from './utils'
import { BackendService } from './backend'

let mainWindow: BrowserWindow | null = null
const backendService = new BackendService()

/**
 * åˆ›å»ºåº”ç”¨çª—å£
 */
async function createWindow() {
  // å¯åŠ¨åå°æœåŠ¡
  try {
    await backendService.start()
    console.log('Backend service started successfully')
  } catch (error) {
    console.error('Failed to start backend service:', error)
    // å¯é€‰ï¼šæ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
  }

  mainWindow = new BrowserWindow({
    width: 1400,
    height: 900,
    minWidth: 1000,
    minHeight: 600,
    webPreferences: {
      preload: path.join(__dirname, '../preload/index.js'),
      nodeIntegration: false,
      contextIsolation: true,
      enableRemoteModule: false,
      sandbox: true
    }
  })

  // åŠ è½½åº”ç”¨
  if (isDev) {
    mainWindow.loadURL('http://localhost:5173')
    mainWindow.webContents.openDevTools()
  } else {
    mainWindow.loadFile(path.join(__dirname, '../renderer/index.html'))
  }

  mainWindow.on('closed', () => {
    mainWindow = null
  })

  createMenu()
}

/**
 * IPC äº‹ä»¶å¤„ç†
 */
ipcMain.handle('get-backend-url', () => {
  return backendService.getServiceUrl()
})

ipcMain.handle('get-app-version', () => {
  return app.getVersion()
})

/**
 * App äº‹ä»¶
 */
app.on('ready', createWindow)

app.on('window-all-closed', async () => {
  // åœæ­¢åå°æœåŠ¡
  await backendService.stop()
  
  if (process.platform !== 'darwin') {
    app.quit()
  }
})

app.on('activate', () => {
  if (mainWindow === null) {
    createWindow()
  }
})

// å¤„ç†åº”ç”¨é€€å‡º
app.on('before-quit', async () => {
  await backendService.stop()
})
```

### æ­¥éª¤ 4ï¼šåœ¨ Vue ä¸­ä½¿ç”¨åå°æœåŠ¡

åˆ›å»º `src/api/service.ts`ï¼š

```typescript
import { ref, onMounted } from 'vue'

const backendUrl = ref<string>('')

export async function initBackendService() {
  if (window.electron) {
    backendUrl.value = await window.electron.ipcRenderer.invoke('get-backend-url')
    console.log('Backend URL:', backendUrl.value)
  } else {
    // å¼€å‘ç¯å¢ƒæˆ–é Electron ç¯å¢ƒ
    backendUrl.value = 'http://localhost:8080'
  }
}

export function getBackendUrl(): string {
  return backendUrl.value
}

// åœ¨ main.ts ä¸­è°ƒç”¨
export async function setupBackendService() {
  await initBackendService()
}
```

åœ¨ `src/main.ts` ä¸­ï¼š

```typescript
import { setupBackendService } from '@/api/service'

// åˆå§‹åŒ–åå°æœåŠ¡
await setupBackendService()

// åˆ›å»º Vue åº”ç”¨
const app = createApp(App)
// ...
```

### æ­¥éª¤ 5ï¼šé…ç½® API è¯·æ±‚

æ›´æ–° `src/utils/request.ts`ï¼š

```typescript
import axios from 'axios'
import { getBackendUrl } from '@/api/service'

const request = axios.create({
  baseURL: getBackendUrl(),
  timeout: 10000
})

// è¯·æ±‚æ‹¦æˆªå™¨
request.interceptors.request.use(
  (config) => {
    // æ·»åŠ è®¤è¯ä»¤ç‰Œç­‰
    return config
  },
  (error) => Promise.reject(error)
)

// å“åº”æ‹¦æˆªå™¨
request.interceptors.response.use(
  (response) => response.data,
  (error) => Promise.reject(error)
)

export default request
```

---

## ğŸ“¦ æ‰“åŒ…åå°æœåŠ¡

### é¡¹ç›®ç»“æ„

```
haitang-web-admin/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ windows/
â”‚   â”‚   â””â”€â”€ backend.exe
â”‚   â”œâ”€â”€ macos/
â”‚   â”‚   â””â”€â”€ backend
â”‚   â””â”€â”€ linux/
â”‚       â””â”€â”€ backend
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ preload/
â”‚   â””â”€â”€ renderer/
â”œâ”€â”€ package.json
â””â”€â”€ electron.vite.config.ts
```

### æ›´æ–° package.json

```json
{
  "build": {
    "files": [
      "dist/**/*",
      "node_modules/**/*",
      "backend/**/*"
    ],
    "extraFiles": [
      {
        "from": "backend",
        "to": "backend",
        "filter": ["**/*"]
      }
    ]
  }
}
```

### æ„å»ºå‘½ä»¤

```bash
# æ„å»ºå‰ç«¯å’Œåå°
npm run build:electron

# æ‰“åŒ…åº”ç”¨
npm run dist

# æˆ–æŒ‡å®šå¹³å°
npm run dist:win    # Windows
npm run dist:mac    # macOS
npm run dist:linux  # Linux
```

---

## ğŸ” è°ƒè¯•å’Œæµ‹è¯•

### å¼€å‘ç¯å¢ƒæµ‹è¯•

```bash
# å¯åŠ¨å¼€å‘æ¨¡å¼
npm run dev:electron

# åå°æœåŠ¡åº”è¯¥è‡ªåŠ¨å¯åŠ¨
# æ£€æŸ¥æ—¥å¿—è¾“å‡º
```

### æŸ¥çœ‹æ—¥å¿—

```typescript
// åœ¨ä¸»è¿›ç¨‹ä¸­
console.log('[Backend] Service started')
console.error('[Backend Error] Error message')

// åœ¨ DevTools ä¸­æŸ¥çœ‹
```

### å¥åº·æ£€æŸ¥

```bash
curl http://localhost:8080/health
```

---

## ğŸš€ éƒ¨ç½²å’Œåˆ†å‘

### åˆ›å»ºå®‰è£…ç¨‹åº

```bash
npm run dist
```

### åˆ†å‘æ–‡ä»¶

ç”Ÿæˆçš„æ–‡ä»¶ä½äº `dist/` ç›®å½•ï¼š

```
dist/
â”œâ”€â”€ æµ·æ£ ä¼ä¸šç®¡ç†ç³»ç»Ÿ 1.0.0.exe      # Windows å®‰è£…ç¨‹åº
â”œâ”€â”€ æµ·æ£ ä¼ä¸šç®¡ç†ç³»ç»Ÿ Setup 1.0.0.exe # NSIS å®‰è£…ç¨‹åº
â”œâ”€â”€ æµ·æ£ ä¼ä¸šç®¡ç†ç³»ç»Ÿ 1.0.0.dmg      # macOS å®‰è£…ç¨‹åº
â””â”€â”€ æµ·æ£ ä¼ä¸šç®¡ç†ç³»ç»Ÿ-1.0.0.AppImage  # Linux AppImage
```

### ç”¨æˆ·å®‰è£…

ç”¨æˆ·ç›´æ¥è¿è¡Œå®‰è£…ç¨‹åºï¼Œåº”ç”¨ä¼šè‡ªåŠ¨ï¼š
1. å®‰è£…å‰ç«¯åº”ç”¨
2. å®‰è£…åå°æœåŠ¡
3. åˆ›å»ºå¿«æ·æ–¹å¼
4. å¯åŠ¨åº”ç”¨

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q1ï¼šåå°æœåŠ¡å¯åŠ¨å¤±è´¥

**æ£€æŸ¥æ¸…å•ï¼š**
1. ç¡®è®¤å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨
2. ç¡®è®¤å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
3. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
4. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨

### Q2ï¼šå‰ç«¯æ— æ³•è¿æ¥åå°

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// æ£€æŸ¥åå° URL
console.log('Backend URL:', backendUrl.value)

// æµ‹è¯•è¿æ¥
fetch(`${backendUrl.value}/health`)
  .then(r => console.log('Connected'))
  .catch(e => console.error('Connection failed', e))
```

### Q3ï¼šæ‰“åŒ…ååå°æœåŠ¡æ‰¾ä¸åˆ°

**æ£€æŸ¥ï¼š**
1. ç¡®è®¤ `backend/` æ–‡ä»¶å¤¹åœ¨é¡¹ç›®æ ¹ç›®å½•
2. ç¡®è®¤ `package.json` ä¸­çš„ `build.files` åŒ…å« `backend/**/*`
3. é‡æ–°æ„å»ºåº”ç”¨

### Q4ï¼šå¦‚ä½•æ›´æ–°åå°æœåŠ¡

**æ–¹æ¡ˆï¼š**
1. æ›´æ–° `backend/` æ–‡ä»¶å¤¹ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶
2. é‡æ–°æ„å»ºåº”ç”¨
3. å‘å¸ƒæ–°ç‰ˆæœ¬

---

## ğŸ“š å‚è€ƒèµ„æº

- Electron å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.electronjs.org/docs
- electron-viteï¼šhttps://electron-vite.org/
- electron-builderï¼šhttps://www.electron.build/

