# 重复物料批量同步功能接口路径调整说明

## 调整背景

根据最新的 API 接口文档，系统提供了两套接口路径来管理物料清单明细：

1. **物料清单模块接口（推荐）**：`/erp/saltprocess/material/item`
2. **发货清单模块接口**：`/erp/shipping/item`

虽然两套接口底层操作的是同一张数据表，但从业务角度建议：

- 物料清单相关功能使用 `/erp/saltprocess/material/item` 路径
- 发货清单相关功能使用 `/erp/shipping/item` 路径

## 接口路径调整

### 1. 批量更新物料明细接口

**调整前**：

```typescript
export function batchUpdateMaterials(items: MaterialVO[]): AxiosPromise<void> {
  return request({
    url: '/erp/saltprocess/material/batch',  // ❌ 错误路径
    method: 'put',
    data: items
  });
}
```

**调整后**：

```typescript
export function batchUpdateMaterialItems(items: any[]): AxiosPromise<void> {
  return request({
    url: '/erp/saltprocess/material/item/batch',  // ✅ 正确路径
    method: 'put',
    data: items
  });
}
```

### 2. 单个更新物料明细接口

**新增**：

```typescript
export function updateMaterialItem(data: any): AxiosPromise<void> {
  return request({
    url: '/erp/saltprocess/material/item',  // ✅ 物料明细更新接口
    method: 'put',
    data: data
  });
}
```

**说明**：

- 原有的 `updateMaterial` 接口保持不变，用于更新物料主表
- 新增的 `updateMaterialItem` 接口用于更新物料明细

## 数据结构调整

### 批量更新请求数据

**调整前**：

```typescript
const updateItems: MaterialVO[] = importResult.value.existedItems.map((existedItemVo: any) => {
  return {
    ...existedItemVo.existedItem,  // 包含所有字段
    quantity: accumulatedQuantity,
    version: existedItemVo.existedItem.version || 1
  };
});
```

**调整后**：

```typescript
const updateItems = importResult.value.existedItems.map((existedItemVo: any) => {
  const accumulatedQuantity = calculateAccumulatedQuantity(existedItemVo);
  return {
    id: existedItemVo.existedItem.id,  // ✅ 必填：物料明细ID
    materialName: existedItemVo.existedItem.materialName,
    specification: existedItemVo.existedItem.specification,
    quantity: accumulatedQuantity,  // ✅ 累加后的数量
    unit: existedItemVo.existedItem.unit,
    version: existedItemVo.existedItem.version || 1  // ✅ 必填：版本号（乐观锁）
  };
});
```

### 单个更新请求数据

**调整后**：

```typescript
const updateData = {
  id: existedItem.id,  // ✅ 必填：物料明细ID
  materialName: existedItem.materialName,
  specification: existedItem.specification,
  quantity: existedItem.quantity + duplicateItem.quantity,  // ✅ 累加数量
  unit: existedItem.unit,
  version: existedItem.version || 1  // ✅ 必填：版本号（乐观锁）
};
```

## 文件修改清单

### 1. /src/api/erp/saltprocess/material/index.ts

**新增接口**：

- `batchUpdateMaterialItems`: 批量更新物料明细
- `updateMaterialItem`: 单个更新物料明细

**接口路径**：

- 批量更新：`PUT /erp/saltprocess/material/item/batch`
- 单个更新：`PUT /erp/saltprocess/material/item`

### 2. /src/views/erp/saltprocess/project/components/MaterialDetail.vue

**导入调整**：

```typescript
// 调整前
import {
  updateMaterial,
  batchUpdateMaterials
} from '@/api/erp/saltprocess/material';

// 调整后
import {
  updateMaterialItem,
  batchUpdateMaterialItems
} from '@/api/erp/saltprocess/material';
```

**方法调用调整**：

- `batchUpdateMaterials` → `batchUpdateMaterialItems`
- `updateMaterial` → `updateMaterialItem`

## 接口对比

| 功能             | 旧路径                            | 新路径                                 | 说明                |
| ---------------- | --------------------------------- | -------------------------------------- | ------------------- |
| 批量更新物料明细 | `/erp/saltprocess/material/batch` | `/erp/saltprocess/material/item/batch` | ✅ 使用物料明细接口 |
| 单个更新物料明细 | `/erp/saltprocess/material`       | `/erp/saltprocess/material/item`       | ✅ 使用物料明细接口 |
| 更新物料主表     | `/erp/saltprocess/material`       | `/erp/saltprocess/material`            | 保持不变            |

## 接口权限要求

- 物料清单模块：`erp:material:item:edit`
- 发货清单模块：`erp:shipping:item:edit`

## 后端接口说明

### 请求参数示例

```json
[
  {
    "id": 1,
    "materialName": "plc控制柜",
    "specification": "见图纸及清单",
    "quantity": 2,
    "unit": "套",
    "version": 1
  }
]
```

### 必填字段

| 字段          | 类型    | 说明             | 必填  |
| ------------- | ------- | ---------------- | ----- |
| id            | Long    | 物料明细 ID      | ✅ 是 |
| quantity      | Integer | 数量             | ✅ 是 |
| version       | Integer | 版本号（乐观锁） | ✅ 是 |
| materialName  | String  | 物料名称         | 否    |
| specification | String  | 规格型号         | 否    |
| unit          | String  | 单位             | 否    |

## 测试验证

### 1. 批量同步测试

1. 导入包含重复物料的 Excel 文件
2. 点击"合并同步"按钮
3. 确认更新操作
4. 检查网络请求：
   - **请求地址**：`PUT /dev-api/erp/saltprocess/material/item/batch`
   - **实际地址**：`PUT /erp/saltprocess/material/item/batch`（代理转发后）
   - **请求体**：包含 id、quantity、version 等字段的数组
5. 验证数据库中的数量已更新

### 2. 单个更新测试

1. 在重复物料列表中点击某条记录的"更新"按钮
2. 确认更新操作
3. 检查网络请求：
   - **请求地址**：`PUT /dev-api/erp/saltprocess/material/item`
   - **实际地址**：`PUT /erp/saltprocess/material/item`（代理转发后）
   - **请求体**：包含 id、quantity、version 等字段的对象
4. 验证数据库中的数量已更新

## 代理配置说明

前端开发环境使用 `/dev-api` 作为代理前缀，vite.config.ts 中的配置会自动去除该前缀：

```typescript
// vite.config.ts
proxy: {
  [env.VITE_APP_BASE_API]: {  // '/dev-api'
    target: 'http://localhost:8080',
    changeOrigin: true,
    ws: true,
    rewrite: (path) => path.replace(new RegExp('^' + env.VITE_APP_BASE_API), '')
  }
}
```

**示例**：

- 前端请求：`/dev-api/erp/saltprocess/material/item/batch`
- 实际转发：`http://localhost:8080/erp/saltprocess/material/item/batch`

## 优势

1. **路径规范化**：使用符合业务场景的接口路径
2. **职责清晰**：物料清单和发货清单接口分离
3. **易于维护**：接口路径更加语义化，便于理解和维护
4. **向后兼容**：原有的物料主表更新接口保持不变

## 注意事项

1. ⚠️ 确保后端已实现 `/erp/saltprocess/material/item/batch` 接口
2. ⚠️ 检查用户权限配置：`erp:material:item:edit`
3. ⚠️ 版本号（version）字段必须传递，用于乐观锁控制
4. ⚠️ 如果后端接口路径不同，需要联系后端开发人员确认

## 版本信息

- **版本**：v1.3.1
- **日期**：2025-10-28
- **作者**：haitang
- **修改类型**：接口路径调整
