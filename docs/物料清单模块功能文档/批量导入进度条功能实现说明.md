# æ‰¹é‡å¯¼å…¥è¿›åº¦æ¡åŠŸèƒ½å®ç°è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

åœ¨ç‰©æ–™æ¸…å•æ‰¹é‡å¯¼å…¥åŠŸèƒ½ä¸­ï¼Œæ·»åŠ äº†å®æ—¶è¿›åº¦å±•ç¤ºåŠŸèƒ½ã€‚ç”¨æˆ·åœ¨é…ç½®å¯¼å…¥å‚æ•°åï¼Œç³»ç»Ÿä¼šåœ¨é…ç½®å¼¹çª—ä¸­å±•ç¤ºå¯¼å…¥è¿›åº¦ï¼Œæ— éœ€å…³é—­å¼¹çª—å³å¯çœ‹åˆ°å¯¼å…¥è¿‡ç¨‹ã€‚

## å®ç°æ—¥æœŸ

2025-01-27

## åŠŸèƒ½ç‰¹æ€§

### 1. å®æ—¶è¿›åº¦å±•ç¤º

- âœ… è¿›åº¦æ¡æ˜¾ç¤ºå¯¼å…¥ç™¾åˆ†æ¯”
- âœ… å½“å‰å¯¼å…¥ Sheet åç§°
- âœ… å½“å‰æ‰¹æ¬¡/æ€»æ‰¹æ¬¡
- âœ… å·²å¯¼å…¥æ•°é‡/æ€»æ•°é‡
- âœ… å®æ—¶çŠ¶æ€æ¶ˆæ¯

### 2. è‡ªåŠ¨åˆ†æ‰¹ä¸Šä¼ 

- âœ… æŒ‰ç”¨æˆ·é…ç½®çš„æ‰¹æ¬¡å¤§å°è‡ªåŠ¨åˆ†æ‰¹
- âœ… è¿ç»­è‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€æ‰‹åŠ¨ç¡®è®¤
- âœ… å®æ—¶æ›´æ–°è¿›åº¦ä¿¡æ¯

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- âœ… å¯¼å…¥è¿‡ç¨‹ä¸­ä¸å…³é—­é…ç½®å¼¹çª—
- âœ… éšè—é…ç½®è¡¨å•ï¼Œæ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
- âœ… å¯¼å…¥å®Œæˆåæ˜¾ç¤º"å®Œæˆ"æŒ‰é’®

## æŠ€æœ¯å®ç°

### 1. ç»„ä»¶ä¿®æ”¹

#### MaterialImportConfigDialog.vue

**æ–°å¢ Props**:

```typescript
interface Props {
  visible: boolean;
  sheetGroups: Array<{...}>;
  // è¿›åº¦ç›¸å…³props
  importing?: boolean;
  progressPercentage?: number;
  progressStatus?: 'success' | 'exception' | 'warning' | '';
  currentSheet?: string;
  currentBatch?: number;
  totalBatches?: number;
  importedCount?: number;
  totalCount?: number;
  progressMessage?: string;
}
```

**æ–°å¢ UI åŒºåŸŸ**:

```vue
<!-- å¯¼å…¥è¿›åº¦ -->
<el-card v-if="importing" shadow="never">
  <el-progress
    :percentage="progressPercentage"
    :status="progressStatus"
    :stroke-width="20"
  />
  <el-descriptions :column="2" border>
    <el-descriptions-item label="å½“å‰Sheet">{{ currentSheet }}</el-descriptions-item>
    <el-descriptions-item label="å½“å‰æ‰¹æ¬¡">{{ currentBatch }} / {{ totalBatches }}</el-descriptions-item>
    <el-descriptions-item label="å·²å¯¼å…¥">{{ importedCount }}æ¡</el-descriptions-item>
    <el-descriptions-item label="æ€»è®¡">{{ totalCount }}æ¡</el-descriptions-item>
  </el-descriptions>
  <div class="progress-message">{{ progressMessage }}</div>
</el-card>

<!-- Sheetåˆ—è¡¨é…ç½® -->
<el-card v-if="!importing" shadow="never">
  <!-- é…ç½®è¡¨å• -->
</el-card>
```

**æŒ‰é’®çŠ¶æ€æ§åˆ¶**:

```vue
<template #footer>
  <el-button v-if="!importing" @click="handleClose">å–æ¶ˆ</el-button>
  <el-button
    v-if="!importing"
    type="primary"
    @click="handleConfirm"
  >
    å¼€å§‹å¯¼å…¥
  </el-button>
  <el-button v-if="importing && progressPercentage === 100" type="primary" @click="handleClose">
    å®Œæˆ
  </el-button>
</template>
```

#### MaterialDetail.vue

**æ–°å¢å“åº”å¼æ•°æ®**:

```typescript
const importing = ref(false);
const importProgress = ref({
  percentage: 0,
  status: '' as 'success' | 'exception' | 'warning' | '',
  currentSheet: '',
  currentBatch: 0,
  totalBatches: 0,
  importedCount: 0,
  totalCount: 0,
  message: ''
});
```

**ä¿®æ”¹å¯¼å…¥ç¡®è®¤é€»è¾‘**:

```typescript
const handleImportConfigConfirm = async (config: any) => {
  // ä¸å…³é—­å¼¹çª—ï¼Œå¼€å§‹å¯¼å…¥æµç¨‹
  importing.value = true;

  // æ‰§è¡Œå¯¼å…¥
  await submitDataWithConfig(processConfig);

  // å¯¼å…¥å®Œæˆåï¼Œè®¾ç½®çŠ¶æ€
  importing.value = false;
};
```

**ä¿®æ”¹å¯¼å…¥é€»è¾‘**:

```typescript
const submitDataWithConfig = async (config: any) => {
  // 1. è®¡ç®—æ€»æ•°å’Œæ€»æ‰¹æ¬¡æ•°
  let totalMaterialCount = 0;
  let totalBatchCount = 0;
  selectedGroups.forEach(group => {
    const batchSize = batchSizeMap[group.sheetName] || 50;
    const validMaterials = group.materials.filter(...);
    totalMaterialCount += validMaterials.length;
    totalBatchCount += Math.ceil(validMaterials.length / batchSize);
  });

  // 2. åˆå§‹åŒ–è¿›åº¦
  importProgress.value = {
    percentage: 0,
    status: '',
    currentSheet: '',
    currentBatch: 0,
    totalBatches: totalBatchCount,
    importedCount: 0,
    totalCount: totalMaterialCount,
    message: 'å‡†å¤‡å¼€å§‹å¯¼å…¥...'
  };

  let currentGlobalBatch = 0;

  // 3. åˆ†æ‰¹ä¸Šä¼ ï¼Œå®æ—¶æ›´æ–°è¿›åº¦
  for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
    // æ›´æ–°è¿›åº¦ä¿¡æ¯
    currentGlobalBatch++;
    importProgress.value.currentSheet = group.sheetName;
    importProgress.value.currentBatch = currentGlobalBatch;
    importProgress.value.message = `æ­£åœ¨å¯¼å…¥ ${group.sheetName} - ç¬¬ ${batchIndex + 1}/${totalBatches} æ‰¹...`;

    // ä¸Šä¼ æ•°æ®
    const result = await importParsedMaterialData(importData);

    if (result && result.success) {
      // æ›´æ–°æˆåŠŸè¿›åº¦
      totalSuccess += batchSuccess;
      importProgress.value.importedCount = totalSuccess;
      importProgress.value.percentage = Math.round((currentGlobalBatch / totalBatchCount) * 100);
      importProgress.value.message = `âœ… ${group.sheetName} ç¬¬${batchIndex + 1}æ‰¹ä¸Šä¼ æˆåŠŸ`;
    }
  }

  // 4. è®¾ç½®æœ€ç»ˆè¿›åº¦
  importProgress.value.percentage = 100;
  importProgress.value.status = totalSuccess > 0 ? 'success' : 'exception';
  importProgress.value.message = `ğŸ‰ å¯¼å…¥å®Œæˆï¼æˆåŠŸå¯¼å…¥ ${totalSuccess} æ¡`;
};
```

## è¿›åº¦è®¡ç®—é€»è¾‘

### æ€»æ‰¹æ¬¡è®¡ç®—

```typescript
let totalBatchCount = 0;
selectedGroups.forEach(group => {
  const batchSize = batchSizeMap[group.sheetName] || 50;
  const validMaterials = group.materials.filter(...);
  totalBatchCount += Math.ceil(validMaterials.length / batchSize);
});
```

**ç¤ºä¾‹**:

- Sheet1: 227 æ¡æ•°æ®ï¼Œæ‰¹æ¬¡å¤§å° 50 â†’ 5 æ‰¹ (227Ã·50=4.54 å‘ä¸Šå–æ•´)
- Sheet2: 150 æ¡æ•°æ®ï¼Œæ‰¹æ¬¡å¤§å° 50 â†’ 3 æ‰¹
- **æ€»è®¡**: 8 æ‰¹

### è¿›åº¦ç™¾åˆ†æ¯”è®¡ç®—

```typescript
importProgress.value.percentage = Math.round((currentGlobalBatch / totalBatchCount) * 100);
```

**ç¤ºä¾‹**:

- ç¬¬ 1 æ‰¹å®Œæˆ: 1/8 = 12.5% â†’ 13%
- ç¬¬ 2 æ‰¹å®Œæˆ: 2/8 = 25%
- ç¬¬ 3 æ‰¹å®Œæˆ: 3/8 = 37.5% â†’ 38%
- ...
- ç¬¬ 8 æ‰¹å®Œæˆ: 8/8 = 100%

## UI å±•ç¤ºæ•ˆæœ

### å¯¼å…¥å‰ï¼ˆé…ç½®é˜¶æ®µï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰©æ–™å¯¼å…¥é…ç½®                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â„¹ï¸ å¯¼å…¥è¯´æ˜                         â”‚
â”‚                                     â”‚
â”‚  å…¨å±€é…ç½®                            â”‚
â”‚  æ¯æ‰¹å¯¼å…¥æ•°é‡: [50] æ¡/æ‰¹æ¬¡          â”‚
â”‚                                     â”‚
â”‚  Sheetå¯¼å…¥é…ç½®                       â”‚
â”‚  â˜‘ ç”µæ§è®¾å¤‡æ±‡æ€»  æ€»æ•°:227 å¾…å¯¼å…¥:227 â”‚
â”‚  â˜‘ æœºæ¢°è®¾å¤‡æ±‡æ€»  æ€»æ•°:150 å¾…å¯¼å…¥:150 â”‚
â”‚                                     â”‚
â”‚  ç»Ÿè®¡ä¿¡æ¯                            â”‚
â”‚  å·²é€‰: 2ä¸ª | å¾…å¯¼å…¥: 377æ¡ | æ‰¹æ¬¡: 8æ‰¹â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           [å–æ¶ˆ]  [å¼€å§‹å¯¼å…¥ (377æ¡)] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯¼å…¥ä¸­ï¼ˆè¿›åº¦å±•ç¤ºï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰©æ–™å¯¼å…¥é…ç½®                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â„¹ï¸ å¯¼å…¥è¯´æ˜                         â”‚
â”‚                                     â”‚
â”‚  å¯¼å…¥è¿›åº¦                            â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  62%           â”‚
â”‚                                     â”‚
â”‚  å½“å‰Sheet: ç”µæ§è®¾å¤‡æ±‡æ€»              â”‚
â”‚  å½“å‰æ‰¹æ¬¡: 5 / 8                     â”‚
â”‚  å·²å¯¼å…¥: 227æ¡                       â”‚
â”‚  æ€»è®¡: 377æ¡                         â”‚
â”‚                                     â”‚
â”‚  âœ… ç”µæ§è®¾å¤‡æ±‡æ€» ç¬¬5æ‰¹ä¸Šä¼ æˆåŠŸï¼Œ       â”‚
â”‚     å·²å¯¼å…¥ 227/377 æ¡                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯¼å…¥å®Œæˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‰©æ–™å¯¼å…¥é…ç½®                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â„¹ï¸ å¯¼å…¥è¯´æ˜                         â”‚
â”‚                                     â”‚
â”‚  å¯¼å…¥è¿›åº¦                            â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100% âœ“      â”‚
â”‚                                     â”‚
â”‚  å½“å‰Sheet: æœºæ¢°è®¾å¤‡æ±‡æ€»              â”‚
â”‚  å½“å‰æ‰¹æ¬¡: 8 / 8                     â”‚
â”‚  å·²å¯¼å…¥: 377æ¡                       â”‚
â”‚  æ€»è®¡: 377æ¡                         â”‚
â”‚                                     â”‚
â”‚  ğŸ‰ å¯¼å…¥å®Œæˆï¼æˆåŠŸå¯¼å…¥ 377 æ¡ï¼Œ       â”‚
â”‚     å¤±è´¥ 0 æ¡                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          [å®Œæˆ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç”¨æˆ·ä½¿ç”¨æµç¨‹

1. **é…ç½®å¯¼å…¥å‚æ•°**

   - é€‰æ‹©è¦å¯¼å…¥çš„ Sheet
   - è®¾ç½®æ¯æ‰¹å¯¼å…¥æ•°é‡ï¼ˆ20-100 æ¡ï¼‰
   - æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

2. **ç‚¹å‡»"å¼€å§‹å¯¼å…¥"**

   - é…ç½®è¡¨å•éšè—
   - æ˜¾ç¤ºè¿›åº¦æ¡å’Œè¯¦ç»†ä¿¡æ¯

3. **å®æ—¶æŸ¥çœ‹è¿›åº¦**

   - è¿›åº¦æ¡æ˜¾ç¤ºå®Œæˆç™¾åˆ†æ¯”
   - æŸ¥çœ‹å½“å‰å¤„ç†çš„ Sheet å’Œæ‰¹æ¬¡
   - æŸ¥çœ‹å·²å¯¼å…¥æ•°é‡

4. **å¯¼å…¥å®Œæˆ**
   - è¿›åº¦æ¡æ˜¾ç¤º 100%ï¼ˆç»¿è‰² âœ“ æˆ–çº¢è‰² âœ—ï¼‰
   - æ˜¾ç¤ºæœ€ç»ˆå¯¼å…¥ç»“æœ
   - ç‚¹å‡»"å®Œæˆ"æŒ‰é’®å…³é—­å¼¹çª—

## é”™è¯¯å¤„ç†

### å¯¼å…¥å¤±è´¥

```typescript
} catch (error: any) {
  sheetFailedCount += batchMaterials.length;
  sheetErrors.push({
    batchIndex: batchIndex + 1,
    errorMessage: error.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥'
  });
  // ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹
}
```

### æœ€ç»ˆçŠ¶æ€

```typescript
importProgress.value.status = totalSuccess > 0 ? 'success' : 'exception';
```

- **å…¨éƒ¨æˆåŠŸ**: status = 'success', è¿›åº¦æ¡ç»¿è‰²
- **éƒ¨åˆ†æˆåŠŸ**: status = 'success', è¿›åº¦æ¡ç»¿è‰²
- **å…¨éƒ¨å¤±è´¥**: status = 'exception', è¿›åº¦æ¡çº¢è‰²

## æ€§èƒ½ä¼˜åŒ–

1. **é¿å…é¢‘ç¹æ›´æ–°**: æ¯ä¸ªæ‰¹æ¬¡ä¸Šä¼ åæ‰æ›´æ–°è¿›åº¦ï¼Œä¸æ˜¯æ¯æ¡æ•°æ®æ›´æ–°ä¸€æ¬¡
2. **å“åº”å¼æ•°æ®ä¼˜åŒ–**: ä½¿ç”¨å•ä¸ªå¯¹è±¡ `importProgress` è€Œä¸æ˜¯å¤šä¸ªç‹¬ç«‹ ref
3. **è®¡ç®—å±æ€§ç¼“å­˜**: æ€»æ‰¹æ¬¡æ•°å’Œæ€»æ•°é‡åœ¨å¼€å§‹æ—¶è®¡ç®—ä¸€æ¬¡

## åç»­ä¼˜åŒ–å»ºè®®

1. **æš‚åœ/ç»§ç»­åŠŸèƒ½**: å…è®¸ç”¨æˆ·æš‚åœå’Œæ¢å¤å¯¼å…¥
2. **å¯¼å…¥å†å²**: è®°å½•æ¯æ¬¡å¯¼å…¥çš„è¯¦ç»†ä¿¡æ¯
3. **å¯¼å…¥é¢„ä¼°æ—¶é—´**: åŸºäºå·²å®Œæˆæ‰¹æ¬¡è®¡ç®—å‰©ä½™æ—¶é—´
4. **å¤±è´¥é‡è¯•**: å…è®¸å¯¹å¤±è´¥çš„æ‰¹æ¬¡è¿›è¡Œé‡è¯•

## æ€»ç»“

é€šè¿‡å®ç°å®æ—¶è¿›åº¦å±•ç¤ºåŠŸèƒ½ï¼Œå¤§å¹…æå‡äº†æ‰¹é‡å¯¼å…¥çš„ç”¨æˆ·ä½“éªŒï¼š

âœ… **é€æ˜åº¦**ï¼šç”¨æˆ·å¯ä»¥æ¸…æ¥šçœ‹åˆ°å¯¼å…¥è¿›åº¦
âœ… **åé¦ˆåŠæ—¶**ï¼šæ¯ä¸ªæ‰¹æ¬¡å®Œæˆåç«‹å³æ›´æ–°
âœ… **çŠ¶æ€æ¸…æ™°**ï¼šæ˜ç¡®æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥çŠ¶æ€
âœ… **ä½“éªŒæµç•…**ï¼šæ— éœ€å…³é—­å¼¹çª—ï¼Œä¸€æ°”å‘µæˆ

---

**å®ç°æ—¥æœŸ**: 2025-01-27  
**å¼€å‘äººå‘˜**: AI Assistant  
**å½±å“èŒƒå›´**: ç‰©æ–™æ¸…å•æ‰¹é‡å¯¼å…¥åŠŸèƒ½  
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯
