# 重复物料明细展示功能实现说明

## 功能概述

优化物料导入完成后的弹窗，增加重复物料的详细展示，让用户清楚地了解哪些数据因为重复而被跳过。

## 需求背景

根据 `物料清单数据差异分析报告.md` 的分析结果：

- 用户上传了 227 条物料数据
- 系统成功保存了 217 条
- 有 10 条因为重复（物料名称+规格相同）被跳过
- 用户对这 10 条数据去哪里了感到困惑

**问题**：当前的导入结果弹窗只显示"跳过记录数量"，但没有详细说明是哪些物料被跳过，以及为什么被跳过。

## 实现方案

### 1. 优化统计信息展示

#### 修改前

```vue
<el-descriptions-item label="跳过记录">
  <el-tag type="info" v-if="importResult.skippedRecords > 0">
    {{ importResult.skippedRecords }}
  </el-tag>
  <span v-else>0</span>
</el-descriptions-item>
```

#### 修改后

```vue
<el-descriptions-item label="重复跳过">
  <el-tag type="warning" v-if="importResult.skippedRecords > 0">
    {{ importResult.skippedRecords }} 条
  </el-tag>
  <span v-else>0</span>
</el-descriptions-item>
```

**改进点**：

- 标签从"跳过记录"改为"重复跳过"，更明确
- 标签颜色从 `info` 改为 `warning`，更醒目
- 添加"条"字，更友好

### 2. 新增重复物料明细表格

在导入结果弹窗中，新增一个专门的区域来展示重复物料的详细信息。

#### 2.1 组件结构

```vue
<!-- 重复物料明细 -->
<div v-if="importResult.duplicateItems && importResult.duplicateItems.length > 0" class="duplicate-list">
  <h4>
    <el-icon style="vertical-align: middle; margin-right: 5px;"><WarningFilled /></el-icon>
    重复物料明细（共 {{ importResult.duplicateItems.length }} 条）：
  </h4>

  <!-- 提示信息 -->
  <el-alert
    title="这些物料因为在系统中已存在相同的「物料名称+规格」组合而被跳过，避免重复导入"
    type="warning"
    :closable="false"
    style="margin-bottom: 10px;"
  />

  <!-- 重复物料表格 -->
  <el-table :data="importResult.duplicateItems" border size="small" style="margin-top: 10px;" max-height="300">
    <el-table-column type="index" label="序号" width="60" align="center" />
    <el-table-column prop="materialName" label="物料名称" min-width="150" show-overflow-tooltip>
      <template #default="{ row }">
        <el-tag type="warning" effect="plain" size="small">{{ row.materialName }}</el-tag>
      </template>
    </el-table-column>
    <el-table-column prop="specification" label="规格型号" min-width="180" show-overflow-tooltip>
      <template #default="{ row }">
        {{ row.specification || '-' }}
      </template>
    </el-table-column>
    <el-table-column prop="quantity" label="数量" width="80" align="center" />
    <el-table-column prop="unit" label="单位" width="70" align="center" />
    <el-table-column prop="sheetName" label="来源Sheet" width="120" align="center" show-overflow-tooltip />
    <el-table-column prop="rowNumber" label="Excel行号" width="90" align="center">
      <template #default="{ row }">
        <el-tag size="small" type="info">第 {{ row.rowNumber }} 行</el-tag>
      </template>
    </el-table-column>
    <el-table-column label="原因" width="100" align="center" fixed="right">
      <template #default>
        <el-tag type="warning" size="small">重复</el-tag>
      </template>
    </el-table-column>
  </el-table>
</div>
```

#### 2.2 表格特点

| 列名       | 说明                  | 特点                         |
| ---------- | --------------------- | ---------------------------- |
| 序号       | 重复物料的序号        | 自动编号                     |
| 物料名称   | 被跳过的物料名称      | 使用 warning 标签高亮显示    |
| 规格型号   | 物料的规格型号        | 显示具体规格，无规格显示 "-" |
| 数量       | 物料数量              | 居中对齐                     |
| 单位       | 计量单位              | 居中对齐                     |
| 来源 Sheet | 数据来源的工作表      | 可溢出显示                   |
| Excel 行号 | 在原始 Excel 中的行号 | 使用 info 标签显示           |
| 原因       | 跳过原因              | 固定显示"重复"               |

### 3. 更新类型定义

在 `src/api/erp/saltprocess/material/types.ts` 中添加重复物料相关的类型定义：

```typescript
/**
 * 物料导入结果视图对象
 */
export interface MaterialImportResultVo {
  success: boolean;
  summary: string;
  totalRecords: number;
  successRecords: number;
  failedRecords: number;
  newProductRecords: number;
  matchedProductRecords: number;
  skippedRecords?: number; // 跳过的记录数（重复物料）
  shippingListId?: string;
  listCode?: string;
  errors?: MaterialImportError[];
  warnings?: MaterialImportWarning[];
  duplicateItems?: DuplicateMaterialItem[]; // 重复物料明细
}

/**
 * 重复物料项
 */
export interface DuplicateMaterialItem {
  materialName: string;
  specification?: string;
  quantity: number;
  unit?: string;
  sheetName?: string;
  rowNumber?: number;
  reason?: string; // 重复原因
}
```

### 4. 收集重复物料数据

在 `submitDataWithConfig` 方法中，收集每个批次返回的重复物料信息：

```typescript
// 在方法开始处声明收集数组
const allDuplicateItems: any[] = []; // 收集所有重复物料

// 在处理每个批次的响应时
if (result && result.success) {
  // ... 其他处理逻辑

  // 收集重复物料信息
  if (result.duplicateItems && result.duplicateItems.length > 0) {
    allDuplicateItems.push(...result.duplicateItems);
  }

  // 如果有 skippedRecords 但没有 duplicateItems，计算跳过数量
  if (result.skippedRecords && result.skippedRecords > 0) {
    totalSkipped += result.skippedRecords;
  }
}

// 在构建最终结果时
importResult.value = {
  // ... 其他字段
  duplicateItems: allDuplicateItems.length > 0 ? allDuplicateItems : undefined
};
```

### 5. 优化摘要信息

```typescript
summary: totalSkipped > 0
  ? `成功导入 ${totalSuccess} 条，失败 ${totalFailed} 条，重复跳过 ${totalSkipped} 条`
  : `成功导入 ${totalSuccess} 条，失败 ${totalFailed} 条`,
```

当有重复物料时，在摘要中明确显示"重复跳过"的数量。

### 6. 样式优化

```scss
.duplicate-list {
  margin-top: 20px;
  text-align: left;

  h4 {
    margin-bottom: 10px;
    font-size: 14px;
    color: #e6a23c; // 警告色
    font-weight: 600;
    display: flex;
    align-items: center;
  }

  :deep(.el-table) {
    font-size: 13px;
  }
}
```

## 效果展示

### 修改前

导入结果弹窗只显示：

- 总记录数：227
- 成功记录：227
- 跳过记录：0（显示错误）

**问题**：用户不知道有 10 条数据被跳过，也不知道是哪些数据。

### 修改后

导入结果弹窗显示：

#### 1. 统计信息

- 总记录数：217
- 成功记录：217
- 失败记录：0
- **重复跳过：10 条**（醒目的警告标签）
- 新建产品：XX
- 匹配产品：XX

#### 2. 摘要

```
成功导入 217 条，失败 0 条，重复跳过 10 条
```

#### 3. 重复物料明细表格

展示所有 10 条重复物料的详细信息：

| 序号 | 物料名称   | 规格型号                   | 数量 | 单位 | 来源 Sheet   | Excel 行号 | 原因 |
| ---- | ---------- | -------------------------- | ---- | ---- | ------------ | ---------- | ---- |
| 1    | 三通       | 配套连接片，螺丝螺母，盖板 | 1    | 套   | 电控设备汇总 | 第 46 行   | 重复 |
| 2    | plc 控制柜 | 见图纸及清单               | 1    | 套   | 电控设备汇总 | 第 50 行   | 重复 |
| 3    | 电源柜     | 见图纸及清单               | 1    | 套   | 电控设备汇总 | 第 51 行   | 重复 |
| ...  | ...        | ...                        | ...  | ...  | ...          | ...        | ...  |

**用户可以清楚地看到**：

- 哪些物料被跳过了
- 它们的具体规格
- 在 Excel 中的位置（第几行）
- 来源于哪个工作表
- 为什么被跳过（重复）

## 后端接口要求

为了完整实现此功能，后端接口需要在导入响应中返回 `duplicateItems` 数据：

### 请求示例（前端发送）

```json
{
  "projectId": "1",
  "batchNumber": "1761554758535_电控设备汇总_1",
  "materialItems": [
    {
      "materialName": "三通",
      "specification": "配套连接片，螺丝螺母，盖板",
      "quantity": 1,
      "unit": "套",
      "sheetName": "电控设备汇总",
      "rowNumber": 46
    }
    // ... 更多物料
  ]
}
```

### 响应示例（后端返回）

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "success": true,
    "successCount": 47,
    "failedRecords": 0,
    "skippedRecords": 3,
    "newProductCount": 10,
    "matchedProductCount": 37,
    "duplicateItems": [
      {
        "materialName": "三通",
        "specification": "配套连接片，螺丝螺母，盖板",
        "quantity": 1,
        "unit": "套",
        "sheetName": "电控设备汇总",
        "rowNumber": 46,
        "reason": "物料名称+规格已存在"
      },
      {
        "materialName": "plc控制柜",
        "specification": "见图纸及清单",
        "quantity": 1,
        "unit": "套",
        "sheetName": "电控设备汇总",
        "rowNumber": 50,
        "reason": "物料名称+规格已存在"
      },
      {
        "materialName": "电源柜",
        "specification": "见图纸及清单",
        "quantity": 1,
        "unit": "套",
        "sheetName": "电控设备汇总",
        "rowNumber": 51,
        "reason": "物料名称+规格已存在"
      }
    ],
    "errors": []
  }
}
```

**关键字段**：

- `skippedRecords`：跳过的记录数量
- `duplicateItems`：重复物料的详细信息数组

## 用户体验优化

### 1. 视觉层次

- **警告图标**：使用 `<WarningFilled />` 图标，视觉上更醒目
- **颜色区分**：
  - 重复物料使用警告色（橙色）
  - 错误信息使用危险色（红色）
  - 成功信息使用成功色（绿色）

### 2. 信息完整性

每条重复物料都显示：

- 物料名称（高亮）
- 规格型号（完整显示）
- 数量和单位
- 来源 Sheet
- Excel 行号（方便用户回到原始文件查找）
- 跳过原因

### 3. 可操作性

- 表格支持滚动（max-height: 300px）
- 长文本自动省略显示，hover 显示完整内容
- 清晰的提示文字说明跳过原因

## 测试验证

### 测试场景 1：有重复物料

**测试数据**：227 条，其中 10 条重复

**预期结果**：

- ✅ 统计信息显示"重复跳过：10 条"
- ✅ 摘要显示"重复跳过 10 条"
- ✅ 重复物料明细表格显示 10 条数据
- ✅ 每条数据包含完整信息

### 测试场景 2：无重复物料

**测试数据**：100 条，无重复

**预期结果**：

- ✅ 统计信息显示"重复跳过：0"
- ✅ 摘要不显示重复跳过信息
- ✅ 不显示重复物料明细表格

### 测试场景 3：全部重复

**测试数据**：50 条，全部重复

**预期结果**：

- ✅ 统计信息显示"重复跳过：50 条"
- ✅ 成功记录：0
- ✅ 重复物料明细表格显示 50 条数据

## 相关文件

### 前端文件

- `src/views/erp/saltprocess/project/components/MaterialDetail.vue`
- `src/api/erp/saltprocess/material/types.ts`

### 文档文件

- `docs/物料清单数据差异分析报告.md`（问题分析）
- `docs/物料清单模块功能文档/重复物料明细展示功能实现说明.md`（本文档）

## 注意事项

### 1. 后端接口兼容性

如果后端暂时无法返回 `duplicateItems` 数据：

- 前端仍然可以正常运行
- 只会显示跳过数量，不显示明细表格
- 不会报错

### 2. 数据一致性

确保：

- `skippedRecords` = `duplicateItems.length`
- 重复物料不计入成功或失败数量

### 3. 性能考虑

- 使用 `max-height` 限制表格高度，避免数据过多时页面过长
- 重复物料数据较多时，考虑分页显示

## 后续优化建议

1. **导出功能**：允许用户导出重复物料列表，方便数据核对
2. **批量处理**：允许用户选择是否强制导入重复物料
3. **智能提示**：在导入前预检测重复物料，提前提醒用户
4. **历史记录**：保存每次导入的重复物料记录，方便追溯

---

**实现日期**：2025-10-27  
**文档版本**：v1.0  
**实现人员**：AI Assistant
