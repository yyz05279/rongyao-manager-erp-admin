# 物料导入发货日期必填问题修复说明

## 问题描述

### 错误信息

```
发货日期不能为空
```

### 问题原因

后端物料导入接口 `/erp/saltprocess/material/import` 要求 `shippingDate`（发货日期）字段必填，但**物料清单本身不应该有发货日期**。

发货日期是发货清单才需要的字段，物料清单只是记录项目所需的物料信息，与发货无关。

### 接口设计问题

在 `MaterialImportBo` 接口定义中：

```typescript
export interface MaterialImportBo {
  // 项目信息
  projectId: string;
  projectName?: string;

  // 批次信息
  batchNumber?: string;

  // 负责人信息
  responsiblePerson?: string;
  responsiblePersonId?: number;

  // 发货日期信息
  shippingDate?: string;          // ❌ 定义为可选，但后端要求必填
  expectedDeliveryDate?: string;

  // ... 其他字段
}
```

虽然 `shippingDate` 在类型定义中是可选的（有 `?` 标记），但后端验证时要求它必须存在，导致接口文档与实际实现不一致。

## 修复方案

### 临时解决方案（前端）

在构造导入请求时，传递当前日期作为默认的发货日期：

```typescript
const importData: MaterialImportBo = {
  projectId: props.projectId,
  batchNumber: `${batchNumber}_${group.sheetName}_${batchIndex + 1}`,
  // 临时解决方案：后端要求发货日期必填，但物料清单不应该有此字段
  // TODO: 后端应该修改接口，使发货日期仅在发货清单中必填
  shippingDate: new Date().toISOString().split('T')[0], // YYYY-MM-DD格式
  fileSource: '前端Excel解析-物料清单批量导入',
  remarks: `Sheet: ${group.sheetName}, 批次: ${batchIndex + 1}`,
  materialItems: safeMaterialItems
};
```

### 根本解决方案（需后端配合）

**建议后端修改接口设计：**

#### 方案 A：拆分接口（推荐）

1. **物料清单导入接口**：`/erp/saltprocess/material/import`

   - 不需要发货相关字段
   - 专注于物料信息的导入

2. **发货清单导入接口**：`/erp/saltprocess/shipping/import`
   - 包含发货日期、车辆信息等发货相关字段
   - 专门处理发货清单

#### 方案 B：条件验证

在现有接口中，根据数据类型（物料清单 vs 发货清单）动态验证：

- 如果是物料清单：`shippingDate` 可选
- 如果是发货清单：`shippingDate` 必填

## 修改位置

**文件**: `src/views/erp/saltprocess/project/components/MaterialDetail.vue`

**方法**:

1. `submitDataWithConfig` - 使用配置提交数据（第 1297 行）
2. `submitData` - 直接提交数据（第 1011 行，已包含修复）

## 修复效果

### 修复前

- ❌ 导入物料清单
- ❌ 后端返回"发货日期不能为空"
- ❌ 导入失败

### 修复后

- ✅ 导入物料清单
- ✅ 前端自动传递当前日期作为发货日期
- ✅ 导入成功

## 注意事项

### 1. 数据含义问题

虽然修复后功能可以正常工作，但数据库中会存储一个"假的"发货日期：

- 这个日期并不代表实际发货时间
- 只是为了满足后端验证而传递的默认值
- 可能会造成数据理解上的混淆

### 2. 建议

**强烈建议后端修改接口设计**，将物料清单和发货清单的导入分开处理，或者使发货日期真正可选。

## 相关文档

### 接口定义

- `src/api/erp/saltprocess/material/types.ts` - MaterialImportBo 接口定义
- `docs/物料清单模块功能文档/物料导入API调用示例.ts` - API 调用示例

### 使用示例

```typescript
// ✅ 正确的调用方式（包含发货日期）
const importData: MaterialImportBo = {
  projectId: '1967857798821703681',
  batchNumber: 'BATCH-1234567890',
  shippingDate: '2025-01-27', // 必填
  materialItems: [
    {
      materialName: 'plc控制柜',
      materialType: 'ELECTRICAL',
      quantity: 1,
      // ... 其他字段
    }
  ]
};

const result = await importParsedMaterialData(importData);
```

## 数据流程

```
用户上传Excel
    ↓
前端解析物料数据
    ↓
用户选择要导入的Sheet
    ↓
构造导入请求
    ├─ projectId: 项目ID
    ├─ batchNumber: 批次号
    ├─ shippingDate: 当前日期（临时方案）✅
    ├─ fileSource: 数据来源
    └─ materialItems: 物料明细列表
    ↓
调用后端导入接口
    ↓
后端验证（包括检查shippingDate）
    ↓
导入成功 ✅
```

## 后续优化

### 短期（前端）

- [x] 添加默认发货日期
- [ ] 在导入成功后提示用户注意发货日期字段的含义

### 长期（后端）

- [ ] 拆分物料导入和发货清单导入接口
- [ ] 修改验证逻辑，使发货日期真正可选
- [ ] 更新接口文档，明确必填/可选字段

## 总结

这是一个**接口设计不合理**导致的问题：

**问题本质**：物料清单不应该有发货日期，但后端接口要求此字段必填

**临时解决**：前端传递当前日期作为默认值，满足后端验证

**根本解决**：需要后端修改接口设计，分离物料清单和发货清单的处理逻辑

---

**修复日期**: 2025-01-27  
**修复人员**: AI Assistant  
**影响范围**: 物料清单批量导入功能  
**测试状态**: 待用户验证  
**后续计划**: 联系后端修改接口设计
