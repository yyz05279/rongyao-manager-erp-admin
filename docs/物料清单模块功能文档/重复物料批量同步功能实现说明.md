# 重复物料批量同步功能实现说明

## 功能概述

本次更新为物料清单模块的重复物料管理添加了批量同步和单个更新功能，支持快速处理导入时的重复物料数据。

## 实现的功能

### 1. UI 优化

#### 1.1 列宽调整

- **来源 Sheet 列**：宽度从 `min-width="80"` 调整为 `min-width="150"`
- **Excel 行号列**：宽度从 `width="100"` 调整为 `width="120"`
- **目的**：解决文本显示超出父视图的问题

#### 1.2 批量同步按钮

- **位置**：重复物料明细标题区域的右侧
- **图标**：Upload 图标
- **状态**：支持 loading 状态显示
- **功能**：一键批量更新所有重复物料的数量

#### 1.3 说明组件

- **类型**：info 类型的 Alert 组件
- **位置**：批量同步按钮下方
- **内容**：动态显示将要批量更新的重复物料条数
- **示例**：`点击"合并同步"按钮，将批量更新所有重复物料的数量（共 10 条），累加到数据库现有数量`

#### 1.4 单个更新按钮

- **位置**：每条重复数据表格的最右侧（操作列）
- **宽度**：100px
- **固定**：fixed="right" 防止滚动时被遮挡
- **功能**：单独更新某一条重复物料的数量

### 2. API 接口

#### 2.1 批量更新接口

```typescript
/**
 * 批量更新物料明细
 * @param items 物料明细数组
 */
export function batchUpdateMaterials(items: MaterialVO[]): AxiosPromise<void> {
  return request({
    url: '/erp/saltprocess/material/batch',
    method: 'put',
    data: items
  });
}
```

**接口地址**：`PUT /erp/saltprocess/material/batch`

**请求参数**：MaterialVO 数组

**返回值**：Promise<void>

#### 2.2 单个更新接口

已有的 `updateMaterial` 接口，用于更新单个物料明细。

```typescript
export function updateMaterial(data: MaterialVO): AxiosPromise<void> {
  return request({
    url: '/erp/saltprocess/material',
    method: 'put',
    data: data
  });
}
```

### 3. 业务逻辑实现

#### 3.1 批量合并同步（handleBatchSyncDuplicates）

**流程**：

1. **数据验证**：检查是否存在需要同步的重复物料
2. **用户确认**：显示确认对话框，提示将要更新的物料数量
3. **数据构建**：
   - 遍历所有已存在的物料（existedItems）
   - 对每个物料计算累加后的数量（现有数量 + 所有重复项数量）
   - 构建 MaterialVO 数组
4. **API 调用**：调用批量更新接口 `batchUpdateMaterials`
5. **结果处理**：
   - 成功：显示成功消息，关闭结果弹窗，刷新数据列表
   - 失败：显示错误消息

**代码示例**：

```typescript
const handleBatchSyncDuplicates = async () => {
  if (!importResult.value?.existedItems || importResult.value.existedItems.length === 0) {
    ElMessage.warning('没有需要同步的重复物料');
    return;
  }

  try {
    await ElMessageBox.confirm(
      `确定要批量同步所有重复物料吗？将更新 ${importResult.value.existedItems.length} 个物料的数量。`,
      '批量同步确认',
      {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }
    );

    batchSyncing.value = true;

    const updateItems: MaterialVO[] = importResult.value.existedItems.map((existedItemVo: any) => {
      const accumulatedQuantity = calculateAccumulatedQuantity(existedItemVo);
      return {
        ...existedItemVo.existedItem,
        quantity: accumulatedQuantity,
        version: existedItemVo.existedItem.version || 1
      };
    });

    await batchUpdateMaterials(updateItems);
    ElMessage.success('批量同步成功');
    showResult.value = false;
    await initializeData();
  } catch (error: any) {
    if (error !== 'cancel') {
      console.error('批量同步失败:', error);
      ElMessage.error('批量同步失败：' + (error.message || '未知错误'));
    }
  } finally {
    batchSyncing.value = false;
  }
};
```

#### 3.2 单个物料更新（handleUpdateSingleItem）

**流程**：

1. **参数接收**：接收已存在物料（existedItem）和重复项（duplicateItem）
2. **用户确认**：显示确认对话框，提示更新前后的数量变化
3. **数据构建**：
   - 复制已存在物料的所有字段
   - 更新数量为：现有数量 + 重复项数量
   - 设置版本号
4. **API 调用**：调用单个更新接口 `updateMaterial`
5. **结果处理**：
   - 成功：显示成功消息，关闭结果弹窗，刷新数据列表
   - 失败：显示错误消息

**代码示例**：

```typescript
const handleUpdateSingleItem = async (existedItem: any, duplicateItem: any) => {
  try {
    await ElMessageBox.confirm(
      `确定要将数量 ${duplicateItem.quantity} ${duplicateItem.unit} 累加到现有数量吗？更新后将为 ${existedItem.quantity + duplicateItem.quantity} ${existedItem.unit}`,
      '更新确认',
      {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'info'
      }
    );

    const updateData: MaterialVO = {
      ...existedItem,
      quantity: existedItem.quantity + duplicateItem.quantity,
      version: existedItem.version || 1
    };

    await updateMaterial(updateData);
    ElMessage.success('更新成功');
    showResult.value = false;
    await initializeData();
  } catch (error: any) {
    if (error !== 'cancel') {
      console.error('更新失败:', error);
      ElMessage.error('更新失败：' + (error.message || '未知错误'));
    }
  }
};
```

#### 3.3 辅助计算方法

**计算所有重复项的总条数**：

```typescript
const calculateTotalDuplicatesCount = (): number => {
  if (!importResult.value?.existedItems) return 0;
  return importResult.value.existedItems.reduce((total: number, item: any) => {
    return total + (item.duplicateItems?.length || 0);
  }, 0);
};
```

### 4. 状态管理

新增响应式状态：

```typescript
const batchSyncing = ref(false); // 批量同步状态
```

用于控制批量同步按钮的 loading 状态。

## 文件修改清单

### 1. MaterialDetail.vue

- **位置**：`src/views/erp/saltprocess/project/components/MaterialDetail.vue`
- **修改内容**：
  - 调整表格列宽度
  - 添加批量同步按钮和说明组件
  - 添加单个更新按钮列
  - 新增 batchSyncing 状态
  - 实现 handleBatchSyncDuplicates 方法
  - 实现 handleUpdateSingleItem 方法
  - 实现 calculateTotalDuplicatesCount 方法
  - 导入 Upload 图标和新的 API 接口

### 2. material/index.ts

- **位置**：`src/api/erp/saltprocess/material/index.ts`
- **修改内容**：
  - 新增 batchUpdateMaterials 批量更新接口

## 使用说明

### 批量同步操作

1. 导入 Excel 文件
2. 系统检测到重复物料时，会在"重复物料明细"区域显示详细信息
3. 点击右上角的"合并同步"按钮
4. 确认更新操作
5. 系统批量更新所有重复物料的数量
6. 自动刷新数据列表

### 单个更新操作

1. 在重复物料明细表格中找到需要更新的记录
2. 点击该行最右侧的"更新"按钮
3. 确认更新操作
4. 系统更新该条物料的数量
5. 自动刷新数据列表

## 优势

1. **效率提升**：批量同步功能大幅提升重复物料处理效率
2. **灵活性**：支持批量和单个两种更新方式，满足不同场景需求
3. **用户友好**：
   - 清晰的说明和提示
   - 确认对话框防止误操作
   - Loading 状态提示
   - 自动刷新数据列表
4. **数据安全**：
   - 版本号控制（乐观锁）
   - 用户确认机制
   - 完善的错误处理

## 注意事项

1. 批量更新操作会更新所有重复物料，请确认后再操作
2. 单个更新操作仅更新选中的一条重复记录
3. 更新成功后会自动关闭结果弹窗并刷新数据列表
4. 如果后端接口尚未实现，需要等待后端开发完成

## 后续优化建议

1. 支持选择性批量同步（勾选要同步的物料）
2. 显示更新进度条（处理大量数据时）
3. 支持撤销操作
4. 添加操作日志记录
5. 支持导出重复物料报表

## 版本信息

- **版本**：v1.3.0
- **日期**：2025-10-28
- **作者**：haitang
