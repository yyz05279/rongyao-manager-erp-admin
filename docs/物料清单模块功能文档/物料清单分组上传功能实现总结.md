# 物料清单分组上传功能实现总结

## 功能概述

对物料清单数据上传接口进行了重大优化，现在支持按 Excel Sheet 分组上传。不同类型的物料（如电控设备汇总、机械设备汇总等）会分别上传到后端，每个 Sheet 对应其特定类型的物料明细，实现了更精细化的数据管理。

## 核心改进

### 1. 分组上传机制

#### 1.1 上传流程

```
原方案：
所有物料数据 → 一次性上传 → 后端处理

新方案：
电控设备汇总 → 单独上传 → 后端处理
机械设备汇总 → 单独上传 → 后端处理
通用物料汇总 → 单独上传 → 后端处理
发货信息汇总 → 单独上传 → 后端处理
```

#### 1.2 技术实现

```typescript
// 提交数据 - 按Sheet分组上传
const submitData = async () => {
  const batchNumber = new Date().getTime().toString();
  const importResults: any[] = [];

  // 遍历每个Sheet分组
  for (const group of sheetGroups.value) {
    // 过滤该Sheet下的有效记录
    const validMaterials = group.materials.filter(item => !item.hasErrors);

    if (validMaterials.length === 0) continue;

    // 获取物料类型（从Sheet名称推断）
    const materialType = inferMaterialType(group.sheetName, validMaterials[0]);

    const importData: MaterialImportBo = {
      projectId: props.projectId,
      batchNumber: `${batchNumber}-${group.sheetName}`,  // 独立批次号
      materialItems: validMaterials.map(item => ({
        ...item,
        materialType: materialType || item.materialType
      })),
      fileSource: `前端Excel解析导入-${group.sheetName}`,  // 标记来源Sheet
      remarks: `Sheet: ${group.sheetName}, 共${group.materials.length}条，有效${validMaterials.length}条`
    };

    // 单独上传每个Sheet的数据
    const result = await importParsedMaterialData(importData);
    importResults.push({...});
  }

  // 汇总所有Sheet的导入结果
  importResult.value = {...};
};
```

### 2. 智能类型推断

#### 2.1 物料类型自动识别

系统根据 Sheet 名称自动推断物料类型：

```typescript
const inferMaterialType = (sheetName: string, sampleMaterial: any): string => {
  const name = sheetName.toLowerCase();

  // 根据Sheet名称判断
  if (name.includes('电控')) return 'ELECTRICAL';
  if (name.includes('机械')) return 'MECHANICAL';
  if (name.includes('发货') || name.includes('装车')) return 'SHIPPING_INFO';

  // 如果无法从Sheet名称判断，使用原有的物料类型
  return sampleMaterial?.materialType || 'GENERAL';
};
```

#### 2.2 类型映射规则

| Sheet 名称关键词   | 物料类型代码  | 物料类型名称 |
| ------------------ | ------------- | ------------ |
| 包含"电控"         | ELECTRICAL    | 电控设备     |
| 包含"机械"         | MECHANICAL    | 机械设备     |
| 包含"发货"或"装车" | SHIPPING_INFO | 发货信息     |
| 其他               | GENERAL       | 通用物料     |

### 3. 批次号管理

#### 3.1 独立批次号生成

每个 Sheet 生成独立的批次号：

```
基础批次号: 1640000000000
Sheet 批次号格式: {基础批次号}-{Sheet名称}

示例：
- 1640000000000-电控设备汇总
- 1640000000000-机械设备汇总
- 1640000000000-通用物料汇总
```

#### 3.2 优势

- ✅ 便于追溯每个 Sheet 的导入来源
- ✅ 支持按 Sheet 进行数据查询和管理
- ✅ 方便数据回滚和错误处理

### 4. 导入结果展示优化

#### 4.1 总体统计信息

```vue
<el-descriptions :column="2" border>
  <el-descriptions-item label="总记录数">
    {{ importResult.totalRecords }}
  </el-descriptions-item>
  <el-descriptions-item label="成功记录">
    <el-tag type="success">{{ importResult.successRecords }}</el-tag>
  </el-descriptions-item>
  <el-descriptions-item label="失败记录">
    <el-tag type="danger">{{ importResult.failedRecords }}</el-tag>
  </el-descriptions-item>
  <el-descriptions-item label="新建产品">
    {{ importResult.newProductRecords }}
  </el-descriptions-item>
  <el-descriptions-item label="匹配产品">
    {{ importResult.matchedProductRecords }}
  </el-descriptions-item>
  <el-descriptions-item label="处理Sheet数">
    {{ importResult.sheetResults?.length || 0 }}
  </el-descriptions-item>
</el-descriptions>
```

#### 4.2 各 Sheet 导入详情表格

新增详细的 Sheet 级别导入结果展示：

| Sheet 名称   | 总记录数 | 成功 | 失败 | 新建产品 | 匹配产品 | 状态 |
| ------------ | -------- | ---- | ---- | -------- | -------- | ---- |
| 电控设备汇总 | 23       | 23   | 0    | 5        | 18       | 成功 |
| 机械设备汇总 | 45       | 43   | 2    | 12       | 31       | 失败 |
| 通用物料汇总 | 12       | 12   | 0    | 2        | 10       | 成功 |

#### 4.3 结果数据结构

```typescript
interface ImportResult {
  success: boolean;
  summary: string;
  totalRecords: number;
  successRecords: number;
  failedRecords: number;
  newProductRecords: number;
  matchedProductRecords: number;
  sheetResults: SheetResult[];  // 新增：各Sheet的详细结果
  errors: any[];
}

interface SheetResult {
  sheetName: string;
  success: boolean;
  totalRecords: number;
  successRecords: number;
  failedRecords: number;
  newProductRecords: number;
  matchedProductRecords: number;
  errors: any[];
}
```

## 使用场景

### 场景 1：多类型物料导入

用户上传包含多种类型物料的 Excel 文件：

```
物料清单.xlsx
├─ 电控设备汇总 (23条)
│  └─ 自动识别为 ELECTRICAL 类型
├─ 机械设备汇总 (45条)
│  └─ 自动识别为 MECHANICAL 类型
└─ 通用物料汇总 (12条)
   └─ 自动识别为 GENERAL 类型
```

系统会：

1. 分别上传 3 个 Sheet 的数据
2. 每个 Sheet 生成独立批次号
3. 自动识别并设置正确的物料类型
4. 返回每个 Sheet 的导入结果

### 场景 2：部分导入失败处理

假设某个 Sheet 导入失败：

```
导入结果：
✅ 电控设备汇总: 成功导入 23/23 条
❌ 机械设备汇总: 导入失败 43/45 条 (2条错误)
✅ 通用物料汇总: 成功导入 12/12 条

总体结果: 部分成功
- 总计: 80 条
- 成功: 78 条
- 失败: 2 条
```

用户可以：

- 查看详细的错误信息
- 只需修复失败的 Sheet
- 重新上传失败的部分

### 场景 3：项目阶段分类管理

用户按项目阶段组织物料：

```
项目物料清单.xlsx
├─ 采购清单 → GENERAL 类型
├─ 已入库设备 → MECHANICAL 类型
├─ 待安装电控 → ELECTRICAL 类型
└─ 发货记录 → SHIPPING_INFO 类型
```

每个阶段的物料独立上传和管理，便于：

- 追溯物料状态变化
- 按阶段统计数据
- 灵活的数据查询

## 技术优势

### 1. 数据隔离

- ✅ 每个 Sheet 独立上传，互不影响
- ✅ 一个 Sheet 失败不影响其他 Sheet
- ✅ 便于错误定位和修复

### 2. 类型管理

- ✅ 自动识别物料类型
- ✅ 避免人工分类错误
- ✅ 统一的类型管理规范

### 3. 数据追溯

- ✅ 独立批次号便于追溯
- ✅ 明确的数据来源标记
- ✅ 支持按 Sheet 查询和管理

### 4. 错误处理

- ✅ 精确到 Sheet 级别的错误定位
- ✅ 详细的导入结果反馈
- ✅ 支持部分重试

### 5. 用户体验

- ✅ 清晰的导入进度反馈
- ✅ 详细的统计信息展示
- ✅ 直观的成功/失败状态

## API 接口变化

### 请求数据结构

```typescript
// 单次请求（每个Sheet一次）
{
  projectId: "project-123",
  batchNumber: "1640000000000-电控设备汇总",  // Sheet独立批次号
  materialItems: [
    {
      materialName: "PLC控制柜",
      materialType: "ELECTRICAL",  // 自动推断的类型
      specification: "XYZ-456型",
      quantity: 1,
      unit: "套",
      sheetName: "电控设备汇总",  // 来源Sheet
      ...
    }
  ],
  fileSource: "前端Excel解析导入-电控设备汇总",  // 标记来源
  remarks: "Sheet: 电控设备汇总, 共23条记录，有效23条"
}
```

### 响应数据结构

```typescript
// 汇总响应
{
  success: true,
  summary: "共处理 3 个Sheet分组，成功 78 条，失败 2 条",
  totalRecords: 80,
  successRecords: 78,
  failedRecords: 2,
  newProductRecords: 19,
  matchedProductRecords: 59,
  sheetResults: [  // 各Sheet的详细结果
    {
      sheetName: "电控设备汇总",
      success: true,
      totalRecords: 23,
      successRecords: 23,
      failedRecords: 0,
      newProductRecords: 5,
      matchedProductRecords: 18,
      errors: []
    },
    {
      sheetName: "机械设备汇总",
      success: false,
      totalRecords: 45,
      successRecords: 43,
      failedRecords: 2,
      newProductRecords: 12,
      matchedProductRecords: 31,
      errors: [
        {
          rowNumber: 15,
          materialName: "搅拌机",
          errorMessage: "规格型号不符合要求"
        }
      ]
    }
  ],
  errors: [...]
}
```

## 后端接口要求

### 1. 接口地址

```
POST /erp/saltprocess/material/frontend-import/data
```

### 2. 请求参数

```typescript
interface MaterialImportBo {
  projectId: string;           // 项目ID
  batchNumber: string;         // 批次号（含Sheet名称）
  materialItems: MaterialItemBo[];  // 物料明细列表
  fileSource: string;          // 来源标记
  remarks: string;             // 备注信息
}
```

### 3. 响应参数

```typescript
interface MaterialImportResultVo {
  success: boolean;
  totalRecords: number;
  successRecords: number;
  failedRecords: number;
  newProductRecords: number;
  matchedProductRecords: number;
  errors: MaterialImportError[];
}
```

### 4. 建议优化

后端可以考虑：

1. **批次号解析**: 从批次号中提取 Sheet 名称
2. **类型验证**: 验证前端推断的物料类型是否正确
3. **数据关联**: 建立 Sheet 与物料数据的关联关系
4. **查询支持**: 支持按 Sheet 名称或批次号查询物料

## 测试要点

### 1. 功能测试

- [ ] 单 Sheet 文件导入
- [ ] 多 Sheet 文件导入
- [ ] 不同类型 Sheet 的类型推断
- [ ] 部分 Sheet 导入失败的处理
- [ ] 全部 Sheet 导入成功
- [ ] 全部 Sheet 导入失败

### 2. 数据验证

- [ ] 批次号格式正确性
- [ ] Sheet 名称准确性
- [ ] 物料类型自动识别
- [ ] 数据完整性

### 3. 结果展示

- [ ] 总体统计信息正确
- [ ] Sheet 详情表格展示
- [ ] 成功/失败状态标记
- [ ] 错误信息显示

### 4. 边界测试

- [ ] 空 Sheet 处理
- [ ] 特殊字符 Sheet 名称
- [ ] 大量 Sheet (>10 个)
- [ ] 单 Sheet 大量数据

## 迁移指南

### 从旧版本升级

如果您正在使用旧版本的物料导入功能，请注意：

1. **接口兼容性**: 新版本保持向后兼容，单 Sheet 文件仍可正常导入
2. **批次号变化**: 批次号格式从 `timestamp` 变为 `timestamp-sheetName`
3. **结果结构**: 导入结果增加了 `sheetResults` 字段
4. **类型推断**: 新增自动类型推断功能

### 数据库变更建议

建议后端数据库增加以下字段：

```sql
ALTER TABLE erp_project_material
ADD COLUMN sheet_name VARCHAR(200) COMMENT 'Sheet来源名称',
ADD INDEX idx_sheet_name (sheet_name),
ADD INDEX idx_batch_number (batch_number);
```

## 后续优化建议

### 1. 并发上传

当前是串行上传各 Sheet，可以优化为：

- 并发上传多个 Sheet
- 显示总体上传进度
- 支持取消某个 Sheet 的上传

### 2. 上传策略

- 支持选择性上传指定的 Sheet
- 支持设置 Sheet 上传顺序
- 支持暂停和恢复上传

### 3. 智能重试

- 失败的 Sheet 自动重试
- 可配置重试次数和间隔
- 重试失败后的降级处理

### 4. 数据预校验

- 上传前进行更全面的数据校验
- 预估导入时间
- 提前发现潜在问题

## 总结

本次优化实现了物料清单的分组上传功能，主要成果包括：

### ✅ 核心功能

1. **按 Sheet 分组上传** - 每个 Sheet 独立处理
2. **智能类型推断** - 自动识别物料类型
3. **独立批次管理** - 每个 Sheet 生成独立批次号
4. **详细结果展示** - Sheet 级别的导入结果

### 🎯 业务价值

1. **数据隔离** - 不同类型物料分别管理
2. **精确追溯** - 明确的数据来源和批次
3. **错误定位** - 精确到 Sheet 的错误信息
4. **灵活处理** - 支持部分导入和重试

### 📈 用户体验

1. **清晰反馈** - 详细的导入进度和结果
2. **直观展示** - 表格化的 Sheet 导入详情
3. **便捷操作** - 自动化的类型识别

这个功能特别适合处理复杂的、多类型的物料清单，为企业提供了更加专业和精细化的物料数据管理能力。🎉
