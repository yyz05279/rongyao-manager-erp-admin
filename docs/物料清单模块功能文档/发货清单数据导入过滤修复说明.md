# 发货清单数据导入过滤修复说明

## 问题描述

### 现象

用户在物料清单导入时，即使只勾选了"电控设备汇总"等物料 Sheet，但在实际导入时仍然提示"发货日期不能为空"错误，说明发货清单数据仍然被上传到后端。

### 问题原因

虽然在 UI 层面（数据预览、导入配置弹窗）已经过滤了发货清单，但在实际构造导入请求时，数据过滤不够彻底，导致发货清单数据仍然被包含在上传的数据中。

## 修复方案

### 三层过滤机制

为确保发货清单数据绝对不会被上传，在导入流程中实施三层过滤：

#### 第一层：Sheet 级别过滤

在遍历用户选中的 Sheet 时，首先检查 Sheet 名称，直接跳过发货清单：

```typescript
for (const group of selectedGroups) {
  // 双重检查：确保不处理发货清单
  const lowerSheetName = group.sheetName.toLowerCase();
  if (lowerSheetName.includes('发货') || lowerSheetName.includes('装车')) {
    console.warn(`跳过发货清单Sheet: ${group.sheetName}`);
    continue;
  }
  // ... 继续处理
}
```

#### 第二层：数据行级别过滤

在过滤每个 Sheet 的有效数据时，严格检查每条数据：

```typescript
const validMaterials = group.materials.filter((item) => {
  // 1. 严格检查：必须属于当前Sheet
  if (item.sheetName !== group.sheetName) {
    console.warn(`⚠️ 数据Sheet不匹配: 预期 ${group.sheetName}, 实际 ${item.sheetName}`);
    return false;
  }

  // 2. 基于Sheet名称的额外检查
  const itemSheetName = (item.sheetName || '').toLowerCase();
  if (itemSheetName.includes('发货') || itemSheetName.includes('装车')) {
    console.warn(`⚠️ 排除发货清单数据: ${item.sheetName}`);
    return false;
  }

  // 3. 检查物料类型
  const itemType = item.materialType || materialType;
  const isValid = itemType !== 'SHIPPING_INFO' &&
         !(item as any).imported &&
         !item.hasErrors;

  return isValid;
});
```

#### 第三层：导入数据构造时的最后检查

在构造实际上传的数据时，进行最后一次安全检查：

```typescript
// 构造导入数据 - 最后一次安全检查
const safeMaterialItems = batchMaterials
  .filter((item) => {
    const itemSheetName = (item.sheetName || '').toLowerCase();
    const isSafe = !itemSheetName.includes('发货') && !itemSheetName.includes('装车');
    if (!isSafe) {
      console.error(`🚫 最后检查发现发货清单数据！Sheet: ${item.sheetName}, 物料: ${item.materialName}`);
    }
    return isSafe;
  })
  .map((item) => ({
    ...item,
    materialType: item.materialType || materialType,
    sheetName: group.sheetName
  }));

// 如果过滤后没有数据，跳过此批次
if (safeMaterialItems.length === 0) {
  console.warn(`⚠️ 批次 ${batchIndex + 1} 过滤后无数据，跳过`);
  continue;
}

const importData: MaterialImportBo = {
  projectId: props.projectId,
  batchNumber: `${batchNumber}_${group.sheetName}_${batchIndex + 1}`,
  materialItems: safeMaterialItems
};
```

## 调试日志增强

为了便于问题排查，在关键位置添加了详细的调试日志：

### 1. Sheet 级别日志

```typescript
console.warn(`跳过发货清单Sheet: ${group.sheetName}`);
```

### 2. 数据匹配日志

```typescript
console.warn(`⚠️ 数据Sheet不匹配: 预期 ${group.sheetName}, 实际 ${item.sheetName}`);
console.warn(`⚠️ 排除发货清单数据: ${item.sheetName}`);
```

### 3. 最后检查日志

```typescript
console.error(`🚫 最后检查发现发货清单数据！Sheet: ${item.sheetName}, 物料: ${item.materialName}`);
```

### 4. 导入数据确认日志

```typescript
console.log(`📦 导入数据检查 - Sheet: ${group.sheetName}, 批次: ${batchIndex + 1}, 数量: ${importData.materialItems.length}`);
console.log(`📋 第一条数据预览:`, importData.materialItems[0]);
```

## 修复效果

### 修复前

- ❌ 用户勾选"电控设备汇总"
- ❌ 实际上传包含发货清单数据
- ❌ 后端返回"发货日期不能为空"错误

### 修复后

- ✅ 用户勾选"电控设备汇总"
- ✅ 只上传电控设备数据
- ✅ 发货清单数据在三层过滤中被完全排除
- ✅ 导入成功

## 使用场景验证

### 场景 1：单独导入电控设备

1. 上传包含多个 Sheet 的 Excel 文件（包括电控、机械、发货清单）
2. 在导入配置中只勾选"电控设备汇总"
3. 点击"开始导入"
4. **预期结果**：只导入电控设备数据，控制台显示跳过发货清单

### 场景 2：同时导入多个物料 Sheet

1. 上传包含多个 Sheet 的 Excel 文件
2. 在导入配置中勾选"电控设备汇总"和"机械设备汇总"
3. 点击"开始导入"
4. **预期结果**：只导入选中的物料 Sheet，发货清单被完全过滤

### 场景 3：Excel 中只有发货清单

1. 上传只包含发货清单 Sheet 的 Excel 文件
2. 系统解析后显示"已自动过滤 X 条发货清单"
3. 没有可导入的 Sheet
4. **预期结果**：导入配置弹窗中没有可选 Sheet

## 技术实现细节

### 过滤条件组合

每层过滤都使用了多个条件的组合：

1. **Sheet 名称检查**：`includes('发货')` || `includes('装车')`
2. **Sheet 归属检查**：`item.sheetName === group.sheetName`
3. **物料类型检查**：`itemType !== 'SHIPPING_INFO'`
4. **导入状态检查**：`!imported`
5. **错误状态检查**：`!hasErrors`

### 安全保障

- 使用 `console.warn` 和 `console.error` 标记异常情况
- 在发现问题时立即返回 `false` 停止处理
- 在每个批次上传前再次验证数据
- 如果批次数据全部被过滤，跳过该批次

## 代码位置

**修改文件**：

- `src/views/erp/saltprocess/project/components/MaterialDetail.vue`

**修改方法**：

- `submitDataWithConfig` - 使用配置提交数据（当前使用）
- `submitData` - 直接提交数据（保持一致性）

## 注意事项

1. **控制台日志**：修复后会在控制台看到更多调试信息，这是正常现象
2. **性能影响**：三层过滤会增加少量计算开销，但确保了数据安全性
3. **命名规范**：确保发货清单 Sheet 名称包含"发货"或"装车"关键词
4. **数据一致性**：每条数据的`sheetName`字段必须准确

## 后续优化建议

1. **配置化关键词**：允许配置发货清单的识别关键词
2. **数据标记**：在 Excel 解析时就标记数据类型
3. **白名单机制**：仅允许特定类型的 Sheet 导入
4. **前端预校验**：在用户勾选前就进行数据校验

## 总结

通过三层过滤机制和详细的调试日志，彻底解决了发货清单数据误上传的问题：

✅ **Sheet 级别过滤**：直接跳过发货清单 Sheet
✅ **数据级别过滤**：严格检查每条数据的归属和类型
✅ **上传前过滤**：构造导入数据时最后一次检查
✅ **调试日志**：便于排查问题和验证过滤效果
✅ **用户体验**：只上传用户选中的 Sheet 数据

---

**修复日期**: 2025-01-27  
**修复人员**: AI Assistant  
**影响范围**: 物料清单批量导入功能  
**测试状态**: 待用户验证
