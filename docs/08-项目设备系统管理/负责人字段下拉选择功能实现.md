# 项目设备系统管理 - 负责人字段下拉选择功能实现

## 修改概述

将项目设备系统弹窗组件中的"负责人"字段从输入框改为下拉选择框，并实现本地搜索功能。

**修改文件**: `src/views/erp/saltprocess/equipment-system/components/ProjectEquipmentSystemForm.vue`

**修改日期**: 2024年

## 功能特性

### 1. 下拉选择框
- 使用 Element Plus 的 `el-select` 组件替换原有的输入框
- 支持本地搜索过滤（`filterable`）
- 支持清空选择（`clearable`）
- 显示加载状态（`:loading`）

### 2. 数据源
- **接口地址**: `/dev-api/system/user/simple-list`
- **请求方法**: GET
- **调用时机**: 组件挂载时（`onMounted`）
- **数据类型**: `UserVO[]`

### 3. 自动填充
- 选择负责人后，自动填充"负责人姓名"字段
- 负责人姓名字段变为只读（`disabled`）
- 优先显示昵称（`nickName`），其次显示用户名（`userName`）

### 4. 用户体验
- 下拉选项显示用户昵称或用户名
- 支持输入关键字快速搜索
- 支持清空选择
- 加载时显示 loading 状态

## 技术实现

### 1. 模板修改（第 66-92 行）

**修改前**:
```vue
<el-row :gutter="20">
  <el-col :span="12">
    <el-form-item label="负责人ID" prop="responsiblePersonId">
      <el-input-number v-model="form.responsiblePersonId" :min="0" placeholder="请输入负责人ID" style="width: 100%" />
    </el-form-item>
  </el-col>
  <el-col :span="12">
    <el-form-item label="负责人姓名" prop="responsiblePerson">
      <el-input v-model="form.responsiblePerson" placeholder="请输入负责人姓名" />
    </el-form-item>
  </el-col>
</el-row>
```

**修改后**:
```vue
<el-row :gutter="20">
  <el-col :span="12">
    <el-form-item label="负责人" prop="responsiblePersonId">
      <el-select
        v-model="form.responsiblePersonId"
        placeholder="请选择负责人"
        filterable
        clearable
        style="width: 100%"
        :loading="userListLoading"
        @change="handleResponsiblePersonChange"
      >
        <el-option
          v-for="user in userList"
          :key="user.userId"
          :label="user.nickName || user.userName"
          :value="user.userId"
        />
      </el-select>
    </el-form-item>
  </el-col>
  <el-col :span="12">
    <el-form-item label="负责人姓名" prop="responsiblePerson">
      <el-input v-model="form.responsiblePerson" placeholder="系统自动填充" :disabled="true" />
    </el-form-item>
  </el-col>
</el-row>
```

### 2. 导入依赖（第 118-125 行）

```typescript
import { ref, reactive, onMounted, watch } from 'vue';
import { ElMessage } from 'element-plus';
import type { FormInstance, FormRules } from 'element-plus';
import { getProjectEquipmentSystem, addProjectEquipmentSystem, updateProjectEquipmentSystem } from '@/api/erp/saltprocess/equipment-system';
import type { ProjectEquipmentSystemForm } from '@/api/erp/saltprocess/equipment-system/types';
import { getSimpleUserList } from '@/api/system/user';  // 新增
import type { UserVO } from '@/api/system/user/types';  // 新增
```

### 3. 响应式数据（第 140-144 行）

```typescript
// 响应式数据
const formRef = ref<FormInstance>();
const buttonLoading = ref(false);
const userListLoading = ref(false);  // 新增：用户列表加载状态
const userList = ref<UserVO[]>([]);  // 新增：用户列表数据
```

### 4. 生命周期钩子（第 174-185 行）

```typescript
// 生命周期
onMounted(() => {
  // 获取用户列表
  getUserList();  // 新增：组件挂载时获取用户列表

  if (props.systemId) {
    getSystemDetail();
  } else {
    // 新增模式，生成临时编码提示
    form.systemCode = '系统自动生成';
  }
});
```

### 5. 新增方法

#### 获取用户列表（第 199-216 行）

```typescript
/**
 * 获取用户列表
 * 从系统用户接口获取简化的用户列表，用于负责人下拉选择
 */
const getUserList = async () => {
  userListLoading.value = true;
  try {
    const res = await getSimpleUserList();
    userList.value = res.data || [];
    console.log('获取用户列表成功:', userList.value.length, '个用户');
  } catch (error) {
    console.error('获取用户列表失败:', error);
    ElMessage.error('获取用户列表失败');
    userList.value = [];
  } finally {
    userListLoading.value = false;
  }
};
```

#### 处理负责人变更（第 218-236 行）

```typescript
/**
 * 处理负责人选择变更
 * 当用户选择负责人时，自动填充负责人姓名
 */
const handleResponsiblePersonChange = (userId: string | number | undefined) => {
  if (!userId) {
    // 清空选择
    form.responsiblePerson = '';
    return;
  }

  // 根据选中的userId查找对应的用户信息
  const selectedUser = userList.value.find(user => user.userId === userId);
  if (selectedUser) {
    // 自动填充负责人姓名（优先使用昵称，其次使用用户名）
    form.responsiblePerson = selectedUser.nickName || selectedUser.userName || '';
    console.log('选择负责人:', selectedUser.nickName || selectedUser.userName, '(ID:', userId, ')');
  }
};
```

## 数据流程

1. **组件挂载**: 调用 `getUserList()` 获取用户列表
2. **用户选择**: 用户从下拉框选择负责人
3. **触发变更**: 触发 `handleResponsiblePersonChange` 事件
4. **自动填充**: 根据选中的 `userId` 查找用户信息，自动填充负责人姓名
5. **表单提交**: 提交时包含 `responsiblePersonId` 和 `responsiblePerson` 两个字段

## 类型安全

- 使用 TypeScript 严格类型检查
- `UserVO` 接口定义清晰的用户数据结构
- 所有函数参数和返回值都有明确的类型定义

## 错误处理

- 接口调用失败时显示错误提示
- 失败时将用户列表设置为空数组，避免程序崩溃
- 使用 `try-catch-finally` 确保加载状态正确更新

## 用户体验优化

1. **加载状态**: 显示 loading 动画，告知用户数据正在加载
2. **搜索功能**: 支持输入关键字快速过滤用户
3. **清空功能**: 支持一键清空选择
4. **自动填充**: 选择后自动填充姓名，减少手动输入
5. **只读保护**: 姓名字段只读，防止手动修改导致数据不一致

## 测试验证

### 功能测试
- [x] 下拉框能正常显示人员列表
- [x] 本地搜索功能正常工作
- [x] 选中后自动填充姓名
- [x] 清空选择功能正常
- [x] 加载状态正确显示
- [x] 表单验证规则正常工作
- [x] 数据提交正确

### 边界测试
- [x] 接口调用失败时的错误处理
- [x] 用户列表为空时的显示
- [x] 清空选择时的处理
- [x] 编辑模式下的数据回显

## 代码规范

✅ 遵循 Vue 3 Composition API 规范
✅ 使用 TypeScript 严格类型检查
✅ 添加详细的 JSDoc 注释
✅ 使用 async/await 处理异步操作
✅ 统一的错误处理机制
✅ 清晰的变量命名
✅ 合理的代码结构

## 总结

本次修改成功将负责人字段从输入框改为下拉选择框，提升了用户体验和数据准确性：

1. **用户体验提升**: 下拉选择比手动输入更便捷，支持搜索功能
2. **数据准确性**: 避免手动输入错误，确保负责人信息的一致性
3. **代码质量**: 遵循项目规范，添加完善的注释和错误处理
4. **类型安全**: 使用 TypeScript 确保类型安全
5. **可维护性**: 代码结构清晰，易于后续维护和扩展

