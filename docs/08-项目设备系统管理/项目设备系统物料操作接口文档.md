# 项目设备系统物料操作接口文档

## 概述

**基础路径**: `/erp/saltprocess/projectEquipmentSystem`

**权限前缀**: `erp:saltprocess:projectEquipmentSystem`

**数据层级**: 项目 → 设备系统 → 子系统 → 子项 → **物料**

---

## 1. 获取项目子项下的物料列表

### 接口信息

| 属性 | 值                                             |
| ---- | ---------------------------------------------- |
| 方法 | `GET`                                          |
| 路径 | `/item/{projectItemId}/materials`              |
| 权限 | `erp:saltprocess:projectEquipmentSystem:query` |
| 描述 | 根据项目子项 ID 查询该子项下的所有物料         |

### 路径参数

| 参数名        | 类型 | 必填 | 描述        |
| ------------- | ---- | ---- | ----------- |
| projectItemId | Long | 是   | 项目子项 ID |

### 请求示例

```http
GET /erp/saltprocess/projectEquipmentSystem/item/1001/materials
Authorization: Bearer {token}
```

### 成功响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": [
        {
            "id": 2001,
            "projectItemId": 1001,
            "projectSubsystemId": 501,
            "projectSystemId": 101,
            "projectId": 1,
            "templateId": 3001,
            "materialId": 4001,
            "materialCode": "MAT-001",
            "materialName": "高压阀门",
            "specification": "DN100 PN25",
            "materialType": "阀门",
            "materialCategory": "主材",
            "quantity": 10,
            "unit": "个",
            "unitWeight": 25.5,
            "totalWeight": 255.0,
            "manufacturer": "XXX阀门厂",
            "model": "HV-100",
            "serialNumber": "SN20250101001",
            "packageType": "木箱",
            "packageQuantity": 2,
            "isFragile": false,
            "isHazardous": false,
            "storageRequirement": "干燥通风",
            "status": "NORMAL",
            "sequenceNumber": 1,
            "remarks": "备注信息",
            "remarks1": null,
            "remarks2": null,
            "version": 1,
            "createTime": "2025-01-15T10:30:00",
            "updateTime": "2025-01-15T14:20:00"
        },
        {
            "id": 2002,
            "projectItemId": 1001,
            "materialCode": "MAT-002",
            "materialName": "法兰",
            "specification": "DN100 PN25 RF",
            "quantity": 20,
            "unit": "个",
            "unitWeight": 5.2,
            "totalWeight": 104.0,
            "status": "NORMAL",
            "sequenceNumber": 2
        }
    ]
}
```

### 失败响应

```json
{
    "code": 500,
    "msg": "查询项目物料列表失败：项目子项不存在"
}
```

---

## 2. 编辑项目物料

### 接口信息

| 属性 | 值                                            |
| ---- | --------------------------------------------- |
| 方法 | `PUT`                                         |
| 路径 | `/item/{projectItemId}/materials/{id}`        |
| 权限 | `erp:saltprocess:projectEquipmentSystem:edit` |
| 描述 | 更新指定项目子项下的单个物料信息              |

### 路径参数

| 参数名        | 类型 | 必填 | 描述        |
| ------------- | ---- | ---- | ----------- |
| projectItemId | Long | 是   | 项目子项 ID |
| id            | Long | 是   | 物料 ID     |

### 请求体参数

> **注意**: 项目层级冗余字段（projectSubsystemId, projectSystemId, projectId）由后端自动填充，前端无需传递。

| 参数名             | 类型       | 必填   | 描述                                   |
| ------------------ | ---------- | ------ | -------------------------------------- |
| materialCode       | String     | 否     | 物料编码（最大 50 字符）               |
| materialName       | String     | **是** | 物料名称（最大 200 字符）              |
| specification      | String     | 否     | 规格型号（最大 500 字符）              |
| materialType       | String     | 否     | 物料类型（最大 50 字符）               |
| materialCategory   | String     | 否     | 物料类别（最大 50 字符）               |
| quantity           | Integer    | 否     | 数量（最小 1）                         |
| unit               | String     | 否     | 单位（最大 20 字符）                   |
| unitWeight         | BigDecimal | 否     | 单重(kg)（≥0）                         |
| totalWeight        | BigDecimal | 否     | 总重(kg)（≥0）                         |
| manufacturer       | String     | 否     | 制造商（最大 100 字符）                |
| model              | String     | 否     | 型号（最大 100 字符）                  |
| serialNumber       | String     | 否     | 序列号（最大 100 字符）                |
| packageType        | String     | 否     | 包装方式（最大 50 字符）               |
| packageQuantity    | Integer    | 否     | 包装件数（≥0）                         |
| isFragile          | Boolean    | 否     | 是否易碎                               |
| isHazardous        | Boolean    | 否     | 是否危险品                             |
| storageRequirement | String     | 否     | 存储要求（最大 200 字符）              |
| status             | String     | 否     | 状态（NORMAL/PREPARING/READY/SHIPPED） |
| sequenceNumber     | Integer    | 否     | 排序号（≥0）                           |
| remarks            | String     | 否     | 备注（最大 500 字符）                  |
| remarks1           | String     | 否     | 备注 1（最大 500 字符）                |
| remarks2           | String     | 否     | 备注 2（最大 500 字符）                |

### 请求示例

```http
PUT /erp/saltprocess/projectEquipmentSystem/item/1001/materials/2001
Content-Type: application/json
Authorization: Bearer {token}
```

```json
{
    "materialName": "高压阀门（修改后）",
    "specification": "DN100 PN40",
    "quantity": 15,
    "unit": "个",
    "unitWeight": 28.0,
    "totalWeight": 420.0,
    "manufacturer": "新制造商",
    "status": "PREPARING",
    "remarks": "已更新规格"
}
```

### 成功响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

### 失败响应

**场景 1：项目子项不存在**

```json
{
    "code": 404,
    "msg": "指定的项目子项 ID 不存在。"
}
```

**场景 2：物料不存在**

```json
{
    "code": 404,
    "msg": "指定的物料 ID 不存在。"
}
```

**场景 3：物料不属于指定的项目子项（数据隔离）**

```json
{
    "code": 403,
    "msg": "物料不属于指定的项目子项，操作被拒绝。"
}
```

**场景 4：参数校验失败**

```json
{
    "code": 400,
    "msg": "物料名称不能为空"
}
```

### 关键字段说明

-   **自动填充字段**：后端会根据 path 中的 `projectItemId` 自动填充 `projectSubsystemId`、`projectSystemId`、`projectId` 等冗余字段，前端无需传递这些字段。
-   **必填字段**：`materialName` 是必填字段，其他字段可选。
-   **数值约束**：
    -   `quantity`：最小值为 1
    -   `unitWeight`、`totalWeight`：最小值为 0，最多保留 2 位小数
    -   `packageQuantity`、`sequenceNumber`：最小值为 0
-   **状态取值**：`status` 可选值为 `NORMAL`（正常）、`PREPARING`（准备中）、`READY`（就绪）、`SHIPPED`（已发货）
-   **字符长度限制**：各字段的最大长度见请求体参数表

---

## 3. 删除项目物料

### 接口信息

| 属性 | 值                                              |
| ---- | ----------------------------------------------- |
| 方法 | `DELETE`                                        |
| 路径 | `/item/{projectItemId}/materials/{ids}`         |
| 权限 | `erp:saltprocess:projectEquipmentSystem:remove` |
| 描述 | 删除指定项目子项下的物料记录，支持批量删除      |

### 路径参数

| 参数名        | 类型      | 必填 | 描述                              |
| ------------- | --------- | ---- | --------------------------------- |
| projectItemId | Long      | 是   | 项目子项 ID                       |
| ids           | Long 数组 | 是   | 物料 ID 数组（逗号分隔的多个 ID） |

### 请求示例

```http
DELETE /erp/saltprocess/projectEquipmentSystem/item/1001/materials/2001,2002,2003
Authorization: Bearer {token}
```

### 成功响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

### 失败响应

**场景 1：项目子项不存在**

```json
{
    "code": 404,
    "msg": "指定的项目子项 ID 不存在。"
}
```

**场景 2：物料不存在**

```json
{
    "code": 404,
    "msg": "物料 ID 2001 不存在。"
}
```

**场景 3：物料不属于指定的项目子项（数据隔离）**

```json
{
    "code": 403,
    "msg": "物料 ID 2001 不属于指定的项目子项，操作被拒绝。"
}
```

### 关键字段说明

-   **批量删除**：支持通过 `ids` 参数一次删除多个物料，ID 之间用逗号分隔。
-   **数据隔离**：删除前会验证所有物料是否属于指定的项目子项，确保数据安全。
-   **逻辑删除**：使用逻辑删除，不影响已引用该数据的项目实例。
-   **自动填充**：后端会根据 path 中的 `projectItemId` 自动验证数据归属，前端无需传递额外参数。

---

## 4. 批量保存项目物料（Upsert）

### 接口信息

| 属性 | 值                                                   |
| ---- | ---------------------------------------------------- |
| 方法 | `POST`                                               |
| 路径 | `/item/{projectItemId}/materials/batch`              |
| 权限 | `erp:saltprocess:projectEquipmentSystem:add`         |
| 描述 | 在指定项目子项下批量保存物料，同时支持新增和更新操作 |

### 路径参数

| 参数名        | 类型 | 必填 | 描述        |
| ------------- | ---- | ---- | ----------- |
| projectItemId | Long | 是   | 项目子项 ID |

### 请求体参数

> **注意**：项目层级冗余字段（projectSubsystemId, projectSystemId, projectId）由后端自动填充，前端无需传递。

| 参数名             | 类型       | 必填   | 描述                                            |
| ------------------ | ---------- | ------ | ----------------------------------------------- |
| id                 | Long       | 否     | 物料 ID（新增时为 null 或不传，更新时必须传递） |
| materialCode       | String     | 否     | 物料编码（最大 50 字符）                        |
| materialName       | String     | **是** | 物料名称（最大 200 字符）                       |
| specification      | String     | 否     | 规格型号（最大 500 字符）                       |
| materialType       | String     | 否     | 物料类型（最大 50 字符）                        |
| materialCategory   | String     | 否     | 物料类别（最大 50 字符）                        |
| quantity           | Integer    | 否     | 数量（最小 1）                                  |
| unit               | String     | 否     | 单位（最大 20 字符）                            |
| unitWeight         | BigDecimal | 否     | 单重(kg)（≥0）                                  |
| totalWeight        | BigDecimal | 否     | 总重(kg)（≥0）                                  |
| manufacturer       | String     | 否     | 制造商（最大 100 字符）                         |
| model              | String     | 否     | 型号（最大 100 字符）                           |
| serialNumber       | String     | 否     | 序列号（最大 100 字符）                         |
| packageType        | String     | 否     | 包装方式（最大 50 字符）                        |
| packageQuantity    | Integer    | 否     | 包装件数（≥0）                                  |
| isFragile          | Boolean    | 否     | 是否易碎                                        |
| isHazardous        | Boolean    | 否     | 是否危险品                                      |
| storageRequirement | String     | 否     | 存储要求（最大 200 字符）                       |
| status             | String     | 否     | 状态（NORMAL/PREPARING/READY/SHIPPED）          |
| sequenceNumber     | Integer    | 否     | 排序号（≥0）                                    |
| remarks            | String     | 否     | 备注（最大 500 字符）                           |
| remarks1           | String     | 否     | 备注 1（最大 500 字符）                         |
| remarks2           | String     | 否     | 备注 2（最大 500 字符）                         |

### 请求示例

**混合新增和更新的场景**

```http
POST /erp/saltprocess/projectEquipmentSystem/item/1001/materials/batch
Content-Type: application/json
Authorization: Bearer {token}
```

```json
[
    {
        "materialCode": "MAT-003",
        "materialName": "新增物料-减压阀",
        "specification": "DN50 PN16",
        "materialType": "阀门",
        "materialCategory": "主材",
        "quantity": 5,
        "unit": "个",
        "unitWeight": 12.5,
        "totalWeight": 62.5,
        "manufacturer": "XXX阀门厂",
        "model": "RV-50",
        "status": "NORMAL",
        "sequenceNumber": 3,
        "remarks": "新增的减压阀"
    },
    {
        "id": 2001,
        "materialCode": "MAT-001",
        "materialName": "更新的高压阀门",
        "specification": "DN100 PN40",
        "quantity": 12,
        "unit": "个",
        "unitWeight": 28.0,
        "totalWeight": 336.0,
        "manufacturer": "新制造商",
        "status": "READY",
        "remarks": "已更新规格和状态"
    },
    {
        "id": 2002,
        "materialCode": "MAT-002",
        "materialName": "更新的法兰",
        "specification": "DN100 PN25 RF",
        "quantity": 25,
        "unit": "个",
        "unitWeight": 5.5,
        "totalWeight": 137.5,
        "status": "PREPARING"
    }
]
```

### 成功响应

**全部成功的场景**

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "totalCount": 3,
        "successCount": 3,
        "failureCount": 0,
        "insertCount": 1,
        "updateCount": 2,
        "deleteCount": 0,
        "failures": [],
        "message": "批量操作完成，新增1条，更新2条"
    }
}
```

**部分失败的场景**

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "totalCount": 3,
        "successCount": 2,
        "failureCount": 1,
        "insertCount": 1,
        "updateCount": 1,
        "deleteCount": 0,
        "failures": [
            {
                "rowNumber": 3,
                "recordId": 2002,
                "errorMessage": "物料名称不能为空",
                "errorField": "materialName"
            }
        ],
        "message": "批量操作完成，新增1条，更新1条，失败1条"
    }
}
```

### 失败响应

**场景 1：项目子项不存在**

```json
{
    "code": 404,
    "msg": "指定的项目子项 ID 不存在。"
}
```

**场景 2：物料列表为空**

```json
{
    "code": 400,
    "msg": "物料列表不能为空"
}
```

**场景 3：参数校验失败（必填字段缺失）**

```json
{
    "code": 400,
    "msg": "物料名称不能为空"
}
```

### 关键字段说明

-   **Upsert 操作**：根据 `id` 字段判断操作类型：
    -   `id` 为 `null` 或不传递 → 执行新增操作
    -   `id` 不为 `null` → 执行更新操作（需验证数据归属）
-   **自动填充字段**：后端会根据 path 中的 `projectItemId` 自动填充 `projectSubsystemId`、`projectSystemId`、`projectId` 等冗余字段，前端无需传递这些字段。
-   **事务一致性**：所有操作在同一事务中完成，确保数据一致性。
-   **必填字段**：`materialName` 是必填字段，其他字段可选。
-   **数值约束**：
    -   `quantity`：最小值为 1
    -   `unitWeight`、`totalWeight`：最小值为 0，最多保留 2 位小数
    -   `packageQuantity`、`sequenceNumber`：最小值为 0
-   **状态取值**：`status` 可选值为 `NORMAL`（正常）、`PREPARING`（准备中）、`READY`（就绪）、`SHIPPED`（已发货）
-   **失败详情**：`failures` 数组包含失败记录的详细信息，包括行号、记录 ID、错误信息和错误字段。
-   **操作统计**：返回结果中的 `insertCount` 和 `updateCount` 分别表示新增和更新的成功数量。

---

## 5. 批量编辑项目物料（已废弃）

### 接口信息

| 属性 | 值                                            |
| ---- | --------------------------------------------- |
| 方法 | `PUT`                                         |
| 路径 | `/item/{projectItemId}/materials/batch`       |
| 权限 | `erp:saltprocess:projectEquipmentSystem:edit` |
| 描述 | 在指定项目子项下批量编辑物料（**已废弃**）    |
| 状态 | **@Deprecated**                               |

### ⚠️ 废弃说明

**该接口已废弃，请使用以下接口替代：**

-   **推荐接口**：`POST /item/{projectItemId}/materials/batch`（Upsert 接口）
-   **替代原因**：
    -   新的 Upsert 接口同时支持新增和更新操作，功能更强大
    -   避免接口重复，减少维护成本
    -   统一批量操作的接口设计

### 路径参数

| 参数名        | 类型 | 必填 | 描述        |
| ------------- | ---- | ---- | ----------- |
| projectItemId | Long | 是   | 项目子项 ID |

### 请求体参数

> **注意**：该接口已废弃，请使用 POST `/item/{projectItemId}/materials/batch` 替代。

| 参数名       | 类型      | 必填   | 描述                                      |
| ------------ | --------- | ------ | ----------------------------------------- |
| id           | Long      | **是** | 物料 ID（必须传递，用于标识要更新的物料） |
| materialName | String    | **是** | 物料名称（最大 200 字符）                 |
| 其他字段     | 见第 2 节 | 否     | 其他可选字段同第 2 节编辑接口             |

### 请求示例

```http
PUT /erp/saltprocess/projectEquipmentSystem/item/1001/materials/batch
Content-Type: application/json
Authorization: Bearer {token}
```

```json
[
    {
        "id": 2001,
        "materialName": "更新的高压阀门",
        "specification": "DN100 PN40",
        "quantity": 15,
        "status": "PREPARING"
    },
    {
        "id": 2002,
        "materialName": "更新的法兰",
        "specification": "DN100 PN25 RF",
        "quantity": 20
    }
]
```

### 成功响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "totalCount": 2,
        "successCount": 2,
        "failureCount": 0,
        "updateCount": 2,
        "failures": [],
        "message": "批量操作完成，成功2条"
    }
}
```

### 失败响应

**场景 1：项目子项不存在**

```json
{
    "code": 404,
    "msg": "指定的项目子项 ID 不存在。"
}
```

**场景 2：物料列表为空**

```json
{
    "code": 400,
    "msg": "物料列表不能为空"
}
```

### 关键字段说明

-   **已废弃**：该接口不再推荐使用，所有新的批量操作请使用 POST `/item/{projectItemId}/materials/batch` 接口。
-   **兼容性**：该接口仍然可用，但不会获得新功能更新。
-   **迁移建议**：
    -   如果只需要更新操作，可直接使用 POST Upsert 接口，传递 `id` 字段即可
    -   如果需要混合新增和更新，POST Upsert 接口更加便捷

---

## 附录：状态枚举说明

| 状态值    | 中文名称 | 描述                       |
| --------- | -------- | -------------------------- |
| NORMAL    | 正常     | 物料处于正常状态，可以使用 |
| PREPARING | 准备中   | 物料正在准备中，尚未就绪   |
| READY     | 就绪     | 物料已就绪，可以发货       |
| SHIPPED   | 已发货   | 物料已发货                 |

## 附录：权限标识说明

| 权限标识                                        | 操作          | 描述                       |
| ----------------------------------------------- | ------------- | -------------------------- |
| `erp:saltprocess:projectEquipmentSystem:query`  | 查询          | 查询项目物料列表和详情     |
| `erp:saltprocess:projectEquipmentSystem:add`    | 新增/批量保存 | 新增单个物料或批量保存物料 |
| `erp:saltprocess:projectEquipmentSystem:edit`   | 编辑          | 编辑单个物料或批量编辑物料 |
| `erp:saltprocess:projectEquipmentSystem:remove` | 删除          | 删除单个或多个物料         |
