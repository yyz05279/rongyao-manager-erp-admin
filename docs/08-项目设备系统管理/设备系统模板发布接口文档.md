# 设备系统模板发布接口文档

## 文档信息

-   **模块名称**: 设备系统模板管理
-   **接口名称**: 发布设备系统模板
-   **版本**: v1.0
-   **更新日期**: 2025-11-24
-   **作者**: haitang

---

## 目录

1. [接口概述](#接口概述)
2. [接口详情](#接口详情)
3. [业务规则](#业务规则)
4. [错误处理](#错误处理)
5. [使用示例](#使用示例)
6. [架构设计](#架构设计)

---

## 接口概述

### 功能描述

发布设备系统模板接口用于将草稿状态的模板发布为正式可用状态。发布后的模板可以被项目引用和使用。

### 核心功能

1. **状态转换**: 将模板状态从 `DRAFT`（草稿）更新为 `ACTIVE`（启用）
2. **完整性验证**: 确保模板包含必要的信息和至少一个子系统
3. **权限控制**: 只有具有发布权限的用户才能执行此操作
4. **审计日志**: 记录发布操作的详细信息

---

## 接口详情

### 基本信息

-   **接口路径**: `/erp/saltprocess/equipmentSystemTemplate/{id}/publish`
-   **请求方式**: `POST`
-   **权限标识**: `erp:saltprocess:equipmentSystemTemplate:publish`
-   **是否幂等**: 是（使用 `@RepeatSubmit` 注解防止重复提交）

### 请求参数

#### 路径参数

| 参数名 | 类型 | 必填 | 说明            |
| ------ | ---- | ---- | --------------- |
| id     | Long | 是   | 设备系统模板 ID |

#### 请求示例

```http
POST /erp/saltprocess/equipmentSystemTemplate/123/publish
Content-Type: application/json
Authorization: Bearer {token}
```

### 响应结果

#### 成功响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

#### 失败响应

**模板不存在**

```json
{
    "code": 500,
    "msg": "设备系统模板不存在"
}
```

**状态不允许发布**

```json
{
    "code": 500,
    "msg": "只有草稿状态的模板才能发布，当前状态：ACTIVE"
}
```

**模板不完整**

```json
{
    "code": 500,
    "msg": "模板至少需要包含一个子系统才能发布"
}
```

**权限不足**

```json
{
    "code": 403,
    "msg": "无权限访问"
}
```

---

## 业务规则

### 1. 状态流转规则

```
DRAFT (草稿) --[发布]--> ACTIVE (启用)
ACTIVE (启用) --[归档]--> ARCHIVED (归档)
```

**发布条件**:

-   当前状态必须为 `DRAFT`
-   已启用或已归档的模板不能再次发布

### 2. 完整性验证规则

发布前会验证以下内容：

| 验证项     | 规则                | 错误提示                             |
| ---------- | ------------------- | ------------------------------------ |
| 模板编码   | 不能为空            | "模板编码不能为空"                   |
| 模板名称   | 不能为空            | "模板名称不能为空"                   |
| 系统类型   | 不能为空            | "系统类型不能为空"                   |
| 子系统数量 | 至少包含 1 个子系统 | "模板至少需要包含一个子系统才能发布" |

### 3. 权限要求

-   用户必须具有 `erp:saltprocess:equipmentSystemTemplate:publish` 权限
-   系统会记录发布操作的审计日志

### 4. 事务保证

-   使用 `@Transactional` 注解确保操作的原子性
-   发布失败时自动回滚，不会产生脏数据

---

## 错误处理

### 错误码说明

| 错误码 | 说明     | 处理建议               |
| ------ | -------- | ---------------------- |
| 200    | 操作成功 | -                      |
| 403    | 权限不足 | 联系管理员分配发布权限 |
| 500    | 业务异常 | 根据具体错误信息处理   |

### 常见错误场景

#### 场景 1: 模板不存在

**原因**: 传入的模板 ID 在数据库中不存在  
**解决**: 检查模板 ID 是否正确

#### 场景 2: 状态不允许发布

**原因**: 模板当前状态不是草稿  
**解决**: 只有草稿状态的模板才能发布

#### 场景 3: 模板不完整

**原因**: 模板缺少必要信息或子系统  
**解决**: 完善模板信息后再发布

---

## 使用示例

### 前端调用示例 (TypeScript)

```typescript
import request from "@/utils/request";

/**
 * 发布设备系统模板
 * @param id 模板ID
 * @returns 发布结果
 */
export const publishTemplate = (id: number): Promise<void> => {
    return request({
        url: `/erp/saltprocess/equipmentSystemTemplate/${id}/publish`,
        method: "post",
    });
};

// 使用示例
const handlePublish = async (templateId: number) => {
    try {
        await publishTemplate(templateId);
        ElMessage.success("模板发布成功");
        // 刷新列表
        await loadTemplateList();
    } catch (error) {
        ElMessage.error("模板发布失败");
    }
};
```

### 后端测试示例 (JUnit)

```java
@SpringBootTest
@Transactional
@Rollback
class ErpSaltEquipmentSystemTemplateServiceTest {

    @Autowired
    private IErpSaltEquipmentSystemTemplateService templateService;

    @Test
    @DisplayName("测试发布设备系统模板")
    void testPublishTemplate() {
        // Given: 创建一个草稿状态的模板
        ErpSaltEquipmentSystemTemplateBo bo = new ErpSaltEquipmentSystemTemplateBo();
        bo.setTemplateName("测试模板");
        bo.setSystemType("SOLID");
        bo.setStatus("DRAFT");
        // ... 设置其他必要字段和子系统

        Boolean createResult = templateService.insertByBo(bo);
        assertTrue(createResult);

        // When: 发布模板
        Long templateId = 1L; // 假设创建后的ID
        Boolean publishResult = templateService.publishTemplate(templateId);

        // Then: 验证发布结果
        assertTrue(publishResult);

        // 验证状态已更新
        ErpSaltEquipmentSystemTemplateVo vo = templateService.queryById(templateId);
        assertEquals("ACTIVE", vo.getStatus());
    }

    @Test
    @DisplayName("测试发布已启用的模板应该失败")
    void testPublishActiveTemplateShouldFail() {
        // Given: 一个已启用的模板
        Long templateId = 1L;

        // When & Then: 尝试发布应该抛出异常
        assertThrows(ServiceException.class, () -> {
            templateService.publishTemplate(templateId);
        });
    }
}
```

---

## 架构设计

### 三层架构实现

```
Controller层 (表现层)
├── ErpSaltEquipmentSystemTemplateController
├── 职责：接收HTTP请求，参数验证，返回响应
├── 注解：@RestController, @SaCheckPermission, @Log
└── 方法：publish(@PathVariable Long id)

Service层 (业务逻辑层)
├── IErpSaltEquipmentSystemTemplateService (接口)
├── ErpSaltEquipmentSystemTemplateServiceImpl (实现)
├── 职责：业务逻辑处理，状态验证，完整性检查
├── 注解：@Service, @Transactional
└── 方法：publishTemplate(Long id)

Mapper层 (数据访问层)
├── ErpSaltEquipmentSystemTemplateMapper
├── 职责：数据库操作，Entity映射
└── 方法：selectById(), updateById()
```

### 数据流转换

```
前端请求 (HTTP POST)
    ↓ Controller接收
路径参数 (Long id)
    ↓ Service业务处理
1. 查询模板Entity
2. 验证状态和完整性
3. 更新状态为ACTIVE
    ↓ Mapper数据库操作
数据库记录更新
    ↓ 返回操作结果
Boolean (成功/失败)
    ↓ Controller.toAjax()
R<Void> (统一响应对象)
    ↓ 前端响应 (JSON)
```

### 核心类说明

#### 1. TemplateStatus 枚举类

```java
@Getter
@AllArgsConstructor
public enum TemplateStatus {
    DRAFT("DRAFT", "草稿"),
    ACTIVE("ACTIVE", "启用"),
    ARCHIVED("ARCHIVED", "归档");

    private final String code;
    private final String name;

    // 检查是否可以发布
    public static boolean canPublish(String code) {
        return DRAFT.getCode().equals(code);
    }
}
```

#### 2. Service 实现关键代码

```java
@Override
@Transactional(rollbackFor = Exception.class)
public Boolean publishTemplate(Long id) {
    // 1. 验证模板是否存在
    ErpSaltEquipmentSystemTemplate template = baseMapper.selectById(id);
    if (template == null) {
        throw new ServiceException("设备系统模板不存在");
    }

    // 2. 验证当前状态是否允许发布
    if (!TemplateStatus.canPublish(template.getStatus())) {
        throw new ServiceException("只有草稿状态的模板才能发布");
    }

    // 3. 验证模板完整性
    validateTemplateCompleteness(id, template);

    // 4. 更新模板状态为ACTIVE
    ErpSaltEquipmentSystemTemplate updateEntity = new ErpSaltEquipmentSystemTemplate();
    updateEntity.setId(id);
    updateEntity.setStatus(TemplateStatus.ACTIVE.getCode());

    return baseMapper.updateById(updateEntity) > 0;
}
```

### 设计原则遵循

1. ✅ **单一职责原则**: Controller 只负责接收请求，Service 处理业务逻辑
2. ✅ **开闭原则**: 通过枚举类扩展状态，不修改现有代码
3. ✅ **依赖倒置原则**: Controller 依赖 Service 接口，不依赖具体实现
4. ✅ **事务管理**: 使用@Transactional 确保数据一致性
5. ✅ **异常处理**: 统一使用 ServiceException 处理业务异常
6. ✅ **日志记录**: 详细记录操作过程和结果

---

## 附录

### A. 相关接口

| 接口         | 路径                                                       | 说明         |
| ------------ | ---------------------------------------------------------- | ------------ |
| 查询模板详情 | GET /erp/saltprocess/equipmentSystemTemplate/{id}          | 查看模板信息 |
| 创建模板     | POST /erp/saltprocess/equipmentSystemTemplate              | 创建草稿模板 |
| 编辑模板     | PUT /erp/saltprocess/equipmentSystemTemplate               | 编辑草稿模板 |
| 发布模板     | POST /erp/saltprocess/equipmentSystemTemplate/{id}/publish | 发布草稿模板 |
| 删除模板     | DELETE /erp/saltprocess/equipmentSystemTemplate/{ids}      | 删除模板     |

### B. 状态枚举说明

| 状态值   | 说明 | 允许的操作       |
| -------- | ---- | ---------------- |
| DRAFT    | 草稿 | 编辑、发布、删除 |
| ACTIVE   | 启用 | 查看、归档       |
| ARCHIVED | 归档 | 查看             |

### C. 权限配置

在系统权限管理中需要配置以下权限：

```sql
INSERT INTO sys_menu (menu_name, parent_id, order_num, path, component, is_frame, is_cache, menu_type, visible, status, perms, icon, create_by, create_time, update_by, update_time, remark)
VALUES ('发布设备系统模板', [父菜单ID], 5, '', '', 1, 0, 'F', '1', '0', 'erp:saltprocess:equipmentSystemTemplate:publish', '#', 'admin', NOW(), '', NULL, '');
```

---

**文档版本**: v1.0
**制定时间**: 2025-11-24
**适用项目**: 海棠 ERP 系统
**维护团队**: 海棠开发团队

本文档遵循海棠 ERP 系统编码规范，实现了完整的三层架构设计和 RESTful API 标准。
