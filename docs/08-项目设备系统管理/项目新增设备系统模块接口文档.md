# 新增项目设备系统接口（批量从模板创建）实施计划

## 接口流程与选型

- 项目列表：复用 `GET /erp/project/list`（haitang-modules/haitang-erp/src/main/java/com/haitang/erp/controller/project/ErpProjectController.java:49）
- 模板列表：复用 `GET /erp/saltprocess/equipmentSystemTemplate/list` 与 `GET /erp/saltprocess/equipmentSystemTemplate/standard`（haitang-modules/haitang-erp/src/main/java/com/haitang/erp/controller/saltprocess/ErpSaltEquipmentSystemTemplateController.java:69, 138）
- 新增项目设备系统（批量）：新增端点 `POST /erp/saltprocess/projectEquipmentSystem/create-from-templates `
  - 入参：`{"projectId": String, "templateIds": String[]}`
  - 出参：`{"createdSystemIds": String[]}`（或携带系统 Code 与名称）

## 控制器改造

- 位置：`ErpSaltProjectEquipmentSystemController`（haitang-modules/haitang-erp/src/main/java/com/haitang/erp/controller/saltprocess/ErpSaltProjectEquipmentSystemController.java`）
- 在 `@RequestMapping("/erp/saltprocess/projectEquipmentSystem")` 下新增方法：
  - `@PostMapping("/create-from-templates")`
  - 权限：`@SaCheckPermission("erp:saltprocess:projectEquipmentSystem:add")`
  - 幂等：`@RepeatSubmit()`
  - 日志：`@Log(title = "项目设备系统", businessType = BusinessType.INSERT)`
  - 调用服务：`erpSaltProjectEquipmentSystemService.createBatchFromTemplates(projectId, templateIds)`

## Service 实现（核心）

- 目标类：`ErpSaltProjectEquipmentSystemServiceImpl`（haitang-modules/haitang-erp/src/main/java/com/haitang/erp/service/saltprocess/impl/ErpSaltProjectEquipmentSystemServiceImpl.java:171）
- 新增/完善方法：
  1. `@Transactional(rollbackFor = Exception.class) public List<Long> createBatchFromTemplates(Long projectId, Collection<Long> templateIds)`：循环调用 `createFromTemplate(projectId, templateId)`，收集返回的系统 ID；分模板事务隔离，避免超长事务。
  2. `@Transactional(rollbackFor = Exception.class) public Boolean createFromTemplate(Long projectId, Long templateId)`：实现从设备系统模板深度复制到项目设备系统的逻辑（当前为 TODO，haitang-modules/.../ErpSaltProjectEquipmentSystemServiceImpl.java:171）。
- 依赖与查询：
  - 校验项目存在：`ErpProjectController` 或盐化项目 `ErpSaltProjectMapper`（haitang-modules/haitang-erp/src/main/java/com/haitang/erp/mapper/saltprocess/ErpSaltProjectMapper.java:18）
  - 查询设备系统模板：`IErpSaltEquipmentSystemTemplateService.queryById`（ErpSaltEquipmentSystemTemplateController.java:90）
  - 查询子系统模板：`ErpSaltSubsystemTemplateMapper.selectBySystemTemplateId`（haitang-modules/.../ErpSaltSubsystemTemplateMapper.java:34）
  - 查询子项模板：`ErpSaltItemTemplateMapper.selectBySubsystemTemplateId`（haitang-modules/.../ErpSaltItemTemplateMapper.java:34）
  - 查询物料模板：`ErpSaltMaterialTemplateMapper.selectByItemTemplateId`（haitang-modules/.../ErpSaltMaterialTemplateMapper.java:34）

## 深度复制与快照隔离

- 原则：遵循 `/document/技术文档/快照隔离机制设计文档.md` 的四步（清空 ID / 生成新编码 / 保存追溯字段 / 递归复制）
- 复制层级：设备系统 → 子系统 → 子项 → 物料（完整深度）
- 字段策略：
  - 追溯模板：`templateId` 记录来源但不建立外键
  - 编码生成：`systemCode`、`subsystemCode`、`itemCode`、`materialCode` 使用 `IdUtil.nanoId()` 前缀（如 `SYS-...`、`SUB-...`、`ITEM-...`、`MAT-...`），或与项目码拼接时间戳（参考文档示例）
  - 复制字段：名称、类型、规格型号、描述、排序、是否必需、数量、单位、物料 ID 等按模板映射
- 批量优化：
  - 一次性批量查询子系统/子项/物料，构建 Map 映射（O(1)）
  - 批量插入 `ErpSaltProjectSubsystem`、`ErpSaltProjectItem`、`ErpSaltProjectMaterial`
- 统计更新：完成复制后，更新 `ErpSaltProjectEquipmentSystem.totalItems`、`totalMaterials`、`subsystemCount`（haitang-modules/.../ErpSaltProjectEquipmentSystem.java:77, 82, 87）

## 复制伪代码（关键步骤）

```java
@Transactional(rollbackFor = Exception.class)
public Boolean createFromTemplate(Long projectId, Long templateId) {
    // 1. 校验项目存在
    // 2. 查询设备系统模板 + 批量查询其子系统模板
    // 3. 创建项目设备系统(清空ID, 生成systemCode, 记录templateId, 设置status=DRAFT)
    // 4. 对每个子系统模板：创建项目子系统(生成subsystemCode, 记录templateId)
    //    4.1 批量查询子项模板 → 创建项目子项(生成itemCode, 记录templateId)
    //         4.1.1 批量查询物料模板 → 创建项目物料(复制materialId, 数量, 单位, 类型等)
    // 5. 批量插入各层数据；汇总并更新统计字段；返回true
}
```

## Mapper 与批量方法

- 使用现有 Mapper：
  - 项目系统：`ErpSaltProjectEquipmentSystemMapper`（haitang-modules/.../ErpSaltProjectEquipmentSystemMapper.java:18）
  - 项目子系统：`ErpSaltProjectSubsystemMapper`（haitang-modules/.../ErpSaltProjectSubsystemMapper.java:18）
  - 项目子项：`ErpSaltProjectItemMapper`（haitang-modules/.../ErpSaltProjectItemMapper.java:18）
  - 项目物料：`ErpSaltProjectMaterialMapper`（haitang-modules/.../ErpSaltProjectMaterialMapper.java:18）
- 若无批量插入 XML，采用循环插入 + 分批策略（每批 500-1000）避免超长 SQL；后续可补充 XML `insertBatch`（参考快照文档的批量示例）

## 事务与错误处理

- 服务层方法统一添加 `@Transactional(rollbackFor = Exception.class)`，确保任一层失败全量回滚
- 错误分类：
  - 参数错误：项目不存在、模板不存在、模板已归档不可用 → `ServiceException`
  - 数据库错误：插入/更新失败 → `ServiceException` + 记录错误日志
- 日志：
  - 关键节点 `info`：开始复制、各层数据量、完成统计
  - 异常 `error`：携带 `projectId`、`templateId`、层级与数量信息

## 单元测试与隔离性测试

- 测试框架：Junit5 + SpringBootTest + 事务回滚
- 用例设计：
  1. 单模板复制：验证创建 1 个项目设备系统，子系统/子项/物料数量与模板一致；编码均不同；`templateId` 正确追溯
  2. 多模板批量复制：模板 A/B 并行创建，互不影响；统计字段正确
  3. 隔离性：修改模板后，已创建项目数据不受影响；删除模板不影响项目数据
  4. 失败回滚：在子项插入阶段抛异常，验证无任何层级残留数据
- 覆盖率：目标 70%+ 覆盖 `createFromTemplate` 主路径与异常路径

## 兼容性与扩展

- 兼容已有 CRUD（控制器已存在增删改查，ErpSaltProjectEquipmentSystemController.java:59, 73, 83）
- 如需导出：沿用 `exportSystem`（ErpSaltProjectEquipmentSystemServiceImpl.java:178）
- 后续可加：`GET /erp/saltprocess/projectEquipmentSystem/by-project/{projectId}` 快速查看项目下设备系统（已有 Mapper 支持，ErpSaltProjectEquipmentSystemMapper.java:34）

## 验证与交付

- 本地联调：
  - 流程：`GET /erp/project/list` → 勾选项目 → `GET /erp/saltprocess/equipmentSystemTemplate/list` → 勾选模板 → `POST /erp/saltprocess/projectEquipmentSystem/create-from-templates`
- 数据核对：统计字段、编码唯一性、`templateId` 追溯字段
- 文档：在 API 文档补充新端点说明与请求响应示例（不修改现有文档文件，按需补充说明）

## 接口文档：批量从模板创建项目设备系统

- 基本信息

  - 路径：`POST /erp/saltprocess/projectEquipmentSystem/create-from-templates`
  - 权限：`erp:saltprocess:projectEquipmentSystem:add`
  - 幂等：支持（前端按 `RepeatSubmit`约束，后端按项目+模板集防重复创建）
  - 响应包装：`R<List<String>>`
- 请求体（JSON）

  - 字段：
    - `projectId`：Long（可选，与 `projectCode`二选一，优先使用）
    - `projectCode`：String（可选，标识项目编码，当 `projectId`缺省时使用）
    - `templateIds`：Array`<Long>`（必填，设备系统模板ID集合）
  - 约束：
    - `projectId`与 `projectCode`必须至少提供一个
    - `templateIds`非空，长度建议≤100，过长将分批处理
  - 示例：

```json
{
  "projectId": 123456,
  "templateIds": [1001, 1002, 1005]
}
```

- 响应体（JSON）
  - 成功返回：HTTP 200

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    "SYS-6YbK8qvJpT",
    "SYS-3aNw2LmQfX",
    "SYS-Xp9Zr1UdMe"
  ]
}
```

    -   返回值说明：`data`为已创建的项目设备系统标识列表（系统编码或ID，以实际实现为准）；数量与 `templateIds`一致
    -   失败返回：
        -   400 `参数错误`：项目不存在/模板不存在/模板不可用
        -   403 `权限不足`：缺少 `erp:saltprocess:projectEquipmentSystem:add`
        -   500 `服务器错误`：数据库插入/统计更新失败

- 错误示例

```json
{
  "code": 400,
  "msg": "模板不存在: 1002",
  "data": null
}
```

- 业务规则与处理

  - 复制层级：系统→子系统→子项→物料，完整深度复制
  - 追溯字段：记录来源模板 `templateId`，不建立外键
  - 编码生成：`systemCode/subsystemCode/itemCode/materialCode`采用随机前缀策略确保唯一
  - 统计更新：完成后更新 `subsystemCount/totalItems/totalMaterials`
  - 事务：每个模板独立事务，任一失败不影响其他模板创建
- 调用示例

```bash
curl -X POST \
  'http://<host>/erp/saltprocess/projectEquipmentSystem/create-from-templates' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer <token>' \
  -d '{
        "projectId": 123456,
        "templateIds": [1001,1002,1005]
      }'
```

- 关联端点
  - 项目列表：`GET /erp/project/list`
  - 模板列表：`GET /erp/saltprocess/equipmentSystemTemplate/list`
  - 模板标准：`GET /erp/saltprocess/equipmentSystemTemplate/standard`
