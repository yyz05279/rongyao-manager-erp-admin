# 物料选择功能实现说明

## 概述

本文档说明了在 `ProjectSubsystemDetail.vue` 组件中实现物料选择功能的完整过程。通过集成 `MaterialSelectorDialog` 组件，用户可以从物料库中选择物料并添加到子项中。

## 实现内容

### 1. 导入必要的组件和类型

```typescript
import type { MaterialVO } from '@/api/erp/material/material/types';
import MaterialSelectorDialog from '@/views/erp/subsystem/template/components/MaterialSelectorDialog.vue';
```

### 2. 新增响应式数据

```typescript
// 物料选择器
const materialSelectorVisible = ref(false);

// 计算已添加的物料编码列表（用于物料选择器中的已添加标记）
const existingMaterialCodes = computed<string[]>(() => {
  return materialList.value
    .map(material => material.materialCode)
    .filter((code): code is string => Boolean(code));
});
```

### 3. 修改 handleAddMaterialInDialog 方法

**原实现：** 直接打开物料表单对话框

```typescript
const handleAddMaterialInDialog = () => {
  resetMaterialForm();
  materialDialog.title = '添加物料';
  materialDialog.visible = true;
};
```

**新实现：** 打开物料选择对话框

```typescript
const handleAddMaterialInDialog = () => {
  materialSelectorVisible.value = true;
};
```

### 4. 新增 handleMaterialsSelected 方法

处理用户从物料选择器中选中的物料：

```typescript
const handleMaterialsSelected = async (materials: MaterialVO[]) => {
  // 1. 验证是否选择了子项
  if (!selectedItemId.value) {
    ElMessage.error('未选择子项');
    return;
  }

  try {
    // 2. 将选中的物料转换为物料表单数据
    const materialsToCreate: ProjectMaterialForm[] = materials.map(material => ({
      materialCode: material.materialCode || '',
      materialName: material.materialName || '',
      specification: material.specification || '',
      materialType: material.materialType || '',
      materialCategory: material.materialType || '',
      quantity: 1,
      unit: material.unit || '',
      unitWeight: 0,
      totalWeight: 0,
      manufacturer: '',
      model: material.model || '',
      status: 'NORMAL',
      sequenceNumber: 0,
      remarks: material.remarks || ''
    }));

    // 3. 调用API批量保存物料
    await batchSaveProjectMaterials(selectedItemId.value, materialsToCreate);
    ElMessage.success(`成功添加 ${materials.length} 个物料`);

    // 4. 刷新物料列表
    await loadMaterialList();
  } catch (error) {
    console.error('添加物料失败:', error);
    ElMessage.error('添加物料失败');
  }
};
```

### 5. 在模板中添加 MaterialSelectorDialog 组件

```vue
<!-- 物料选择器对话框 -->
<MaterialSelectorDialog
  v-model="materialSelectorVisible"
  :existing-material-codes="existingMaterialCodes"
  @confirm="handleMaterialsSelected"
/>
```

## 工作流程

### 用户操作流程

1. **打开物料详情对话框**
   - 在子项列表中点击"查看物料"按钮
   - 显示该子项下的所有物料

2. **点击"添加物料"按钮**
   - 打开物料选择对话框
   - 显示所有可用的物料列表

3. **在物料选择器中搜索和选择物料**
   - 可以按物料名称或编码搜索
   - 已添加的物料显示为"已添加"状态，不可选择
   - 用户可以多选物料

4. **确认选择**
   - 点击"确定添加"按钮
   - 系统调用 `batchSaveProjectMaterials` API 批量保存物料
   - 物料列表自动刷新

### 数据流转

```
MaterialSelectorDialog (选择器)
    ↓ (emit confirm 事件)
handleMaterialsSelected (处理选中的物料)
    ↓ (转换数据格式)
ProjectMaterialForm[] (物料表单数据数组)
    ↓ (调用 API)
batchSaveProjectMaterials (批量保存)
    ↓ (API 响应)
loadMaterialList (刷新物料列表)
```

## MaterialSelectorDialog 组件说明

### Props

| 属性名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| modelValue | boolean | 是 | 对话框是否显示 |
| existingMaterialCodes | string[] | 否 | 已添加的物料编码列表 |
| existingMaterialIds | number[] | 否 | 已添加的物料ID列表 |

### Events

| 事件名 | 参数 | 说明 |
|--------|------|------|
| update:modelValue | boolean | 对话框显示/隐藏状态变化 |
| confirm | MaterialVO[] | 用户确认选择，传递选中的物料列表 |

### 功能特性

- ✅ 搜索功能：按物料名称或编码搜索
- ✅ 分页功能：支持分页查看物料列表
- ✅ 状态标记：已添加的物料显示"已添加"标签
- ✅ 多选功能：支持多选物料
- ✅ 跨分页选择：切换分页时保持选中状态
- ✅ 重复检查：自动过滤已添加的物料

## 数据映射关系

从 MaterialVO 到 ProjectMaterialForm 的字段映射：

| MaterialVO | ProjectMaterialForm | 说明 |
|------------|-------------------|------|
| materialCode | materialCode | 物料编码 |
| materialName | materialName | 物料名称 |
| specification | specification | 规格型号 |
| materialType | materialType/materialCategory | 物料类型 |
| unit | unit | 单位 |
| model | model | 型号 |
| remarks | remarks | 备注 |
| - | quantity | 默认数量（设为1） |
| - | unitWeight | 单重（设为0） |
| - | totalWeight | 总重（设为0） |
| - | manufacturer | 制造商（设为空） |
| - | status | 状态（设为NORMAL） |
| - | sequenceNumber | 排序号（设为0） |

## 关键特性

1. **智能去重**
   - 通过 `existingMaterialCodes` 计算属性自动获取已添加物料编码
   - MaterialSelectorDialog 自动标记已添加物料为不可选状态

2. **批量操作**
   - 支持一次选择多个物料
   - 调用 `batchSaveProjectMaterials` API 批量保存

3. **用户友好**
   - 清晰的物料选择流程
   - 实时反馈操作结果
   - 自动刷新列表

4. **类型安全**
   - 完整的 TypeScript 类型定义
   - 编译时类型检查

## 测试建议

1. **基本功能测试**
   - 打开物料详情对话框
   - 点击"添加物料"按钮
   - 验证物料选择器是否打开

2. **搜索功能测试**
   - 按物料名称搜索
   - 按物料编码搜索
   - 验证搜索结果

3. **选择功能测试**
   - 选择单个物料
   - 选择多个物料
   - 验证已添加物料不可选

4. **分页测试**
   - 在不同分页间切换
   - 验证跨分页选择状态保持

5. **添加功能测试**
   - 确认选择后物料是否正确添加
   - 验证物料列表是否自动刷新
   - 验证物料信息是否正确映射

## 后续改进

1. 可以添加物料快速编辑功能
2. 可以支持物料的批量编辑
3. 可以添加物料的导入功能
4. 可以添加物料的模板预设功能

## 文件变更

### 修改的文件

`/src/views/erp/saltprocess/equipment-system/components/ProjectSubsystemDetail.vue`

**变更内容：**
- 新增导入 MaterialVO 类型
- 新增导入 MaterialSelectorDialog 组件
- 新增 materialSelectorVisible 响应式数据
- 新增 existingMaterialCodes 计算属性
- 修改 handleAddMaterialInDialog 方法
- 新增 handleMaterialsSelected 方法
- 在模板中添加 MaterialSelectorDialog 组件

## 总结

通过本次实现，ProjectSubsystemDetail 组件现已具备完整的物料选择功能。用户可以方便地从物料库中选择物料并添加到子项中，提高了操作效率和用户体验。

