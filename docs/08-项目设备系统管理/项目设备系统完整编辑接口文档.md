# 项目设备系统完整编辑接口文档

## 一、接口概述

### 1.1 接口信息

- **接口名称**：完整编辑项目设备系统（支持级联更新子系统）
- **接口路径**：`PUT /erp/saltprocess/projectEquipmentSystem/full`
- **HTTP方法**：PUT
- **权限标识**：`erp:saltprocess:projectEquipmentSystem:edit`
- **开发时间**：2025-01-01

### 1.2 功能说明

本接口参考"编辑设备系统模板"接口（`PUT /erp/saltprocess/equipmentSystemTemplate`）的完整实现，支持项目设备系统的级联更新操作。

**核心功能**：
1. ✅ 更新项目设备系统基本信息
2. ✅ 级联删除旧的子系统、子项、物料
3. ✅ 级联创建新的子系统、子项、物料
4. ✅ 自动更新统计信息（子系统数、子项数、物料数）
5. ✅ 保持项目数据隔离（不允许修改其他项目的数据）

### 1.3 与基本编辑接口的区别

| 特性 | 基本编辑接口 | 完整编辑接口 |
|------|------------|------------|
| **路径** | `PUT /erp/saltprocess/projectEquipmentSystem` | `PUT /erp/saltprocess/projectEquipmentSystem/full` |
| **功能** | 只更新基本信息 | 支持级联更新子系统 |
| **子系统** | ❌ 不处理 | ✅ 级联更新 |
| **子项** | ❌ 不处理 | ✅ 级联更新 |
| **物料** | ❌ 不处理 | ✅ 级联更新 |
| **统计信息** | ❌ 不自动更新 | ✅ 自动更新 |
| **使用场景** | 快速更新基本字段 | 完整重构设备系统 |

## 二、请求参数

### 2.1 请求体（JSON）

```json
{
  "id": 1,                          // 必填：项目设备系统ID
  "projectId": 100,                 // 必填：化盐项目ID
  "projectName": "淮安项目",         // 可选：项目名称（冗余）
  "templateId": 10,                 // 可选：设备系统模板ID
  "systemCode": "SYS-001",          // 必填：系统编码
  "systemName": "固态处理厂",        // 必填：系统名称
  "systemType": "SOLID",            // 可选：系统类型
  "category": "处理厂",              // 可选：分类
  "description": "固态处理厂描述",   // 可选：描述
  "responsiblePersonId": 200,       // 可选：负责人ID
  "responsiblePerson": "张三",       // 可选：负责人姓名
  "status": "DRAFT",                // 可选：状态
  "priority": 1,                    // 可选：优先级
  "sequenceNumber": 1,              // 可选：排序号
  "remarks": "备注信息",             // 可选：备注
  "version": 0,                     // 可选：版本号（乐观锁）
  "subsystems": [                   // 必填：项目子系统列表（至少1个）
    {
      "projectSystemId": 1,         // 必填：项目设备系统ID
      "projectId": 100,             // 必填：项目ID
      "templateId": 20,             // 可选：子系统模板ID（引用模板时填写）
      "subsystemCode": "SUB-001",   // 必填：子系统编码
      "subsystemName": "平面输送机", // 必填：子系统名称
      "subsystemType": "CONVEYOR",  // 可选：子系统类型
      "category": "输送设备",        // 可选：分类
      "specification": "规格说明",   // 可选：规格型号
      "model": "型号A",              // 可选：型号
      "manufacturer": "制造商A",     // 可选：制造商
      "description": "描述信息",     // 可选：描述
      "status": "DRAFT",            // 可选：状态
      "sequenceNumber": 1,          // 可选：排序号
      "remarks": "备注"              // 可选：备注
    }
  ]
}
```

### 2.2 字段说明

#### 项目设备系统字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | ✅ | 项目设备系统ID |
| projectId | Long | ✅ | 化盐项目ID（用于数据隔离验证） |
| projectName | String | ❌ | 项目名称（冗余字段） |
| templateId | Long | ❌ | 设备系统模板ID（追溯来源） |
| systemCode | String | ✅ | 系统编码（唯一） |
| systemName | String | ✅ | 系统名称 |
| systemType | String | ❌ | 系统类型（SOLID/LIQUID/POWDER/BURNER） |
| category | String | ❌ | 分类 |
| description | String | ❌ | 描述（最多500字符） |
| responsiblePersonId | Long | ❌ | 负责人ID |
| responsiblePerson | String | ❌ | 负责人姓名 |
| status | String | ❌ | 状态（DRAFT/ACTIVE/COMPLETED/ARCHIVED） |
| priority | Integer | ❌ | 优先级 |
| sequenceNumber | Integer | ❌ | 排序号 |
| remarks | String | ❌ | 备注（最多500字符） |
| version | Integer | ❌ | 版本号（乐观锁） |
| subsystems | List | ✅ | 项目子系统列表（至少1个） |

#### 项目子系统字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectSystemId | Long | ✅ | 项目设备系统ID |
| projectId | Long | ✅ | 项目ID |
| templateId | Long | ❌ | 子系统模板ID（引用模板时填写） |
| subsystemCode | String | ✅ | 子系统编码 |
| subsystemName | String | ✅ | 子系统名称 |
| subsystemType | String | ❌ | 子系统类型 |
| category | String | ❌ | 分类 |
| specification | String | ❌ | 规格型号 |
| model | String | ❌ | 型号 |
| manufacturer | String | ❌ | 制造商 |
| description | String | ❌ | 描述 |
| status | String | ❌ | 状态 |
| sequenceNumber | Integer | ❌ | 排序号 |
| remarks | String | ❌ | 备注 |

### 2.3 验证规则

1. **项目设备系统ID**：必须存在且有效
2. **项目ID**：必须与现有记录的项目ID一致（数据隔离）
3. **子系统列表**：至少包含1个子系统
4. **子系统名称**：新建子系统时必填
5. **字符串长度**：遵循字段定义的最大长度限制

## 三、响应结果

### 3.1 成功响应

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": null
}
```

### 3.2 失败响应

```json
{
  "code": 500,
  "msg": "项目设备系统不存在",
  "data": null
}
```

### 3.3 常见错误

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 项目设备系统不存在 | ID无效 | 检查ID是否正确 |
| 至少需要一个项目子系统 | 子系统列表为空 | 添加至少1个子系统 |
| 不允许修改其他项目的设备系统 | projectId不匹配 | 确保projectId与现有记录一致 |
| 新建项目子系统时，子系统名称不能为空 | 子系统名称缺失 | 填写子系统名称 |

## 四、业务逻辑

### 4.1 执行流程

```
1. 验证参数
   ├── 验证子系统列表不为空
   ├── 验证项目设备系统ID存在
   └── 验证项目数据隔离（projectId一致）

2. 更新基本信息
   └── 更新项目设备系统表（erp_salt_project_equipment_system）

3. 删除旧数据
   ├── 删除旧的项目子系统（CASCADE自动删除子项和物料）
   └── 记录日志

4. 创建新数据
   ├── 遍历子系统列表
   │   ├── 判断是否引用模板（templateId）
   │   │   ├── 是：从子系统模板复制数据
   │   │   └── 否：使用传入的数据创建
   │   ├── 插入项目子系统
   │   └── 如果引用模板，复制子项和物料数据
   └── 记录日志

5. 更新统计信息
   ├── 统计子系统数量
   ├── 统计总子项数
   ├── 统计总物料数
   └── 更新项目设备系统统计字段

6. 返回结果
```

### 4.2 数据隔离机制

1. **项目隔离**：不允许修改其他项目的设备系统
2. **快照隔离**：删除旧数据，创建新数据（不是更新）
3. **级联删除**：删除子系统时自动删除关联的子项和物料
4. **模板引用**：支持引用子系统模板，但创建独立的项目数据

## 五、代码实现

### 5.1 文件清单

| 文件 | 说明 |
|------|------|
| `ErpSaltProjectEquipmentSystemFullBo.java` | 完整编辑业务对象（包含子系统列表） |
| `IErpSaltProjectEquipmentSystemService.java` | Service接口（新增updateFullByBo方法） |
| `ErpSaltProjectEquipmentSystemServiceImpl.java` | Service实现（核心业务逻辑） |
| `ErpSaltProjectEquipmentSystemController.java` | Controller（新增editFull接口） |

### 5.2 核心方法

#### Controller层
```java
@PutMapping("/full")
public R<Void> editFull(@Validated(EditGroup.class) @RequestBody ErpSaltProjectEquipmentSystemFullBo bo)
```

#### Service层
```java
Boolean updateFullByBo(ErpSaltProjectEquipmentSystemFullBo bo)
```

#### 辅助方法
```java
// 创建项目子系统列表
private int createProjectSubsystems(Long projectSystemId, Long projectId, List<ErpSaltProjectSubsystemBo> subsystemBos)

// 从子系统模板复制子项和物料
private void copyItemsAndMaterialsFromTemplate(Long subsystemTemplateId, Long projectSubsystemId, Long projectId)

// 更新统计信息
private void updateProjectSystemStatistics(Long projectSystemId, int subsystemCount)
```

## 六、与参考接口的差异

### 6.1 主要差异点

| 特性 | 设备系统模板 | 项目设备系统 |
|------|------------|------------|
| **数据表** | erp_salt_equipment_system_template | erp_salt_project_equipment_system |
| **子系统表** | erp_salt_subsystem_template | erp_salt_project_subsystem |
| **子项表** | erp_salt_item_template | erp_salt_project_item |
| **物料表** | erp_salt_material_template | erp_salt_project_material |
| **项目关联** | ❌ 无 | ✅ 有（projectId字段） |
| **租户隔离** | ❌ 无 | ✅ 有（tenant_id字段） |
| **数据隔离验证** | 模板编码唯一性 | 项目ID一致性 |

### 6.2 业务逻辑一致性

✅ **相同的业务逻辑**：
- 级联删除旧数据
- 级联创建新数据
- 支持引用模板
- 自动更新统计信息
- 事务管理

✅ **额外的项目关联**：
- 验证项目ID一致性
- 设置项目ID到子系统、子项、物料
- 支持租户隔离

## 七、使用示例

### 7.1 完整编辑示例

```bash
curl -X PUT http://localhost:8080/erp/saltprocess/projectEquipmentSystem/full \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "id": 1,
    "projectId": 100,
    "systemCode": "SYS-001",
    "systemName": "固态处理厂",
    "systemType": "SOLID",
    "status": "DRAFT",
    "subsystems": [
      {
        "projectSystemId": 1,
        "projectId": 100,
        "templateId": 20,
        "subsystemName": "平面输送机",
        "subsystemType": "CONVEYOR"
      }
    ]
  }'
```

## 八、注意事项

### 8.1 重要提示

⚠️ **数据安全**：
- 本接口会删除所有旧的子系统、子项、物料数据
- 请确保在调用前已备份重要数据
- 建议在草稿状态下进行编辑

⚠️ **性能考虑**：
- 大量子系统、子项、物料会影响性能
- 建议分批处理或使用异步方式

⚠️ **事务管理**：
- 整个操作在一个事务中执行
- 任何步骤失败都会回滚

### 8.2 最佳实践

1. **编辑前查询**：先调用查询接口获取完整数据
2. **保留必要字段**：确保ID、projectId等关键字段正确
3. **验证子系统**：确保子系统列表完整且正确
4. **测试环境验证**：先在测试环境验证功能
5. **日志监控**：关注日志输出，及时发现问题

---

**文档版本**：v1.0  
**最后更新**：2025-01-01  
**维护人员**：海棠开发团队

