# 物料操作功能实现说明

## 概述

本文档说明了在 `ProjectSubsystemDetail.vue` 组件中实现物料操作功能的完整过程。通过集成后端 API 接口，实现了物料的查询、新增、编辑和删除功能。

## 实现内容

### 1. API 接口扩展 (`src/api/erp/saltprocess/project-item/index.ts`)

#### 新增类型定义

```typescript
// 物料表单数据
export interface ProjectMaterialForm {
  id?: string | number;
  materialCode?: string;
  materialName: string;           // 必填
  specification?: string;
  materialType?: string;
  materialCategory?: string;
  quantity?: number;
  unit?: string;
  unitWeight?: number;
  totalWeight?: number;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  packageType?: string;
  packageQuantity?: number;
  isFragile?: boolean;
  isHazardous?: boolean;
  storageRequirement?: string;
  status?: string;
  sequenceNumber?: number;
  remarks?: string;
  remarks1?: string;
  remarks2?: string;
}

// 批量物料操作结果
export interface BatchMaterialResult {
  totalCount: number;
  successCount: number;
  failureCount: number;
  insertCount?: number;
  updateCount?: number;
  deleteCount?: number;
  failures?: Array<{
    rowNumber: number;
    recordId?: string | number;
    errorMessage: string;
    errorField?: string;
  }>;
  message: string;
}
```

#### 新增 API 函数

1. **编辑物料**
   ```typescript
   updateProjectMaterial(projectItemId, materialId, data)
   // PUT /erp/saltprocess/projectEquipmentSystem/item/{projectItemId}/materials/{materialId}
   ```

2. **删除物料**（支持批量）
   ```typescript
   deleteProjectMaterials(projectItemId, materialIds)
   // DELETE /erp/saltprocess/projectEquipmentSystem/item/{projectItemId}/materials/{ids}
   ```

3. **批量保存物料**（Upsert）
   ```typescript
   batchSaveProjectMaterials(projectItemId, data)
   // POST /erp/saltprocess/projectEquipmentSystem/item/{projectItemId}/materials/batch
   ```

### 2. Vue 组件功能实现 (`ProjectSubsystemDetail.vue`)

#### 新增响应式数据

```typescript
// 物料表单
const materialForm = reactive<ProjectMaterialForm>({...})

// 物料对话框
const materialDialog = reactive({
  visible: false,
  title: '',
  loading: false
})

// 物料表单验证规则
const materialRules = {
  materialName: [{ required: true, message: '请输入物料名称', trigger: 'blur' }],
  quantity: [...],
  unit: [...]
}
```

#### 实现的功能函数

1. **resetMaterialForm()**
   - 重置物料表单数据
   - 清除表单验证状态

2. **handleAddMaterialInDialog()**
   - 打开新增物料对话框
   - 重置表单数据

3. **handleEditMaterial(row)**
   - 打开编辑物料对话框
   - 填充现有物料数据到表单
   - 支持所有物料字段的编辑

4. **handleDeleteMaterial(row)**
   - 删除单个物料
   - 显示确认对话框
   - 删除后刷新物料列表

5. **submitMaterialForm()**
   - 验证表单数据
   - 根据是否有 ID 判断新增或编辑
   - 调用相应的 API 接口
   - 成功后关闭对话框并刷新列表

#### 新增 UI 组件

添加了物料表单对话框，包含以下字段：

**基本信息**
- 物料编码
- 物料名称（必填）
- 规格型号
- 物料类型
- 物料类别

**数量和重量**
- 数量
- 单位
- 单重(kg)
- 总重(kg)

**制造商信息**
- 制造商
- 型号
- 序列号

**包装信息**
- 包装方式
- 包装件数
- 是否易碎（开关）
- 是否危险品（开关）

**其他信息**
- 存储要求
- 状态（下拉选择：正常、准备中、就绪、已发货）
- 排序号
- 备注
- 备注1
- 备注2

## API 接口对应关系

| 功能 | HTTP 方法 | 路径 | API 函数 |
|------|---------|------|---------|
| 查询物料列表 | GET | `/item/{projectItemId}/materials` | getItemMaterials (已存在) |
| 编辑物料 | PUT | `/item/{projectItemId}/materials/{id}` | updateProjectMaterial |
| 删除物料 | DELETE | `/item/{projectItemId}/materials/{ids}` | deleteProjectMaterials |
| 批量保存物料 | POST | `/item/{projectItemId}/materials/batch` | batchSaveProjectMaterials |

## 使用流程

### 查看物料列表
1. 在子项列表中点击"查看物料"按钮
2. 打开物料详情对话框，显示该子项下的所有物料

### 添加物料
1. 在物料详情对话框中点击"添加物料"按钮
2. 打开物料表单对话框
3. 填写物料信息（物料名称为必填项）
4. 点击"确定"提交
5. 系统调用 `batchSaveProjectMaterials` API 新增物料

### 编辑物料
1. 在物料列表中点击编辑按钮
2. 打开物料表单对话框，预填充现有数据
3. 修改需要更新的字段
4. 点击"确定"提交
5. 系统调用 `updateProjectMaterial` API 更新物料

### 删除物料
1. 在物料列表中点击删除按钮
2. 显示确认对话框
3. 确认删除后，系统调用 `deleteProjectMaterials` API 删除物料
4. 物料列表自动刷新

## 关键特性

1. **完整的字段支持**
   - 支持物料的所有字段编辑
   - 包括基本信息、数量重量、制造商信息、包装信息等

2. **数据验证**
   - 物料名称为必填项
   - 表单提交前进行验证

3. **用户友好的交互**
   - 确认对话框防止误操作
   - 操作成功/失败提示
   - 操作后自动刷新列表

4. **类型安全**
   - 使用 TypeScript 接口定义
   - 完整的类型检查

5. **API 兼容性**
   - 支持后端的所有物料操作接口
   - 支持批量操作
   - 支持 Upsert 操作

## 技术细节

### 物料状态枚举
- `NORMAL` - 正常
- `PREPARING` - 准备中
- `READY` - 就绪
- `SHIPPED` - 已发货

### 数据类型转换
- 数值字段自动转换（字符串转数字）
- 布尔值字段使用开关组件
- 日期字段使用时间格式化函数

### 错误处理
- 网络请求错误捕获
- 用户操作取消处理
- 表单验证错误提示

## 测试建议

1. **新增物料**
   - 验证必填字段校验
   - 验证各字段类型转换
   - 验证批量保存响应处理

2. **编辑物料**
   - 验证数据预填充
   - 验证字段更新
   - 验证版本号处理（如有）

3. **删除物料**
   - 验证单个删除
   - 验证确认对话框
   - 验证列表刷新

4. **边界情况**
   - 未选择子项时的处理
   - 网络错误时的处理
   - 并发操作的处理

## 后续改进

1. 可以添加物料模板选择功能
2. 可以支持物料的批量编辑
3. 可以添加物料的导入/导出功能
4. 可以添加物料的搜索和筛选功能
5. 可以添加物料的历史记录查看

## 文件变更

### 修改的文件
1. `/src/api/erp/saltprocess/project-item/index.ts`
   - 新增物料操作 API 函数
   - 新增类型定义

2. `/src/views/erp/saltprocess/equipment-system/components/ProjectSubsystemDetail.vue`
   - 新增物料表单响应式数据
   - 新增物料操作处理函数
   - 新增物料表单对话框 UI
   - 更新导入语句

## 总结

通过本次实现，`ProjectSubsystemDetail.vue` 组件现已具备完整的物料操作功能，包括查询、新增、编辑和删除。所有操作都通过后端 API 进行，确保数据的一致性和安全性。

