# 项目设备系统发布接口文档

## 文档信息

-   **模块名称**: 项目设备系统管理
-   **接口名称**: 发布项目设备系统
-   **版本**: v1.0
-   **更新日期**: 2025-11-24
-   **作者**: haitang

---

## 目录

1. [接口概述](#接口概述)
2. [接口详情](#接口详情)
3. [业务规则](#业务规则)
4. [错误处理](#错误处理)
5. [使用示例](#使用示例)
6. [架构设计](#架构设计)

---

## 接口概述

### 功能描述

发布项目设备系统接口用于将草稿状态的项目设备系统发布为活跃状态。发布后的项目设备系统可以正式投入使用。

### 核心功能

1. **状态转换**: 将项目设备系统状态从 `DRAFT`（草稿）更新为 `ACTIVE`（活跃）
2. **完整性验证**: 确保项目设备系统包含必要的信息和至少一个子系统
3. **权限控制**: 只有具有发布权限的用户才能执行此操作
4. **审计日志**: 记录发布操作的详细信息

---

## 接口详情

### 基本信息

-   **接口路径**: `/erp/saltprocess/projectEquipmentSystem/{id}/publish`
-   **请求方式**: `POST`
-   **权限标识**: `erp:saltprocess:projectEquipmentSystem:publish`
-   **是否幂等**: 是（使用 `@RepeatSubmit` 注解防止重复提交）

### 请求参数

#### 路径参数

| 参数名 | 类型 | 必填 | 说明            |
| ------ | ---- | ---- | --------------- |
| id     | Long | 是   | 项目设备系统 ID |

#### 请求头

| 参数名        | 类型   | 必填 | 说明           |
| ------------- | ------ | ---- | -------------- |
| Authorization | String | 是   | 用户认证 Token |

### 响应参数

#### 成功响应

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

#### 失败响应

```json
{
    "code": 500,
    "msg": "只有草稿状态的项目设备系统才能发布，当前状态：ACTIVE"
}
```

---

## 业务规则

### 状态转换规则

```
DRAFT (草稿) --[发布]--> ACTIVE (活跃)
```

### 发布前置条件

1. **状态检查**: 项目设备系统当前状态必须为 `DRAFT`
2. **基本信息完整性**:
    - 系统编码不能为空
    - 系统名称不能为空
    - 项目 ID 不能为空
3. **子系统检查**: 至少包含一个子系统

### 发布后效果

-   项目设备系统状态更新为 `ACTIVE`
-   系统可以正式投入使用
-   记录操作日志

---

## 错误处理

### HTTP 状态码

| 错误码 | 说明     | 处理建议               |
| ------ | -------- | ---------------------- |
| 200    | 操作成功 | -                      |
| 403    | 权限不足 | 联系管理员分配发布权限 |
| 500    | 业务异常 | 根据具体错误信息处理   |

### 常见错误场景

#### 场景 1: 项目设备系统不存在

**原因**: 传入的项目设备系统 ID 在数据库中不存在  
**解决**: 检查项目设备系统 ID 是否正确

#### 场景 2: 状态不允许发布

**原因**: 项目设备系统当前状态不是草稿  
**解决**: 只有草稿状态的项目设备系统才能发布

#### 场景 3: 项目设备系统不完整

**原因**: 项目设备系统缺少必要信息或子系统  
**解决**: 完善项目设备系统信息后再发布

---

## 使用示例

### 前端调用示例 (TypeScript)

```typescript
import request from "@/utils/request";

/**
 * 发布项目设备系统
 * @param id 项目设备系统ID
 * @returns 发布结果
 */
export const publishProjectSystem = (id: number): Promise<void> => {
    return request({
        url: `/erp/saltprocess/projectEquipmentSystem/${id}/publish`,
        method: "post",
    });
};

// 使用示例
publishProjectSystem(123)
    .then(() => {
        console.log("发布成功");
    })
    .catch((error) => {
        console.error("发布失败", error);
    });
```

### 后端单元测试示例 (Java)

```java
@SpringBootTest
@Transactional
@Rollback
class ErpSaltProjectEquipmentSystemServiceTest {

    @Autowired
    private IErpSaltProjectEquipmentSystemService projectSystemService;

    @Test
    @DisplayName("测试发布项目设备系统")
    void testPublishProjectSystem() {
        // Given: 创建一个草稿状态的项目设备系统
        ErpSaltProjectEquipmentSystemBo bo = new ErpSaltProjectEquipmentSystemBo();
        bo.setProjectId(1L);
        bo.setSystemName("测试设备系统");
        bo.setSystemType("SOLID");
        bo.setStatus("DRAFT");
        // ... 设置其他必要字段和子系统

        Boolean createResult = projectSystemService.insertByBo(bo);
        assertTrue(createResult);

        // When: 发布项目设备系统
        Long systemId = 1L; // 假设创建后的ID
        Boolean publishResult = projectSystemService.publishSystem(systemId);

        // Then: 验证发布结果
        assertTrue(publishResult);

        // 验证状态已更新
        ErpSaltProjectEquipmentSystemVo vo = projectSystemService.queryById(systemId);
        assertEquals("ACTIVE", vo.getStatus());
    }
}
```

### cURL 调用示例

```bash
curl -X POST \
  'http://localhost:8080/erp/saltprocess/projectEquipmentSystem/123/publish' \
  -H 'Authorization: Bearer {token}' \
  -H 'Content-Type: application/json'
```

---

## 架构设计

### 三层架构实现

```
Controller层 (表现层)
├── ErpSaltProjectEquipmentSystemController
├── 职责：接收HTTP请求，参数验证，返回响应
├── 注解：@RestController, @SaCheckPermission, @Log
└── 方法：publish(@PathVariable Long id)

Service层 (业务逻辑层)
├── IErpSaltProjectEquipmentSystemService (接口)
├── ErpSaltProjectEquipmentSystemServiceImpl (实现)
├── 职责：业务逻辑处理，状态验证，完整性检查
├── 注解：@Service, @Transactional
└── 方法：publishSystem(Long id)

Mapper层 (数据访问层)
├── ErpSaltProjectEquipmentSystemMapper
├── 职责：数据库操作，Entity映射
└── 方法：selectById(), updateById()
```

### 数据流转换

```
前端请求 (HTTP POST)
    ↓ Controller接收
路径参数 (Long id)
    ↓ Service业务处理
1. 查询项目设备系统Entity
2. 验证状态和完整性
3. 更新状态为ACTIVE
    ↓ Mapper数据库操作
数据库记录更新
    ↓ 返回操作结果
Boolean (成功/失败)
    ↓ Controller.toAjax()
R<Void> (统一响应对象)
    ↓ 前端响应 (JSON)
```

### 核心代码实现

#### 1. Controller 接口

```java
@Operation(summary = "发布项目设备系统", description = "将草稿状态的项目设备系统发布为活跃状态")
@Parameter(name = "id", description = "项目设备系统ID", required = true)
@SaCheckPermission("erp:saltprocess:projectEquipmentSystem:publish")
@Log(title = "发布项目设备系统", businessType = BusinessType.UPDATE)
@RepeatSubmit()
@PostMapping("/{id}/publish")
public R<Void> publish(@PathVariable Long id) {
    return toAjax(erpSaltProjectEquipmentSystemService.publishSystem(id));
}
```

#### 2. Service 实现关键代码

```java
@Override
@Transactional(rollbackFor = Exception.class)
public Boolean publishSystem(Long id) {
    // 1. 验证项目设备系统是否存在
    ErpSaltProjectEquipmentSystem system = baseMapper.selectById(id);
    if (system == null) {
        throw new ServiceException("项目设备系统不存在");
    }

    // 2. 验证当前状态是否允许发布
    if (!ProjectEquipmentSystemStatus.canPublish(system.getStatus())) {
        throw new ServiceException("只有草稿状态的项目设备系统才能发布");
    }

    // 3. 验证项目设备系统完整性
    validateSystemCompleteness(id, system);

    // 4. 更新项目设备系统状态为ACTIVE
    ErpSaltProjectEquipmentSystem updateEntity = new ErpSaltProjectEquipmentSystem();
    updateEntity.setId(id);
    updateEntity.setStatus(ProjectEquipmentSystemStatus.ACTIVE.getCode());

    return baseMapper.updateById(updateEntity) > 0;
}
```

#### 3. 状态枚举类

```java
@Getter
@AllArgsConstructor
public enum ProjectEquipmentSystemStatus {
    DRAFT("DRAFT", "草稿"),
    ACTIVE("ACTIVE", "活跃"),
    COMPLETED("COMPLETED", "已完成"),
    ARCHIVED("ARCHIVED", "已归档");

    private final String code;
    private final String name;

    public static boolean canPublish(String code) {
        return DRAFT.getCode().equals(code);
    }
}
```

---

## 遵循的编码规范

本接口实现严格遵循《海棠 ERP 系统项目编码规范》：

1. **三层架构标准**: Controller → Service → Mapper 清晰分层
2. **枚举类设计规范**: 使用 `fromCode` 方法，避免与 `valueOf` 冲突
3. **API 设计规范**: RESTful 风格，路径命名统一
4. **异常处理规范**: 完整的异常捕获和日志记录
5. **事务管理**: 使用 `@Transactional` 确保数据一致性
6. **权限控制**: 使用 `@SaCheckPermission` 进行权限验证
7. **文档注释**: 完整的 JavaDoc 和 Swagger 注解

---

## 测试检查清单

-   [ ] 草稿状态的项目设备系统可以成功发布
-   [ ] 已活跃的项目设备系统不能再次发布
-   [ ] 没有子系统的项目设备系统不能发布
-   [ ] 发布后状态正确更新为 ACTIVE
-   [ ] 操作日志正确记录
-   [ ] 权限控制生效
-   [ ] 防重复提交生效

---

## 部署说明

### 1. 权限配置

需要在系统中配置新的权限：

```sql
-- 添加发布权限
INSERT INTO sys_menu (menu_name, parent_id, order_num, perms, menu_type, visible, status)
VALUES ('发布项目设备系统', [父菜单ID], 5, 'erp:saltprocess:projectEquipmentSystem:publish', 'F', '1', '0');
```

### 2. 数据库变更

无需数据库结构变更，使用现有的 `status` 字段。

---

**文档版本**: v1.0
**最后更新**: 2025-11-24
**维护人员**: 海棠开发团队
