# 设备系统模版子项新增编辑与删除接口文档

## 概述

本文档描述了设备系统模版关联子项的新增、编辑和删除接口，用于管理子系统模版下的子项模板数据。

## 接口列表

### 1. 新增设备系统模版关联的子项数据

#### 接口信息

-   **接口路径**: `POST /erp/saltprocess/equipmentSystemTemplate/subsystem/{subsystemTemplateId}/items`
-   **接口描述**: 在指定子系统模版下新增子项模板
-   **权限要求**: `erp:saltprocess:equipmentSystemTemplate:add`
-   **请求方式**: POST
-   **Content-Type**: application/json

#### 路径参数

| 参数名              | 类型 | 必填 | 说明          |
| ------------------- | ---- | ---- | ------------- |
| subsystemTemplateId | Long | 是   | 子系统模版 ID |

#### 请求体参数 (List<ErpSaltItemTemplateBo>)

| 参数名               | 类型       | 必填 | 说明                                | 校验规则                          |
| -------------------- | ---------- | ---- | ----------------------------------- | --------------------------------- |
| templateCode         | String     | 是   | 子项模板编码                        | 最大长度 50                       |
| itemName             | String     | 是   | 子项名称                            | 最大长度 100                      |
| itemType             | String     | 否   | 子项类型（MAIN/FASTENER/ACCESSORY） | 最大长度 50                       |
| specification        | String     | 否   | 规格型号                            | 最大长度 500                      |
| description          | String     | 否   | 描述                                | 最大长度 500                      |
| defaultQuantity      | BigDecimal | 否   | 默认数量                            | 最小 0.01，最多 8 位整数 2 位小数 |
| defaultUnit          | String     | 否   | 默认单位                            | 最大长度 20                       |
| estimatedUnitWeight  | BigDecimal | 否   | 预估单重(kg)                        | 最小 0，最多 10 位整数 2 位小数   |
| parentItemTemplateId | Long       | 否   | 父子项模板 ID（支持子项嵌套）       | -                                 |
| sequenceNumber       | Integer    | 否   | 排序号                              | 最小 0                            |
| status               | String     | 否   | 状态                                | 最大长度 20                       |
| remarks              | String     | 否   | 备注                                | 最大长度 500                      |

**注意**: `subsystemTemplateId` 会自动从路径参数中设置，请求体中无需传入。

#### 请求示例

```json
[
    {
        "templateCode": "ITEM001",
        "itemName": "输送主体",
        "itemType": "MAIN",
        "specification": "长度5米，宽度1米",
        "description": "平面输送机主体部分",
        "defaultQuantity": 1.0,
        "defaultUnit": "套",
        "estimatedUnitWeight": 500.0,
        "sequenceNumber": 1,
        "status": "ACTIVE",
        "remarks": "主要承重部件"
    },
    {
        "templateCode": "ITEM002",
        "itemName": "紧固件",
        "itemType": "FASTENER",
        "defaultQuantity": 10.0,
        "defaultUnit": "个"
    }
]
```

#### 响应结果

**成功响应 (200 OK)**

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

**失败响应 (404 Not Found)**

```json
{
    "code": 404,
    "msg": "指定的子系统模版 ID 不存在。"
}
```

**失败响应 (400 Bad Request)**

```json
{
    "code": 400,
    "msg": "参数校验失败：子项名称不能为空"
}
```

---

### 2. 编辑设备系统模版关联的子项数据

#### 接口信息

-   **接口路径**: `PUT /erp/saltprocess/equipmentSystemTemplate/subsystem/{subsystemTemplateId}/items/{id}`
-   **接口描述**: 更新指定子系统模版下的子项模板信息
-   **权限要求**: `erp:saltprocess:equipmentSystemTemplate:edit`
-   **请求方式**: PUT
-   **Content-Type**: application/json

#### 路径参数

| 参数名              | 类型 | 必填 | 说明          |
| ------------------- | ---- | ---- | ------------- |
| subsystemTemplateId | Long | 是   | 子系统模版 ID |
| id                  | Long | 是   | 子项模板 ID   |

#### 请求体参数 (ErpSaltItemTemplateBo)

参数与新增接口相同，但 `id` 和 `subsystemTemplateId` 会自动从路径参数中设置。

#### 请求示例

```json
{
    "templateCode": "ITEM001",
    "itemName": "输送主体（改进版）",
    "itemType": "MAIN",
    "specification": "长度6米，宽度1.2米",
    "description": "平面输送机主体部分，已优化结构",
    "defaultQuantity": 1.0,
    "defaultUnit": "套",
    "estimatedUnitWeight": 550.0,
    "sequenceNumber": 1,
    "status": "ACTIVE",
    "remarks": "2025年1月改进版本"
}
```

#### 响应结果

**成功响应 (200 OK)**

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

**失败响应 (404 Not Found)**

```json
{
    "code": 404,
    "msg": "指定的子项模板 ID 不存在。"
}
```

**失败响应 (403 Forbidden)**

```json
{
    "code": 403,
    "msg": "子项模板不属于指定的子系统模版，操作被拒绝。"
}
```

---

### 3. 删除设备系统模版关联的子项数据

#### 接口信息

-   **接口路径**: `DELETE /erp/saltprocess/equipmentSystemTemplate/subsystem/{subsystemTemplateId}/items/{ids}`
-   **接口描述**: 删除指定子系统模版下的子项模板记录（支持批量删除）
-   **权限要求**: `erp:saltprocess:equipmentSystemTemplate:remove`
-   **请求方式**: DELETE

#### 路径参数

| 参数名              | 类型   | 必填 | 说明                                   |
| ------------------- | ------ | ---- | -------------------------------------- |
| subsystemTemplateId | Long   | 是   | 子系统模版 ID                          |
| ids                 | Long[] | 是   | 子项模板 ID 数组（逗号分隔，支持批量） |

#### 请求示例

**单个删除**

```
DELETE /erp/saltprocess/equipmentSystemTemplate/subsystem/1990265855048286200/items/1990265855048286210
```

**批量删除**

```
DELETE /erp/saltprocess/equipmentSystemTemplate/subsystem/1990265855048286200/items/1990265855048286210,1990265855048286211,1990265855048286212
```

#### 响应结果

**成功响应 (200 OK)**

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

**失败响应 (404 Not Found)**

```json
{
    "code": 404,
    "msg": "子项模板 ID 1990265855048286210 不存在。"
}
```

**失败响应 (403 Forbidden)**

```json
{
    "code": 403,
    "msg": "子项模板 ID 1990265855048286210 不属于指定的子系统模版，操作被拒绝。"
}
```

---

## 数据隔离机制

### 设计原则

1. **快照隔离**: 所有操作只影响设备系统模版关联的子项模板数据，不影响公司子项库中的原始数据
2. **归属验证**: 编辑和删除操作会严格验证子项模板是否属于指定的子系统模版
3. **逻辑删除**: 删除操作使用逻辑删除（`del_flag=1`），不会物理删除数据库记录

### 验证流程

```
1. 验证子系统模版是否存在
   ↓
2. 验证子项模板是否存在（编辑/删除操作）
   ↓
3. 验证子项模板的 subsystemTemplateId 是否匹配路径参数
   ↓
4. 执行操作（新增/编辑/删除）
   ↓
5. 返回结果
```

---

## 技术实现

### 实现层级

-   **Controller 层**: `ErpSaltEquipmentSystemTemplateController`
    -   `addSubsystemItem()` - 新增子项模板
    -   `updateSubsystemItem()` - 编辑子项模板
    -   `removeSubsystemItems()` - 删除子项模板
-   **Service 层**: `IErpSaltItemTemplateService`
    -   `insertByBo()` - 新增子项模板
    -   `updateByBo()` - 更新子项模板
    -   `deleteWithValidByIds()` - 批量删除子项模板
-   **Mapper 层**: `ErpSaltItemTemplateMapper`
    -   `insert()` - 插入数据库记录
    -   `updateById()` - 更新数据库记录
    -   `deleteBatchIds()` - 批量删除数据库记录（逻辑删除）

### 数据流转换

```
前端请求 (JSON)
    ↓ Controller接收
ErpSaltItemTemplateBo (业务参数对象)
    ↓ Service.Convert.toEntity()
ErpSaltItemTemplate (数据库实体对象)
    ↓ Mapper数据库操作
数据库记录新增/更新/删除
    ↓ 返回操作结果
Boolean (成功/失败)
    ↓ Controller.toAjax()
R<Void> (统一响应对象)
    ↓ 前端响应 (JSON)
```

---

## 使用示例

### cURL 示例

**新增子项模板**

```bash
curl -X POST "http://localhost:8080/erp/saltprocess/equipmentSystemTemplate/subsystem/1990265855048286200/items" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "templateCode": "ITEM001",
    "itemName": "输送主体",
    "itemType": "MAIN",
    "specification": "长度5米，宽度1米",
    "defaultQuantity": 1.00,
    "defaultUnit": "套",
    "estimatedUnitWeight": 500.00,
    "sequenceNumber": 1,
    "status": "ACTIVE"
  }'
```

**编辑子项模板**

```bash
curl -X PUT "http://localhost:8080/erp/saltprocess/equipmentSystemTemplate/subsystem/1990265855048286200/items/1990265855048286210" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "templateCode": "ITEM001",
    "itemName": "输送主体（改进版）",
    "itemType": "MAIN",
    "specification": "长度6米，宽度1.2米",
    "defaultQuantity": 1.00,
    "defaultUnit": "套",
    "estimatedUnitWeight": 550.00,
    "sequenceNumber": 1,
    "status": "ACTIVE"
  }'
```

**删除子项模板**

```bash
# 单个删除
curl -X DELETE "http://localhost:8080/erp/saltprocess/equipmentSystemTemplate/subsystem/1990265855048286200/items/1990265855048286210" \
  -H "Authorization: Bearer {token}"

# 批量删除
curl -X DELETE "http://localhost:8080/erp/saltprocess/equipmentSystemTemplate/subsystem/1990265855048286200/items/1990265855048286210,1990265855048286211,1990265855048286212" \
  -H "Authorization: Bearer {token}"
```

### JavaScript/TypeScript 示例

```typescript
import request from "@/utils/request";

// 新增子项模板
export const addSubsystemItem = (subsystemTemplateId: number, data: any) => {
    return request({
        url: `/erp/saltprocess/equipmentSystemTemplate/subsystem/${subsystemTemplateId}/items`,
        method: "post",
        data: data,
    });
};

// 编辑子项模板
export const updateSubsystemItem = (
    subsystemTemplateId: number,
    id: number,
    data: any
) => {
    return request({
        url: `/erp/saltprocess/equipmentSystemTemplate/subsystem/${subsystemTemplateId}/items/${id}`,
        method: "put",
        data: data,
    });
};

// 删除子项模板（支持批量）
export const removeSubsystemItems = (
    subsystemTemplateId: number,
    ids: number | number[]
) => {
    const idsStr = Array.isArray(ids) ? ids.join(",") : ids;
    return request({
        url: `/erp/saltprocess/equipmentSystemTemplate/subsystem/${subsystemTemplateId}/items/${idsStr}`,
        method: "delete",
    });
};

// 使用示例
const example = async () => {
    // 新增
    await addSubsystemItem(1990265855048286200, {
        templateCode: "ITEM001",
        itemName: "输送主体",
        itemType: "MAIN",
        specification: "长度5米，宽度1米",
        defaultQuantity: 1.0,
        defaultUnit: "套",
        estimatedUnitWeight: 500.0,
        sequenceNumber: 1,
        status: "ACTIVE",
    });

    // 编辑
    await updateSubsystemItem(1990265855048286200, 1990265855048286210, {
        templateCode: "ITEM001",
        itemName: "输送主体（改进版）",
        itemType: "MAIN",
        specification: "长度6米，宽度1.2米",
        defaultQuantity: 1.0,
        defaultUnit: "套",
        estimatedUnitWeight: 550.0,
        sequenceNumber: 1,
        status: "ACTIVE",
    });

    // 单个删除
    await removeSubsystemItems(1990265855048286200, 1990265855048286210);

    // 批量删除
    await removeSubsystemItems(
        1990265855048286200,
        [1990265855048286210, 1990265855048286211, 1990265855048286212]
    );
};
```

---

## 注意事项

1. **权限要求**:

    - 新增接口需要 `erp:saltprocess:equipmentSystemTemplate:add` 权限
    - 编辑接口需要 `erp:saltprocess:equipmentSystemTemplate:edit` 权限
    - 删除接口需要 `erp:saltprocess:equipmentSystemTemplate:remove` 权限

2. **数据隔离**:

    - 所有操作都会验证子项模板是否属于指定的子系统模版
    - 跨子系统模版的操作会被拒绝（返回 403 状态码）

3. **逻辑删除**:

    - 删除操作使用逻辑删除（`del_flag=1`）
    - 不会物理删除数据库记录
    - 已引用该模板的项目实例不受影响

4. **事务管理**:

    - 所有操作都在事务中执行
    - 发生异常时自动回滚

5. **防重复提交**:

    - 新增和编辑接口使用 `@RepeatSubmit()` 注解防止重复提交

6. **参数校验**:

    - 使用 `@Validated(AddGroup.class)` 和 `@Validated(EditGroup.class)` 进行参数校验
    - 必填字段不能为空
    - 字符串长度、数值范围等都有校验规则

7. **模板编码唯一性**:
    - `templateCode` 在同一子系统模版下应保持唯一
    - 建议使用有意义的编码规则

---

## 相关接口

-   查询子系统模版详情: `GET /erp/saltprocess/equipmentSystemTemplate/subsystemTemplate/{id}`
-   查询子系统模版下的所有子项: `GET /erp/saltprocess/equipmentSystemTemplate/subsystem/{subsystemTemplateId}/items`
-   修改子系统模版基本信息: `PUT /erp/saltprocess/equipmentSystemTemplate/subsystem`
-   查询子项模版下的所有物料: `GET /erp/saltprocess/equipmentSystemTemplate/item/{itemTemplateId}/materials`

---

## 开发记录

### 开发信息

-   **开发时间**: 2025-01-17
-   **开发人员**: AI Assistant
-   **需求来源**: 盐加工 ERP 系统设备系统模版管理需求

### 实现的功能

1. ✅ 在子系统模版下新增子项模板
2. ✅ 编辑子系统模版下的子项模板
3. ✅ 删除子系统模版下的子项模板（支持批量删除）
4. ✅ 数据隔离验证机制
5. ✅ 权限控制和操作日志
6. ✅ 参数校验和异常处理

### 技术特性

-   遵循 RESTful API 设计规范
-   严格的数据隔离机制
-   完整的权限控制
-   防重复提交保护
-   逻辑删除机制
-   完整的异常处理和错误提示
-   操作日志记录

### 代码位置

-   **Controller**: `haitang-modules/haitang-erp/src/main/java/com/haitang/erp/controller/saltprocess/ErpSaltEquipmentSystemTemplateController.java`
-   **Service**: `haitang-modules/haitang-erp/src/main/java/com/haitang/erp/service/saltprocess/IErpSaltItemTemplateService.java`
-   **Bo**: `haitang-modules/haitang-erp/src/main/java/com/haitang/erp/domain/saltprocess/bo/ErpSaltItemTemplateBo.java`
-   **Vo**: `haitang-modules/haitang-erp/src/main/java/com/haitang/erp/domain/saltprocess/vo/ErpSaltItemTemplateVo.java`

---

## 编码规范遵循

本接口开发严格遵循《海棠 ERP 系统项目编码规范》：

-   ✅ 三层架构设计（Controller-Service-Mapper）
-   ✅ Controller 层薄层设计，只负责接收请求和返回响应
-   ✅ Service 层处理业务逻辑和数据转换
-   ✅ Mapper 层只处理数据库操作
-   ✅ 完整的异常处理和日志记录
-   ✅ RESTful API 路径设计
-   ✅ 数据隔离机制
-   ✅ 权限控制和参数校验

---

## 版本历史

| 版本 | 日期       | 作者         | 说明                                   |
| ---- | ---------- | ------------ | -------------------------------------- |
| 1.0  | 2025-01-17 | AI Assistant | 初始版本，实现子项模板新增编辑删除接口 |
