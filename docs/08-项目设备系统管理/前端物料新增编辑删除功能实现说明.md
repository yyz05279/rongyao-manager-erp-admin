# 设备系统模版物料编辑删除功能 - 前端实现说明

## 概述

本文档说明了在设备系统模版详情模块中，物料编辑和删除功能的前端实现。该功能支持修改物料的所有基础字段，因为数据已完全隔离。

## 实现时间

2025-11-17

## 修改的文件

### 1. API 接口文件

**文件**: `src/api/erp/saltprocess/equipment-system/template.ts`

**新增接口**:

```typescript
/**
 * 编辑设备系统模版关联的物料数据
 * @param itemTemplateId 子项模版ID
 * @param materialId 物料模板ID
 * @param data 物料模板数据
 */
export const updateEquipmentSystemItemMaterial = (
  itemTemplateId: string | number,
  materialId: string | number,
  data: any
): AxiosPromise<void> => {
  return request({
    url: `/erp/saltprocess/equipmentSystemTemplate/item/${itemTemplateId}/materials/${materialId}`,
    method: 'put',
    data
  });
};

/**
 * 删除设备系统模版关联的物料数据（支持批量删除）
 * @param itemTemplateId 子项模版ID
 * @param materialIds 物料模板ID数组（逗号分隔）
 */
export const deleteEquipmentSystemItemMaterials = (
  itemTemplateId: string | number,
  materialIds: string | number | Array<string | number>
): AxiosPromise<void> => {
  const ids = Array.isArray(materialIds) ? materialIds.join(',') : materialIds;
  return request({
    url: `/erp/saltprocess/equipmentSystemTemplate/item/${itemTemplateId}/materials/${ids}`,
    method: 'delete'
  });
};
```

### 2. 组件文件

**文件**: `src/views/erp/subsystem/template/components/ItemTemplateManagement.vue`

#### 2.1 导入新的 API 函数

```typescript
import {
  getEquipmentSystemSubsystemItems,
  getEquipmentSystemItemMaterials,
  updateEquipmentSystemItemMaterial,
  deleteEquipmentSystemItemMaterials
} from '@/api/erp/saltprocess/equipment-system/template';
```

#### 2.2 扩展物料表单类型定义

新增了完整的物料字段支持：

```typescript
interface MaterialFormData {
  id?: string | number;
  templateId?: string | number;
  itemTemplateId: string | number;
  templateCode: string;          // 物料模板编码
  materialCode?: string;          // 物料编码
  materialName: string;           // 物料名称
  specification?: string;         // 规格型号
  materialType?: string;          // 物料类型
  materialCategory?: string;      // 物料类别
  defaultQuantity: number;        // 默认数量
  defaultUnit?: string;           // 默认单位
  estimatedUnitWeight?: number;   // 预估单重(kg)
  manufacturer?: string;          // 制造商
  model?: string;                 // 型号
  packageType?: string;           // 包装方式
  isFragile?: boolean;            // 是否易碎
  isHazardous?: boolean;          // 是否危险品
  storageRequirement?: string;    // 存储要求
  sequenceNumber?: number;        // 排序号
  status?: string;                // 状态
  remarks?: string;               // 备注
}
```

#### 2.3 更新物料编辑表单

物料编辑对话框现在支持所有字段的编辑，包括：

- **基本信息**: 物料模板编码、物料编码、物料名称、规格型号、物料类型、物料类别
- **数量和单位**: 默认数量、默认单位、预估单重
- **制造商信息**: 制造商、型号
- **包装和存储**: 包装方式、存储要求
- **属性标识**: 是否易碎、是否危险品、排序号
- **其他信息**: 状态、备注

#### 2.4 更新删除功能

删除功能根据 `useEquipmentSystemApi` 标志选择正确的 API：

```typescript
const handleDeleteMaterial = async (row: SubsystemMaterialTemplateVO) => {
  try {
    await ElMessageBox.confirm(`是否确认删除物料"${row.materialName}"?`, '警告', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    });

    // 根据模式选择不同的API
    if (props.useEquipmentSystemApi) {
      // 使用设备系统模版API
      await deleteEquipmentSystemItemMaterials(selectedItemId.value!, row.id);
    } else {
      // 使用子系统模版API
      await delMaterialTemplate(row.id);
    }
    
    ElMessage.success('删除成功');
    loadMaterialList();
  } catch (error) {
    if (error !== 'cancel') {
      console.error('删除物料失败:', error);
      ElMessage.error('删除失败');
    }
  }
};
```

#### 2.5 更新编辑功能

编辑功能同样根据 `useEquipmentSystemApi` 标志选择正确的 API：

```typescript
const submitMaterialEditForm = async () => {
  try {
    await materialFormRef.value?.validate();

    materialEditDialog.loading = true;
    
    // 根据模式选择不同的API
    if (props.useEquipmentSystemApi) {
      // 使用设备系统模版API - 支持修改所有字段
      await updateEquipmentSystemItemMaterial(
        selectedItemId.value!,
        materialForm.id!,
        materialForm
      );
    } else {
      // 使用子系统模版API - 只支持部分字段
      await updateMaterialTemplate(materialForm as any);
    }
    
    ElMessage.success('修改成功');
    materialEditDialog.visible = false;
    loadMaterialList();
  } catch (error) {
    if (error !== false) {
      console.error('保存物料失败:', error);
      ElMessage.error('保存失败');
    }
  } finally {
    materialEditDialog.loading = false;
  }
};
```

## 功能特性

1. **完整字段支持**: 物料编辑表单支持所有字段的修改
2. **数据隔离**: 通过 `itemTemplateId` 确保数据隔离
3. **API 模式切换**: 根据 `useEquipmentSystemApi` 自动选择正确的 API
4. **批量删除**: 删除接口支持批量删除（虽然前端暂未实现批量删除UI）
5. **表单验证**: 必填字段有完整的验证规则
6. **用户体验**: 清晰的分组显示，易于理解和操作

## 使用方式

在设备系统模版详情页面中，查看子系统详情时：

1. 点击子项的"查看物料"按钮
2. 在物料列表中点击"编辑"按钮
3. 在弹出的对话框中修改物料的任意字段
4. 点击"确定"保存修改

删除物料：

1. 在物料列表中点击"删除"按钮
2. 确认删除操作
3. 物料将被删除

## 注意事项

1. 物料编辑功能只在设备系统模版模式下支持所有字段的修改
2. 在子系统模版模式下，只支持部分字段的修改
3. 删除操作会立即生效，请谨慎操作
4. 所有操作都需要相应的权限

## 相关文档

- [设备系统模版物料编辑删除接口文档](./设备系统模版物料编辑删除接口文档.md)
- [子系统模版子项和物料查询接口文档](./子系统模版子项和物料查询接口文档.md)

