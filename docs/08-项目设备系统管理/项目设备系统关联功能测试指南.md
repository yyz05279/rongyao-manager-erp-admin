# 项目设备系统关联功能测试指南

## 功能概述

项目设备系统关联功能允许用户将多个设备系统模板批量关联到指定项目，实现快速创建项目设备系统。

## 测试前准备

### 1. 数据准备

**盐化项目数据：**
- 确保系统中至少有 1 个盐化项目
- 项目状态可以是任意状态
- 路径：ERP管理 -> 盐化工艺 -> 项目管理

**设备系统模板数据：**
- 确保系统中至少有 1 个启用状态的设备系统模板
- 模板状态必须是 `ACTIVE`（启用）
- 路径：ERP管理 -> 盐化工艺 -> 设备系统模板管理

### 2. 权限检查

确保当前用户拥有以下权限：
- `erp:saltprocess:projectEquipmentSystem:add` - 新增项目设备系统权限

## 测试步骤

### 步骤 1：打开关联弹窗

1. 进入项目设备系统管理页面
2. 点击"关联设备系统"按钮
3. **预期结果：**
   - 弹窗正常打开
   - 弹窗标题显示"项目设备系统关联"
   - 弹窗宽度为 900px

### 步骤 2：检查项目列表加载

1. 观察"选择项目"下拉框
2. 点击下拉框展开项目列表
3. **预期结果：**
   - 项目列表正常加载
   - 显示格式：`项目名称 (项目编码)`
   - 支持搜索过滤
   - 支持清空选择

**如果项目列表为空：**
- 检查控制台是否有错误信息
- 检查接口 `GET /erp/saltprocess/project/list` 是否正常
- 检查是否有盐化项目数据

### 步骤 3：检查模板列表加载

1. 观察设备系统模板表格
2. **预期结果：**
   - 模板列表正常显示
   - 表格列：选择框、模板编号、模板名称、系统类型、子系统数、子项数、状态
   - 系统类型显示彩色标签（固态/液态/粉盐/燃烧器）
   - 状态显示为"启用"
   - 表格最大高度 400px，超出可滚动

**如果模板列表为空：**
- 检查控制台是否有错误信息
- 检查接口 `GET /erp/saltprocess/equipmentSystemTemplate/list?status=ACTIVE` 是否正常
- 检查是否有启用状态的模板数据

### 步骤 4：选择项目

1. 点击"选择项目"下拉框
2. 选择一个项目
3. **预期结果：**
   - 项目成功选中
   - 下拉框显示选中的项目信息

### 步骤 5：选择模板

1. 在模板表格中勾选一个或多个模板
2. **预期结果：**
   - 复选框正常勾选
   - 表格下方显示"已选择 X 个模板"的提示信息
   - 提示信息为蓝色背景的 Alert 组件

### 步骤 6：表单验证测试

**测试 6.1：未选择项目**
1. 不选择项目，直接勾选模板
2. 点击"确定"按钮
3. **预期结果：** 显示警告提示"请选择项目"

**测试 6.2：未选择模板**
1. 选择项目，不勾选模板
2. 点击"确定"按钮
3. **预期结果：** 显示警告提示"请至少选择一个设备系统模板"

### 步骤 7：提交关联

1. 选择项目和至少一个模板
2. 点击"确定"按钮
3. **预期结果：**
   - 按钮显示 loading 状态
   - 接口调用 `POST /erp/saltprocess/projectEquipmentSystem/create-from-templates`
   - 请求参数格式：
     ```json
     {
       "projectId": 123456,
       "templateIds": [1001, 1002]
     }
     ```

**成功场景：**
- 显示成功提示："关联成功"
- 弹窗自动关闭
- 触发父组件的 success 事件
- 父组件刷新数据列表

**失败场景：**
- 显示错误提示（显示具体错误信息）
- 弹窗保持打开状态
- 允许用户修改后重试

### 步骤 8：取消操作

1. 打开弹窗并进行一些选择
2. 点击"取消"按钮或点击弹窗外部区域
3. **预期结果：**
   - 弹窗关闭
   - 表单数据被重置
   - 不触发 success 事件

## 常见问题排查

### 问题 1：项目列表加载失败

**错误信息：** `加载项目列表失败`

**排查步骤：**
1. 打开浏览器控制台，查看具体错误信息
2. 检查接口 `GET /erp/saltprocess/project/list` 是否返回 200
3. 检查返回数据格式是否正确：
   ```json
   {
     "code": 200,
     "data": {
       "rows": [...],
       "total": 10
     }
   }
   ```
4. 检查是否有盐化项目数据

### 问题 2：模板列表加载失败

**错误信息：** `加载模板列表失败` 或 `Invalid bound statement`

**排查步骤：**
1. 检查接口 `GET /erp/saltprocess/equipmentSystemTemplate/list?status=ACTIVE`
2. 检查后端 Mapper 是否正确实现
3. 检查是否有启用状态的模板数据

### 问题 3：提交失败

**错误信息：** 各种错误

**排查步骤：**
1. 检查接口 `POST /erp/saltprocess/projectEquipmentSystem/create-from-templates`
2. 检查请求参数格式是否正确
3. 检查后端是否已实现该接口
4. 检查用户是否有相应权限
5. 检查后端日志获取详细错误信息

## 性能测试

### 大数据量测试

1. 创建 50+ 个项目
2. 创建 50+ 个启用状态的模板
3. 打开弹窗，检查加载速度
4. 选择多个模板（10+），检查提交速度

**预期结果：**
- 列表加载时间 < 2 秒
- 提交响应时间 < 5 秒
- 界面不卡顿

## 测试检查清单

- [ ] 弹窗正常打开和关闭
- [ ] 项目列表正常加载
- [ ] 模板列表正常加载
- [ ] 项目选择功能正常
- [ ] 模板多选功能正常
- [ ] 已选择提示正常显示
- [ ] 表单验证正常工作
- [ ] 提交成功流程正常
- [ ] 提交失败处理正常
- [ ] 取消操作正常
- [ ] Loading 状态正常显示
- [ ] 错误提示信息清晰
- [ ] 样式显示正常
- [ ] 响应式布局正常

## 测试完成标准

所有测试检查清单项目都通过，且：
1. 无控制台错误
2. 无 TypeScript 类型错误
3. 无 UI 显示异常
4. 功能符合需求文档

