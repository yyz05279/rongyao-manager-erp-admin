# 子系统模版子项和物料查询接口文档

## 接口信息

### 开发信息

-   **开发时间**: 2025-11-17
-   **开发人员**: AI Assistant
-   **需求来源**: 盐加工 ERP 系统设备系统模版管理需求

## 接口 1: 获取指定子系统模版下的所有子项

### 基本信息

-   **接口名称**: 获取子系统模版子项列表
-   **接口路径**: `GET /erp/saltprocess/equipmentSystemTemplate/subsystem/{subsystemTemplateId}/items`
-   **权限标识**: `erp:saltprocess:equipmentSystemTemplate:query`

### 功能描述

根据设备系统模版中与子系统的关联 ID，查询并返回该子系统下属的所有子项（Items）的详细信息列表。

### 请求参数

#### 路径参数

| 参数名              | 类型 | 必填 | 说明                                                             |
| ------------------- | ---- | ---- | ---------------------------------------------------------------- |
| subsystemTemplateId | Long | 是   | 设备系统模版与子系统的关联 ID (`erp_salt_subsystem_template.id`) |

### 响应结果

#### 成功响应 (200 OK)

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": [
        {
            "itemTemplateId": 101,
            "itemName": "电机A型",
            "itemCode": "DJ-A001",
            "specifications": "规格描述...",
            "quantity": 1.0,
            "unit": "台"
        },
        {
            "itemTemplateId": 102,
            "itemName": "传感器B型",
            "itemCode": "CGQ-B002",
            "specifications": "规格描述...",
            "quantity": 5.0,
            "unit": "个"
        }
    ]
}
```

#### 失败响应 (404 Not Found)

```json
{
    "code": 404,
    "msg": "指定的子系统模版 ID 不存在。",
    "data": null
}
```

### 使用示例

#### cURL 示例

```bash
curl -X GET "http://localhost:8080/erp/saltprocess/equipmentSystemTemplate/subsystem/1/items" \
  -H "Authorization: Bearer {token}"
```

#### JavaScript 示例

```javascript
const getSubsystemItems = async (subsystemTemplateId) => {
    const response = await fetch(
        `/erp/saltprocess/equipmentSystemTemplate/subsystem/${subsystemTemplateId}/items`,
        {
            method: "GET",
            headers: {
                Authorization: `Bearer ${token}`,
            },
        }
    );
    return await response.json();
};
```

---

## 接口 2: 获取指定子项模版下的所有物料

### 基本信息

-   **接口名称**: 获取子项模版物料列表
-   **接口路径**: `GET /erp/saltprocess/equipmentSystemTemplate/item/{itemTemplateId}/materials`
-   **权限标识**: `erp:saltprocess:equipmentSystemTemplate:query`

### 功能描述

根据设备系统模版中与子项的关联 ID，查询并返回构成该子项所需的所有物料（Materials）的详细信息列表。

### 请求参数

#### 路径参数

| 参数名         | 类型 | 必填 | 说明                                                      |
| -------------- | ---- | ---- | --------------------------------------------------------- |
| itemTemplateId | Long | 是   | 设备系统模版与子项的关联 ID (`erp_salt_item_template.id`) |

### 响应结果

#### 成功响应 (200 OK)

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": [
        {
            "materialId": 201,
            "materialName": "螺丝 M5x20",
            "materialCode": "LS-M5X20",
            "specifications": "不锈钢",
            "quantity": 20,
            "unit": "颗"
        },
        {
            "materialId": 202,
            "materialName": "轴承 6204",
            "materialCode": "ZC-6204",
            "specifications": "深沟球轴承",
            "quantity": 2,
            "unit": "个"
        }
    ]
}
```

#### 失败响应 (404 Not Found)

```json
{
    "code": 404,
    "msg": "指定的子项模版 ID 不存在。",
    "data": null
}
```

### 使用示例

#### cURL 示例

```bash
curl -X GET "http://localhost:8080/erp/saltprocess/equipmentSystemTemplate/item/101/materials" \
  -H "Authorization: Bearer {token}"
```

#### JavaScript 示例

```javascript
const getItemMaterials = async (itemTemplateId) => {
    const response = await fetch(
        `/erp/saltprocess/equipmentSystemTemplate/item/${itemTemplateId}/materials`,
        {
            method: "GET",
            headers: {
                Authorization: `Bearer ${token}`,
            },
        }
    );
    return await response.json();
};
```

---

## 技术实现

### 实现层级

-   **Controller 层**: `ErpSaltEquipmentSystemTemplateController`
    -   `getSubsystemItems()` - 获取子系统子项列表
    -   `getItemMaterials()` - 获取子项物料列表
-   **Service 层**:
    -   `IErpSaltItemTemplateService.queryBySubsystemTemplateId()`
    -   `IErpSaltMaterialTemplateService.queryByItemTemplateId()`
-   **Mapper 层**:
    -   `ErpSaltItemTemplateMapper.selectBySubsystemTemplateId()`
    -   `ErpSaltMaterialTemplateMapper.selectByItemTemplateId()`

### 数据转换

接口使用了简化的 VO 对象来返回数据，字段映射关系如下：

#### 子项数据映射

| 数据库字段       | VO 字段        | 说明        |
| ---------------- | -------------- | ----------- |
| id               | itemTemplateId | 子项模版 ID |
| item_name        | itemName       | 子项名称    |
| template_code    | itemCode       | 子项编码    |
| specification    | specifications | 规格型号    |
| default_quantity | quantity       | 默认数量    |
| default_unit     | unit           | 默认单位    |

#### 物料数据映射

| 数据库字段       | VO 字段        | 说明     |
| ---------------- | -------------- | -------- |
| id               | materialId     | 物料 ID  |
| material_name    | materialName   | 物料名称 |
| material_code    | materialCode   | 物料编码 |
| specification    | specifications | 规格型号 |
| default_quantity | quantity       | 默认数量 |
| default_unit     | unit           | 默认单位 |

### 错误处理

两个接口都实现了完善的错误处理：

1. **ID 不存在**: 返回 404 状态码和友好的错误信息
2. **权限不足**: 返回 403 状态码（由 `@SaCheckPermission` 自动处理）
3. **系统异常**: 返回 500 状态码和错误信息

### 关键代码位置

-   **Controller**: `haitang-modules/haitang-erp/src/main/java/com/haitang/erp/controller/saltprocess/ErpSaltEquipmentSystemTemplateController.java`
-   **VO 对象**:
    -   `haitang-modules/haitang-erp/src/main/java/com/haitang/erp/domain/saltprocess/vo/SubsystemItemVo.java`
    -   `haitang-modules/haitang-erp/src/main/java/com/haitang/erp/domain/saltprocess/vo/ItemMaterialVo.java`

---

## 注意事项

1. **权限要求**: 需要 `erp:saltprocess:equipmentSystemTemplate:query` 权限
2. **数据格式**: 所有响应数据格式统一为 JSON
3. **RESTful 风格**: 接口遵循 RESTful 设计规范
4. **错误处理**: 当 ID 不存在时，返回 404 状态码而不是 500
5. **数据隔离**: 查询的是设备系统模版关联的数据，遵循快照隔离机制

---

## 相关接口

-   查询设备系统模版详情: `GET /erp/saltprocess/equipmentSystemTemplate/{id}`
-   查询子系统模版详情: `GET /erp/saltprocess/equipmentSystemTemplate/subsystemTemplate/{id}`
-   修改子系统模版: `PUT /erp/saltprocess/equipmentSystemTemplate/subsystem`

---

## 开发记录

### 创建的文件

1. `SubsystemItemVo.java` - 子系统子项视图对象
2. `ItemMaterialVo.java` - 子项物料视图对象
3. 在 `ErpSaltEquipmentSystemTemplateController.java` 中添加了两个新接口

### 修改的文件

1. `ErpSaltEquipmentSystemTemplateController.java` - 添加了两个新接口和相关依赖注入

### 技术特性

-   ✅ RESTful 风格设计
-   ✅ 完善的错误处理（404 Not Found）
-   ✅ 统一的 JSON 响应格式
-   ✅ 权限控制（`@SaCheckPermission`）
-   ✅ 数据转换（Entity → VO）
-   ✅ Stream API 优化
-   ✅ 遵循快照隔离机制

---

**文档版本**: v1.0
**创建时间**: 2025-11-17
**维护团队**: 海棠开发团队
