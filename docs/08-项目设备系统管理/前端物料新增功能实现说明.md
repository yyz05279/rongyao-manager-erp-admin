# 设备系统模版物料新增功能 - 前端实现说明

## 概述

本文档说明了在设备系统模版详情模块中，物料新增功能的前端实现。该功能从基础物料库中选择物料，并将其复制为子项模板下的新物料模板。

## 实现时间

2025-11-17

## 修改的文件

### 1. API 接口文件

**文件**: `src/api/erp/saltprocess/equipment-system/template.ts`

**新增接口**:

```typescript
/**
 * 从基础物料库复制新增物料模板
 * @param itemTemplateId 子项模版ID
 * @param materialId 基础物料ID
 */
export const addEquipmentSystemItemMaterialFromBase = (
  itemTemplateId: string | number,
  materialId: string | number
): AxiosPromise<void> => {
  return request({
    url: `/erp/saltprocess/equipmentSystemTemplate/item/${itemTemplateId}/materials/from-base/${materialId}`,
    method: 'post'
  });
};
```

### 2. 组件文件

**文件**: `src/views/erp/subsystem/template/components/ItemTemplateManagement.vue`

#### 2.1 导入新的 API 函数

```typescript
import {
  getEquipmentSystemSubsystemItems,
  getEquipmentSystemItemMaterials,
  updateEquipmentSystemItemMaterial,
  deleteEquipmentSystemItemMaterials,
  addEquipmentSystemItemMaterialFromBase  // 新增
} from '@/api/erp/saltprocess/equipment-system/template';
```

#### 2.2 更新物料选择处理函数

更新 `handleMaterialsSelected` 函数，根据 `useEquipmentSystemApi` 标志选择不同的 API：

```typescript
const handleMaterialsSelected = async (materials: MaterialVO[]) => {
  try {
    // 根据模式选择不同的API
    if (props.useEquipmentSystemApi) {
      // 使用设备系统模版API - 从基础物料库复制
      const promises = materials.map(material => 
        addEquipmentSystemItemMaterialFromBase(selectedItemId.value!, material.id as number)
      );
      await Promise.all(promises);
    } else {
      // 使用子系统模版API - 批量添加
      const materialTemplates: SubsystemMaterialTemplateForm[] = materials.map(material => ({
        templateId: props.templateId,
        itemTemplateId: selectedItemId.value!,
        materialId: material.id as number,
        defaultQuantity: 1,
        isRequired: true,
        remarks: ''
      }));
      await addMaterialTemplateBatch(materialTemplates);
    }
    
    ElMessage.success(`成功添加 ${materials.length} 个物料`);
    loadMaterialList();
  } catch (error) {
    console.error('批量添加物料失败:', error);
    ElMessage.error('添加物料失败');
  }
};
```

### 3. 复用物料选择对话框

**组件**: `MaterialSelectorDialog.vue`

该组件已经存在于 `src/views/erp/subsystem/template/components/` 目录中，可以直接复用。

**功能特性**:
- 支持按物料名称、物料编码搜索
- 显示物料的详细信息（编码、名称、规格、单位、材质、制造商等）
- 支持多选
- 显示已添加状态，已添加的物料不可再选
- 分页显示

## 接口说明

### 后端接口

**接口路径**: `POST /erp/saltprocess/equipmentSystemTemplate/item/{itemTemplateId}/materials/from-base/{materialId}`

**功能**: 从基础物料库中选择一个物料，并将其复制为指定子项模板下的一个新物料模板。

**路径参数**:
- `itemTemplateId`: 子项模板 ID
- `materialId`: 基础物料 ID

**业务逻辑**:
1. 查询基础物料（从 `erp_material` 表）
2. 字段映射（将基础物料的字段复制到新的物料模板对象）
3. 生成新编码（为新的物料模板生成唯一的 `templateCode`）
4. 创建物料模板（保存到数据库）

### 物料数据来源

**接口**: `GET /erp/saltprocess/material/item/list`

**说明**: 该接口返回基础物料库中的物料列表，用于物料选择对话框。

**查询参数**:
- `pageNum`: 页码
- `pageSize`: 每页数量
- `materialName`: 物料名称（模糊查询）
- `materialCode`: 物料编码（模糊查询）

## 使用方式

在设备系统模版详情页面中，查看子系统详情时：

1. 点击子项的"查看物料"按钮
2. 在物料列表对话框中点击"添加物料"按钮
3. 在物料选择对话框中搜索并选择需要的物料
4. 点击"确定添加"按钮
5. 系统会从基础物料库复制选中的物料，创建新的物料模板

## 功能特性

✅ **从基础物料库复制**: 使用新的接口从基础物料库复制物料
✅ **数据隔离**: 每个子项模板的物料数据完全隔离
✅ **批量添加**: 支持一次选择多个物料进行批量添加
✅ **智能过滤**: 已添加的物料不可再次选择
✅ **API 模式切换**: 根据 `useEquipmentSystemApi` 自动选择正确的 API

## 注意事项

1. 物料选择对话框复用了子系统模版管理模块的组件
2. 添加物料时，系统会自动从基础物料库复制所有字段
3. 复制后的物料模板可以独立编辑，不影响基础物料
4. 所有操作都需要相应的权限（`erp:saltprocess:equipmentSystemTemplate:add`）

## 相关文档

- [设备系统模版物料编辑删除接口文档](./设备系统模版物料编辑删除接口文档.md)
- [前端物料编辑删除功能实现说明](./前端物料编辑删除功能实现说明.md)

