# 项目子项数据操作接口文档

## 文档信息

- **版本**: v2.0
- **更新日期**: 2025年1月
- **基础路径**: `/erp/saltprocess/projectEquipmentSystem`
- **认证方式**: Sa-Token权限控制
- **数据格式**: JSON

---

## 目录

1. [接口概览](#1-接口概览)
2. [查询接口](#2-查询接口)
3. [新增接口](#3-新增接口)
4. [编辑接口](#4-编辑接口)
5. [删除接口](#5-删除接口)
6. [数据模型](#6-数据模型)
7. [错误响应](#7-错误响应)

---

## 1. 接口概览

| 操作 | 方法 | 路径 | 权限标识 |
|------|------|------|---------|
| 查询列表 | GET | `/subsystem/{projectSubsystemId}/items/list` | `erp:saltprocess:projectItem:list` |
| 查询详情 | GET | `/subsystem/{projectSubsystemId}/items/{id}` | `erp:saltprocess:projectItem:query` |
| 新增子项 | POST | `/subsystem/{projectSubsystemId}/items` | `erp:saltprocess:projectItem:add` |
| 编辑子项 | PUT | `/subsystem/{projectSubsystemId}/items/{id}` | `erp:saltprocess:projectItem:edit` |
| 删除子项 | DELETE | `/subsystem/{projectSubsystemId}/items/{ids}` | `erp:saltprocess:projectItem:remove` |

---

## 2. 查询接口

### 2.1 查询项目子项列表（分页）

**接口地址**: `GET /erp/saltprocess/projectEquipmentSystem/subsystem/{projectSubsystemId}/items/list`

**权限标识**: `erp:saltprocess:projectItem:list`

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectSubsystemId | Long | 是 | 项目子系统ID |

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| pageNum | Integer | 是 | 页码（从1开始） |
| pageSize | Integer | 是 | 每页数量 |
| itemName | String | 否 | 子项名称（模糊查询） |
| itemType | String | 否 | 子项类型 |
| status | String | 否 | 状态 |

**成功响应** (200):
```json
{
  "code": 200,
  "msg": "查询成功",
  "total": 50,
  "rows": [
    {
      "id": 1,
      "projectSubsystemId": 100,
      "itemCode": "ITEM-ABC123456",
      "itemName": "冷凝器",
      "itemType": "设备",
      "specification": "型号XYZ-100",
      "quantity": 2,
      "unit": "台",
      "status": "ACTIVE",
      "sequenceNumber": 1
    }
  ]
}
```

### 2.2 查询项目子项详情

**接口地址**: `GET /erp/saltprocess/projectEquipmentSystem/subsystem/{projectSubsystemId}/items/{id}`

**权限标识**: `erp:saltprocess:projectItem:query`

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectSubsystemId | Long | 是 | 项目子系统ID |
| id | Long | 是 | 项目子项ID |

**成功响应** (200):
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "id": 1,
    "projectSubsystemId": 100,
    "projectSystemId": 10,
    "projectId": 1,
    "itemCode": "ITEM-ABC123456",
    "itemName": "冷凝器",
    "itemType": "设备",
    "specification": "型号XYZ-100",
    "description": "高效冷凝器",
    "quantity": 2,
    "unit": "台",
    "unitWeight": 150.50,
    "totalWeight": 301.00,
    "materialCount": 5,
    "status": "ACTIVE",
    "sequenceNumber": 1,
    "remarks": "备注信息"
  }
}
```

**失败响应**:
- `404`: 指定的项目子项 ID 不存在
- `403`: 子项不属于指定的项目子系统，操作被拒绝

---

## 3. 新增接口

### 3.1 新增项目子项（支持批量）

**接口地址**: `POST /erp/saltprocess/projectEquipmentSystem/subsystem/{projectSubsystemId}/items`

**权限标识**: `erp:saltprocess:projectItem:add`

**功能说明**:
- 在指定项目子系统下新增子项数据
- 验证项目子系统是否存在（数据隔离）
- 支持批量新增或单个新增
- 自动注入 `projectSubsystemId` 到子项数据

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectSubsystemId | Long | 是 | 项目子系统ID |

**请求体** (支持单个或批量):
```json
[
  {
    "itemCode": "ITEM-NEW001",
    "itemName": "新增冷凝器",
    "itemType": "设备",
    "specification": "型号XYZ-200",
    "description": "高效冷凝器",
    "quantity": 3,
    "unit": "台",
    "unitWeight": 200.00,
    "totalWeight": 600.00,
    "status": "DRAFT",
    "sequenceNumber": 10,
    "remarks": "新增备注"
  },
  {
    "itemCode": "ITEM-NEW002",
    "itemName": "新增膨胀罐",
    "itemType": "配件",
    "specification": "容量100L",
    "quantity": 1,
    "unit": "套",
    "status": "DRAFT",
    "sequenceNumber": 11
  }
]
```

**字段说明**:
| 字段名 | 类型 | 必填 | 说明 | 验证规则 |
|--------|------|------|------|---------|
| itemCode | String | 是 | 子项编码 | 最大50字符 |
| itemName | String | 是 | 子项名称 | 最大100字符 |
| itemType | String | 否 | 子项类型 | 最大50字符 |
| specification | String | 否 | 规格型号 | 最大500字符 |
| description | String | 否 | 描述 | 最大500字符 |
| quantity | BigDecimal | 否 | 数量 | ≥0.01，最多8位整数2位小数 |
| unit | String | 否 | 单位 | 最大20字符 |
| unitWeight | BigDecimal | 否 | 单重(kg) | ≥0，最多10位整数2位小数 |
| totalWeight | BigDecimal | 否 | 总重(kg) | ≥0，最多10位整数2位小数 |
| materialCount | Integer | 否 | 物料数量 | ≥0 |
| parentItemId | Long | 否 | 父子项ID | - |
| status | String | 否 | 状态 | 最大20字符 |
| sequenceNumber | Integer | 否 | 排序号 | ≥0 |
| remarks | String | 否 | 备注 | 最大500字符 |

**成功响应** (200):
```json
{
  "code": 200,
  "msg": "操作成功"
}
```

**失败响应**:
- `404`: 指定的项目子系统 ID 不存在
- `400`: 子项列表不能为空
- `400`: 参数验证失败（字段不符合规则）

**示例**:
```bash
curl -X POST "http://localhost:8080/erp/saltprocess/projectEquipmentSystem/subsystem/100/items" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '[
    {
      "itemCode": "ITEM-NEW001",
      "itemName": "新增冷凝器",
      "quantity": 3,
      "unit": "台"
    }
  ]'
```

---

## 4. 编辑接口

### 4.1 编辑项目子项

**接口地址**: `PUT /erp/saltprocess/projectEquipmentSystem/subsystem/{projectSubsystemId}/items/{id}`

**权限标识**: `erp:saltprocess:projectItem:edit`

**功能说明**:
- 更新指定项目子系统下的子项信息
- 验证子项是否属于指定的项目子系统（数据隔离）
- 自动设置 `id` 和 `projectSubsystemId`

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectSubsystemId | Long | 是 | 项目子系统ID |
| id | Long | 是 | 项目子项ID |

**请求体**:
```json
{
  "itemName": "更新后的冷凝器",
  "itemType": "设备",
  "specification": "型号XYZ-300",
  "description": "更新描述",
  "quantity": 5,
  "unit": "台",
  "unitWeight": 250.00,
  "totalWeight": 1250.00,
  "status": "ACTIVE",
  "sequenceNumber": 15,
  "remarks": "更新备注"
}
```

**注意事项**:
- ❗ 请求体中的 `id` 和 `projectSubsystemId` 会被路径参数覆盖
- ❗ 必须传入完整的数据，未传入的字段会被设置为null

**成功响应** (200):
```json
{
  "code": 200,
  "msg": "操作成功"
}
```

**失败响应**:
- `404`: 指定的项目子系统 ID 不存在
- `404`: 指定的项目子项 ID 不存在
- `403`: 子项不属于指定的项目子系统，操作被拒绝
- `400`: 参数验证失败

**示例**:
```bash
curl -X PUT "http://localhost:8080/erp/saltprocess/projectEquipmentSystem/subsystem/100/items/1" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "itemName": "更新后的冷凝器",
    "quantity": 5,
    "unit": "台"
  }'
```

---

## 5. 删除接口

### 5.1 批量删除项目子项

**接口地址**: `DELETE /erp/saltprocess/projectEquipmentSystem/subsystem/{projectSubsystemId}/items/{ids}`

**权限标识**: `erp:saltprocess:projectItem:remove`

**功能说明**:
- 删除指定项目子系统下的子项记录
- 支持批量删除（ids 可以是逗号分隔的多个ID）
- 验证所有子项是否属于指定的项目子系统（数据隔离）
- 使用逻辑删除，不影响已使用该子项的数据

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| projectSubsystemId | Long | 是 | 项目子系统ID |
| ids | String | 是 | 项目子项ID（多个用逗号分隔） |

**成功响应** (200):
```json
{
  "code": 200,
  "msg": "操作成功"
}
```

**失败响应**:
- `404`: 指定的项目子系统 ID 不存在
- `404`: 子项 ID {id} 不存在
- `403`: 子项 ID {id} 不属于指定的项目子系统，操作被拒绝

**示例**:

单个删除:
```bash
curl -X DELETE "http://localhost:8080/erp/saltprocess/projectEquipmentSystem/subsystem/100/items/1" \
  -H "Authorization: Bearer {token}"
```

批量删除:
```bash
curl -X DELETE "http://localhost:8080/erp/saltprocess/projectEquipmentSystem/subsystem/100/items/1,2,3" \
  -H "Authorization: Bearer {token}"
```

---

## 6. 数据模型

### ErpSaltProjectItemBo (请求对象)

| 字段名 | 类型 | 必填 | 说明 | 验证规则 |
|--------|------|------|------|---------|
| id | Long | 编辑时必填 | 主键ID | - |
| projectSubsystemId | Long | 是 | 项目子系统ID | 自动注入 |
| projectSystemId | Long | 是 | 项目设备系统ID | 自动注入 |
| projectId | Long | 是 | 项目ID | 自动注入 |
| templateId | Long | 否 | 子项模板ID | - |
| itemCode | String | 是 | 子项编码 | 最大50字符 |
| itemName | String | 是 | 子项名称 | 最大100字符 |
| itemType | String | 否 | 子项类型 | 最大50字符 |
| specification | String | 否 | 规格型号 | 最大500字符 |
| description | String | 否 | 描述 | 最大500字符 |
| quantity | BigDecimal | 否 | 数量 | ≥0.01 |
| unit | String | 否 | 单位 | 最大20字符 |
| unitWeight | BigDecimal | 否 | 单重(kg) | ≥0 |
| totalWeight | BigDecimal | 否 | 总重(kg) | ≥0 |
| materialCount | Integer | 否 | 物料数量 | ≥0 |
| parentItemId | Long | 否 | 父子项ID | - |
| status | String | 否 | 状态 | 最大20字符 |
| sequenceNumber | Integer | 否 | 排序号 | ≥0 |
| remarks | String | 否 | 备注 | 最大500字符 |
| version | Integer | 否 | 版本号 | 乐观锁 |

### ErpSaltProjectItemVo (响应对象)

包含所有Bo字段，额外增加：
- `createTime`: 创建时间
- `updateTime`: 更新时间

---

## 7. 错误响应

### 7.1 标准错误格式

```json
{
  "code": 404,
  "msg": "指定的项目子系统 ID 不存在。"
}
```

### 7.2 错误码说明

| HTTP状态码 | 错误码 | 说明 | 场景 |
|-----------|--------|------|------|
| 200 | 200 | 成功 | 操作成功 |
| 400 | 400 | 参数错误 | 参数验证失败 |
| 401 | 401 | 认证失败 | Token无效或过期 |
| 403 | 403 | 权限不足/数据隔离 | 无权限或跨子系统操作 |
| 404 | 404 | 资源不存在 | 子系统或子项不存在 |
| 500 | 500 | 服务器错误 | 系统内部错误 |

### 7.3 常见错误信息

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 指定的项目子系统 ID 不存在 | 子系统ID无效 | 检查子系统ID是否正确 |
| 指定的项目子项 ID 不存在 | 子项ID无效 | 检查子项ID是否正确 |
| 子项不属于指定的项目子系统，操作被拒绝 | 数据隔离验证失败 | 确认子项属于该子系统 |
| 子项列表不能为空 | 批量新增时列表为空 | 至少传入一个子项 |
| 子项编码不能为空 | 必填字段缺失 | 补充必填字段 |

---

## 8. 使用流程

### 8.1 新增子项流程

```
1. 获取项目子系统ID (projectSubsystemId)
   ↓
2. 准备子项数据（可以是单个或多个）
   ↓
3. 调用新增接口
   POST /subsystem/{projectSubsystemId}/items
   ↓
4. 系统自动验证子系统是否存在
   ↓
5. 系统自动注入 projectSubsystemId
   ↓
6. 系统逐个创建子项
   ↓
7. 返回成功响应
```

### 8.2 编辑子项流程

```
1. 获取项目子系统ID和子项ID
   ↓
2. 准备更新数据
   ↓
3. 调用编辑接口
   PUT /subsystem/{projectSubsystemId}/items/{id}
   ↓
4. 系统验证子系统和子项是否存在
   ↓
5. 系统验证子项是否属于该子系统（数据隔离）
   ↓
6. 系统更新子项数据
   ↓
7. 返回成功响应
```

### 8.3 删除子项流程

```
1. 获取项目子系统ID和子项ID（可多个）
   ↓
2. 调用删除接口
   DELETE /subsystem/{projectSubsystemId}/items/{ids}
   ↓
3. 系统验证子系统是否存在
   ↓
4. 系统逐个验证子项是否存在
   ↓
5. 系统逐个验证子项是否属于该子系统（数据隔离）
   ↓
6. 系统批量逻辑删除子项
   ↓
7. 返回成功响应
```

---

## 9. 注意事项

### 9.1 数据隔离
- ✅ 所有操作都会验证子项是否属于指定的子系统
- ✅ 跨子系统操作会返回403错误
- ✅ 确保数据安全和完整性

### 9.2 批量操作
- ✅ 新增接口支持批量添加
- ✅ 删除接口支持批量删除
- ✅ 批量操作中任何一个失败都会回滚

### 9.3 自动注入
- ✅ `projectSubsystemId` 会自动从路径参数注入
- ✅ 编辑时 `id` 会自动从路径参数注入
- ✅ 请求体中的这些字段会被覆盖

### 9.4 权限控制
- ✅ 所有接口都需要相应的权限标识
- ✅ 确保用户拥有正确的权限
- ✅ 无权限会返回403错误

---

## 10. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v2.0 | 2025-01 | 重构接口设计，增加数据隔离验证 |
| v1.0 | 2024-11 | 初始版本 |

