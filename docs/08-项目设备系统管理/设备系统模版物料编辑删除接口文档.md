# 设备系统模版物料编辑与删除接口文档

## 概述

本文档描述了设备系统模版关联物料的编辑和删除接口，用于管理子项模版下的物料模板数据。

## 接口列表

### 1. 编辑设备系统模版关联的物料数据

#### 接口信息

-   **接口路径**: `PUT /erp/saltprocess/equipmentSystemTemplate/item/{itemTemplateId}/materials/{id}`
-   **接口描述**: 更新指定子项模版下的物料模板信息
-   **权限要求**: `erp:saltprocess:equipmentSystemTemplate:edit`
-   **请求方式**: PUT
-   **Content-Type**: application/json

#### 路径参数

| 参数名         | 类型 | 必填 | 说明        |
| -------------- | ---- | ---- | ----------- |
| itemTemplateId | Long | 是   | 子项模版 ID |
| id             | Long | 是   | 物料模板 ID |

#### 请求体参数 (ErpSaltMaterialTemplateBo)

| 参数名              | 类型       | 必填 | 说明         | 校验规则                         |
| ------------------- | ---------- | ---- | ------------ | -------------------------------- |
| id                  | Long       | 是   | 主键 ID      | 不能为空                         |
| itemTemplateId      | Long       | 是   | 子项模板 ID  | 不能为空                         |
| templateCode        | String     | 是   | 物料模板编码 | 不能为空，最大 50 字符           |
| materialCode        | String     | 否   | 物料编码     | 最大 50 字符                     |
| materialName        | String     | 是   | 物料名称     | 不能为空，最大 200 字符          |
| specification       | String     | 否   | 规格型号     | -                                |
| materialType        | String     | 否   | 物料类型     | 最大 50 字符                     |
| materialCategory    | String     | 否   | 物料类别     | 最大 50 字符                     |
| defaultQuantity     | Integer    | 否   | 默认数量     | 最小值为 1                       |
| defaultUnit         | String     | 否   | 默认单位     | 最大 20 字符                     |
| estimatedUnitWeight | BigDecimal | 否   | 预估单重(kg) | 最小值为 0.00，最多 10 位 2 小数 |
| manufacturer        | String     | 否   | 制造商       | 最大 100 字符                    |
| model               | String     | 否   | 型号         | 最大 100 字符                    |
| packageType         | String     | 否   | 包装方式     | 最大 50 字符                     |
| isFragile           | Boolean    | 否   | 是否易碎     | 0-否，1-是                       |
| isHazardous         | Boolean    | 否   | 是否危险品   | 0-否，1-是                       |
| storageRequirement  | String     | 否   | 存储要求     | 最大 200 字符                    |
| sequenceNumber      | Integer    | 否   | 排序号       | 最小值为 0                       |
| status              | String     | 否   | 状态         | 最大 20 字符                     |
| remarks             | String     | 否   | 备注         | 最大 500 字符                    |

#### 请求示例

```json
{
    "id": 1990265855048286210,
    "itemTemplateId": 1990265855048286200,
    "templateCode": "MAT_TMPL_001",
    "materialCode": "MAT001",
    "materialName": "不锈钢管",
    "specification": "DN100 PN16",
    "materialType": "PIPELINE",
    "materialCategory": "管路设备",
    "defaultQuantity": 10,
    "defaultUnit": "米",
    "estimatedUnitWeight": 15.5,
    "manufacturer": "XX钢铁公司",
    "model": "304不锈钢",
    "packageType": "捆装",
    "isFragile": false,
    "isHazardous": false,
    "storageRequirement": "常温干燥",
    "sequenceNumber": 1,
    "status": "ACTIVE",
    "remarks": "用于主管路"
}
```

#### 响应参数

| 参数名 | 类型    | 说明                          |
| ------ | ------- | ----------------------------- |
| code   | Integer | 状态码（200-成功，其他-失败） |
| msg    | String  | 响应消息                      |
| data   | Object  | 响应数据（成功时为 null）     |

#### 响应示例

**成功响应**:

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

**失败响应**:

```json
{
    "code": 404,
    "msg": "指定的子项模版 ID 不存在。",
    "data": null
}
```

```json
{
    "code": 404,
    "msg": "指定的物料模板 ID 不存在。",
    "data": null
}
```

```json
{
    "code": 403,
    "msg": "物料模板不属于指定的子项模版，操作被拒绝。",
    "data": null
}
```

#### 业务逻辑

1. **验证子项模版存在性**: 检查指定的子项模版 ID 是否存在
2. **验证物料模板存在性**: 检查指定的物料模板 ID 是否存在
3. **数据隔离验证**: 验证物料模板是否属于指定的子项模版
4. **更新物料模板**: 调用 Service 层更新物料模板数据
5. **事务管理**: 使用 @Transactional 确保数据一致性
6. **日志记录**: 记录操作日志

#### 数据隔离机制

-   **逻辑隔离**: 验证物料模板的 itemTemplateId 必须与路径参数中的 itemTemplateId 一致
-   **权限隔离**: 通过 @SaCheckPermission 注解确保只有授权用户才能执行操作
-   **事务隔离**: 使用 @Transactional(rollbackFor = Exception.class) 确保数据一致性

---

### 2. 删除设备系统模版关联的物料数据

#### 接口信息

-   **接口路径**: `DELETE /erp/saltprocess/equipmentSystemTemplate/item/{itemTemplateId}/materials/{ids}`
-   **接口描述**: 删除指定子项模版下的物料模板记录，支持批量删除
-   **权限要求**: `erp:saltprocess:equipmentSystemTemplate:remove`
-   **请求方式**: DELETE

#### 路径参数

| 参数名         | 类型   | 必填 | 说明                         |
| -------------- | ------ | ---- | ---------------------------- |
| itemTemplateId | Long   | 是   | 子项模版 ID                  |
| ids            | Long[] | 是   | 物料模板 ID 数组（逗号分隔） |

#### 请求示例

**单个删除**:

```
DELETE /erp/saltprocess/equipmentSystemTemplate/item/1990265855048286200/materials/1990265855048286210
```

**批量删除**:

```
DELETE /erp/saltprocess/equipmentSystemTemplate/item/1990265855048286200/materials/1990265855048286210,1990265855048286211,1990265855048286212
```

#### 响应参数

| 参数名 | 类型    | 说明                          |
| ------ | ------- | ----------------------------- |
| code   | Integer | 状态码（200-成功，其他-失败） |
| msg    | String  | 响应消息                      |
| data   | Object  | 响应数据（成功时为 null）     |

#### 响应示例

**成功响应**:

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

**失败响应**:

```json
{
    "code": 404,
    "msg": "指定的子项模版 ID 不存在。",
    "data": null
}
```

```json
{
    "code": 404,
    "msg": "物料模板 ID 1990265855048286210 不存在。",
    "data": null
}
```

```json
{
    "code": 403,
    "msg": "物料模板 ID 1990265855048286210 不属于指定的子项模版，操作被拒绝。",
    "data": null
}
```

#### 业务逻辑

1. **验证子项模版存在性**: 检查指定的子项模版 ID 是否存在
2. **批量验证物料模板**: 遍历所有物料模板 ID，验证每个物料模板是否存在
3. **数据隔离验证**: 验证每个物料模板是否属于指定的子项模版
4. **批量删除**: 调用 Service 层批量删除物料模板（逻辑删除）
5. **事务管理**: 使用 @Transactional 确保批量操作的原子性
6. **日志记录**: 记录删除操作日志

#### 数据隔离机制

-   **逻辑隔离**: 验证每个物料模板的 itemTemplateId 必须与路径参数中的 itemTemplateId 一致
-   **权限隔离**: 通过 @SaCheckPermission 注解确保只有授权用户才能执行操作
-   **软删除**: 使用逻辑删除（del_flag=1），不影响已引用该模板的项目实例

---

## 技术实现

### 实现层级

-   **Controller 层**: `ErpSaltEquipmentSystemTemplateController`
    -   `updateItemMaterial()` - 编辑物料模板
    -   `removeItemMaterials()` - 删除物料模板
-   **Service 层**: `IErpSaltMaterialTemplateService`
    -   `updateByBo()` - 更新物料模板
    -   `deleteWithValidByIds()` - 批量删除物料模板
-   **Mapper 层**: `ErpSaltMaterialTemplateMapper`
    -   `updateById()` - 更新数据库记录
    -   `deleteBatchIds()` - 批量删除数据库记录（逻辑删除）

### 数据流转换

```
前端请求 (JSON)
    ↓ Controller接收
ErpSaltMaterialTemplateBo (业务参数对象)
    ↓ Service.Convert.toEntity()
ErpSaltMaterialTemplate (数据库实体对象)
    ↓ Mapper数据库操作
数据库记录更新/删除
    ↓ 返回操作结果
Boolean (成功/失败)
    ↓ Controller.toAjax()
R<Void> (统一响应对象)
    ↓ 前端响应 (JSON)
```

### 异常处理

-   **ServiceException**: 业务异常，如物料模板不存在、数据隔离验证失败等
-   **事务回滚**: 当发生异常时，通过 @Transactional(rollbackFor = Exception.class) 自动回滚
-   **日志记录**: 使用 @Slf4j 记录关键操作和异常信息

---

## 使用示例

### JavaScript 示例

#### 编辑物料模板

```javascript
const updateItemMaterial = async (itemTemplateId, materialId, data) => {
    const response = await fetch(
        `/erp/saltprocess/equipmentSystemTemplate/item/${itemTemplateId}/materials/${materialId}`,
        {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(data),
        }
    );
    return await response.json();
};

// 使用示例
const result = await updateItemMaterial(
    1990265855048286200,
    1990265855048286210,
    {
        id: 1990265855048286210,
        itemTemplateId: 1990265855048286200,
        templateCode: "MAT_TMPL_001",
        materialName: "不锈钢管",
        specification: "DN100 PN16",
        defaultQuantity: 10,
        defaultUnit: "米",
    }
);
```

#### 删除物料模板

```javascript
const removeItemMaterials = async (itemTemplateId, materialIds) => {
    const idsParam = Array.isArray(materialIds)
        ? materialIds.join(",")
        : materialIds;

    const response = await fetch(
        `/erp/saltprocess/equipmentSystemTemplate/item/${itemTemplateId}/materials/${idsParam}`,
        {
            method: "DELETE",
            headers: {
                Authorization: `Bearer ${token}`,
            },
        }
    );
    return await response.json();
};

// 单个删除
const result1 = await removeItemMaterials(
    1990265855048286200,
    1990265855048286210
);

// 批量删除
const result2 = await removeItemMaterials(
    1990265855048286200,
    [1990265855048286210, 1990265855048286211, 1990265855048286212]
);
```

---

## 注意事项

1. **权限要求**:

    - 编辑接口需要 `erp:saltprocess:equipmentSystemTemplate:edit` 权限
    - 删除接口需要 `erp:saltprocess:equipmentSystemTemplate:remove` 权限

2. **数据隔离**:

    - 所有操作都会验证物料模板是否属于指定的子项模版
    - 跨子项模版的操作会被拒绝（返回 403 状态码）

3. **逻辑删除**:

    - 删除操作使用逻辑删除（del_flag=1）
    - 不会物理删除数据库记录
    - 已引用该模板的项目实例不受影响

4. **事务管理**:

    - 所有操作都在事务中执行
    - 发生异常时自动回滚

5. **防重复提交**:

    - 编辑接口使用 @RepeatSubmit() 注解防止重复提交

6. **参数校验**:
    - 使用 @Validated(EditGroup.class) 进行参数校验
    - 必填字段不能为空
    - 字符串长度、数值范围等都有校验规则

---

## 相关接口

-   查询子项物料列表: `GET /erp/saltprocess/equipmentSystemTemplate/item/{itemTemplateId}/materials`
-   查询设备系统模版详情: `GET /erp/saltprocess/equipmentSystemTemplate/{id}`
-   修改子系统模版: `PUT /erp/saltprocess/equipmentSystemTemplate/subsystem`

---

## 开发记录

### 实现的功能

1. 编辑设备系统模版关联的物料数据
2. 删除设备系统模版关联的物料数据（支持批量删除）
3. 数据隔离验证机制
4. 完整的异常处理和日志记录

### 技术特性

-   **RESTful API 设计**: 遵循 REST API 设计规范
-   **数据隔离**: 验证物料模板是否属于指定的子项模版
-   **权限控制**: 使用 Sa-Token 进行权限验证
-   **事务管理**: 使用 Spring @Transactional 注解
-   **防重复提交**: 使用自定义@RepeatSubmit 注解
-   **参数校验**: 使用 JSR-303 Bean Validation
-   **日志记录**: 使用@Log 注解记录操作日志
-   **逻辑删除**: 使用 MyBatis-Plus 的@TableLogic 注解

### 遵循的编码规范

-   严格遵循《海棠 ERP 系统项目编码规范》
-   Controller 层薄层设计，只负责接收请求和返回响应
-   Service 层处理业务逻辑和数据转换
-   Mapper 层只处理数据库操作
-   完整的异常处理和日志记录
-   RESTful API 路径设计

---

## 版本历史

| 版本 | 日期       | 作者    | 说明                                 |
| ---- | ---------- | ------- | ------------------------------------ |
| 1.0  | 2025-01-17 | haitang | 初始版本，实现物料模板编辑和删除接口 |

### 3. 从基础物料库复制新增物料模板

#### 接口信息

-   **接口路径**: `POST /erp/saltprocess/equipmentSystemTemplate/item/{itemTemplateId}/materials/from-base/{materialId}`
-   **接口描述**: 从基础物料库中选择一个物料，并将其复制为指定子项模板下的一个新物料模板。
-   **权限要求**: `erp:saltprocess:equipmentSystemTemplate:add`
-   **请求方式**: POST

#### 路径参数

| 参数名         | 类型 | 必填 | 说明        |
| -------------- | ---- | ---- | ----------- |
| itemTemplateId | Long | 是   | 子项模板 ID |
| materialId     | Long | 是   | 基础物料 ID |

#### 请求体参数

无

#### 响应参数

| 参数名 | 类型    | 说明                          |
| ------ | ------- | ----------------------------- |
| code   | Integer | 状态码（200-成功，其他-失败） |
| msg    | String  | 响应消息                      |
| data   | Object  | 响应数据（成功时为 null）     |

#### 响应示例

**成功响应**:

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": null
}
```

**失败响应**:

```json
{
    "code": 500,
    "msg": "基础物料不存在，ID: 999",
    "data": null
}
```

#### 业务逻辑

1.  **查询基础物料**: 根据 `materialId` 从 `erp_material` 表中查询物料信息。
2.  **字段映射**: 将基础物料的字段（如名称、规格、类型等）复制到新的物料模板对象中。
3.  **生成新编码**: 为新的物料模板生成一个唯一的 `templateCode`。
4.  **创建物料模板**: 调用 `insertByBo` 方法将新的物料模板保存到数据库中。