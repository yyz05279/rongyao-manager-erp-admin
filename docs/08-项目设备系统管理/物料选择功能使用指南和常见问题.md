# 物料选择功能使用指南和常见问题

## 使用流程

### 正确的操作步骤

1. **打开物料详情对话框**
   - 在子项列表中点击"查看物料"按钮
   - 此时会显示该子项下的所有物料

2. **点击"添加物料"按钮**
   - 在物料详情对话框中点击"添加物料"按钮
   - 打开物料选择器对话框

3. **搜索和选择物料**
   - 可以按物料名称或编码搜索
   - 已添加的物料显示为"已添加"状态，不可选择
   - 支持多选物料

4. **确认选择**
   - 点击"确定添加"按钮
   - 系统会调用 API 批量保存物料
   - 物料列表自动刷新

## 常见问题

### 问题 1：提示"项目子项ID不能为空"

**错误信息：**
```json
{
  "code": 500,
  "msg": "项目子项ID不能为空",
  "data": null
}
```

**原因：**
- 在物料详情对话框打开前，没有选择子项
- 或者物料详情对话框关闭后再打开物料选择器

**解决方案：**
1. 确保在子项列表中点击了"查看物料"按钮
2. 确保物料详情对话框是打开状态
3. 在物料详情对话框中点击"添加物料"按钮

### 问题 2：物料选择器中没有显示物料

**原因：**
- 物料库中没有物料
- 搜索条件过于严格
- 网络连接问题

**解决方案：**
1. 检查物料库中是否有物料
2. 尝试清除搜索条件，点击"重置"按钮
3. 检查网络连接

### 问题 3：已添加的物料仍然可以选择

**原因：**
- 物料编码不匹配
- 物料列表未正确刷新

**解决方案：**
1. 关闭物料选择器，重新打开
2. 刷新页面后重试
3. 检查物料编码是否正确

## 调试技巧

### 查看浏览器控制台日志

打开浏览器开发者工具（F12），查看 Console 标签页：

**添加物料时的日志：**
```
=== handleMaterialsSelected 被调用 ===
接收到的物料数量: 1
接收到的物料数据: [...]
当前选中的子项ID: 1001
准备提交的物料数据: [...]
调用 batchSaveProjectMaterials，参数：{projectItemId: 1001, materialsCount: 1}
```

**如果看到以下日志说明有问题：**
```
当前选中的子项ID: null
```

这表示没有正确选择子项。

### 检查 API 请求

在浏览器开发者工具的 Network 标签页中：

1. 查看请求 URL：
   ```
   POST /erp/saltprocess/projectEquipmentSystem/item/1001/materials/batch
   ```

2. 查看请求体（Request Payload）：
   ```json
   [
     {
       "materialCode": "MAT-001",
       "materialName": "垂直下弯通",
       "quantity": 1,
       ...
     }
   ]
   ```

3. 查看响应状态：
   - 200 - 成功
   - 400 - 参数错误
   - 404 - 资源不存在
   - 500 - 服务器错误

## 数据流转说明

### 添加物料的完整流程

```
用户界面
  ↓
点击"添加物料"按钮
  ↓
handleAddMaterialInDialog()
  ↓
打开 MaterialSelectorDialog
  ↓
用户选择物料
  ↓
点击"确定添加"
  ↓
emit confirm 事件
  ↓
handleMaterialsSelected(materials)
  ↓
验证 selectedItemId
  ↓
转换物料数据格式
  ↓
调用 batchSaveProjectMaterials(projectItemId, data)
  ↓
API 请求
  ↓
后端处理
  ↓
返回结果
  ↓
刷新物料列表
  ↓
显示成功提示
```

## 关键变量说明

### selectedItemId
- **类型：** `string | number | null`
- **说明：** 当前选中的子项 ID
- **何时设置：** 用户在子项列表中点击"查看物料"按钮时
- **何时清空：** 物料详情对话框关闭时

### selectedItemName
- **类型：** `string`
- **说明：** 当前选中的子项名称
- **用途：** 显示在物料详情对话框的标题中

### materialList
- **类型：** `ProjectItemMaterialVO[]`
- **说明：** 当前子项下的物料列表
- **何时更新：** 调用 loadMaterialList() 时

### existingMaterialCodes
- **类型：** `string[]`
- **说明：** 已添加物料的编码列表
- **用途：** 传递给物料选择器，标记已添加的物料

## 最佳实践

### 1. 始终检查子项选择
```typescript
if (!selectedItemId.value) {
  ElMessage.error('请先在物料列表中选择一个子项');
  return;
}
```

### 2. 提供清晰的用户反馈
- 操作前：显示加载状态
- 操作中：显示进度提示
- 操作后：显示成功/失败消息

### 3. 处理所有可能的错误
- 网络错误
- 参数验证错误
- 权限错误
- 业务逻辑错误

### 4. 记录详细的调试日志
- 记录关键步骤
- 记录输入参数
- 记录 API 响应

## 性能优化建议

1. **分页加载物料**
   - 物料库可能很大
   - 使用分页加载提高性能

2. **搜索优化**
   - 支持模糊搜索
   - 支持多条件搜索

3. **缓存已选物料**
   - 避免重复查询
   - 提高用户体验

## 后续改进

1. 支持物料快速编辑
2. 支持物料批量编辑
3. 支持物料导入/导出
4. 支持物料模板预设
5. 支持物料历史记录

## 总结

正确使用物料选择功能的关键是：

1. ✅ 先选择子项（点击"查看物料"）
2. ✅ 再打开物料选择器（点击"添加物料"）
3. ✅ 选择物料并确认
4. ✅ 等待 API 响应和列表刷新

如果遇到问题，请查看浏览器控制台的日志，确认 `selectedItemId` 是否正确设置。

