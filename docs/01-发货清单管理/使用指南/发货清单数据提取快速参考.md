# 发货清单数据提取快速参考

## 快速开始

### 1. 导入工具函数

```typescript
import {
  extractExcelMetadata,
  assignEquipmentTypes,
  assignSubsystems,
  assignShippingTypes
} from '@/api/erp/saltprocess/shipping/excel-parser';
```

### 2. Excel 数据格式

```
第1行：淮安化盐系统-发货清单（机械）       ← 标题，提取"机械"
第2行：一、固态处理厂                      ← 子系统，提取"固态处理厂"
第3行起：数据行
```

### 3. 提取元数据（一行代码）

```typescript
const metadata = extractExcelMetadata({
  title: '淮安化盐系统-发货清单（机械）',
  secondRow: '一、固态处理厂',
  sheetName: '第一批设备'
});

// 返回：
// {
//   shippingType: '机械',
//   equipmentType: 'MECHANICAL',
//   subsystem: '固态处理厂',
//   sheetName: '第一批设备'
// }
```

### 4. 批量分配到明细（三行代码）

```typescript
items = assignEquipmentTypes(items, metadata.equipmentType);
items = assignSubsystems(items, metadata.subsystem);
items = assignShippingTypes(items, metadata.shippingType);
```

### 5. 构建请求体

```typescript
const request = {
  projectId: '1',
  shippingType: metadata.shippingType,        // ✅ 主表级别
  subsystem: metadata.subsystem,              // ✅ 主表级别
  shippingItems: items                        // ✅ 已包含 shippingType 和 subsystem
};
```

## 完整示例

```typescript
// 1. 解析 Excel（使用 XLSX 库）
const workbook = XLSX.read(fileData);
const sheetName = workbook.SheetNames[0];        // ✅ 从 Excel 获取 Sheet 名称（如："第一车"）
const sheet = workbook.Sheets[sheetName];
const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

// 2. 提取元数据
const metadata = extractExcelMetadata({
  title: jsonData[0][0],
  secondRow: jsonData[1][0],
  sheetName: sheetName                          // ✅ 使用从 Excel 提取的 Sheet 名称
});

// 3. 解析明细数据
let items = jsonData.slice(2).map(row => ({
  equipmentName: row[1],
  quantity: row[3],
  unit: row[4]
}));

// 4. 批量分配元数据
items = assignEquipmentTypes(items, metadata.equipmentType);
items = assignSubsystems(items, metadata.subsystem);
items = assignShippingTypes(items, metadata.shippingType);
// 为每个明细添加 sheetName
items = items.map(item => ({
  ...item,
  sheetName: metadata.sheetName                 // ✅ 所有明细都包含 Sheet 名称
}));

// 5. 调用接口
await importEnhancedShippingList({
  projectId: '1',
  shippingType: metadata.shippingType,
  subsystem: metadata.subsystem,
  responsiblePersonId: 1,
  shippingDate: '2025-01-15',
  shippingItems: items                          // ✅ 每个明细都包含 sheetName: "第一车"
});
```

## 常见场景

### 场景 1：标题提取发货类型

| Excel 标题                      | 提取结果 |
| ------------------------------- | -------- |
| `淮安化盐系统-发货清单（机械）` | `机械`   |
| `发货清单【电控】`              | `电控`   |
| `管路设备清单`                  | `管路`   |

### 场景 2：第二行提取子系统

| Excel 第二行       | 提取结果     |
| ------------------ | ------------ |
| `一、固态处理厂`   | `固态处理厂` |
| `1、固态处理厂`    | `固态处理厂` |
| `（一）固态处理厂` | `固态处理厂` |
| `固态处理厂`       | `固态处理厂` |

### 场景 3：多个 Sheet 处理

```typescript
// 处理 Excel 文件中的所有 Sheet
const workbook = XLSX.read(fileData);

// 遍历所有 Sheet
for (const sheetName of workbook.SheetNames) {
  console.log('正在处理 Sheet:', sheetName);  // 输出："第一车"、"第二车"等

  const sheet = workbook.Sheets[sheetName];
  const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  // 为每个 Sheet 独立提取元数据
  const metadata = extractExcelMetadata({
    title: jsonData[0][0],
    secondRow: jsonData[1][0],
    sheetName: sheetName                        // ✅ 每个 Sheet 独立的名称
  });

  // 处理该 Sheet 的数据...
  let items = jsonData.slice(2).map(row => ({
    equipmentName: row[1],
    quantity: row[3],
    unit: row[4]
  }));

  // 批量分配元数据
  items = assignEquipmentTypes(items, metadata.equipmentType);
  items = assignSubsystems(items, metadata.subsystem);
  items = assignShippingTypes(items, metadata.shippingType);
  items = items.map(item => ({
    ...item,
    sheetName: sheetName                        // ✅ 每个明细都标记来自哪个 Sheet
  }));

  // 导入该批次数据
  await importEnhancedShippingList({
    projectId: '1',
    batchNumber: sheetName,                     // ✅ 使用 Sheet 名称作为批次号
    shippingType: metadata.shippingType,
    subsystem: metadata.subsystem,
    shippingDate: '2025-01-15',
    shippingItems: items
  });

  console.log(`Sheet "${sheetName}" 导入完成`);
}
```

| 中文     | 枚举值           |
| -------- | ---------------- |
| 机械     | `MECHANICAL`     |
| 电控     | `ELECTRICAL`     |
| 管路     | `PIPELINE`       |
| 燃烧器   | `BURNER`         |
| 辅助设备 | `AUXILIARY`      |
| 标准件   | `STANDARD_PARTS` |

## API 请求数据结构

```json
{
  "projectId": "1",
  "shippingType": "机械",              // ✅ 主表级别-从标题提取
  "subsystem": "固态处理厂",            // ✅ 主表级别-从第二行提取
  "responsiblePersonId": 1,
  "shippingDate": "2025-01-15",
  "shippingItems": [
    {
      "equipmentName": "螺旋给料机",
      "quantity": 2,
      "unit": "台",
      "shippingType": "机械",         // ✅ 明细级别-可选
      "equipmentType": "MECHANICAL",  // ✅ 明细级别-可选
      "subsystem": "固态处理厂",       // ✅ 明细级别-可选
      "sheetName": "第一批设备"        // ✅ 明细级别-可选
    }
  ]
}
```

## 字段说明

### 主表级别字段（可选）

- `shippingType` - 发货类型（中文），如：`机械`、`电控`
- `subsystem` - 子系统，如：`固态处理厂`

### 明细级别字段（可选）

- `shippingType` - 发货类型（中文），继承主表或独立设置
- `equipmentType` - 设备类型（枚举），如：`MECHANICAL`
- `subsystem` - 子系统，继承主表或独立设置
- `sheetName` - **Excel Sheet 标签名称**（如：`第一车`、`第二车`）

**重要说明**：

- `sheetName` 从 Excel 文件的 Sheet 标签中提取，不是手动输入
- 获取方式：`workbook.SheetNames[0]` 或遍历 `workbook.SheetNames`
- 用途：标记每个明细数据来自哪个 Sheet，便于追溯和管理

## 优先级规则

**明细级别 > 主表级别 > 默认值**

```typescript
// 示例：部分明细覆盖主表设置
const items = [
  {
    equipmentName: '设备A',
    // shippingType 未设置，将使用主表的"机械"
  },
  {
    equipmentName: '设备B',
    shippingType: '电控'  // ✅ 明细覆盖主表设置
  }
];

items = assignShippingTypes(items, '机械');

// 结果：
// items[0].shippingType = '机械'  (继承主表)
// items[1].shippingType = '电控'  (保持明细设置)
```

## 注意事项

1. **所有新增字段都是可选的**，不影响现有功能
2. **自动清理前缀**：`一、`、`1、`、`（一）` 等会被自动移除
3. **类型安全**：使用 TypeScript 类型定义，编译时检查
4. **向后兼容**：保留了原有的接口结构

## 相关文档

- [完整使用指南](./发货清单Excel数据提取使用指南.md)
- [优化实现总结](./发货类型获取优化实现总结.md)
- [API 接口文档](./发货清清单导入API接口设计.md)

## 常见问题

**Q: 如果 Excel 标题没有括号怎么办？**

A: 工具会尝试关键词匹配，如标题包含"机械"、"电控"等关键词也能识别。

**Q: 第二行数据格式不标准怎么办？**

A: 工具支持多种格式，包括带前缀、不带前缀、对象格式等。

**Q: sheetName 从哪里获取？**

A: **从 Excel 文件的 Sheet 标签中获取**，不是手动输入！

```typescript
const workbook = XLSX.read(fileData);
const sheetName = workbook.SheetNames[0];  // 例如："第一车"、"第二车"

// 传入 extractExcelMetadata
const metadata = extractExcelMetadata({
  title: jsonData[0][0],
  secondRow: jsonData[1][0],
  sheetName: sheetName                     // ✅ 使用从 Excel 提取的名称
});

// 所有明细都添加 sheetName
items = items.map(item => ({
  ...item,
  sheetName: sheetName                     // ✅ 每个明细都标记来自哪个 Sheet
}));
```

**Q: 明细想要不同的设备类型怎么办？**

A: 在明细中直接设置 `shippingType` 或 `equipmentType` 字段即可覆盖主表设置。

**Q: 多个 Sheet 如何处理？**

A: 遍历 `workbook.SheetNames`，为每个 Sheet 独立提取元数据并处理（参见场景 3）。

## 快速测试

```typescript
// 测试元数据提取
const testCases = [
  {
    input: { title: '淮安化盐系统-发货清单（机械）', secondRow: '一、固态处理厂' },
    expected: { shippingType: '机械', subsystem: '固态处理厂' }
  },
  {
    input: { title: '发货清单【电控】', secondRow: '1、固态处理厂' },
    expected: { shippingType: '电控', subsystem: '固态处理厂' }
  }
];

testCases.forEach(testCase => {
  const result = extractExcelMetadata(testCase.input);
  console.log('输入:', testCase.input);
  console.log('输出:', result);
  console.log('预期:', testCase.expected);
  console.log('---');
});
```

---

**提示**: 这是一个快速参考文档，详细说明请查看完整使用指南。
