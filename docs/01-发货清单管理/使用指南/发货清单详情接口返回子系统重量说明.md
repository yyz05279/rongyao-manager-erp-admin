# 发货清单详情接口返回子系统重量说明

## 更新日期

2025 年 10 月 30 日

## 功能说明

发货清单详情接口现在会返回子系统重量数组信息。

## API 接口

### 查询发货清单详情

**请求**：

```
GET /erp/saltprocess/shipping/{id}
```

**响应示例**：

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "id": 1,
        "listCode": "SP20250916D78E-SL-001",
        "projectId": 1,
        "projectName": "测试项目",
        "batchNumber": "第一车",
        "totalWeight": 14.5,
        "totalVolume": 10.5,

        // 新增：子系统重量数组
        "subsystemWeights": [
            {
                "subsystem": "固态处理厂-机械",
                "weight": 14.5,
                "remarks": "平面输送机+粉碎机总重"
            },
            {
                "subsystem": "液态处理厂-电控",
                "weight": 3.2,
                "remarks": "电控柜总重"
            }
        ],

        // 发货明细列表
        "items": [
            {
                "id": 1001,
                "itemName": "平面输送机-输送主体",
                "quantity": 2,
                "unit": "套",
                "subsystem": "固态处理厂-机械"
            }
        ]
    }
}
```

## 数据结构

### SubsystemWeightVo

| 字段      | 类型       | 说明       |
| --------- | ---------- | ---------- |
| subsystem | String     | 子系统名称 |
| weight    | BigDecimal | 重量（吨） |
| remarks   | String     | 备注       |

## 业务逻辑

1. **有子系统重量数据时**：

    - 返回完整的子系统重量数组
    - 前端可以展示每个子系统的重量分布

2. **无子系统重量数据时**：

    - 返回空数组 `[]`
    - 表示该发货清单导入时未使用子系统重量功能

3. **数据来源**：
    - 从数据库 `subsystem_weights` 字段读取（JSON 格式）
    - 自动解析为对象数组返回

## 前端使用示例

### Vue 3 + TypeScript

```typescript
import { ref } from "vue";
import { getShippingListDetail } from "@/api/shipping";

interface SubsystemWeight {
    subsystem: string;
    weight: number;
    remarks: string;
}

interface ShippingListDetail {
    id: number;
    listCode: string;
    batchNumber: string;
    subsystemWeights: SubsystemWeight[];
    // ... 其他字段
}

const detail = ref<ShippingListDetail | null>(null);

const loadDetail = async (id: number) => {
    const response = await getShippingListDetail(id);
    detail.value = response.data;

    // 展示子系统重量信息
    if (
        detail.value.subsystemWeights &&
        detail.value.subsystemWeights.length > 0
    ) {
        console.log("子系统重量分布：");
        detail.value.subsystemWeights.forEach((sw) => {
            console.log(`${sw.subsystem}: ${sw.weight}吨`);
        });
    }
};
```

### 前端展示

```vue
<template>
    <el-card>
        <h3>发货清单详情</h3>

        <!-- 子系统重量信息 -->
        <div v-if="detail.subsystemWeights?.length > 0">
            <h4>子系统重量分布</h4>
            <el-table :data="detail.subsystemWeights">
                <el-table-column prop="subsystem" label="子系统" />
                <el-table-column prop="weight" label="重量（吨）" />
                <el-table-column prop="remarks" label="备注" />
            </el-table>
        </div>

        <!-- 发货明细 -->
        <div>
            <h4>发货明细</h4>
            <el-table :data="detail.items">
                <el-table-column prop="itemName" label="物品名称" />
                <el-table-column prop="quantity" label="数量" />
                <el-table-column prop="subsystem" label="所属子系统" />
            </el-table>
        </div>
    </el-card>
</template>
```

## 技术实现

### VO 类定义

```java
public class ErpShippingListVo {
    // ... 其他字段

    /**
     * 子系统重量映射列表
     */
    private List<SubsystemWeightVo> subsystemWeights;

    @Data
    public static class SubsystemWeightVo {
        private String subsystem;    // 子系统名称
        private BigDecimal weight;   // 重量（吨）
        private String remarks;      // 备注
    }
}
```

### Service 层实现

```java
@Override
public ErpShippingListVo queryById(Long id) {
    ErpShippingList entity = baseMapper.selectById(id);
    ErpShippingListVo vo = ErpShippingListConvert.INSTANCE.toVo(entity);

    // 解析子系统重量JSON字符串为对象列表
    vo.setSubsystemWeights(parseSubsystemWeights(entity.getSubsystemWeights()));

    return vo;
}

private List<ErpShippingListVo.SubsystemWeightVo> parseSubsystemWeights(String json) {
    if (json == null || json.trim().isEmpty()) {
        return new ArrayList<>();
    }

    try {
        return objectMapper.readValue(json,
            new TypeReference<List<ErpShippingListVo.SubsystemWeightVo>>() {});
    } catch (JsonProcessingException e) {
        log.error("解析子系统重量JSON失败", e);
        return new ArrayList<>();
    }
}
```

## 应用场景

### 场景 1：查看发货清单概览

前端可以通过 `subsystemWeights` 数组快速了解这批货物的子系统重量分布，无需遍历所有明细项。

### 场景 2：数据统计分析

可以按子系统维度统计各个子系统的发货情况：

```typescript
const analyzeBySubsystem = (detail: ShippingListDetail) => {
    if (!detail.subsystemWeights) return;

    detail.subsystemWeights.forEach((sw) => {
        const itemsInSubsystem = detail.items.filter(
            (item) => item.subsystem === sw.subsystem
        );

        console.log(`${sw.subsystem}：`);
        console.log(`  总重量：${sw.weight}吨`);
        console.log(`  明细数：${itemsInSubsystem.length}条`);
    });
};
```

### 场景 3：验证数据一致性

可以对比子系统重量和明细项重量，验证数据一致性：

```typescript
const validateWeight = (detail: ShippingListDetail) => {
    if (!detail.subsystemWeights?.length) return true;

    const subsystemTotal = detail.subsystemWeights.reduce(
        (sum, sw) => sum + sw.weight,
        0
    );

    // 注意：totalWeight 单位是kg，subsystemWeights 单位是吨
    const expected = subsystemTotal * 1000;

    return Math.abs(detail.totalWeight - expected) < 0.01;
};
```

## 注意事项

### 1. 数据兼容性

-   旧数据（导入前未使用子系统重量功能）：`subsystemWeights` 返回空数组 `[]`
-   新数据（使用子系统重量功能）：返回完整的子系统重量数组

### 2. 单位转换

-   `subsystemWeights` 中的 `weight` 单位是**吨**
-   `totalWeight` 字段单位是 **kg**
-   转换关系：`总重量(kg) = 子系统重量之和(吨) × 1000`

### 3. 空值处理

```typescript
// 推荐的空值处理方式
if (detail.subsystemWeights && detail.subsystemWeights.length > 0) {
    // 处理子系统重量数据
} else {
    // 该发货清单未使用子系统重量功能
}
```

### 4. JSON 解析异常

如果数据库中的 JSON 格式错误，Service 层会：

-   记录错误日志
-   返回空数组
-   不影响其他数据的正常返回

## 相关文档

-   [发货清单子系统重量功能使用文档](./发货清单子系统重量功能使用文档.md)
-   [发货清单子系统重量功能开发总结](./发货清单子系统重量功能开发总结.md)
-   [发货清单子系统重量字段实施指南](./发货清单子系统重量字段实施指南.md)

## 修改记录

| 日期       | 版本 | 修改内容                               |
| ---------- | ---- | -------------------------------------- |
| 2025-10-30 | v1.1 | 详情接口新增返回 subsystemWeights 字段 |

---

**技术支持**：如有问题，请联系开发团队。
