# 发货清单重量数据上传修复说明

## 问题描述

在上传发货清单 Excel 数据时，重量数据没有被正确上传到后端，导致：

- `totalWeight` 字段值为 `"0.00"`
- 明细项的 `unitWeight` 和 `totalWeight` 字段为空或零

## 问题根因

### 1. 字段名称不匹配

Excel 文件中的重量列表头使用了**带括号的完整名称**：

```
┌────┬──────────┬────────┬──────────┐
│序号│  名称    │  分项  │重量（吨）│  <--- 注意：使用中文全角括号
├────┼──────────┼────────┼──────────┤
│ 1  │平面输送机│输送主体│   7.0    │
└────┴──────────┴────────┴──────────┘
```

但是代码中只查找了 `detail.重量` 字段：

```typescript
// ❌ 原始代码（有问题）
const convertEquipmentDetails = (): EnhancedShippingItemForm[] => {
  parsedData.value.equipmentDetails.forEach(sheet => {
    sheet.data.forEach(detail => {
      allItems.push({
        weight: detail.重量,  // ⚠️ 只查找 "重量"，找不到 "重量（吨）"
        // ...
      });
    });
  });
};
```

### 2. Excel 解析器按原样保留表头

`EnhancedShippingExcelParser` 解析时会保留 Excel 表头的原始名称：

```typescript
// enhanced-shipping-excel-parser.ts (第329-333行)
headers.forEach((header, index) => {
  if (header && row[index] !== undefined) {
    const cleanHeader = header.trim();  // 只去除空格，保留括号
    record[cleanHeader] = row[index];    // 字段名 = "重量（吨）"
  }
});
```

这导致解析出来的数据结构为：

```javascript
{
  "序号": 1,
  "名称": "平面输送机",
  "分项": "输送主体",
  "数量": 2,
  "单位": "套",
  "重量（吨）": 7.0,  // ✅ 字段名包含括号
  "备注": ""
}
```

但代码查找的是：

```typescript
detail.重量  // ❌ 找不到，返回 undefined
```

## 解决方案

### 修改方案

支持多种可能的重量字段名称，提高兼容性：

```typescript
// ✅ 修复后的代码
const convertEquipmentDetails = (): EnhancedShippingItemForm[] => {
  const allItems: EnhancedShippingItemForm[] = [];

  parsedData.value.equipmentDetails.forEach(sheet => {
    sheet.data.forEach(detail => {
      // 🔥 支持多种可能的重量字段名称
      const weight = detail.重量
        || detail['重量（吨）']  // 中文全角括号
        || detail['重量(吨)']    // 英文半角括号
        || detail.重量吨         // 无括号变体
        || undefined;            // 默认值

      allItems.push({
        sequenceNo: detail.序号,
        equipmentName: detail.名称 || '',
        subItemName: detail.分项,
        quantity: detail.数量 || 0,
        unit: detail.单位 || '套',
        weight: weight,  // ✅ 使用动态提取的重量值
        specification: detail.分项 || '',
        equipmentType: inferEquipmentType(detail.名称 || ''),
        remarks1: detail.备注,
        remarks: detail.备注
      });
    });
  });

  return allItems;
};
```

### 调试日志增强

添加详细的日志输出，方便排查问题：

```typescript
// 4. 转换设备明细数据
const shippingItems = convertEquipmentDetails();

// 🔍 调试日志：检查重量数据是否正确提取
console.log('=== 设备明细数据检查 ===');
console.log('总数量:', shippingItems.length);
const itemsWithWeight = shippingItems.filter(item => item.weight);
console.log('包含重量数据的项:', itemsWithWeight.length);

if (itemsWithWeight.length > 0) {
  console.log('重量数据示例:', itemsWithWeight.slice(0, 3).map(item => ({
    名称: item.equipmentName,
    重量: item.weight,
    单位: '吨'
  })));
} else {
  console.warn('⚠️ 没有提取到任何重量数据！');
  console.log('原始数据示例:', parsedData.value.equipmentDetails.slice(0, 1).map(sheet => ({
    sheetName: sheet.sheetName,
    字段名: Object.keys(sheet.data[0] || {})
  })));
}
```

## 修复文件

### 修改的文件

1. **`src/views/erp/saltprocess/shipping/components/EnhancedShippingImportDialog.vue`**
   - 修改 `convertEquipmentDetails()` 函数
   - 添加调试日志

### 影响范围

- ✅ 不影响其他功能
- ✅ 向后兼容（仍然支持 "重量" 字段）
- ✅ 提高容错性（支持多种表头格式）

## 测试验证

### 测试步骤

1. **准备测试 Excel 文件**

   - 包含 "重量（吨）" 列
   - 包含实际的重量数据

2. **上传测试**

```bash
# 1. 选择包含重量数据的Excel文件
# 2. 完成导入配置
# 3. 点击"导入"按钮
```

3. **查看控制台日志**

```
=== 设备明细数据检查 ===
总数量: 27
包含重量数据的项: 15
重量数据示例: [
  { 名称: '平面输送机', 重量: 7.0, 单位: '吨' },
  { 名称: '粉碎机', 重量: 7.5, 单位: '吨' },
  { 名称: '除尘系统', 重量: 13.5, 单位: '吨' }
]
```

4. **验证后端数据**

查看发货清单详情，确认：

- `totalWeight` 不再是 "0.00"
- 明细项包含正确的 `unitWeight` 和 `totalWeight`

### 预期结果

- ✅ 重量数据正确提取
- ✅ 重量数据正确上传到后端
- ✅ `totalWeight` 显示正确的总重量
- ✅ 明细项显示正确的单重和总重

## 支持的字段名称

现在支持以下所有重量字段名称（优先级从高到低）：

| 优先级 | 字段名       | 说明         | 示例              |
| ------ | ------------ | ------------ | ----------------- |
| 1      | `重量`       | 最简洁的形式 | Excel: 重量       |
| 2      | `重量（吨）` | 中文全角括号 | Excel: 重量（吨） |
| 3      | `重量(吨)`   | 英文半角括号 | Excel: 重量(吨)   |
| 4      | `重量吨`     | 无括号连写   | Excel: 重量吨     |

## 数据转换说明

### 前端到后端的数据映射

```typescript
// 前端 EnhancedShippingItemForm
interface EnhancedShippingItemForm {
  weight?: number | string;  // 重量（吨）✅ 现在能正确提取
  // ...
}

// 后端接口期望
interface ShippingItemVO {
  unitWeight?: number;    // 单重（kg）- 后端会将吨转换为kg
  totalWeight?: number;   // 总重（kg）- 后端会计算 unitWeight * quantity
  // ...
}
```

### 单位转换

后端会自动处理单位转换：

```javascript
// 后端逻辑（推测）
item.unitWeight = requestItem.weight * 1000;  // 吨 → kg
item.totalWeight = item.unitWeight * item.quantity;
```

所以前端只需要保证 `weight` 字段有值即可。

## 可能的扩展

### 1. 字段名称标准化（可选）

如果将来需要更强的健壮性，可以在 Excel 解析器中添加字段名称标准化：

```typescript
// enhanced-shipping-excel-parser.ts
private normalizeFieldName(fieldName: string): string {
  // 移除括号和空格
  let normalized = fieldName.replace(/[（(）)]/g, '').trim();

  // 标准化常见字段
  const fieldMap: Record<string, string> = {
    '重量吨': '重量',
    '重量T': '重量',
    '重量t': '重量'
  };

  return fieldMap[normalized] || normalized;
}
```

### 2. 重量单位自动识别（可选）

如果 Excel 中重量的单位不统一（可能是 kg、t、吨等），可以添加自动识别：

```typescript
function parseWeight(value: any, unit?: string): number | undefined {
  if (!value) return undefined;

  const numValue = Number(value);
  if (isNaN(numValue)) return undefined;

  // 根据单位转换为吨
  if (unit?.includes('kg') || unit?.includes('千克')) {
    return numValue / 1000;  // kg → 吨
  }

  return numValue;  // 默认为吨
}
```

## 总结

### 问题核心

Excel 表头使用 **"重量（吨）"**，但代码只查找 **"重量"**，导致字段匹配失败。

### 解决方法

支持多种可能的字段名称，提高 Excel 格式兼容性。

### 修复效果

- ✅ 重量数据能够正确提取
- ✅ 重量数据能够正确上传到后端
- ✅ 支持多种 Excel 表头格式
- ✅ 向后兼容，不影响现有功能

### 后续建议

1. **Excel 模板规范化**

   - 统一使用 "重量（吨）" 或 "重量" 作为表头
   - 在文档中明确说明支持的字段名称

2. **导入时数据校验**

   - 添加重量数据完整性检查
   - 如果重量数据缺失，给出明确提示

3. **用户体验优化**
   - 在导入预览时显示是否包含重量数据
   - 提供重量数据的统计汇总

---

**修复日期**: 2025-10-30  
**修复人**: AI Assistant  
**版本**: v1.0.0
