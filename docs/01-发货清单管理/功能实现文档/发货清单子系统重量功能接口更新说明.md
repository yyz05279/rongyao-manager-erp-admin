# 发货清单子系统重量功能接口更新说明

## 更新概述

根据《发货清单子系统重量功能使用文档》的推荐方案，已完成发货清单上传接口的数据结构调整。新增**子系统重量数组**功能，用于处理多个明细项共享同一重量的场景，避免重量重复计算。

**更新时间**: 2025-10-30  
**版本**: v1.1.0

---

## 主要变更

### 1. 新增类型定义：`SubsystemWeight`

**文件**: `src/api/erp/saltprocess/shipping/types.ts`

新增子系统重量映射接口：

```typescript
// 子系统重量映射（用于处理多个明细项共享同一重量的场景）
export interface SubsystemWeight {
  subsystem: string;                  // 子系统名称（必填）
  weight: number | string;            // 重量（吨，必填）
  remarks?: string;                   // 备注（可选）
}
```

**用途**：

- 定义子系统与重量的映射关系
- 支持多个明细项共享同一个总重量
- 避免在统计时重复计算重量

---

### 2. 更新接口：`EnhancedShippingImportRequest`

**文件**: `src/api/erp/saltprocess/shipping/index.ts`

在增强版发货清单导入请求接口中，新增 `subsystemWeights` 字段：

```typescript
export interface EnhancedShippingImportRequest {
  // ... 其他字段

  // 子系统重量映射数组（推荐方案）
  // 用于处理多个明细项共享同一重量的场景，避免重复计算
  // 示例：[{ subsystem: "固态处理厂-机械", weight: 14.5, remarks: "平面输送机+粉碎机总重" }]
  subsystemWeights?: SubsystemWeight[];

  // 设备明细
  shippingItems: EnhancedShippingItemForm[];
}
```

**特性**：

- ✅ **可选字段**：向后兼容，不使用时可不传
- ✅ **推荐使用**：当多个明细项共享重量时，强烈推荐使用此方案
- ✅ **灵活组合**：可与明细项的 `weight` 字段混合使用

---

### 3. 更新说明：`EnhancedShippingItemForm`

**文件**: `src/api/erp/saltprocess/shipping/types.ts`

明确 `weight` 字段为可选，并更新注释：

```typescript
export interface EnhancedShippingItemForm {
  // ... 其他字段

  weight?: number | string;           // 重量（吨）- 可选，如果 subsystem 匹配到 subsystemWeights 则从那里获取
  subsystem?: string;                 // 子系统/所属系统（如：固态处理厂）- 用于匹配 subsystemWeights
}
```

**优先级规则**：

1. **优先**：如果明细项的 `subsystem` 字段匹配到 `subsystemWeights` 中的某个子系统，使用子系统定义的重量
2. **其次**：如果没有匹配到，使用明细项自身的 `weight` 字段

---

## 使用示例

### 推荐方案：使用子系统重量数组

```typescript
import { importEnhancedShippingList } from '@/api/erp/saltprocess/shipping';

const requestData = {
  projectId: '1001',
  batchNumber: '第一车',
  responsiblePersonId: 10001,
  shippingDate: '2025-10-30',

  // 定义子系统重量映射
  subsystemWeights: [
    {
      subsystem: '固态处理厂-机械',
      weight: 14.5,
      remarks: '平面输送机+粉碎机总重'
    }
  ],

  // 明细项的 weight 留空，系统从 subsystemWeights 获取
  shippingItems: [
    {
      sequenceNo: 1,
      equipmentName: '平面输送机',
      subItemName: '输送主体',
      quantity: 2,
      unit: '套',
      subsystem: '固态处理厂-机械',
      weight: undefined // 从 subsystemWeights 获取
    },
    {
      sequenceNo: 3,
      equipmentName: '粉碎机',
      subItemName: '粉碎机本体',
      quantity: 2,
      unit: '套',
      subsystem: '固态处理厂-机械',
      weight: undefined // 从 subsystemWeights 获取
    }
    // ... 更多明细项
  ]
};

// 调用接口
const response = await importEnhancedShippingList(requestData);

// 预期结果：
// 总重量 = 14.5 吨（不会因为多个明细项而重复计算）
```

---

## 优势对比

### 传统方法（不推荐）

```typescript
shippingItems: [
  { equipmentName: '粉碎机', subItemName: '本体', weight: 7.5 },
  { equipmentName: '粉碎机', subItemName: '油缸', weight: 7.5 },
  { equipmentName: '粉碎机', subItemName: '油缸座', weight: 7.5 }
  // ... 9个子项
]
// ❌ 问题：总重量 = 7.5 × 9 = 67.5 吨（错误！）
```

### 推荐方案

```typescript
subsystemWeights: [
  { subsystem: '粉碎机组', weight: 7.5 }
],
shippingItems: [
  { equipmentName: '粉碎机', subItemName: '本体', subsystem: '粉碎机组' },
  { equipmentName: '粉碎机', subItemName: '油缸', subsystem: '粉碎机组' },
  { equipmentName: '粉碎机', subItemName: '油缸座', subsystem: '粉碎机组' }
  // ... 9个子项
]
// ✅ 正确：总重量 = 7.5 吨
```

---

## 兼容性说明

### 向后兼容

✅ **完全兼容旧版接口**

如果不传 `subsystemWeights` 参数，接口行为与之前完全一致：

```typescript
// 旧版调用方式仍然有效
const requestData = {
  projectId: '1001',
  batchNumber: '第一车',
  responsiblePersonId: 10001,
  shippingDate: '2025-10-30',

  // 不传 subsystemWeights

  shippingItems: [
    { equipmentName: '输送机', weight: 5.0 },
    { equipmentName: '粉碎机', weight: 7.5 }
  ]
};
```

### 混合使用

✅ **支持混合模式**

可以同时使用子系统重量和明细项重量：

```typescript
subsystemWeights: [
  { subsystem: '机械组', weight: 14.5 }
],
shippingItems: [
  // 属于子系统（从 subsystemWeights 获取）
  { equipmentName: '输送机', subsystem: '机械组' },

  // 独立明细项（使用自身重量）
  { equipmentName: '标准件', weight: 0.5 }
]
```

---

## 数据验证规则

### 子系统重量数组验证

1. **subsystem**: 不能为空
2. **weight**: 必须大于 0
3. **子系统名称唯一性**: 同一导入请求中，子系统名称不能重复

### 明细项验证

1. 如果 `subsystem` 不为空，必须在 `subsystemWeights` 中找到对应的定义
2. 如果 `subsystem` 为空，必须提供 `weight` 字段

### TypeScript 类型检查

```typescript
// ✅ 正确：使用子系统重量
subsystemWeights: [{ subsystem: '机械组', weight: 14.5 }],
shippingItems: [{ subsystem: '机械组', weight: undefined }]

// ✅ 正确：使用明细项重量
subsystemWeights: undefined,
shippingItems: [{ subsystem: undefined, weight: 5.0 }]

// ❌ 错误：缺少重量来源
subsystemWeights: undefined,
shippingItems: [{ subsystem: undefined, weight: undefined }]

// ❌ 错误：子系统未定义
subsystemWeights: [],
shippingItems: [{ subsystem: '未定义的子系统', weight: undefined }]
```

---

## 配套文档

### 1. 使用文档

📄 `docs/发货清单子系统重量功能使用文档.md`

- 完整的功能说明
- API 接口详细文档
- 数据流程说明
- 常见问题解答

### 2. Vue 组件示例

📄 `docs/发货清单子系统重量功能前端集成示例.vue`

- 完整的 Vue 3 组件实现
- 表单交互示例
- 实时预览功能
- 可直接运行的演示代码

### 3. TypeScript 集成示例

📄 `docs/发货清单子系统重量功能TypeScript集成示例.ts`

- 4 个完整的使用案例
- 工具函数和验证函数
- 淮安项目真实案例
- 最佳实践指南

---

## 迁移指南

### 对于现有代码

✅ **无需修改**

现有的发货清单导入代码无需任何修改，接口完全向后兼容。

### 对于新功能开发

📌 **推荐使用子系统重量方案**

当遇到以下场景时，建议使用 `subsystemWeights` 参数：

1. 一个设备有多个子项，但总重量是固定的
2. 多个设备属于同一个子系统，共享总重量
3. 需要避免重量重复计算的任何情况

### 迁移步骤

1. **识别共享重量场景**
   - 检查 Excel 数据中是否有多个明细项共享同一个重量值
2. **构建子系统重量数组**

   ```typescript
   const subsystemWeights = [
     { subsystem: '子系统名称', weight: 总重量 }
   ];
   ```

3. **更新明细项**

   - 设置明细项的 `subsystem` 字段
   - 移除或清空明细项的 `weight` 字段

4. **测试验证**
   - 确认总重量统计正确
   - 检查明细项显示是否正常

---

## 技术支持

### 问题反馈

如遇到问题，请提供以下信息：

1. 完整的请求数据（JSON 格式）
2. 后端返回的错误信息
3. 预期结果和实际结果

### 联系方式

- 开发团队：海棠企业管理系统开发组
- 技术文档：`docs/` 目录
- 问题追踪：项目管理系统

---

## 更新历史

### v1.1.0 (2025-10-30)

✨ **新增**

- 新增 `SubsystemWeight` 类型定义
- `EnhancedShippingImportRequest` 新增 `subsystemWeights` 参数
- 完善 `EnhancedShippingItemForm` 注释说明

📝 **文档**

- 新增使用文档
- 新增 Vue 组件示例
- 新增 TypeScript 集成示例
- 新增接口更新说明

🔄 **兼容性**

- 完全向后兼容
- 支持混合使用模式
- 不影响现有功能

---

## 总结

✅ **接口更新已完成**

本次更新为发货清单导入功能提供了更灵活的重量管理方案，有效解决了多个明细项共享重量的统计问题。新功能完全向后兼容，现有代码无需修改，新功能开发时可根据实际场景选择最合适的方案。

**核心优势**：

- 🎯 避免重量重复计算
- 📊 统计数据更准确
- 🔧 使用更灵活
- ♻️ 完全向后兼容
- 📚 文档完善详细

---

**文档维护**: 开发团队  
**最后更新**: 2025-10-30
