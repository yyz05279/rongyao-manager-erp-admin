# 发货清单子系统重量功能使用文档

## 功能概述

本功能支持在发货清单导入时，通过子系统重量数组来管理多个子项共享同一个重量的场景。

### 使用场景

在实际的发货清单中，经常会遇到以下情况：

**示例：序号 3 - 粉碎机（总重 7.5 吨）**

该设备有 9 个子项，但重量**7.5 吨**是所有子项的总和：

-   粉碎机本体
-   油缸及油管
-   油缸座
-   破粉碎机下料斗
-   除尘管道
-   粉碎机中间短节
-   ... 等

如果每个子项都填写 7.5 吨，统计时会重复计算导致总重量错误。

### 解决方案

新增 `subsystemWeights` 参数（可选），用于定义子系统与重量的映射关系。

## API 接口说明

### 接口地址

```
POST /erp/saltprocess/shipping/import/data
Content-Type: application/json
```

### 新增参数

| 参数名           | 类型  | 必填 | 说明               |
| ---------------- | ----- | ---- | ------------------ |
| subsystemWeights | Array | 否   | 子系统重量映射数组 |

#### SubsystemWeight 对象结构

```typescript
interface SubsystemWeight {
    subsystem: string; // 子系统名称（必填）
    weight: number; // 重量（吨，必填）
    remarks?: string; // 备注（可选）
}
```

## 使用方法

### 方法 1：使用子系统重量数组（推荐）

当多个明细项属于同一个子系统时，使用此方法避免重量重复计算。

#### 请求示例

```json
{
    "projectId": "1001",
    "batchNumber": "第一车",
    "shippingType": "MECHANICAL",
    "responsiblePersonId": 10001,

    // 子系统重量映射（可选）
    "subsystemWeights": [
        {
            "subsystem": "固态处理厂-机械",
            "weight": 14.5,
            "remarks": "平面输送机+粉碎机总重"
        },
        {
            "subsystem": "液态处理厂-电控",
            "weight": 3.2,
            "remarks": "电控柜总重"
        }
    ],

    // 发货明细
    "shippingItems": [
        // 固态处理厂-机械子系统的明细
        {
            "sequenceNo": 1,
            "equipmentName": "平面输送机",
            "subItemName": "输送主体",
            "quantity": 2,
            "unit": "套",
            "subsystem": "固态处理厂-机械",
            "weight": null // 重量留空，从 subsystemWeights 中获取
        },
        {
            "sequenceNo": 1,
            "equipmentName": "平面输送机",
            "subItemName": "紧固件",
            "quantity": 1,
            "unit": "套",
            "subsystem": "固态处理厂-机械",
            "weight": null // 重量留空
        },
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "粉碎机本体",
            "quantity": 2,
            "unit": "套",
            "subsystem": "固态处理厂-机械",
            "weight": null // 重量留空
        },
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "油缸及油管",
            "quantity": 8,
            "unit": "套",
            "subsystem": "固态处理厂-机械",
            "weight": null // 重量留空
        },
        // ... 其他子项也标记为同一子系统，重量留空

        // 液态处理厂-电控子系统的明细
        {
            "sequenceNo": 10,
            "equipmentName": "电控柜",
            "subItemName": "主控柜",
            "quantity": 1,
            "unit": "套",
            "subsystem": "液态处理厂-电控",
            "weight": null // 重量留空
        }
    ]
}
```

#### 数据流程

1. **明细项匹配**：系统根据明细项的 `subsystem` 字段，从 `subsystemWeights` 数组中查找对应的重量
2. **重量分配**：找到匹配的子系统后，该明细项使用子系统定义的重量
3. **统计总重**：计算总重时，直接累加 `subsystemWeights` 数组中的重量值，避免重复计算

#### 优点

✅ 避免重量重复计算  
✅ 数据结构清晰，易于管理  
✅ 统计准确  
✅ 前端只需定义子系统重量映射表

### 方法 2：传统方法（每个明细项单独指定重量）

如果不使用 `subsystemWeights`，可以继续使用传统方式。

#### 请求示例

```json
{
    "projectId": "1001",
    "batchNumber": "第一车",
    "shippingType": "MECHANICAL",

    // 不传 subsystemWeights

    "shippingItems": [
        {
            "sequenceNo": 1,
            "equipmentName": "平面输送机",
            "subItemName": "输送主体",
            "quantity": 2,
            "unit": "套",
            "weight": 5.0 // 直接指定重量
        },
        {
            "sequenceNo": 1,
            "equipmentName": "平面输送机",
            "subItemName": "紧固件",
            "quantity": 1,
            "unit": "套",
            "weight": 2.0 // 直接指定重量
        }
    ]
}
```

#### 数据流程

1. 直接使用明细项的 `weight` 字段
2. 统计总重时累加所有明细项的重量

#### 注意事项

⚠️ 如果多个子项共享同一个设备的重量，需要手动分配，避免重复计算  
⚠️ 统计时会累加所有明细项的重量

### 方法 3：混合使用

可以同时使用 `subsystemWeights` 和明细项的 `weight` 字段。

```json
{
    "subsystemWeights": [
        {
            "subsystem": "固态处理厂-机械",
            "weight": 14.5
        }
    ],

    "shippingItems": [
        // 属于子系统的明细项
        {
            "subsystem": "固态处理厂-机械",
            "weight": null // 从 subsystemWeights 获取
            // ...
        },

        // 独立的明细项
        {
            "subsystem": null, // 不属于任何子系统
            "weight": 2.0 // 使用自身重量
            // ...
        }
    ]
}
```

#### 优先级规则

1. **优先**：如果明细项的 `subsystem` 字段匹配到 `subsystemWeights` 中的某个子系统，使用子系统定义的重量
2. **其次**：如果没有匹配到，使用明细项自身的 `weight` 字段

## 完整示例

### 场景：淮安项目第一年设备明细

根据您提供的图片，数据结构如下：

```json
{
    "projectId": "1001",
    "projectName": "淮安项目",
    "batchNumber": "第一车",
    "shippingType": "MECHANICAL",
    "shippingDate": "2025-10-30",
    "responsiblePersonId": 10001,

    "subsystemWeights": [
        {
            "subsystem": "第一年-设备明细",
            "weight": 7.0,
            "remarks": "序号1-平面输送机总重"
        },
        {
            "subsystem": "第一年-设备明细",
            "weight": 7.5,
            "remarks": "序号3-粉碎机总重"
        }
    ],

    "shippingItems": [
        // 序号1 - 平面输送机
        {
            "sequenceNo": 1,
            "equipmentName": "平面输送机",
            "subItemName": "输送主体",
            "quantity": 2,
            "unit": "套",
            "subsystem": "第一年-设备明细",
            "remarks1": "整机发货"
        },
        {
            "sequenceNo": 1,
            "equipmentName": "平面输送机",
            "subItemName": "紧固件",
            "quantity": 1,
            "unit": "套",
            "subsystem": "第一年-设备明细",
            "remarks1": "见清单"
        },

        // 序号2 - 子输送
        {
            "sequenceNo": 2,
            "equipmentName": "子输送",
            "subItemName": "卸料溜壳",
            "quantity": 2,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        },
        {
            "sequenceNo": 2,
            "equipmentName": "子输送",
            "subItemName": "紧固件",
            "quantity": 1,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        },

        // 序号3 - 粉碎机（9个子项）
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "粉碎机本体",
            "quantity": 2,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        },
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "油缸及油管",
            "quantity": 8,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        },
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "油缸座",
            "quantity": 8,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        },
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "破粉碎机下料斗",
            "quantity": 2,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        },
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "除尘管道",
            "quantity": 2,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        },
        {
            "sequenceNo": 3,
            "equipmentName": "粉碎机",
            "subItemName": "粉碎机中间短节",
            "quantity": 2,
            "unit": "套",
            "subsystem": "第一年-设备明细"
        }
        // ... 其他子项
    ]
}
```

### 预期结果

**统计总重量**：14.5 吨（7.0 + 7.5）

-   ✅ 不会因为粉碎机的 9 个子项而重复计算 9 次
-   ✅ 系统自动从 `subsystemWeights` 数组累加

## 前端集成示例

### Vue 3 + TypeScript

```typescript
import { ref } from "vue";
import { importShippingList } from "@/api/shipping";

interface SubsystemWeight {
    subsystem: string;
    weight: number;
    remarks?: string;
}

const subsystemWeights = ref<SubsystemWeight[]>([
    { subsystem: "固态处理厂-机械", weight: 14.5 },
    { subsystem: "液态处理厂-电控", weight: 3.2 },
]);

const handleImport = async () => {
    const data = {
        projectId: "1001",
        batchNumber: "第一车",
        shippingType: "MECHANICAL",

        // 传入子系统重量映射
        subsystemWeights: subsystemWeights.value,

        shippingItems: [
            // ... 明细项
        ],
    };

    const response = await importShippingList(data);

    if (response.data.success) {
        console.log("导入成功，总重量:", response.data.totalWeight, "吨");
    }
};
```

### React + TypeScript

```typescript
import { useState } from "react";
import { importShippingList } from "@/api/shipping";

const ShippingImport = () => {
    const [subsystemWeights, setSubsystemWeights] = useState([
        { subsystem: "固态处理厂-机械", weight: 14.5 },
        { subsystem: "液态处理厂-电控", weight: 3.2 },
    ]);

    const handleImport = async () => {
        const data = {
            projectId: "1001",
            batchNumber: "第一车",
            subsystemWeights,
            shippingItems: [
                /* ... */
            ],
        };

        const response = await importShippingList(data);
        console.log("总重量:", response.data.totalWeight);
    };

    return <button onClick={handleImport}>导入发货清单</button>;
};
```

## 数据验证规则

### 子系统重量数组验证

1. **subsystem**：不能为空
2. **weight**：必须大于 0
3. **子系统名称唯一性**：同一导入请求中，子系统名称不能重复

### 明细项验证

1. 如果 `subsystem` 不为空，必须在 `subsystemWeights` 中找到对应的定义
2. 如果 `subsystem` 为空，必须提供 `weight` 字段

## 常见问题

### Q1: 子系统重量和明细项重量同时存在时，使用哪个？

**A**: 优先使用子系统重量。如果明细项的 `subsystem` 匹配到 `subsystemWeights` 中的某个子系统，则使用子系统定义的重量，忽略明细项的 `weight` 字段。

### Q2: 如果有些明细项属于子系统，有些不属于，如何处理？

**A**: 可以混合使用：

-   属于子系统的明细项：设置 `subsystem` 字段，`weight` 留空
-   独立的明细项：`subsystem` 留空，设置 `weight` 字段

### Q3: 统计总重量时，如何避免重复计算？

**A**: 系统会自动处理：

-   如果提供了 `subsystemWeights`，统计时直接累加该数组中的重量值
-   如果没有提供 `subsystemWeights`，则累加明细项的重量值

### Q4: 一个子系统下可以有多个设备吗？

**A**: 可以。一个子系统可以包含多个设备的多个子项，所有这些明细项共享该子系统定义的总重量。

例如：

```json
{
    "subsystemWeights": [
        {
            "subsystem": "固态处理厂-机械",
            "weight": 20.0 // 多个设备的总重
        }
    ],
    "shippingItems": [
        { "equipmentName": "平面输送机", "subsystem": "固态处理厂-机械" },
        { "equipmentName": "粉碎机", "subsystem": "固态处理厂-机械" },
        { "equipmentName": "提升机", "subsystem": "固态处理厂-机械" }
        // 这些设备的总重量是 20 吨
    ]
}
```

## 技术实现说明

### 重量获取逻辑

```java
/**
 * 获取明细项的重量（吨）
 * 优先从子系统重量数组中获取，如果没有则使用明细项自身的重量
 */
private BigDecimal getItemWeight(ShippingItemImportBo itemBo,
                                 List<SubsystemWeight> subsystemWeights) {
    // 1. 优先从子系统重量数组中查找
    if (subsystemWeights != null && itemBo.getSubsystem() != null) {
        for (SubsystemWeight sw : subsystemWeights) {
            if (itemBo.getSubsystem().equals(sw.getSubsystem())) {
                return sw.getWeight();
            }
        }
    }

    // 2. 如果没有找到，使用明细项自身的重量
    return itemBo.getWeight();
}
```

### 总重量计算逻辑

```java
/**
 * 计算总重量（吨）
 * 优先从子系统重量数组中累加，避免重复计算
 */
private BigDecimal calculateTotalWeight(ShippingListImportBo importBo) {
    // 1. 如果提供了子系统重量数组，直接累加
    if (importBo.getSubsystemWeights() != null && !importBo.getSubsystemWeights().isEmpty()) {
        return importBo.getSubsystemWeights().stream()
                .map(SubsystemWeight::getWeight)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }

    // 2. 否则累加明细项重量
    return importBo.getShippingItems().stream()
            .filter(item -> item.getWeight() != null)
            .map(ShippingItemImportBo::getWeight)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
}
```

## 版本历史

-   **v1.0** (2025-10-30)
    -   新增 `subsystemWeights` 参数
    -   支持多个子项共享同一重量
    -   优化总重量计算逻辑

## 技术支持

如有问题，请联系开发团队。
