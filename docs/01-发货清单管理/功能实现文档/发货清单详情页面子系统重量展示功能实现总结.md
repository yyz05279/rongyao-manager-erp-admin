# 发货清单详情页面子系统重量展示功能实现总结

## 更新日期

2025 年 10 月 30 日

## 功能概述

根据《发货清单详情接口返回子系统重量说明》文档，完成了发货清单详情页面的子系统重量展示功能，支持多个子系统共用一个重量时的合并展示。

---

## 实现内容

### 1. 类型定义更新

**文件**: `src/api/erp/saltprocess/shipping/types.ts`

✅ 在 `ShippingListVO` 接口中添加 `subsystemWeights` 字段：

```typescript
export interface ShippingListVO {
  // ... 其他字段

  // 子系统重量映射数组
  subsystemWeights?: SubsystemWeight[];  // 子系统重量列表

  // ...
}
```

---

### 2. 数据解析器更新

**文件**: `src/api/erp/saltprocess/shipping/data-parser.ts`

✅ 新增 `parseSubsystemWeights` 函数，支持解析后端返回的子系统重量数据：

```typescript
/**
 * 解析子系统重量数组
 * 支持JSON字符串和数组两种格式
 */
export function parseSubsystemWeights(data: any): SubsystemWeight[] {
  // 空值处理
  if (!data) {
    return [];
  }

  // 数组格式直接返回
  if (Array.isArray(data)) {
    return data.map((item) => ({
      subsystem: item.subsystem || '',
      weight: typeof item.weight === 'string' ? parseFloat(item.weight) : item.weight || 0,
      remarks: item.remarks || undefined
    }));
  }

  // JSON字符串格式解析后返回
  if (typeof data === 'string') {
    try {
      const parsed = JSON.parse(data);
      if (Array.isArray(parsed)) {
        return parsed.map((item) => ({
          subsystem: item.subsystem || '',
          weight: typeof item.weight === 'string' ? parseFloat(item.weight) : item.weight || 0,
          remarks: item.remarks || undefined
        }));
      }
    } catch (error) {
      console.error('解析子系统重量JSON失败:', error);
      return [];
    }
  }

  return [];
}
```

✅ 在 `parseShippingListVO` 函数中调用解析器：

```typescript
export function parseShippingListVO(data: any): ShippingListVO {
  // ...

  return {
    // ... 其他字段

    // 子系统重量映射数组
    subsystemWeights: parseSubsystemWeights(data.subsystemWeights),

    // ...
  };
}
```

---

### 3. 详情页面展示实现

**文件**: `src/views/erp/saltprocess/shipping/detail.vue`

#### 3.1 添加计算属性 - 合并相同重量的子系统

```typescript
// 计算属性 - 合并相同重量的子系统
const mergedSubsystemWeights = computed(() => {
  const subsystemWeights = shippingDetail.value.subsystemWeights;
  if (!subsystemWeights || subsystemWeights.length === 0) {
    return [];
  }

  // 按重量分组，合并相同重量的子系统
  const weightGroups = new Map<number, {
    subsystems: string[];
    weight: number;
    remarks: string[];
  }>();

  subsystemWeights.forEach(sw => {
    const weight = typeof sw.weight === 'string' ? parseFloat(sw.weight) : sw.weight;

    if (!weightGroups.has(weight)) {
      weightGroups.set(weight, {
        subsystems: [],
        weight,
        remarks: []
      });
    }

    const group = weightGroups.get(weight)!;
    group.subsystems.push(sw.subsystem);

    if (sw.remarks && !group.remarks.includes(sw.remarks)) {
      group.remarks.push(sw.remarks);
    }
  });

  // 转换为数组格式，按重量降序排序
  return Array.from(weightGroups.values())
    .map(group => ({
      subsystems: group.subsystems,
      weight: group.weight,
      remarks: group.remarks.join('; ')
    }))
    .sort((a, b) => b.weight - a.weight);
});
```

**核心逻辑**：

1. 按重量值分组
2. 相同重量的子系统合并到一个组
3. 合并多个备注信息（用分号分隔）
4. 按重量降序排序

#### 3.2 添加子系统列表展示区域（优化版）

**优化逻辑**：

- 优先展示子系统重量数据（表格形式）
- 如果没有重量数据，则显示子系统标签列表
- 统一使用"子系统列表"标题，避免混淆

```vue
<!-- 子系统列表（优化版：优先展示重量数据，否则显示标签列表） -->
<div v-if="mergedSubsystemWeights.length > 0 || subsystemList.length > 0" class="subsystem-section">
  <el-divider content-position="left">
    <div class="section-title-with-icon">
      <el-icon><Box /></el-icon>
      <span class="subsystem-title">子系统列表</span>
      <el-tag type="info" size="small">
        {{ mergedSubsystemWeights.length > 0 ? mergedSubsystemWeights.length : subsystemList.length }} 个子系统
      </el-tag>
    </div>
  </el-divider>

  <!-- 有重量数据时：显示表格 -->
  <el-table
    v-if="mergedSubsystemWeights.length > 0"
    :data="mergedSubsystemWeights"
    border
    stripe
    size="default"
    class="subsystem-weights-table"
  >
    <el-table-column label="序号" type="index" width="80" align="center" />

    <!-- 子系统名称：支持显示多个子系统 -->
    <el-table-column label="子系统名称" min-width="200" align="left">
      <template #default="{ row }">
        <div class="subsystem-names">
          <el-tag
            v-for="(name, idx) in row.subsystems"
            :key="idx"
            type="info"
            size="default"
            effect="plain"
            class="subsystem-tag"
          >
            {{ name }}
          </el-tag>
        </div>
      </template>
    </el-table-column>

    <!-- 重量 -->
    <el-table-column label="重量（吨）" width="150" align="center">
      <template #default="{ row }">
        <span class="weight-value">{{ row.weight.toFixed(2) }}</span>
      </template>
    </el-table-column>

    <!-- 备注 -->
    <el-table-column label="备注" min-width="200" align="left">
      <template #default="{ row }">
        <span class="remarks-text">{{ row.remarks || '-' }}</span>
      </template>
    </el-table-column>
  </el-table>

  <!-- 无重量数据时：显示标签列表 -->
  <div v-else class="subsystem-tags">
    <el-tag
      v-for="(subsystem, index) in subsystemList"
      :key="index"
      size="large"
      effect="plain"
      type="info"
    >
      {{ subsystem }}
    </el-tag>
  </div>
</div>
```

**展示特点**：

- **智能切换**：优先展示重量数据（表格），无重量数据时展示标签列表
- **统一标题**：都使用"子系统列表"，避免用户困惑
- **表格展示**（有重量数据）：
  - 子系统名称列使用标签展示，支持多个子系统
  - 重量值突出显示（蓝色加粗）
  - 备注信息自动合并
- **标签展示**（无重量数据）：
  - 简洁的标签列表形式
  - 从明细项中提取子系统名称

#### 3.3 添加样式

```scss
// 子系统列表统一样式
.subsystem-section {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid #e4e7ed;

  .subsystem-title {
    font-size: 14px;
    font-weight: 600;
    color: #606266;
  }

  // 表格样式（有重量数据时）
  .subsystem-weights-table {
    margin-top: 16px;
    border-radius: 4px;
    overflow: hidden;

    :deep(.el-table__header-wrapper) {
      th {
        background-color: #f5f7fa;
        color: #606266;
        font-weight: 600;
      }
    }

    .subsystem-names {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 4px 0;

      .subsystem-tag {
        font-size: 13px;
        font-weight: 500;
        border-radius: 4px;
      }
    }

    .weight-value {
      font-size: 16px;
      font-weight: 600;
      color: #409eff;
    }

    .remarks-text {
      color: #606266;
      font-size: 13px;
      line-height: 1.5;
    }
  }

  // 标签列表样式（无重量数据时）
  .subsystem-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 16px;

    .el-tag {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: default;

      &:hover {
        opacity: 0.8;
      }
    }
  }
}
```

---

## 功能特性

### ✨ 合并展示

多个子系统共用同一个重量时，会自动合并到一行显示：

**示例数据**：

```json
{
  "subsystemWeights": [
    { "subsystem": "固态处理厂-机械", "weight": 14.5, "remarks": "平面输送机总重" },
    { "subsystem": "固态处理厂-电控", "weight": 14.5, "remarks": "粉碎机总重" }
  ]
}
```

**展示效果**：

| 序号 | 子系统名称                      | 重量（吨） | 备注                       |
| ---- | ------------------------------- | ---------- | -------------------------- |
| 1    | 固态处理厂-机械 固态处理厂-电控 | 14.50      | 平面输送机总重; 粉碎机总重 |

### 🎯 数据兼容

- 支持 JSON 字符串格式（后端数据库存储）
- 支持数组格式（后端直接返回）
- 空值安全处理，不会报错

### 📊 智能排序

按重量降序排列，重要的大重量子系统优先显示。

### 🎨 美观展示

- 表格结构清晰
- 子系统标签形式展示
- 重量值醒目突出
- 支持响应式布局

---

## 使用示例

### 场景 1：单个子系统单独重量

```json
{
  "subsystemWeights": [
    { "subsystem": "固态处理厂", "weight": 14.5 },
    { "subsystem": "液态处理厂", "weight": 3.2 }
  ]
}
```

**展示**：

- 第 1 行：固态处理厂 - 14.50 吨
- 第 2 行：液态处理厂 - 3.20 吨

### 场景 2：多个子系统共用重量

```json
{
  "subsystemWeights": [
    { "subsystem": "平面输送机", "weight": 7.0 },
    { "subsystem": "子输送", "weight": 7.0 },
    { "subsystem": "粉碎机", "weight": 7.5 }
  ]
}
```

**展示**：

- 第 1 行：粉碎机 - 7.50 吨
- 第 2 行：平面输送机 子输送 - 7.00 吨（合并）

### 场景 3：无子系统重量数据

如果后端返回空数组或 null，子系统重量分布区域不显示。

---

## 数据流程

```
后端返回
  ↓
parseSubsystemWeights() 解析
  ↓
ShippingListVO.subsystemWeights
  ↓
mergedSubsystemWeights 计算属性（合并相同重量）
  ↓
模板渲染（表格展示）
```

---

## 技术亮点

### 1. 灵活的数据解析

```typescript
// 支持多种格式
parseSubsystemWeights('[{"subsystem":"...","weight":14.5}]');  // JSON字符串
parseSubsystemWeights([{ subsystem: "...", weight: 14.5 }]);   // 数组
parseSubsystemWeights(null);                                    // 空值
```

### 2. 智能合并算法

使用 `Map` 数据结构按重量分组，性能优秀：

```typescript
const weightGroups = new Map<number, {
  subsystems: string[];
  weight: number;
  remarks: string[];
}>();
```

### 3. 类型安全

全程使用 TypeScript，避免运行时错误：

```typescript
const mergedSubsystemWeights = computed(() => {
  const subsystemWeights = shippingDetail.value.subsystemWeights;
  if (!subsystemWeights || subsystemWeights.length === 0) {
    return [];
  }
  // ...
});
```

---

## 测试建议

### 测试用例

1. **正常数据**：有子系统重量数据，正常展示
2. **空数据**：无子系统重量数据，不显示区域
3. **合并场景**：多个子系统相同重量，合并展示
4. **排序验证**：验证按重量降序排列
5. **备注合并**：多个备注用分号分隔
6. **JSON 解析**：后端返回 JSON 字符串能正常解析

### 测试数据

```json
{
  "subsystemWeights": [
    { "subsystem": "固态处理厂-机械", "weight": 14.5, "remarks": "机械设备总重" },
    { "subsystem": "液态处理厂-电控", "weight": 3.2, "remarks": "电控设备总重" },
    { "subsystem": "固态处理厂-管路", "weight": 14.5, "remarks": "管路设备总重" }
  ]
}
```

**预期结果**：

- 第 1 行：固态处理厂-机械、固态处理厂-管路 - 14.50 吨 - 机械设备总重; 管路设备总重
- 第 2 行：液态处理厂-电控 - 3.20 吨 - 电控设备总重

---

## 相关文档

- [发货清单详情接口返回子系统重量说明](../使用指南/发货清单详情接口返回子系统重量说明.md)
- [发货清单子系统重量功能使用文档](./发货清单子系统重量功能使用文档.md)
- [发货清单子系统重量功能接口更新说明](./发货清单子系统重量功能接口更新说明.md)

---

## 总结

✅ **已完成**：

1. 类型定义更新
2. 数据解析器实现
3. 详情页面展示
4. 合并相同重量逻辑
5. 美观的 UI 展示

✨ **核心价值**：

- 直观展示子系统重量分布
- 智能合并相同重量子系统
- 数据兼容性强
- 用户体验优秀

---

**开发者**: AI 助手  
**更新时间**: 2025-10-30  
**版本**: v1.0.0
