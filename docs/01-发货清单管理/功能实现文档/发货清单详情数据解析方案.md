# 发货清单详情数据解析方案

## 概述

本文档说明如何解析后端返回的发货清单详情数据，包括数据结构说明、解析工具使用方法和最佳实践。

## 数据结构说明

### 后端返回格式

后端返回的发货清单数据包含以下特点：

1. **分页响应格式**：

```json
{
  "total": 1,
  "rows": [...],
  "code": 200,
  "msg": "查询成功"
}
```

2. **增强版字段**：

   - `statusDesc`: 状态描述（如："草稿"）
   - `shippingMethodDesc`: 发货方式描述（如:"卡车运输"）
   - `vehiclePlate`: 车牌号
   - `vehicleDescription`: 车辆描述
   - `driverName`: 司机姓名
   - `driverPhone`: 司机电话
   - `shippingPhotoUrls`: 发货照片 URL 数组
   - `driverLicensePhotoUrls`: 驾照照片 URL 数组

3. **统计字段**：

   - `mechanicalCount`: 机械设备数量
   - `electricalCount`: 电控设备数量
   - `pipelineCount`: 管路设备数量
   - `fragileCount`: 易碎品数量
   - `hazardousCount`: 危险品数量

4. **审计字段**：
   - `tenantId`: 租户 ID
   - `createDept`: 创建部门
   - `version`: 版本号（乐观锁）

### 完整数据示例

```json
{
  "total": 1,
  "rows": [
    {
      "id": "1983722956655599617",
      "listCode": "SP20250916D78E-SL-001",
      "projectId": "1967857798821703681",
      "projectName": "淮安项目",
      "batchNumber": "第一车 ",
      "responsiblePerson": "系统管理员",
      "responsiblePersonId": 1,
      "shippingDate": "2025-02-13",
      "expectedDeliveryDate": null,
      "actualDeliveryDate": null,
      "status": "DRAFT",
      "statusDesc": "草稿",
      "shippingMethod": "TRUCK",
      "shippingMethodDesc": "卡车运输",
      "vehicleInfo": "17.5米车\n苏NHA923",
      "vehiclePlate": "苏NHA923",
      "vehicleDescription": "17.5米车",
      "driverInfo": "李猛         18036946111         ",
      "driverName": "李猛",
      "driverPhone": "18036946111",
      "totalItems": 27,
      "totalWeight": "0.00",
      "totalVolume": "0.00",
      "packingListPath": null,
      "photoPath": null,
      "shippingPhotoUrls": [
        "/shipping-photos/2025-10-30/1761791383184_0aa6aaff.jpg",
        "/shipping-photos/2025-10-30/1761791383186_680cc232.jpg",
        "/shipping-photos/2025-10-30/1761791383187_4cc40d40.jpg"
      ],
      "driverLicensePhotoUrls": [
        "/driver-license/2025-10-30/1761791383100_6e61a2ae.jpg"
      ],
      "remarks": null,
      "tenantId": "000000",
      "createDept": 103,
      "createBy": 1,
      "createTime": "2025-10-30 02:29:43",
      "updateBy": 1,
      "updateTime": "2025-10-30 02:29:44",
      "version": 0,
      "items": null,
      "trackingRecords": null,
      "attachments": null,
      "mechanicalCount": null,
      "electricalCount": null,
      "pipelineCount": null,
      "fragileCount": null,
      "hazardousCount": null
    }
  ],
  "code": 200,
  "msg": "查询成功"
}
```

## 解析工具使用

### 1. 导入解析工具

```typescript
import {
  parseShippingListPageResponse,
  parseShippingListVO,
  parseVehicleInfo,
  parseDriverInfo,
  formatWeight,
  formatVolume,
  getStatusTagType,
  getEquipmentTypeName,
  getFullPhotoUrls
} from '@/api/erp/saltprocess/shipping/data-parser';
```

### 2. 解析分页列表数据

```typescript
// 在 Vue 组件中
import { listShippingList } from '@/api/erp/saltprocess/shipping';
import { parseShippingListPageResponse } from '@/api/erp/saltprocess/shipping/data-parser';

// 查询发货清单列表
const getList = async () => {
  loading.value = true;
  try {
    const response = await listShippingList(queryParams.value);

    // 解析后端返回的数据
    const pageData = parseShippingListPageResponse(response.data);

    // 使用解析后的数据
    dataList.value = pageData.records;
    total.value = pageData.total;

    console.log('解析后的发货清单列表:', dataList.value);
  } catch (error) {
    console.error('查询失败:', error);
  } finally {
    loading.value = false;
  }
};
```

### 3. 解析单个详情数据

```typescript
import { getShippingList } from '@/api/erp/saltprocess/shipping';
import { parseShippingListVO } from '@/api/erp/saltprocess/shipping/data-parser';

// 获取发货清单详情
const getDetail = async (id: string) => {
  loading.value = true;
  try {
    const response = await getShippingList(id);

    // 解析详情数据
    const shippingList = parseShippingListVO(response.data);

    // 使用解析后的数据
    formData.value = shippingList;

    // 访问增强字段
    console.log('车牌号:', shippingList.vehiclePlate);       // "苏NHA923"
    console.log('车辆描述:', shippingList.vehicleDescription); // "17.5米车"
    console.log('司机姓名:', shippingList.driverName);        // "李猛"
    console.log('司机电话:', shippingList.driverPhone);       // "18036946111"
    console.log('状态描述:', shippingList.statusName);        // "草稿"
    console.log('发货照片:', shippingList.shippingPhotoUrls); // [...urls]

  } catch (error) {
    console.error('查询失败:', error);
  } finally {
    loading.value = false;
  }
};
```

### 4. 在模板中使用

```vue
<template>
  <div class="shipping-list-detail">
    <!-- 基本信息 -->
    <el-descriptions :column="2" border>
      <el-descriptions-item label="清单编号">
        {{ shippingList.listCode }}
      </el-descriptions-item>

      <el-descriptions-item label="项目名称">
        {{ shippingList.projectName }}
      </el-descriptions-item>

      <el-descriptions-item label="批次号">
        {{ shippingList.batchNumber }}
      </el-descriptions-item>

      <el-descriptions-item label="发货状态">
        <el-tag :type="getStatusTagType(shippingList.status)">
          {{ shippingList.statusName }}
        </el-tag>
      </el-descriptions-item>

      <el-descriptions-item label="发货方式">
        {{ shippingList.shippingMethodName }}
      </el-descriptions-item>

      <el-descriptions-item label="发货日期">
        {{ shippingList.shippingDate }}
      </el-descriptions-item>
    </el-descriptions>

    <!-- 车辆信息 -->
    <el-descriptions :column="2" border title="车辆信息" style="margin-top: 20px">
      <el-descriptions-item label="车牌号">
        {{ shippingList.vehiclePlate }}
      </el-descriptions-item>

      <el-descriptions-item label="车辆描述">
        {{ shippingList.vehicleDescription }}
      </el-descriptions-item>

      <el-descriptions-item label="司机姓名">
        {{ shippingList.driverName }}
      </el-descriptions-item>

      <el-descriptions-item label="司机电话">
        {{ shippingList.driverPhone }}
      </el-descriptions-item>
    </el-descriptions>

    <!-- 统计信息 -->
    <el-descriptions :column="3" border title="统计信息" style="margin-top: 20px">
      <el-descriptions-item label="总件数">
        {{ shippingList.totalItems }}
      </el-descriptions-item>

      <el-descriptions-item label="总重量">
        {{ formatWeight(shippingList.totalWeight) }}
      </el-descriptions-item>

      <el-descriptions-item label="总体积">
        {{ formatVolume(shippingList.totalVolume) }}
      </el-descriptions-item>

      <el-descriptions-item label="机械设备" v-if="shippingList.mechanicalCount">
        {{ shippingList.mechanicalCount }} 台
      </el-descriptions-item>

      <el-descriptions-item label="电控设备" v-if="shippingList.electricalCount">
        {{ shippingList.electricalCount }} 台
      </el-descriptions-item>

      <el-descriptions-item label="管路设备" v-if="shippingList.pipelineCount">
        {{ shippingList.pipelineCount }} 台
      </el-descriptions-item>
    </el-descriptions>

    <!-- 发货照片 -->
    <div v-if="shippingList.shippingPhotoUrls?.length" style="margin-top: 20px">
      <h3>发货照片</h3>
      <el-image
        v-for="(url, index) in getFullPhotoUrls(shippingList.shippingPhotoUrls)"
        :key="index"
        :src="url"
        :preview-src-list="getFullPhotoUrls(shippingList.shippingPhotoUrls)"
        :initial-index="index"
        fit="cover"
        style="width: 200px; height: 200px; margin-right: 10px"
      />
    </div>

    <!-- 司机驾照照片 -->
    <div v-if="shippingList.driverLicensePhotoUrls?.length" style="margin-top: 20px">
      <h3>司机驾照</h3>
      <el-image
        v-for="(url, index) in getFullPhotoUrls(shippingList.driverLicensePhotoUrls)"
        :key="index"
        :src="url"
        :preview-src-list="getFullPhotoUrls(shippingList.driverLicensePhotoUrls)"
        :initial-index="index"
        fit="cover"
        style="width: 200px; height: 200px; margin-right: 10px"
      />
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { getShippingList } from '@/api/erp/saltprocess/shipping';
import {
  parseShippingListVO,
  formatWeight,
  formatVolume,
  getStatusTagType,
  getFullPhotoUrls
} from '@/api/erp/saltprocess/shipping/data-parser';
import type { ShippingListVO } from '@/api/erp/saltprocess/shipping/types';

const shippingList = ref<ShippingListVO>({} as ShippingListVO);

onMounted(() => {
  getDetail('1983722956655599617');
});

const getDetail = async (id: string) => {
  const response = await getShippingList(id);
  shippingList.value = parseShippingListVO(response.data);
};
</script>
```

## 工具函数详解

### 1. parseShippingListPageResponse

解析分页响应数据，将后端的 `{total, rows}` 格式转换为前端标准的 `{records, total}` 格式。

```typescript
const pageData = parseShippingListPageResponse(response.data);
// 返回: { records: ShippingListVO[], total: number }
```

### 2. parseShippingListVO

解析单个发货清单数据，自动处理：

- 字段名标准化（如 statusDesc → statusName）
- 类型转换（如字符串数字 → 数字类型）
- 车辆和司机信息的解析和分离
- 默认值处理

```typescript
const shippingList = parseShippingListVO(rawData);
```

### 3. parseVehicleInfo

解析车辆信息字符串，自动提取车牌号和车辆描述。

```typescript
const vehicleInfo = parseVehicleInfo("17.5米车\n苏NHA923");
// 返回: {
//   plate: "苏NHA923",
//   description: "17.5米车",
//   combined: "17.5米车 苏NHA923"
// }
```

支持的格式：

- `"17.5米车\n苏NHA923"` （换行分隔）
- `"17.5米车 苏NHA923"` （空格分隔）

### 4. parseDriverInfo

解析司机信息字符串，自动提取姓名和电话。

```typescript
const driverInfo = parseDriverInfo("李猛         18036946111");
// 返回: {
//   name: "李猛",
//   phone: "18036946111",
//   combined: "李猛 18036946111"
// }
```

支持的格式：

- `"李猛 18036946111"` （空格分隔）
- `"李猛         18036946111"` （多个空格）
- 自动识别手机号码格式

### 5. formatWeight

格式化重量显示，添加千分位和单位。

```typescript
formatWeight(1500.5);      // "1,500.50 kg"
formatWeight("0.00");      // "0.00 kg"
formatWeight(2000, "吨");  // "2,000.00 吨"
```

### 6. formatVolume

格式化体积显示，添加千分位和单位。

```typescript
formatVolume(12.8);   // "12.80 m³"
formatVolume("0.00"); // "0.00 m³"
```

### 7. getStatusTagType

获取状态对应的标签类型，用于 Element Plus 的 `el-tag`。

```typescript
getStatusTagType('DRAFT');      // 'info'
getStatusTagType('PENDING');    // 'warning'
getStatusTagType('SHIPPED');    // ''
getStatusTagType('DELIVERED');  // 'success'
getStatusTagType('CANCELLED');  // 'danger'
```

### 8. getEquipmentTypeName

获取设备类型的中文名称。

```typescript
getEquipmentTypeName('MECHANICAL');     // "机械设备"
getEquipmentTypeName('ELECTRICAL');     // "电控设备"
getEquipmentTypeName('PIPELINE');       // "管路设备"
```

### 9. getFullPhotoUrls

将相对路径转换为完整的 URL 列表。

```typescript
const urls = getFullPhotoUrls([
  "/shipping-photos/2025-10-30/1761791383184_0aa6aaff.jpg",
  "/shipping-photos/2025-10-30/1761791383186_680cc232.jpg"
]);
// 返回完整URL数组
```

### 10. isShippingListEditable / isShippingListDeletable

检查发货清单是否可编辑/删除。

```typescript
isShippingListEditable('DRAFT');    // true
isShippingListEditable('SHIPPED');  // false

isShippingListDeletable('DRAFT');    // true
isShippingListDeletable('SHIPPED');  // false
```

## 最佳实践

### 1. 统一使用解析工具

所有从后端获取的发货清单数据，都应该通过解析工具处理后再使用，确保数据格式的一致性。

```typescript
// ✅ 好的做法
const response = await listShippingList(query);
const pageData = parseShippingListPageResponse(response.data);
dataList.value = pageData.records;

// ❌ 不好的做法
const response = await listShippingList(query);
dataList.value = response.data.rows; // 直接使用后端数据
```

### 2. 类型安全

使用 TypeScript 类型定义，确保类型安全。

```typescript
import type { ShippingListVO } from '@/api/erp/saltprocess/shipping/types';

const shippingList = ref<ShippingListVO>({} as ShippingListVO);
```

### 3. 错误处理

解析数据时添加错误处理。

```typescript
try {
  const shippingList = parseShippingListVO(response.data);
  // 使用数据
} catch (error) {
  console.error('数据解析失败:', error);
  ElMessage.error('数据格式错误，请联系管理员');
}
```

### 4. 空值检查

在使用可选字段前，进行空值检查。

```typescript
// ✅ 好的做法
if (shippingList.shippingPhotoUrls?.length) {
  const urls = getFullPhotoUrls(shippingList.shippingPhotoUrls);
  // 使用 urls
}

// ❌ 不好的做法
const urls = getFullPhotoUrls(shippingList.shippingPhotoUrls);
```

### 5. 工具函数复用

充分利用提供的工具函数，避免重复代码。

```typescript
// ✅ 好的做法
<el-tag :type="getStatusTagType(item.status)">
  {{ item.statusName }}
</el-tag>

// ❌ 不好的做法
<el-tag :type="item.status === 'DRAFT' ? 'info' : item.status === 'PENDING' ? 'warning' : ...">
  {{ item.statusName }}
</el-tag>
```

## 数据字段映射表

### 状态字段

| 后端字段     | 前端字段     | 说明                 |
| ------------ | ------------ | -------------------- |
| `status`     | `status`     | 状态代码             |
| `statusDesc` | `statusName` | 状态描述（优先使用） |

### 车辆字段

| 后端字段             | 前端字段             | 说明         |
| -------------------- | -------------------- | ------------ |
| `vehicleInfo`        | `vehicleInfo`        | 原始车辆信息 |
| `vehiclePlate`       | `vehiclePlate`       | 车牌号       |
| `vehicleDescription` | `vehicleDescription` | 车辆描述     |

### 司机字段

| 后端字段      | 前端字段      | 说明         |
| ------------- | ------------- | ------------ |
| `driverInfo`  | `driverInfo`  | 原始司机信息 |
| `driverName`  | `driverName`  | 司机姓名     |
| `driverPhone` | `driverPhone` | 司机电话     |

### 照片字段

| 后端字段                 | 前端字段                 | 说明                     |
| ------------------------ | ------------------------ | ------------------------ |
| `shippingPhotoUrls`      | `shippingPhotoUrls`      | 发货照片 URL 数组        |
| `driverLicensePhotoUrls` | `driverLicensePhotoUrls` | 驾照照片 URL 数组        |
| `photoPath`              | `photoPath`              | 单张照片路径（兼容旧版） |

## 常见问题

### Q1: 为什么要使用解析工具？

**A:** 解析工具的主要作用：

1. **统一数据格式**：后端返回的数据格式可能与前端期望不一致
2. **类型转换**：自动处理字符串数字、日期等类型转换
3. **字段映射**：将后端字段名映射到前端标准字段名
4. **默认值处理**：为空值提供合理的默认值
5. **兼容性**：支持新旧版本数据格式的兼容

### Q2: 如何处理后端返回 null 的字段？

**A:** 解析工具会自动处理 null 值：

```typescript
// 后端返回
{
  "remarks": null,
  "mechanicalCount": null
}

// 解析后
{
  "remarks": null,
  "mechanicalCount": null
}

// 在模板中安全使用
<div v-if="shippingList.remarks">
  {{ shippingList.remarks }}
</div>
```

### Q3: 图片 URL 如何生成？

**A:** 使用 `getFullPhotoUrls` 函数：

```typescript
// 相对路径
const relativePaths = ["/shipping-photos/xxx.jpg"];

// 转换为完整URL
const fullUrls = getFullPhotoUrls(relativePaths);
// 返回: ["http://your-domain.com/shipping-photos/xxx.jpg"]
```

### Q4: 如何扩展解析工具？

**A:** 在 `data-parser.ts` 中添加新的工具函数：

```typescript
/**
 * 新的工具函数
 */
export function customParser(data: any) {
  // 实现逻辑
}
```

## 总结

发货清单数据解析方案提供了：

1. **完整的类型定义** - 支持所有后端返回字段
2. **强大的解析工具** - 自动处理数据转换和格式化
3. **便捷的工具函数** - 简化常见操作
4. **良好的兼容性** - 支持新旧版本数据格式

遵循本文档的最佳实践，可以确保前端代码的健壮性和可维护性。
