# 发货清单增强版 Excel 导入功能说明

## 功能概述

增强版发货清单导入功能是专门为处理复杂的多 sheet 发货清单 Excel 文件而设计的。该功能可以：

1. **自动解析多个 sheet**：识别"设备发货时间"sheet 和多个车次明细 sheet（如"第一车"、"第二车"等）
2. **一比一展示数据**：在预览界面完整展示 Excel 中的所有数据，保持原始格式
3. **支持图片上传**：虽然 xlsx 库不支持直接提取 Excel 中的嵌入图片，但提供了便捷的手动上传界面
4. **动态表格渲染**：根据实际 Excel 数据结构自动生成表格列，适应不同格式的发货清单

## 文件要求

### Excel 文件结构

#### Sheet 1: 设备发货时间

必须包含以下列：

- 序号
- 名称
- 明细
- 发货时间
- 车辆信息
- 司机姓名及电话

#### Sheet 2-N: 车次明细（如"第一车"、"第二车"等）

通常包含以下列（可灵活调整）：

- 序号
- 名称
- 分项
- 数量
- 单位
- 备注
- 重量（吨）

### 支持的文件格式

- `.xlsx` (推荐)
- `.xls`

### 文件大小限制

- 最大 10MB

## 使用流程

### 步骤 1：上传文件

1. 点击"增强版导入"按钮
2. 在弹出的对话框中，将 Excel 文件拖入上传区域或点击选择文件
3. 系统会自动解析文件并显示所有可用的 sheet

### 步骤 2：预览数据

解析完成后，系统会按照以下结构展示数据：

#### 第一部分：设备发货时间

展示"设备发货时间"sheet 中的所有记录，以表格形式呈现。

#### 第二部分：设备明细

按照每个车次 sheet 分别展示：

- 每个 sheet 会生成独立的表格
- 表头和列自动根据 Excel 结构生成
- 支持大数据量的滚动浏览（最大高度 500px）

#### 第三部分：发货照片

- 如果 Excel 中没有图片，显示"添加发货照片"按钮
- 支持上传多张照片
- 支持图片预览和删除
- 可以在预览阶段随时添加更多照片

#### 第四部分：导入配置

必填信息：

- **项目**：选择对应的项目
- **负责人**：选择项目负责人
- **批次号**：默认使用第一个车次的 sheet 名称，可手动修改

### 步骤 3：确认导入

1. 检查预览数据是否正确
2. 完善导入配置信息
3. 点击"确认导入"按钮
4. 等待导入完成

### 步骤 4：完成

导入成功后，可以：

- 查看新创建的发货清单
- 关闭对话框返回列表页面

## 技术特性

### 1. 智能解析

```typescript
// 自动识别发货时间sheet
const hasTimeSheet = sheets.some(name =>
  name.includes('发货时间') || name.includes('设备发货')
);

// 自动识别车次明细sheet
const detailSheets = sheets.filter(name =>
  name.startsWith('第') || name.includes('车')
);
```

### 2. 动态表格生成

系统会自动分析每个 sheet 的列结构，生成对应的表格列定义：

```typescript
// 从数据中提取列名
const columns = Object.keys(data[0]);

// 智能设置列宽
const widthMap = {
  '序号': 80,
  '数量': 80,
  '单位': 80,
  '备注': 150,
  '重量': 100
};
```

### 3. 数据验证

- 验证 Excel 文件是否包含必要的 sheet
- 检查数据完整性
- 提示缺失的必填字段

## 核心组件

### EnhancedShippingExcelParser

Excel 解析工具类，位于 `src/utils/enhanced-shipping-excel-parser.ts`

**主要方法：**

- `parseFile(file: File)`: 解析 Excel 文件，获取所有 sheet 列表
- `parseShippingListExcel()`: 完整解析发货清单数据
- `parseShippingTimeSheet()`: 解析发货时间 sheet
- `parseEquipmentDetailSheet()`: 解析设备明细 sheet
- `validateShippingListExcel()`: 验证 Excel 文件格式

### EnhancedShippingImportDialog

增强版导入对话框组件，位于 `src/views/erp/saltprocess/shipping/components/EnhancedShippingImportDialog.vue`

**特性：**

- 三步向导流程
- 实时数据预览
- 图片上传管理
- 响应式设计

## 数据结构

### 发货时间记录

```typescript
interface ShippingTimeRecord {
  序号: number | string;
  名称: string;
  明细: string;
  发货时间: string;
  车辆信息: string;
  司机姓名及电话: string;
}
```

### 设备明细记录

```typescript
interface EquipmentDetailRecord {
  序号: number | string;
  名称: string;
  分项?: string;
  数量: number | string;
  单位: string;
  备注?: string;
  重量?: number | string;
  [key: string]: any; // 支持其他字段
}
```

### 解析结果

```typescript
interface EnhancedShippingParseResult {
  success: boolean;
  message: string;
  shippingTimes: ShippingTimeRecord[];
  equipmentDetails: {
    sheetName: string;
    data: EquipmentDetailRecord[];
  }[];
  images: {
    sheetName: string;
    imageData: string;
    position?: string;
  }[];
  availableSheets: string[];
}
```

## 注意事项

1. **Excel 图片提取限制**：由于 xlsx 库的限制，无法直接提取 Excel 中嵌入的图片。如需添加图片，请在预览阶段手动上传。

2. **数据格式要求**：虽然系统支持动态列解析，但建议保持 Excel 表头清晰，避免使用合并单元格。

3. **性能考虑**：对于超大 Excel 文件（>5MB），解析可能需要几秒钟时间，请耐心等待。

4. **浏览器兼容性**：推荐使用 Chrome、Edge 或 Firefox 最新版本。

## 与标准导入的区别

| 特性         | 标准导入     | 增强版导入     |
| ------------ | ------------ | -------------- |
| 支持多 sheet | ❌           | ✅             |
| 发货时间信息 | ❌           | ✅             |
| 动态表格生成 | ❌           | ✅             |
| 图片上传     | ❌           | ✅             |
| 数据预览     | 简化版       | 完整版         |
| 适用场景     | 单一格式清单 | 复杂多批次清单 |

## 未来计划

1. **图片提取增强**：考虑使用 exceljs 库替换 xlsx，以支持直接提取 Excel 中的图片
2. **批量导入**：支持一次选择多个 Excel 文件进行批量导入
3. **模板管理**：为不同类型的发货清单提供预定义模板
4. **导出功能**：支持将系统数据导出为相同格式的 Excel

## 技术栈

- **Vue 3.4.20**: 使用 Composition API 和`<script setup>`语法
- **TypeScript 4.9.5**: 类型安全
- **Element Plus 2.2.27**: UI 组件库
- **xlsx 0.18.5**: Excel 文件解析

## 开发规范

遵循海棠企业管理系统开发规范：

- 使用 camelCase 命名变量和函数
- 使用 PascalCase 命名组件
- 完整的 TypeScript 类型定义
- 响应式设计支持

## 问题反馈

如遇到问题，请联系开发团队或提交 Issue。
