# 发货清单批次检查接口使用说明

## 接口概述

在添加发货清单前，需要先检查该批次是否已经存在，避免重复创建。

## API 接口

### 检查批次是否存在

**接口地址**: `GET /erp/saltprocess/shipping/check-batch-exists`

**权限要求**: `erp:shipping:list:query`

**请求参数**:

| 参数名      | 类型          | 必填 | 说明                         |
| ----------- | ------------- | ---- | ---------------------------- |
| projectId   | string/number | 是   | 项目 ID                      |
| batchNumber | string        | 是   | 批次号（如：第一车、第二车） |

**返回结果**:

- `true` - 批次已存在
- `false` - 批次不存在

## TypeScript 接口定义

```typescript
import { checkBatchExists } from '@/api/erp/saltprocess/shipping';

/**
 * 检查批次是否已存在
 * @param projectId 项目ID
 * @param batchNumber 批次号
 * @returns Promise<boolean> true-已存在，false-不存在
 */
checkBatchExists(projectId: string | number, batchNumber: string): AxiosPromise<boolean>
```

## 使用场景

### 场景 1: 手动添加发货清单前检查

```vue
<script setup lang="ts">
import { ref } from 'vue';
import { ElMessage, ElMessageBox } from 'element-plus';
import { checkBatchExists, addShippingList } from '@/api/erp/saltprocess/shipping';

const formData = ref({
  projectId: '',
  batchNumber: '',
  // ... 其他字段
});

// 提交前检查
const handleSubmit = async () => {
  try {
    // 1. 先检查批次是否存在
    const { data: exists } = await checkBatchExists(
      formData.value.projectId,
      formData.value.batchNumber
    );

    if (exists) {
      // 2. 如果已存在，提示用户
      ElMessageBox.confirm(
        `批次"${formData.value.batchNumber}"已存在，是否继续添加？`,
        '批次重复提醒',
        {
          confirmButtonText: '继续添加',
          cancelButtonText: '取消',
          type: 'warning'
        }
      ).then(async () => {
        // 用户确认继续添加
        await saveShippingList();
      }).catch(() => {
        ElMessage.info('已取消添加');
      });
    } else {
      // 3. 批次不存在，直接添加
      await saveShippingList();
    }
  } catch (error) {
    console.error('检查批次失败:', error);
    ElMessage.error('检查批次失败，请重试');
  }
};

// 保存发货清单
const saveShippingList = async () => {
  try {
    await addShippingList(formData.value);
    ElMessage.success('添加成功');
  } catch (error) {
    console.error('添加失败:', error);
    ElMessage.error('添加失败');
  }
};
</script>
```

### 场景 2: 数据预览页面检查（✨ 实际应用场景）

**应用场景**：Excel 导入的第 2 步"预览数据"页面，用户选择项目后立即检查批次是否存在。

```vue
<template>
  <div class="import-wizard">
    <!-- 步骤条 -->
    <el-steps :active="currentStep" finish-status="success">
      <el-step title="上传文件"></el-step>
      <el-step title="预览数据"></el-step>
      <el-step title="完成导入"></el-step>
    </el-steps>

    <!-- 第2步：预览数据 -->
    <div v-if="currentStep === 1" class="preview-step">
      <div class="config-section">
        <el-form :model="formData" label-width="100px">
          <el-form-item label="项目" required>
            <el-select
              v-model="formData.projectId"
              placeholder="请选择项目"
              @change="handleProjectChange"
            >
              <el-option
                v-for="project in projectList"
                :key="project.id"
                :label="project.name"
                :value="project.id"
              />
            </el-select>
          </el-form-item>

          <el-form-item label="批次号">
            <el-input v-model="formData.batchNumber" readonly />
          </el-form-item>

          <el-form-item label="负责人" required>
            <el-select v-model="formData.responsiblePersonId" placeholder="请选择负责人">
              <el-option
                v-for="person in responsiblePersonList"
                :key="person.id"
                :label="person.name"
                :value="person.id"
              />
            </el-select>
          </el-form-item>
        </el-form>
      </div>

      <!-- 数据预览表格 -->
      <div class="data-preview">
        <el-table :data="previewData" border>
          <!-- 表格列定义... -->
        </el-table>
      </div>

      <!-- 操作按钮 -->
      <div class="actions">
        <el-button @click="currentStep--">上一步</el-button>
        <el-button type="primary" @click="handleImport">开始导入</el-button>
      </div>
    </div>

    <!-- 批次已存在提示对话框 -->
    <el-dialog
      v-model="batchExistsDialogVisible"
      title="批次已存在"
      width="500px"
      :close-on-click-modal="false"
    >
      <el-alert
        type="warning"
        :closable="false"
        show-icon
      >
        <template #title>
          <span style="font-size: 16px; font-weight: bold;">
            该项目的批次"{{ formData.batchNumber }}"已存在发货清单
          </span>
        </template>
      </el-alert>

      <div style="margin-top: 20px; padding: 15px; background: #f5f7fa; border-radius: 4px;">
        <p style="margin: 0; color: #606266;">
          <el-icon style="vertical-align: middle;"><InfoFilled /></el-icon>
          继续导入将会覆盖或重复创建数据，建议先查看已存在的清单详情。
        </p>
      </div>

      <template #footer>
        <span class="dialog-footer">
          <el-button @click="batchExistsDialogVisible = false">
            关闭
          </el-button>
          <el-button type="primary" @click="handleViewExistingBatch">
            查看清单详情
          </el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { ElMessage, ElLoading } from 'element-plus';
import { InfoFilled } from '@element-plus/icons-vue';
import { checkBatchExists, importEnhancedShippingList } from '@/api/erp/saltprocess/shipping';
import { useRouter } from 'vue-router';

const router = useRouter();

// 当前步骤
const currentStep = ref(1);  // 0:上传文件, 1:预览数据, 2:完成导入

// 表单数据
const formData = ref({
  projectId: '',
  batchNumber: '第一车',  // 从 Excel Sheet 名称获取
  responsiblePersonId: ''
});

// 批次已存在对话框
const batchExistsDialogVisible = ref(false);
const existingShippingListId = ref('');

// ✅ 项目选择后立即检查批次
const handleProjectChange = async (projectId: string) => {
  if (!projectId || !formData.value.batchNumber) {
    return;
  }

  // 显示加载状态
  const loading = ElLoading.service({
    lock: true,
    text: '正在检查批次...',
    background: 'rgba(0, 0, 0, 0.7)'
  });

  try {
    // 调用批次检查接口
    const { data: exists } = await checkBatchExists(
      projectId,
      formData.value.batchNumber
    );

    if (exists) {
      // 批次已存在，显示提示对话框
      batchExistsDialogVisible.value = true;

      // 如果返回结果中包含清单ID，保存下来
      if (exists.shippingListId) {
        existingShippingListId.value = exists.shippingListId;
      }
    } else {
      // 批次不存在，可以继续导入
      ElMessage.success('批次检查通过，可以导入');
    }
  } catch (error) {
    console.error('检查批次失败:', error);
    ElMessage.error('检查批次失败，请重试');
  } finally {
    loading.close();
  }
};

// 查看已存在的清单详情
const handleViewExistingBatch = () => {
  // 关闭对话框
  batchExistsDialogVisible.value = false;

  // 跳转到清单详情页面
  router.push({
    name: 'ShippingListDetail',
    params: {
      id: existingShippingListId.value
    },
    query: {
      projectId: formData.value.projectId,
      batchNumber: formData.value.batchNumber
    }
  });
};

// 开始导入
const handleImport = async () => {
  // 再次检查批次（防止用户选择项目后又修改了）
  const { data: exists } = await checkBatchExists(
    formData.value.projectId,
    formData.value.batchNumber
  );

  if (exists) {
    batchExistsDialogVisible.value = true;
    return;
  }

  // 继续导入...
  await importEnhancedShippingList({ ... });
};
</script>

<style scoped lang="scss">
.import-wizard {
  padding: 20px;

  .preview-step {
    margin-top: 30px;
  }

  .config-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .data-preview {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .actions {
    display: flex;
    justify-content: center;
    gap: 20px;
  }
}
</style>
```

**优点**：

- ✅ **即时反馈**：项目选择后立即检查，用户马上知道批次状态
- ✅ **友好提示**：清晰的对话框提示，用户体验好
- ✅ **快速跳转**：提供"查看清单详情"按钮，方便用户查看已存在的数据
- ✅ **防止重复**：在导入前再次检查，双重保险

### 场景 3: Excel 解析后立即检查（✨ 基础场景）

**最佳实践**：在 Excel 文件解析完成后，立即检查批次是否存在，避免不必要的数据处理。

```vue
<script setup lang="ts">
import { ref } from 'vue';
import { ElMessage } from 'element-plus';
import { checkBatchExists, importEnhancedShippingList } from '@/api/erp/saltprocess/shipping';
import { extractExcelMetadata } from '@/api/erp/saltprocess/shipping/excel-parser';
import * as XLSX from 'xlsx';

// Excel 文件上传处理
const handleFileUpload = async (file: File) => {
  try {
    // 1. 解析 Excel 文件
    const workbook = await readExcelFile(file);
    const sheetName = workbook.SheetNames[0];

    // 2. ✅ 立即检查批次是否存在（解析后第一时间检查）
    const projectId = formData.value.projectId;
    const batchNumber = sheetName;  // 使用 Sheet 名称作为批次号

    const { data: exists } = await checkBatchExists(projectId, batchNumber);

    if (exists) {
      // 批次已存在，立即停止，不再进行后续的数据处理
      ElMessage.warning({
        message: `批次"${batchNumber}"已存在，请检查后再导入！`,
        duration: 5000
      });
      return;  // ✅ 提前返回，避免浪费资源处理数据
    }

    // 3. 批次不存在，继续解析数据
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

    // 4. 提取元数据
    const metadata = extractExcelMetadata({
      title: jsonData[0][0],
      secondRow: jsonData[1][0],
      sheetName: sheetName
    });

    // 5. 解析明细数据
    let items = jsonData.slice(2).map(row => ({
      sequenceNo: row[0],
      equipmentName: row[1],
      quantity: row[2],
      unit: row[3],
      specification: row[4],
      remarks1: row[5]
    }));

    // 6. 批量分配元数据
    items = assignEquipmentTypes(items, metadata.equipmentType);
    items = assignSubsystems(items, metadata.subsystem);
    items = assignShippingTypes(items, metadata.shippingType);
    items = items.map(item => ({
      ...item,
      sheetName: metadata.sheetName
    }));

    // 7. 调用导入接口
    await importEnhancedShippingList({
      projectId: projectId,
      batchNumber: batchNumber,
      shippingType: metadata.shippingType,
      subsystem: metadata.subsystem,
      responsiblePersonId: formData.value.responsiblePersonId,
      shippingDate: formData.value.shippingDate,
      shippingItems: items
    });

    ElMessage.success('导入成功');
  } catch (error) {
    console.error('导入失败:', error);
    ElMessage.error('导入失败');
  }
};

// 辅助函数：读取 Excel 文件
const readExcelFile = (file: File): Promise<XLSX.WorkBook> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        resolve(workbook);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
};
</script>
```

**优点**：

- ✅ **提前发现问题**：解析后立即检查，无需等待全部数据处理完成
- ✅ **节省资源**：批次已存在时不再进行后续的数据处理和格式化
- ✅ **更好的用户体验**：更快地给出反馈，用户不必等待
- ✅ **避免重复提交**：在第一时间拦截重复的批次

### 场景 4: 多 Sheet 批量导入（✨ 优化版）

**最佳实践**：解析 Excel 后，立即批量检查所有 Sheet 对应的批次，然后只处理不存在的批次。

```vue
<script setup lang="ts">
import { ref } from 'vue';
import { ElMessage, ElMessageBox } from 'element-plus';
import { checkBatchExists, importEnhancedShippingList } from '@/api/erp/saltprocess/shipping';
import { extractExcelMetadata, assignEquipmentTypes, assignSubsystems, assignShippingTypes } from '@/api/erp/saltprocess/shipping/excel-parser';
import * as XLSX from 'xlsx';

// 处理多个 Sheet
const handleMultiSheetUpload = async (file: File) => {
  try {
    // 1. 解析 Excel 文件
    const workbook = await readExcelFile(file);
    const projectId = formData.value.projectId;

    // 2. ✅ 立即批量检查所有批次（并发请求，提升性能）
    const checkPromises = workbook.SheetNames.map(sheetName =>
      checkBatchExists(projectId, sheetName)
        .then(res => ({ sheetName, exists: res.data }))
    );

    const checkResults = await Promise.all(checkPromises);

    // 3. 分类：已存在的批次 vs 新批次
    const existingBatches = checkResults
      .filter(r => r.exists)
      .map(r => r.sheetName);

    const newBatches = checkResults
      .filter(r => !r.exists)
      .map(r => r.sheetName);

    // 4. 提示用户检查结果
    if (existingBatches.length > 0) {
      const message = `以下批次已存在，将跳过：\n${existingBatches.join('、')}\n\n是否继续导入其他批次？`;

      await ElMessageBox.confirm(message, '批次检查提醒', {
        confirmButtonText: '继续导入',
        cancelButtonText: '取消',
        type: 'warning'
      });
    }

    // 5. 如果没有新批次，直接返回
    if (newBatches.length === 0) {
      ElMessage.info('所有批次都已存在，无需导入');
      return;
    }

    // 6. ✅ 只处理新批次的数据
    let successCount = 0;
    let failCount = 0;

    for (const sheetName of newBatches) {
      try {
        // 解析该 Sheet 的数据
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // 提取元数据
        const metadata = extractExcelMetadata({
          title: jsonData[0][0],
          secondRow: jsonData[1][0],
          sheetName: sheetName
        });

        // 解析明细数据
        let items = jsonData.slice(2).map(row => ({
          sequenceNo: row[0],
          equipmentName: row[1],
          quantity: row[2],
          unit: row[3],
          specification: row[4],
          remarks1: row[5]
        }));

        // 批量分配元数据
        items = assignEquipmentTypes(items, metadata.equipmentType);
        items = assignSubsystems(items, metadata.subsystem);
        items = assignShippingTypes(items, metadata.shippingType);
        items = items.map(item => ({
          ...item,
          sheetName: metadata.sheetName
        }));

        // 导入数据
        await importEnhancedShippingList({
          projectId: projectId,
          batchNumber: sheetName,
          shippingType: metadata.shippingType,
          subsystem: metadata.subsystem,
          responsiblePersonId: formData.value.responsiblePersonId,
          shippingDate: formData.value.shippingDate,
          shippingItems: items
        });

        successCount++;
        console.log(`✅ 批次"${sheetName}"导入成功`);
      } catch (error) {
        failCount++;
        console.error(`❌ 批次"${sheetName}"导入失败:`, error);
      }
    }

    // 7. 显示导入结果
    const summary = [
      `导入完成！`,
      `✅ 成功: ${successCount}`,
      existingBatches.length > 0 ? `⏭️ 跳过: ${existingBatches.length}` : '',
      failCount > 0 ? `❌ 失败: ${failCount}` : ''
    ].filter(Boolean).join('，');

    ElMessage.success(summary);

  } catch (error) {
    if (error !== 'cancel') {
      console.error('导入失败:', error);
      ElMessage.error('导入失败');
    }
  }
};
</script>
```

**优点**：

- ✅ **并发检查**：使用 `Promise.all` 批量检查，性能更好
- ✅ **提前过滤**：只处理不存在的批次，节省时间和资源
- ✅ **清晰反馈**：明确告知用户哪些批次已存在、哪些将被导入
- ✅ **用户控制**：用户可以决定是否继续导入其他批次

### 场景 5: 批次号输入时实时检查

```vue
<template>
  <el-form>
    <el-form-item label="项目">
      <el-select v-model="formData.projectId" @change="handleProjectChange">
        <el-option
          v-for="project in projectList"
          :key="project.id"
          :label="project.name"
          :value="project.id"
        />
      </el-select>
    </el-form-item>

    <el-form-item label="批次号">
      <el-input
        v-model="formData.batchNumber"
        placeholder="请输入批次号（如：第一车）"
        @blur="checkBatch"
      >
        <template #suffix>
          <el-icon v-if="batchStatus.checking" class="is-loading">
            <Loading />
          </el-icon>
          <el-icon v-else-if="batchStatus.exists" color="#F56C6C">
            <CircleClose />
          </el-icon>
          <el-icon v-else-if="batchStatus.checked" color="#67C23A">
            <CircleCheck />
          </el-icon>
        </template>
      </el-input>
      <div v-if="batchStatus.exists" style="color: #F56C6C; font-size: 12px; margin-top: 4px;">
        该批次已存在
      </div>
    </el-form-item>
  </el-form>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { checkBatchExists } from '@/api/erp/saltprocess/shipping';
import { Loading, CircleClose, CircleCheck } from '@element-plus/icons-vue';

const formData = ref({
  projectId: '',
  batchNumber: ''
});

const batchStatus = reactive({
  checking: false,    // 正在检查
  checked: false,     // 已检查
  exists: false       // 是否存在
});

// 检查批次
const checkBatch = async () => {
  if (!formData.value.projectId || !formData.value.batchNumber) {
    return;
  }

  batchStatus.checking = true;
  batchStatus.checked = false;
  batchStatus.exists = false;

  try {
    const { data: exists } = await checkBatchExists(
      formData.value.projectId,
      formData.value.batchNumber
    );

    batchStatus.exists = exists;
    batchStatus.checked = true;
  } catch (error) {
    console.error('检查批次失败:', error);
  } finally {
    batchStatus.checking = false;
  }
};

// 项目变化时重新检查
const handleProjectChange = () => {
  if (formData.value.batchNumber) {
    checkBatch();
  }
};
</script>
```

## 最佳实践

### 1. ✨ Excel 解析后立即检查（强烈推荐）

```typescript
// ✅ 最佳实践：解析后第一时间检查，避免不必要的数据处理
const handleExcelUpload = async (file: File) => {
  // 1. 解析 Excel 获取 Sheet 名称
  const workbook = await readExcelFile(file);
  const sheetName = workbook.SheetNames[0];

  // 2. 立即检查批次
  const { data: exists } = await checkBatchExists(projectId, sheetName);
  if (exists) {
    ElMessage.warning(`批次"${sheetName}"已存在`);
    return;  // ✅ 提前返回，节省资源
  }

  // 3. 批次不存在，继续处理数据
  const jsonData = parseExcelData(workbook);
  // ... 后续处理
};

// ❌ 不推荐：处理完所有数据后才检查
const handleExcelUpload = async (file: File) => {
  const workbook = await readExcelFile(file);
  const jsonData = parseExcelData(workbook);  // 浪费资源处理数据
  const items = processItems(jsonData);       // 继续浪费资源

  // 最后才检查，前面的工作可能白做了
  const exists = await checkBatchExists(projectId, batchNumber);
  if (exists) {
    return;  // 已经浪费了大量处理时间
  }
};
```

### 2. 批量导入时并发检查所有批次

```typescript
// ✅ 推荐：使用 Promise.all 并发检查，性能更好
const batchImport = async (sheets: string[]) => {
  // 1. 并发检查所有批次
  const checkPromises = sheets.map(sheet =>
    checkBatchExists(projectId, sheet)
      .then(res => ({ sheet, exists: res.data }))
  );

  const checkResults = await Promise.all(checkPromises);

  // 2. 过滤出不存在的批次
  const newSheets = checkResults
    .filter(r => !r.exists)
    .map(r => r.sheet);

  // 3. 只导入新批次
  for (const sheet of newSheets) {
    await importSheet(sheet);
  }
};

// ❌ 不推荐：串行检查，速度慢
const batchImport = async (sheets: string[]) => {
  for (const sheet of sheets) {
    const exists = await checkBatchExists(projectId, sheet);  // 串行等待
    if (!exists) {
      await importSheet(sheet);
    }
  }
};
```

### 3. 总是在添加前检查

```typescript
// ✅ 推荐：先检查再添加
const addShipping = async () => {
  const { data: exists } = await checkBatchExists(projectId, batchNumber);
  if (exists) {
    ElMessage.warning('批次已存在');
    return;
  }
  await addShippingList(data);
};

// ❌ 不推荐：直接添加，依赖后端报错
const addShipping = async () => {
  await addShippingList(data);  // 可能失败，用户体验差
};
```

### 4. 提供清晰的用户反馈

```typescript
// ✅ 推荐：提供明确的提示信息
if (exists) {
  ElMessage.warning(`批次"${batchNumber}"已存在，请使用其他批次号`);
  return;
}

// ❌ 不推荐：模糊的提示
if (exists) {
  ElMessage.error('操作失败');
  return;
}
```

### 5. 处理异常情况

```typescript
// ✅ 推荐：完整的错误处理
try {
  const { data: exists } = await checkBatchExists(projectId, batchNumber);
  if (exists) {
    // 处理已存在的情况
  } else {
    // 继续添加
  }
} catch (error) {
  console.error('检查批次失败:', error);
  ElMessage.error('检查批次失败，请重试');
}
```

## 注意事项

1. **权限要求**: 需要 `erp:shipping:list:query` 权限
2. **参数验证**: 确保 `projectId` 和 `batchNumber` 都不为空
3. **性能优化**: 批量检查时使用 `Promise.all` 并发请求
4. **用户体验**: 提供实时反馈（加载状态、成功/失败图标）
5. **错误处理**: 捕获异常并给出友好的错误提示

## 相关接口

- [添加发货清单](./index.ts#addShippingList)
- [增强版发货清单导入](./index.ts#importEnhancedShippingList)
- [发货清单数据提取](./发货清单数据提取快速参考.md)

## 完整工作流程

### Excel 导入流程（✨ 推荐）

```
用户上传 Excel
  ↓
1. 解析 Excel 文件，获取 Sheet 名称
  ↓
2. ✅ 立即检查批次是否存在
  ↓
3a. 批次已存在
  │   ↓
  │   提示用户 → 停止处理 → 节省资源 ✅
  │
3b. 批次不存在
  │   ↓
  │   继续解析数据（提取元数据、明细等）
  │   ↓
  │   调用 importEnhancedShippingList
  │   ↓
  │   显示成功结果
```

### 手动添加流程

```
用户输入项目ID和批次号
  ↓
1. 调用 checkBatchExists 检查
  ↓
2a. 批次已存在 → 提示用户 → 停止或让用户决定
  ↓
2b. 批次不存在 → 继续添加
  ↓
3. 调用 addShippingList
  ↓
4. 显示成功/失败结果
```

### 多 Sheet 批量导入流程

```
用户上传 Excel（多个 Sheet）
  ↓
1. 解析 Excel，获取所有 Sheet 名称
  ↓
2. ✅ 并发检查所有批次（Promise.all）
  ↓
3. 分类：已存在批次 vs 新批次
  ↓
4. 提示用户检查结果
  ↓
5. ✅ 只处理新批次的数据
  ↓
6. 逐个导入新批次
  ↓
7. 显示汇总结果（成功数、跳过数、失败数）
```

## 测试示例

```typescript
// 测试批次检查
const testCheckBatch = async () => {
  const testCases = [
    { projectId: '1', batchNumber: '第一车', expected: true },
    { projectId: '1', batchNumber: '第二车', expected: false },
    { projectId: '2', batchNumber: '第一车', expected: false }
  ];

  for (const testCase of testCases) {
    const { data: exists } = await checkBatchExists(
      testCase.projectId,
      testCase.batchNumber
    );

    console.log(
      `项目${testCase.projectId}的批次"${testCase.batchNumber}": `,
      exists ? '已存在' : '不存在',
      exists === testCase.expected ? '✅' : '❌'
    );
  }
};
```

---

**提示**: 这个接口是防止重复创建发货清单的关键步骤，建议在所有添加发货清单的场景中都使用。
