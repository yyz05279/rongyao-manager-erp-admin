# 发货清单增强版接口使用文档

## 概述

本文档详细说明了发货清单增强版功能的 API 接口使用方法，包括图片批量上传和增强版发货清单导入功能。

## 更新日期

2025 年 10 月 29 日

## 主要功能

1. **图片批量上传**：支持一次上传最多 9 张图片，自动保存到项目根目录的`upload/`文件夹
2. **增强版发货清单导入**：支持车辆详细信息、司机信息、发货照片和司机驾照照片等

## 一、图片批量上传接口

### 1.1 接口信息

-   **URL**: `/erp/common/upload/images`
-   **方法**: `POST`
-   **Content-Type**: `multipart/form-data`
-   **权限**: `erp:file:upload`

### 1.2 请求参数

| 参数名  | 类型            | 必填 | 说明                                            |
| ------- | --------------- | ---- | ----------------------------------------------- |
| files   | MultipartFile[] | 是   | 图片文件列表（最多 9 张）                       |
| bizType | String          | 是   | 业务类型（如：shipping-photos、driver-license） |

### 1.3 支持的图片格式

-   jpg / jpeg
-   png
-   gif
-   bmp
-   webp

### 1.4 文件大小限制

-   单个文件最大：10MB
-   批量上传最多：9 张图片

### 1.5 请求示例

#### cURL

```bash
curl -X POST "http://localhost:8080/erp/common/upload/images" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "files=@/path/to/image1.jpg" \
  -F "files=@/path/to/image2.jpg" \
  -F "bizType=shipping-photos"
```

#### JavaScript (Axios)

```javascript
const formData = new FormData();
formData.append("files", file1);
formData.append("files", file2);
formData.append("bizType", "shipping-photos");

axios
    .post("/erp/common/upload/images", formData, {
        headers: {
            "Content-Type": "multipart/form-data",
        },
    })
    .then((response) => {
        console.log("上传成功:", response.data);
    });
```

#### Vue 3 示例

```vue
<template>
    <div>
        <input
            type="file"
            multiple
            accept="image/*"
            @change="handleFileSelect"
            :disabled="uploading"
        />
        <button
            @click="uploadImages"
            :disabled="uploading || files.length === 0"
        >
            上传图片 ({{ files.length }}/9)
        </button>
    </div>
</template>

<script setup>
import { ref } from "vue";
import axios from "axios";

const files = ref([]);
const uploading = ref(false);

const handleFileSelect = (event) => {
    const selectedFiles = Array.from(event.target.files);

    // 限制最多9张
    if (selectedFiles.length > 9) {
        alert("最多只能选择9张图片");
        files.value = selectedFiles.slice(0, 9);
    } else {
        files.value = selectedFiles;
    }
};

const uploadImages = async () => {
    if (files.value.length === 0) return;

    try {
        uploading.value = true;

        const formData = new FormData();
        files.value.forEach((file) => {
            formData.append("files", file);
        });
        formData.append("bizType", "shipping-photos");

        const response = await axios.post(
            "/erp/common/upload/images",
            formData,
            {
                headers: {
                    "Content-Type": "multipart/form-data",
                },
            }
        );

        console.log("上传成功:", response.data);

        // 获取上传后的URL列表
        const uploadedUrls = response.data.data.map((item) => item.fileUrl);
        console.log("图片URL列表:", uploadedUrls);
    } catch (error) {
        console.error("上传失败:", error);
        alert("上传失败: " + error.message);
    } finally {
        uploading.value = false;
    }
};
</script>
```

### 1.6 响应格式

#### 成功响应

```json
{
    "code": 200,
    "message": "图片上传成功",
    "data": [
        {
            "originalFileName": "photo1.jpg",
            "savedFileName": "1730188800000_a1b2c3d4.jpg",
            "filePath": "shipping-photos/2025-10-29/1730188800000_a1b2c3d4.jpg",
            "fileUrl": "/shipping-photos/2025-10-29/1730188800000_a1b2c3d4.jpg",
            "fileSize": 1024567,
            "contentType": "image/jpeg",
            "bizType": "shipping-photos",
            "uploadTime": "2025-10-29 15:30:00",
            "success": true,
            "errorMessage": null
        },
        {
            "originalFileName": "photo2.jpg",
            "savedFileName": "1730188800001_e5f6g7h8.jpg",
            "filePath": "shipping-photos/2025-10-29/1730188800001_e5f6g7h8.jpg",
            "fileUrl": "/shipping-photos/2025-10-29/1730188800001_e5f6g7h8.jpg",
            "fileSize": 987654,
            "contentType": "image/jpeg",
            "bizType": "shipping-photos",
            "uploadTime": "2025-10-29 15:30:01",
            "success": true,
            "errorMessage": null
        }
    ]
}
```

#### 部分失败响应

```json
{
    "code": 200,
    "message": "部分文件上传失败，成功: 2, 失败: 1",
    "data": [
        {
            "originalFileName": "photo1.jpg",
            "success": true,
            "fileUrl": "/shipping-photos/2025-10-29/1730188800000_a1b2c3d4.jpg"
        },
        {
            "originalFileName": "invalid.txt",
            "success": false,
            "errorMessage": "只允许上传图片文件（jpg、png、gif、bmp、webp）"
        }
    ]
}
```

### 1.7 存储路径规则

文件存储在项目根目录的`upload/`文件夹下，按以下规则组织：

```
upload/
├── shipping-photos/           # 发货照片
│   ├── 2025-10-29/
│   │   ├── 1730188800000_a1b2c3d4.jpg
│   │   └── 1730188800001_e5f6g7h8.jpg
│   └── 2025-10-30/
│       └── ...
├── driver-license/            # 司机驾照
│   ├── 2025-10-29/
│   │   └── 1730188900000_i9j0k1l2.jpg
│   └── ...
└── other-business-type/       # 其他业务类型
    └── ...
```

### 1.8 其他接口

#### 单个图片上传

-   **URL**: `/erp/common/upload/image`
-   **方法**: `POST`

#### 删除文件

-   **URL**: `/erp/common/upload`
-   **方法**: `DELETE`
-   **参数**: `filePath` (文件相对路径)

#### 获取支持的文件类型

-   **URL**: `/erp/common/upload/supported-types`
-   **方法**: `GET`

## 二、增强版发货清单导入接口

### 2.1 接口信息

-   **URL**: `/erp/saltprocess/shipping/import/data`
-   **方法**: `POST`
-   **Content-Type**: `application/json`
-   **权限**: `erp:shipping:import`

### 2.2 增强版字段说明

相比旧版本，新增了以下字段：

| 字段名                 | 类型           | 说明                  |
| ---------------------- | -------------- | --------------------- |
| vehiclePlate           | String         | 车牌号                |
| vehicleDescription     | String         | 车辆描述              |
| driverName             | String         | 司机姓名              |
| driverPhone            | String         | 司机电话              |
| shippingPhotoUrls      | List\<String\> | 发货照片 URL 列表     |
| driverLicensePhotoUrls | List\<String\> | 司机驾照照片 URL 列表 |

### 2.3 完整请求示例

```json
{
    "projectId": "1001",
    "projectName": "某化盐项目",
    "batchNumber": "第一车",
    "shippingType": "MECHANICAL",
    "shippingLocation": "工厂仓库",
    "responsiblePerson": "张三",
    "responsiblePersonId": 10001,
    "shippingDate": "2025-10-29",
    "expectedDeliveryDate": "2025-11-01",
    "shippingMethod": "TRUCK",

    // 兼容旧版字段
    "vehicleInfo": "豫A12345 厢式货车",
    "driverInfo": "李四 13800138000",

    // 新增增强版字段
    "vehiclePlate": "豫A12345",
    "vehicleDescription": "厢式货车 载重15吨",
    "driverName": "李四",
    "driverPhone": "13800138000",
    "shippingPhotoUrls": [
        "/shipping-photos/2025-10-29/1730188800000_a1b2c3d4.jpg",
        "/shipping-photos/2025-10-29/1730188800001_e5f6g7h8.jpg"
    ],
    "driverLicensePhotoUrls": [
        "/driver-license/2025-10-29/1730188900000_i9j0k1l2.jpg"
    ],

    "remarks": "注意轻搬轻放",

    "shippingItems": [
        {
            "sequenceNo": 1,
            "equipmentName": "平面输送机",
            "subItemName": "输送主体",
            "quantity": 2,
            "unit": "套",
            "weight": 1.5,
            "specification": "长度15米",
            "equipmentType": "MECHANICAL",
            "remarks1": "需要防雨",
            "remarks": "包装完好"
        }
    ]
}
```

### 2.4 完整使用流程

#### 步骤 1：上传发货照片

```javascript
// 1. 上传发货照片
const shippingPhotos = [file1, file2, file3];
const shippingFormData = new FormData();
shippingPhotos.forEach((file) => {
    shippingFormData.append("files", file);
});
shippingFormData.append("bizType", "shipping-photos");

const shippingResponse = await axios.post(
    "/erp/common/upload/images",
    shippingFormData
);

const shippingPhotoUrls = shippingResponse.data.data
    .filter((item) => item.success)
    .map((item) => item.fileUrl);

console.log("发货照片上传成功:", shippingPhotoUrls);
```

#### 步骤 2：上传司机驾照

```javascript
// 2. 上传司机驾照
const driverLicensePhotos = [licenseFile1];
const licenseFormData = new FormData();
driverLicensePhotos.forEach((file) => {
    licenseFormData.append("files", file);
});
licenseFormData.append("bizType", "driver-license");

const licenseResponse = await axios.post(
    "/erp/common/upload/images",
    licenseFormData
);

const driverLicensePhotoUrls = licenseResponse.data.data
    .filter((item) => item.success)
    .map((item) => item.fileUrl);

console.log("驾照照片上传成功:", driverLicensePhotoUrls);
```

#### 步骤 3：导入发货清单

```javascript
// 3. 导入发货清单（使用上传的图片URL）
const importData = {
    projectId: "1001",
    batchNumber: "第一车",
    shippingType: "MECHANICAL",

    // 车辆信息
    vehiclePlate: "豫A12345",
    vehicleDescription: "厢式货车 载重15吨",

    // 司机信息
    driverName: "李四",
    driverPhone: "13800138000",

    // 图片URL列表
    shippingPhotoUrls: shippingPhotoUrls,
    driverLicensePhotoUrls: driverLicensePhotoUrls,

    // 设备明细
    shippingItems: [
        {
            sequenceNo: 1,
            equipmentName: "平面输送机",
            subItemName: "输送主体",
            quantity: 2,
            unit: "套",
            weight: 1.5,
        },
    ],
};

const importResponse = await axios.post(
    "/erp/saltprocess/shipping/import/data",
    importData
);

console.log("导入成功:", importResponse.data);
```

#### 完整 Vue 3 组件示例

```vue
<template>
    <div class="shipping-import">
        <el-form :model="form" label-width="120px">
            <!-- 基本信息 -->
            <el-form-item label="项目ID">
                <el-input v-model="form.projectId" />
            </el-form-item>

            <el-form-item label="批次号">
                <el-input v-model="form.batchNumber" />
            </el-form-item>

            <!-- 车辆信息 -->
            <el-form-item label="车牌号">
                <el-input v-model="form.vehiclePlate" />
            </el-form-item>

            <el-form-item label="车辆描述">
                <el-input v-model="form.vehicleDescription" />
            </el-form-item>

            <!-- 司机信息 -->
            <el-form-item label="司机姓名">
                <el-input v-model="form.driverName" />
            </el-form-item>

            <el-form-item label="司机电话">
                <el-input v-model="form.driverPhone" />
            </el-form-item>

            <!-- 发货照片 -->
            <el-form-item label="发货照片">
                <el-upload
                    :auto-upload="false"
                    :file-list="shippingPhotoFiles"
                    :limit="9"
                    accept="image/*"
                    list-type="picture-card"
                    @change="handleShippingPhotoChange"
                >
                    <el-icon><Plus /></el-icon>
                </el-upload>
                <div class="upload-tip">最多上传9张图片</div>
            </el-form-item>

            <!-- 司机驾照 -->
            <el-form-item label="司机驾照">
                <el-upload
                    :auto-upload="false"
                    :file-list="driverLicenseFiles"
                    :limit="9"
                    accept="image/*"
                    list-type="picture-card"
                    @change="handleDriverLicenseChange"
                >
                    <el-icon><Plus /></el-icon>
                </el-upload>
            </el-form-item>

            <!-- 设备明细 -->
            <el-form-item label="设备明细">
                <!-- 设备明细表格 -->
            </el-form-item>

            <!-- 操作按钮 -->
            <el-form-item>
                <el-button
                    type="primary"
                    @click="handleImport"
                    :loading="importing"
                >
                    导入
                </el-button>
            </el-form-item>
        </el-form>
    </div>
</template>

<script setup>
import { ref } from "vue";
import { ElMessage } from "element-plus";
import axios from "axios";

const form = ref({
    projectId: "",
    batchNumber: "",
    vehiclePlate: "",
    vehicleDescription: "",
    driverName: "",
    driverPhone: "",
    shippingItems: [],
});

const shippingPhotoFiles = ref([]);
const driverLicenseFiles = ref([]);
const importing = ref(false);

const handleShippingPhotoChange = (file, fileList) => {
    shippingPhotoFiles.value = fileList;
};

const handleDriverLicenseChange = (file, fileList) => {
    driverLicenseFiles.value = fileList;
};

const uploadPhotos = async (files, bizType) => {
    if (!files || files.length === 0) return [];

    const formData = new FormData();
    files.forEach((item) => {
        formData.append("files", item.raw);
    });
    formData.append("bizType", bizType);

    const response = await axios.post("/erp/common/upload/images", formData);
    return response.data.data
        .filter((item) => item.success)
        .map((item) => item.fileUrl);
};

const handleImport = async () => {
    try {
        importing.value = true;

        // 1. 上传发货照片
        const shippingPhotoUrls = await uploadPhotos(
            shippingPhotoFiles.value,
            "shipping-photos"
        );

        // 2. 上传司机驾照
        const driverLicensePhotoUrls = await uploadPhotos(
            driverLicenseFiles.value,
            "driver-license"
        );

        // 3. 导入发货清单
        const importData = {
            ...form.value,
            shippingPhotoUrls,
            driverLicensePhotoUrls,
        };

        const response = await axios.post(
            "/erp/saltprocess/shipping/import/data",
            importData
        );

        if (response.data.data.success) {
            ElMessage.success("导入成功");
        } else {
            ElMessage.error("导入失败: " + response.data.data.summary);
        }
    } catch (error) {
        console.error("导入失败:", error);
        ElMessage.error("导入失败: " + error.message);
    } finally {
        importing.value = false;
    }
};
</script>

<style scoped>
.upload-tip {
    color: #999;
    font-size: 12px;
    margin-top: 5px;
}
</style>
```

## 三、数据库迁移

### 3.1 执行迁移脚本

在执行导入功能前，需要先执行数据库迁移脚本：

```bash
mysql -u root -p haitang_erp < sql/erp_shipping_list_enhanced_fields.sql
```

### 3.2 新增字段说明

| 字段名                    | 类型         | 说明                               |
| ------------------------- | ------------ | ---------------------------------- |
| vehicle_plate             | VARCHAR(50)  | 车牌号                             |
| vehicle_description       | VARCHAR(200) | 车辆描述                           |
| driver_name               | VARCHAR(50)  | 司机姓名                           |
| driver_phone              | VARCHAR(20)  | 司机电话                           |
| shipping_photo_urls       | TEXT         | 发货照片 URL 列表（JSON 格式）     |
| driver_license_photo_urls | TEXT         | 司机驾照照片 URL 列表（JSON 格式） |

## 四、配置说明

### 4.1 文件上传路径配置

在`application.yml`中配置上传路径：

```yaml
file:
    upload:
        path: upload # 相对于项目根目录
```

### 4.2 权限配置

确保用户拥有以下权限：

-   `erp:file:upload` - 文件上传权限
-   `erp:file:delete` - 文件删除权限
-   `erp:shipping:import` - 发货清单导入权限
-   `erp:shipping:validate` - 发货清单验证权限

## 五、注意事项

### 5.1 兼容性

-   新版接口完全兼容旧版数据结构
-   `vehicleInfo`、`driverInfo`、`photoPath` 等旧字段仍然保留
-   建议使用新字段（`vehiclePlate`、`driverName`等）以获得更好的结构化数据

### 5.2 图片 URL 格式

-   上传接口返回的`fileUrl`是相对路径，以`/`开头
-   前端展示时需要拼接完整的服务器地址
-   示例：`http://your-domain.com/upload/shipping-photos/2025-10-29/xxx.jpg`

### 5.3 数据持久化

-   图片 URL 列表在数据库中以 JSON 格式存储
-   查询时需要解析 JSON 字符串为 List
-   Service 层已实现自动转换逻辑

### 5.4 错误处理

-   图片上传失败不会影响其他图片的上传
-   部分上传失败时，接口会返回详细的错误信息
-   建议前端进行重试处理

## 六、常见问题

### Q1: 为什么我的图片无法访问？

A: 请检查：

1. `upload/`目录是否有写入权限
2. 服务器是否配置了静态资源访问路径
3. 图片 URL 是否正确（检查是否有多余的斜杠）

### Q2: 上传图片后，数据库中看不到图片 URL？

A: 请检查：

1. 是否执行了数据库迁移脚本
2. 导入数据时是否包含了`shippingPhotoUrls`和`driverLicensePhotoUrls`字段
3. 检查 Service 层的 JSON 转换逻辑是否正常

### Q3: 如何在查询时获取图片 URL 列表？

A: 需要在 Service 层添加 JSON 转 List 的转换逻辑：

```java
public List<String> getShippingPhotoUrls(Long shippingListId) {
    ErpShippingList entity = baseMapper.selectById(shippingListId);
    if (entity == null || entity.getShippingPhotoUrls() == null) {
        return Collections.emptyList();
    }
    return convertJsonToList(entity.getShippingPhotoUrls());
}
```

## 七、版本历史

-   **v1.0** (2025-10-29)
    -   初始版本
    -   支持图片批量上传（最多 9 张）
    -   支持增强版发货清单导入
    -   新增车辆和司机详细信息字段

## 八、技术支持

如有问题，请联系开发团队或提交 Issue。
