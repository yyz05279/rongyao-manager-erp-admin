# Vue3 + TypeScript + Element Plus 项目打包部署方案

## 目录
1. [方案概述](#方案概述)
2. [方案一：静态服务器部署（推荐快速方案）](#方案一静态服务器部署推荐快速方案)
3. [方案二：Electron 桌面应用打包](#方案二electron-桌面应用打包)
4. [方案三：Docker 容器化部署](#方案三docker-容器化部署)
5. [方案对比](#方案对比)
6. [常见问题](#常见问题)

---

## 方案概述

根据您的需求，我们提供了三种主要的打包部署方案：

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **静态服务器** | 快速、轻量、易部署 | 需要配置服务器 | 快速测试、演示、分发 |
| **Electron** | 完整桌面应用、离线运行 | 包体积大、学习曲线陡 | 需要完整应用体验 |
| **Docker** | 跨平台、环境一致 | 需要 Docker 环境 | 企业部署、多机器分发 |

---

## 方案一：静态服务器部署（推荐快速方案）

### 1.1 原理说明

此方案将 Vue3 项目构建为静态文件（HTML、CSS、JS），然后使用轻量级 HTTP 服务器（如 http-server）在本地运行。

**优势：**
- ✅ 最快速的实现方式
- ✅ 无需开发环境依赖
- ✅ 包体积最小
- ✅ 易于理解和维护

### 1.2 实现步骤

#### 步骤 1：构建生产版本

```bash
# 在项目根目录执行
npm run build:prod
```

执行后会生成 `dist` 文件夹，包含所有打包后的静态文件。

#### 步骤 2：安装 http-server

**方案 A：全局安装（推荐）**
```bash
npm install -g http-server
```

**方案 B：项目本地安装**
```bash
npm install --save-dev http-server
```

#### 步骤 3：运行服务器

**方案 A：使用全局 http-server**
```bash
cd dist
http-server -p 8080 -o
```

**方案 B：使用 npm 脚本**

在 `package.json` 中添加脚本：
```json
{
  "scripts": {
    "serve": "http-server dist -p 8080 -o"
  }
}
```

然后运行：
```bash
npm run serve
```

**方案 C：使用 Vite 预览**
```bash
npm run preview
```

### 1.3 完整配置示例

#### 更新 package.json

```json
{
  "scripts": {
    "dev": "vite serve --mode development",
    "build:prod": "vite build --mode production && vue-tsc --noEmit",
    "preview": "vite preview",
    "serve:dist": "http-server dist -p 8080 -c-1 -o",
    "lint": "eslint src/**/*.{ts,js,vue} --fix",
    "prepare": "husky install",
    "prettier": "prettier --write ."
  }
}
```

#### 创建启动脚本

**Windows 批处理文件** (`bin/start-server.bat`)：

```batch
@echo off
REM 检查是否已安装 http-server
where http-server >nul 2>nul
if %errorlevel% neq 0 (
    echo 正在安装 http-server...
    npm install -g http-server
)

REM 检查 dist 文件夹是否存在
if not exist "dist" (
    echo 正在构建项目...
    call npm run build:prod
)

REM 启动服务器
echo 启动服务器，访问地址: http://localhost:8080
cd dist
http-server -p 8080 -c-1 -o
```

**macOS/Linux 脚本** (`bin/start-server.sh`)：

```bash
#!/bin/bash

# 检查是否已安装 http-server
if ! command -v http-server &> /dev/null; then
    echo "正在安装 http-server..."
    npm install -g http-server
fi

# 检查 dist 文件夹是否存在
if [ ! -d "dist" ]; then
    echo "正在构建项目..."
    npm run build:prod
fi

# 启动服务器
echo "启动服务器，访问地址: http://localhost:8080"
cd dist
http-server -p 8080 -c-1 -o
```

### 1.4 高级配置

#### 配置 CORS（如需跨域请求）

```bash
http-server dist -p 8080 --cors
```

#### 配置缓存策略

```bash
# 禁用缓存（开发测试）
http-server dist -p 8080 -c-1

# 启用缓存（生产环境）
http-server dist -p 8080 -c 3600
```

#### 配置 HTTPS

```bash
# 生成自签名证书
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# 启动 HTTPS 服务器
http-server dist -p 8443 -S -C cert.pem -K key.pem
```

---

## 方案二：Electron 桌面应用打包

### 2.1 原理说明

Electron 将 Vue3 应用打包成完整的桌面应用，可在 Windows、macOS、Linux 上独立运行。

**优势：**
- ✅ 完整的桌面应用体验
- ✅ 可访问系统资源（文件系统、通知等）
- ✅ 可创建安装程序
- ✅ 支持自动更新

**劣势：**
- ❌ 包体积较大（100MB+）
- ❌ 学习曲线陡
- ❌ 开发复杂度高

### 2.2 快速实现（使用 electron-vite）

#### 步骤 1：安装依赖

```bash
npm install --save-dev electron electron-vite electron-builder
```

#### 步骤 2：创建项目结构

```
project/
├── src/
│   ├── main/              # Electron 主进程
│   │   └── index.ts
│   ├── preload/           # 预加载脚本
│   │   └── index.ts
│   └── renderer/          # Vue 应用（现有）
│       ├── src/
│       └── index.html
├── electron.vite.config.ts
└── package.json
```

#### 步骤 3：创建 electron.vite.config.ts

```typescript
import { defineConfig } from 'electron-vite'
import vue from '@vitejs/plugin-vue'
import path from 'path'

export default defineConfig({
  main: {
    entry: 'src/main/index.ts',
    vite: {
      build: {
        rollupOptions: {
          external: ['sqlite3']
        }
      }
    }
  },
  preload: {
    entry: 'src/preload/index.ts'
  },
  renderer: {
    root: '.',
    build: {
      outDir: 'dist/renderer'
    },
    plugins: [vue()],
    resolve: {
      alias: {
        '@': path.resolve(__dirname, './src')
      }
    }
  }
})
```

#### 步骤 4：创建主进程文件

**src/main/index.ts**：

```typescript
import { app, BrowserWindow, Menu } from 'electron'
import path from 'path'
import { isDev } from '../utils'

let mainWindow: BrowserWindow | null = null

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      preload: path.join(__dirname, '../preload/index.js'),
      nodeIntegration: false,
      contextIsolation: true
    }
  })

  if (isDev) {
    mainWindow.loadURL('http://localhost:5173')
    mainWindow.webContents.openDevTools()
  } else {
    mainWindow.loadFile(path.join(__dirname, '../renderer/index.html'))
  }

  mainWindow.on('closed', () => {
    mainWindow = null
  })
}

app.on('ready', createWindow)

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit()
  }
})

app.on('activate', () => {
  if (mainWindow === null) {
    createWindow()
  }
})
```

#### 步骤 5：创建预加载脚本

**src/preload/index.ts**：

```typescript
import { contextBridge, ipcRenderer } from 'electron'

contextBridge.exposeInMainWorld('electron', {
  ipcRenderer: {
    send: (channel: string, ...args: any[]) => ipcRenderer.send(channel, ...args),
    on: (channel: string, func: any) => ipcRenderer.on(channel, (event, ...args) => func(...args)),
    once: (channel: string, func: any) => ipcRenderer.once(channel, (event, ...args) => func(...args))
  }
})
```

#### 步骤 6：更新 package.json

```json
{
  "main": "dist/main/index.js",
  "scripts": {
    "dev": "electron-vite dev",
    "build": "electron-vite build",
    "preview": "electron-vite preview",
    "pack": "electron-builder --dir",
    "dist": "electron-builder"
  },
  "build": {
    "appId": "com.haitang.admin",
    "productName": "海棠企业管理系统",
    "files": [
      "dist/**/*",
      "node_modules/**/*"
    ],
    "win": {
      "target": ["nsis", "portable"],
      "certificateFile": null,
      "certificatePassword": null
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true
    },
    "mac": {
      "target": ["dmg", "zip"],
      "category": "public.app-category.business"
    },
    "linux": {
      "target": ["AppImage", "deb"],
      "category": "Utility"
    }
  }
}
```

#### 步骤 7：构建应用

```bash
# 开发模式
npm run dev

# 生产构建
npm run build

# 打包为可安装程序
npm run dist
```

### 2.3 使用 electron-builder 配置详解

```typescript
// electron-builder 配置详解
{
  "build": {
    // 应用 ID（必须唯一）
    "appId": "com.haitang.admin",
    
    // 应用名称
    "productName": "海棠企业管理系统",
    
    // 包含的文件
    "files": [
      "dist/**/*",
      "node_modules/**/*"
    ],
    
    // Windows 配置
    "win": {
      // 目标格式：nsis（安装程序）、portable（便携版）
      "target": ["nsis", "portable"],
      // 代码签名证书
      "certificateFile": null,
      "certificatePassword": null
    },
    
    // NSIS 安装程序配置
    "nsis": {
      "oneClick": false,                      // 不使用一键安装
      "allowToChangeInstallationDirectory": true,  // 允许用户选择安装目录
      "createDesktopShortcut": true,          // 创建桌面快捷方式
      "createStartMenuShortcut": true         // 创建开始菜单快捷方式
    },
    
    // macOS 配置
    "mac": {
      "target": ["dmg", "zip"],
      "category": "public.app-category.business"
    },
    
    // Linux 配置
    "linux": {
      "target": ["AppImage", "deb"],
      "category": "Utility"
    }
  }
}
```

---

## 方案三：Docker 容器化部署

### 3.1 原理说明

使用 Docker 将应用及其运行环境打包成容器镜像，可在任何安装了 Docker 的机器上运行。

**优势：**
- ✅ 环境一致性强
- ✅ 易于分发和部署
- ✅ 支持多机器部署
- ✅ 便于版本管理

### 3.2 实现步骤

#### 步骤 1：创建 Dockerfile

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

# 复制 package 文件
COPY package*.json ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 构建项目
RUN npm run build:prod

# 运行阶段
FROM node:18-alpine

WORKDIR /app

# 安装 http-server
RUN npm install -g http-server

# 从构建阶段复制 dist 文件夹
COPY --from=builder /app/dist ./dist

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["http-server", "dist", "-p", "8080", "-c-1"]
```

#### 步骤 2：创建 .dockerignore

```
node_modules
npm-debug.log
dist
.git
.gitignore
README.md
.env
.env.local
```

#### 步骤 3：构建 Docker 镜像

```bash
# 构建镜像
docker build -t haitang-admin:1.0.0 .

# 或使用标签
docker build -t haitang-admin:latest .
```

#### 步骤 4：运行容器

```bash
# 基础运行
docker run -p 8080:8080 haitang-admin:latest

# 后台运行
docker run -d -p 8080:8080 --name haitang-admin haitang-admin:latest

# 查看日志
docker logs -f haitang-admin

# 停止容器
docker stop haitang-admin

# 删除容器
docker rm haitang-admin
```

#### 步骤 5：使用 Docker Compose（可选）

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  haitang-admin:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
    volumes:
      - ./dist:/app/dist
    restart: unless-stopped
```

运行：

```bash
# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 3.3 Docker 镜像优化

#### 多阶段构建（已在 Dockerfile 中实现）

优点：
- 减小最终镜像大小
- 只包含运行时所需的文件
- 不包含构建工具

#### 使用 nginx 作为服务器

```dockerfile
# 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build:prod

# 运行阶段
FROM nginx:alpine

# 复制 nginx 配置
COPY nginx.conf /etc/nginx/nginx.conf

# 复制构建结果
COPY --from=builder /app/dist /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

创建 `nginx.conf`：

```nginx
events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name _;
        
        root /usr/share/nginx/html;
        index index.html;
        
        # 处理 SPA 路由
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

---

## 方案对比

### 功能对比表

| 功能 | 静态服务器 | Electron | Docker |
|------|-----------|----------|--------|
| 离线运行 | ❌ | ✅ | ❌ |
| 包体积 | 小 | 大 | 中 |
| 部署难度 | 简单 | 中等 | 中等 |
| 跨平台 | ✅ | ✅ | ✅ |
| 系统集成 | ❌ | ✅ | ❌ |
| 自动更新 | ❌ | ✅ | ❌ |
| 学习曲线 | 平缓 | 陡峭 | 中等 |
| 适合场景 | 快速测试 | 完整应用 | 企业部署 |

### 选择建议

**选择静态服务器方案，如果：**
- 需要快速部署和测试
- 用户有网络连接
- 不需要系统集成
- 优先考虑简单性

**选择 Electron 方案，如果：**
- 需要完整的桌面应用体验
- 需要离线运行能力
- 需要访问系统资源
- 需要自动更新功能

**选择 Docker 方案，如果：**
- 需要在多台服务器上部署
- 需要环境一致性
- 已有 Docker 基础设施
- 需要容器编排（Kubernetes）

---

## 常见问题

### Q1：如何处理 API 代理？

**静态服务器方案：**

使用 http-server 的代理功能或配置 nginx：

```nginx
location /api/ {
    proxy_pass http://backend-server:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

**Electron 方案：**

在主进程中配置代理：

```typescript
session.defaultSession.webRequest.onBeforeSendHeaders((details, callback) => {
  details.requestHeaders['X-Custom-Header'] = 'value'
  callback({ requestHeaders: details.requestHeaders })
})
```

**Docker 方案：**

在 nginx 配置中添加代理规则。

### Q2：如何处理环境变量？

**构建时注入：**

```bash
VITE_API_URL=http://api.example.com npm run build:prod
```

**运行时注入（Docker）：**

```bash
docker run -e VITE_API_URL=http://api.example.com haitang-admin:latest
```

### Q3：如何优化包体积？

1. **启用压缩：**

```typescript
// vite.config.ts
import compression from 'vite-plugin-compression'

export default defineConfig({
  plugins: [
    compression({
      algorithm: 'gzip',
      ext: '.gz'
    })
  ]
})
```

2. **代码分割：**

```typescript
// vite.config.ts
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        'element-plus': ['element-plus'],
        'echarts': ['echarts']
      }
    }
  }
}
```

3. **移除 console：**

```typescript
// vite.config.ts
build: {
  terserOptions: {
    compress: {
      drop_console: true
    }
  }
}
```

### Q4：如何处理 CORS 问题？

**开发环境：** 已在 vite.config.ts 中配置代理

**生产环境：**

```typescript
// 后端配置 CORS 头
response.setHeader('Access-Control-Allow-Origin', '*')
response.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE')
response.setHeader('Access-Control-Allow-Headers', 'Content-Type')
```

或使用 nginx：

```nginx
add_header 'Access-Control-Allow-Origin' '*' always;
add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE' always;
add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
```

### Q5：如何进行性能优化？

1. **启用 gzip 压缩**
2. **使用 CDN 加速**
3. **代码分割和懒加载**
4. **图片优化**
5. **移除未使用的依赖**

---

## 总结

根据您的需求，我们推荐：

1. **快速测试和演示**：使用**方案一（静态服务器）**
   - 最快速、最简单
   - 5 分钟内可部署

2. **完整桌面应用**：使用**方案二（Electron）**
   - 提供最佳用户体验
   - 支持离线运行

3. **企业级部署**：使用**方案三（Docker）**
   - 易于管理和扩展
   - 支持容器编排

所有方案都已提供完整的配置示例和脚本，可直接使用。

