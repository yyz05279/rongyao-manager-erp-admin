# 开发模式批次确认功能说明

## 概述

在开发环境下，物料清单分批上传功能增加了批次确认机制，方便开发人员测试和观察每批数据的上传情况。

## 功能特点

### ✅ 核心特性

1. **环境自动识别**

   - 自动检测当前运行环境（development/production）
   - 开发环境：启用批次确认
   - 生产环境：自动连续上传

2. **批次间确认**

   - 每批上传完成后弹出确认框
   - 显示当前批次上传统计
   - 用户确认后继续下一批
   - 可随时停止上传

3. **详细统计展示**
   - 当前累计成功数
   - 当前累计失败数
   - 下一批次信息预告

## 实现细节

### 环境判断

```typescript
const IS_DEV_MODE = import.meta.env.MODE === 'development';
```

### 确认框逻辑

```typescript
// 【开发模式】如果不是第一批，弹出确认框
if (IS_DEV_MODE && batchIndex > 0) {
  try {
    await ElMessageBox.confirm(
      `第 ${batchIndex} 批已上传完成！\n\n` +
        `成功: ${sheetSuccessCount} 条\n` +
        `失败: ${sheetFailedCount} 条\n\n` +
        `是否继续上传第 ${batchIndex + 1} 批？`,
      '开发模式 - 批次确认',
      {
        confirmButtonText: '继续上传',
        cancelButtonText: '停止上传',
        type: 'info',
        distinguishCancelAndClose: true
      }
    );
    console.info(`✓ 用户确认，继续上传第 ${batchIndex + 1} 批`);
  } catch (action) {
    if (action === 'cancel' || action === 'close') {
      console.warn(`⚠ 用户取消上传，已完成 ${batchIndex} 批`);
      ElMessage.warning(`上传已停止，已完成 ${batchIndex}/${totalBatches} 批`);
      break; // 跳出当前Sheet的上传循环
    }
  }
}
```

### 延迟策略优化

```typescript
// 【非开发模式】添加小延迟，避免请求过快
// 【开发模式】由确认框控制节奏，不需要额外延迟
if (!IS_DEV_MODE && batchIndex < totalBatches - 1) {
  await new Promise((resolve) => setTimeout(resolve, 200));
}
```

## 使用场景

### 场景 1：测试批次上传功能

```
1. 准备测试数据（50条记录）
2. 在开发环境下启动项目
3. 导入Excel文件
4. 观察第1批（20条）上传结果
5. 确认框显示统计：成功20条，失败0条
6. 点击"继续上传"
7. 观察第2批上传结果
...
```

### 场景 2：排查上传问题

```
1. 第1批上传成功
2. 确认框显示统计，检查数据
3. 第2批上传失败
4. 在确认框中看到失败统计
5. 点击"停止上传"
6. 排查失败原因
7. 修复后重新测试
```

### 场景 3：性能测试

```
1. 逐批观察上传耗时
2. 记录每批的响应时间
3. 分析服务器处理能力
4. 优化批次大小参数
```

## 确认框界面

### 标题

```
开发模式 - 批次确认
```

### 内容

```
第 1 批已上传完成！

成功: 20 条
失败: 0 条

是否继续上传第 2 批？
```

### 按钮

- **继续上传**（主按钮，蓝色）
- **停止上传**（次要按钮，灰色）

## 控制台日志

### 正常流程

```
Sheet 机械设备: 共50条数据，分3批上传，每批20条
正在上传第 1/3 批，共20条数据...
✓ 第1批上传成功: 20条 (累计成功: 20/50)

✓ 用户确认，继续上传第 2 批
正在上传第 2/3 批，共20条数据...
✓ 第2批上传成功: 20条 (累计成功: 40/50)

✓ 用户确认，继续上传第 3 批
正在上传第 3/3 批，共10条数据...
✓ 第3批上传成功: 10条 (累计成功: 50/50)
```

### 用户取消

```
Sheet 机械设备: 共50条数据，分3批上传，每批20条
正在上传第 1/3 批，共20条数据...
✓ 第1批上传成功: 20条 (累计成功: 20/50)

⚠ 用户取消上传，已完成 1 批
[消息提示] 上传已停止，已完成 1/3 批
```

## 与生产环境对比

| 特性         | 开发环境        | 生产环境   |
| ------------ | --------------- | ---------- |
| **确认框**   | ✅ 启用         | ❌ 禁用    |
| **批次间隔** | 无需延迟        | 200ms 延迟 |
| **上传速度** | 手动控制        | 自动连续   |
| **用户操作** | 需手动确认      | 无需操作   |
| **适用场景** | 开发测试        | 正式使用   |
| **日志详细** | ✅ 额外确认日志 | 标准日志   |

## 优势

### 开发测试

1. **可观察性强**

   - 逐批观察上传结果
   - 及时发现问题
   - 精确定位错误批次

2. **可控制性好**

   - 随时暂停上传
   - 避免错误数据持续上传
   - 节省测试时间

3. **数据安全**
   - 防止测试数据污染
   - 分批验证数据正确性
   - 及时回滚错误操作

### 用户体验

- ✅ 不影响生产环境性能
- ✅ 自动环境识别，无需配置
- ✅ 清晰的统计信息展示
- ✅ 友好的交互提示

## 注意事项

### 1. 仅开发环境生效

```javascript
// 确保使用正确的环境变量
const IS_DEV_MODE = import.meta.env.MODE === 'development';
```

### 2. 生产环境自动禁用

生产环境下代码仍然存在，但因为 `IS_DEV_MODE` 为 `false`，确认框不会弹出。

### 3. 不要在生产环境测试

如需在生产环境测试批次功能：

- 建议使用专门的测试账号
- 或者临时修改代码禁用环境判断
- 测试完成后记得恢复

### 4. 取消操作的影响

点击"停止上传"后：

- 当前 Sheet 的剩余批次不会上传
- 后续 Sheet 也不会处理
- 已上传的数据保留在系统中
- 需要重新导入未完成的数据

## 调试技巧

### 1. 强制开启确认框（测试用）

```typescript
// 临时修改，测试用
const IS_DEV_MODE = true; // 强制开启
```

### 2. 查看环境变量

```typescript
console.log('当前环境:', import.meta.env.MODE);
console.log('开发模式:', IS_DEV_MODE);
```

### 3. 跳过确认框（调试用）

```typescript
// 临时注释确认框代码
// if (IS_DEV_MODE && batchIndex > 0) {
//   await ElMessageBox.confirm(...);
// }
```

## 未来优化

### 可能的增强功能

1. **自定义确认条件**

   - 配置每 N 批确认一次
   - 仅失败时确认
   - 根据数据量决定是否确认

2. **详细统计展示**

   - 显示批次上传耗时
   - 显示服务器响应信息
   - 显示数据质量评分

3. **批次重试功能**

   - 失败批次自动重试
   - 手动选择重试批次
   - 批量重试失败批次

4. **可视化进度**
   - 进度条显示
   - 批次状态图表
   - 实时统计图表

## 版本信息

- **版本号**: v1.2.0
- **更新日期**: 2025-01-16
- **功能**: 开发模式批次确认
- **环境**: development only

## 相关文档

- [物料清单分批上传功能实现](./物料清单分批上传功能实现.md)
- [分批上传功能快速指南](./分批上传功能快速指南.md)
- [物料导入 API 调用示例](./物料导入API调用示例.ts)

---

## 总结

开发模式批次确认功能为开发测试提供了强大的观察和控制能力，同时确保生产环境的性能和用户体验不受影响。这是一个典型的环境差异化处理的最佳实践。
