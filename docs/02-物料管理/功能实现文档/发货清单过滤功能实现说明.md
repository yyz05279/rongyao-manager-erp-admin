# 发货清单过滤功能实现说明

## 修改概述

在物料清单批量导入模块中，增加了发货清单自动过滤功能。发货清单数据不应在物料清单模块中显示和导入，系统现在会自动识别并隐藏这些数据。

## 修改日期

2025-01-27

## 问题背景

之前的物料清单导入功能会将 Excel 文件中的所有 Sheet 都显示出来，包括发货清单相关的 Sheet。但发货清单有独立的管理模块，不应该在物料清单模块中进行导入操作。

## 解决方案

### 1. 过滤规则

系统根据 Sheet 名称自动识别发货清单：

- Sheet 名称包含"发货"
- Sheet 名称包含"装车"

满足以上任一条件的 Sheet 将被自动过滤，不会显示在物料清单模块中。

### 2. 修改位置

#### 2.1 数据预览标签页过滤

**文件**: `src/views/erp/saltprocess/project/components/MaterialDetail.vue`

**修改内容**: 在 `sheetGroups` 计算属性中添加过滤逻辑

```typescript
const sheetGroups = computed<SheetGroup[]>(() => {
  if (materialData.value.length === 0) return [];

  const groups = new Map<string, any[]>();
  const dataArray = materialData.value;

  for (let i = 0; i < dataArray.length; i++) {
    const material = dataArray[i];
    const sheetName = material.sheetName || '未命名';

    // 过滤发货清单：根据Sheet名称判断
    const lowerSheetName = sheetName.toLowerCase();
    if (lowerSheetName.includes('发货') || lowerSheetName.includes('装车')) {
      continue; // 跳过发货清单
    }

    if (!groups.has(sheetName)) {
      groups.set(sheetName, []);
    }
    const sheetMaterials = groups.get(sheetName);
    if (sheetMaterials) {
      sheetMaterials.push(material);
    }
  }

  // ... 返回结果
});
```

#### 2.2 导入配置弹窗过滤

**文件**: `src/views/erp/saltprocess/project/components/MaterialImportConfigDialog.vue`

**修改内容**: 在 `initSheetConfigs` 方法中添加过滤逻辑

```typescript
const initSheetConfigs = () => {
  sheetConfigs.value = props.sheetGroups
    .filter(group => {
      // 过滤发货清单：根据Sheet名称判断
      const lowerSheetName = group.sheetName.toLowerCase();
      return !lowerSheetName.includes('发货') && !lowerSheetName.includes('装车');
    })
    .map(group => {
      // ... 配置映射
    });
};
```

#### 2.3 统计数据排除发货清单

**文件**: `src/views/erp/saltprocess/project/components/MaterialDetail.vue`

**修改内容**: 所有统计计算属性都排除发货清单数据

```typescript
// 排除发货清单后的总数
const totalCountExcludingShipping = computed(() => {
  return materialData.value.filter(item => {
    const sheetName = (item.sheetName || '').toLowerCase();
    return !sheetName.includes('发货') && !sheetName.includes('装车');
  }).length;
});

// 有效数量（排除发货清单）
const validCount = computed(() => {
  return materialData.value.filter(item => {
    const sheetName = (item.sheetName || '').toLowerCase();
    const isShippingList = sheetName.includes('发货') || sheetName.includes('装车');
    return !item.hasErrors && !isShippingList;
  }).length;
});

// 其他统计属性同样排除发货清单
// - errorCount: 错误数量
// - warningCount: 警告数量
// - pendingCount: 待导入数量
// - importedCount: 已导入数量
```

### 3. UI 显示优化

#### 3.1 统计栏显示

```vue
<div class="statistics-bar">
  <el-tag type="info">总计: {{ totalCountExcludingShipping }}</el-tag>
  <el-tag type="success">有效: {{ validCount }}</el-tag>
  <el-tag type="warning">待导入: {{ pendingCount }}</el-tag>
  <el-tag type="primary">已导入: {{ importedCount }}</el-tag>
  <el-tag type="danger" v-if="errorCount > 0">错误: {{ errorCount }}</el-tag>
</div>
```

所有统计数字都已排除发货清单数据。

#### 3.2 数据预览标题

```vue
<span>数据预览 (共{{ totalCountExcludingShipping }}条物料记录)</span>
```

明确标注为"物料记录"，数量不包含发货清单。

#### 3.3 解析成功提示

```typescript
if (shippingCount > 0) {
  ElMessage.success(`成功解析 ${materialCount} 条物料记录（已自动过滤 ${shippingCount} 条发货清单）`);
} else {
  ElMessage.success(`成功解析 ${materialCount} 条物料记录`);
}
```

如果 Excel 中包含发货清单，系统会明确提示已过滤的数量。

## 效果展示

### 上传包含发货清单的 Excel 文件

**解析提示**:

```
成功解析 150 条物料记录（已自动过滤 20 条发货清单）
```

**数据预览**:

- 标题显示: "数据预览 (共 150 条物料记录)"
- 标签页: 只显示物料相关的 Sheet（电控、机械、管路等）
- 不显示: 发货清单、装车清单等 Sheet

**统计栏**:

- 总计: 150（不包含发货清单）
- 有效: 145
- 待导入: 145
- 已导入: 0
- 错误: 5

**导入配置**:

- Sheet 列表中不显示发货清单相关 Sheet
- 只能选择和导入物料相关的 Sheet

## 技术实现细节

### 1. 过滤位置

过滤在两个关键位置进行：

1. **数据分组时**: `sheetGroups` 计算属性

   - 在将数据按 Sheet 分组时就排除发货清单
   - 确保后续所有操作都基于已过滤的数据

2. **配置初始化时**: `initSheetConfigs` 方法
   - 双重保险，确保配置弹窗不显示发货清单
   - 即使前端有数据，配置时也会再次过滤

### 2. 判断逻辑

```typescript
const lowerSheetName = sheetName.toLowerCase();
if (lowerSheetName.includes('发货') || lowerSheetName.includes('装车')) {
  // 这是发货清单，跳过
}
```

- 不区分大小写（转小写后判断）
- 使用 `includes` 方法，支持部分匹配
- 支持多种命名方式（发货清单、第一车发货、装车清单等）

### 3. 性能优化

- 使用 `continue` 跳过，不创建不必要的数组项
- 统计时使用 `filter` 一次性计算
- 利用 `computed` 缓存计算结果

## 兼容性说明

### 向后兼容

- 对于不包含发货清单的 Excel 文件，行为保持不变
- 现有的数据导入接口完全兼容
- 不影响已导入的历史数据

### 命名规范

建议 Excel 文件中 Sheet 的命名规范：

**物料类 Sheet**（会被导入）:

- 电控物料
- 机械物料
- 管路物料
- 其他物料

**发货清单 Sheet**（会被过滤）:

- 发货清单
- 第一车发货
- 装车清单
- 发货记录

## 注意事项

1. **命名规范**: 确保发货清单 Sheet 名称包含"发货"或"装车"关键词
2. **数据分离**: 物料清单和发货清单应分别在对应模块管理
3. **导入流程**: 发货清单请在"发货清单管理"模块中导入

## 后续优化建议

1. **配置化过滤规则**: 允许管理员自定义过滤关键词
2. **Sheet 类型标识**: 在 Excel 模板中明确标注 Sheet 类型
3. **智能识别**: 基于数据结构自动识别 Sheet 类型
4. **过滤日志**: 记录被过滤的 Sheet 信息供追溯

## 总结

通过在多个层面添加发货清单过滤逻辑，确保了：

✅ **数据隔离**: 物料清单和发货清单数据完全分离
✅ **用户体验**: 不显示无关的 Sheet，界面更清晰
✅ **数据准确**: 统计数字只包含物料记录
✅ **操作安全**: 避免误将发货清单作为物料导入
✅ **性能优化**: 减少不必要的数据处理

---

**开发日期**: 2025-01-27  
**开发人员**: AI Assistant  
**项目**: 海棠企业管理系统  
**模块**: 化盐项目管理 - 物料清单批量导入
