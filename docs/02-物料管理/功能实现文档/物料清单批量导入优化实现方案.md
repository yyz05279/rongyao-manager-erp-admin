# 物料清单批量导入优化实现方案

## 优化目标

1. **导入配置弹窗**：点击导入按钮时弹出配置弹窗
2. **Sheet 选择**：可以选择要导入的 Sheet
3. **批次控制**：可以自由设置每批导入数量（20-100 条）
4. **状态管理**：区分已导入和未导入数据
5. **防重复导入**：已导入的数据不会重复导入
6. **UI 优化**：分区展示已导入和未导入数据

## 实现步骤

### 步骤 1：创建导入配置弹窗组件 ✅

已创建 `MaterialImportConfigDialog.vue` 组件，功能包括：

- Sheet 列表展示
- 每个 Sheet 的导入状态（总数/待导入/已导入）
- 批次大小配置（20-100 条）
- 全局配置应用
- 预计批次计算

**文件位置**：

```
src/views/erp/saltprocess/project/components/MaterialImportConfigDialog.vue
```

### 步骤 2：修改 MaterialDetail.vue - 添加导入配置功能

#### 2.1 在 script 区域添加导入

```typescript
import MaterialImportConfigDialog from './MaterialImportConfigDialog.vue';
```

#### 2.2 添加响应式变量

```typescript
// 导入配置弹窗
const importConfigDialog = reactive({
  visible: false
});
```

#### 2.3 修改物料数据结构，添加导入状态

```typescript
// 为每个物料数据添加导入状态
interface MaterialDataWithStatus extends MaterialItemBo {
  imported?: boolean;          // 是否已导入
  importedTime?: string;       // 导入时间
  importBatchNumber?: string;  // 导入批次号
}
```

#### 2.4 添加计算属性

```typescript
// 待导入数量
const pendingCount = computed(() => {
  return materialData.value.filter(item => !item.imported && !item.hasErrors).length;
});

// 已导入数量
const importedCount = computed(() => {
  return materialData.value.filter(item => item.imported).length;
});
```

#### 2.5 添加方法

```typescript
// 打开导入配置弹窗
const openImportConfig = () => {
  if (errorCount.value > 0) {
    ElMessage.warning('请先修复所有错误数据后再导入');
    return;
  }

  if (pendingCount.value === 0) {
    ElMessage.info('没有待导入的数据');
    return;
  }

  importConfigDialog.visible = true;
};

// 处理导入配置确认
const handleImportConfigConfirm = async (config: any) => {
  console.log('导入配置:', config);
  await submitDataWithConfig(config);
};

// 按配置导入数据
const submitDataWithConfig = async (config: any) => {
  submitting.value = true;

  try {
    const batchNumber = new Date().getTime().toString();
    const currentDate = new Date().toISOString().split('T')[0];
    const IS_DEV_MODE = import.meta.env.MODE === 'development';

    let totalSuccess = 0;
    let totalFailed = 0;
    let userCancelled = false;

    // 按配置的Sheet进行导入
    for (const sheetConfig of config.sheets) {
      if (userCancelled) break;

      const group = sheetGroups.value.find(g => g.sheetName === sheetConfig.sheetName);
      if (!group) continue;

      // 只处理未导入的数据
      const pendingMaterials = group.materials.filter((item: any) => !item.imported && !item.hasErrors);
      if (pendingMaterials.length === 0) continue;

      // 按配置的批次大小分批导入
      const batchSize = sheetConfig.batchSize;
      const totalBatches = Math.ceil(pendingMaterials.length / batchSize);

      for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
        if (userCancelled) break;

        const start = batchIndex * batchSize;
        const end = Math.min(start + batchSize, pendingMaterials.length);
        const batchMaterials = pendingMaterials.slice(start, end);

        // 开发模式确认
        if (IS_DEV_MODE && batchIndex > 0) {
          try {
            await ElMessageBox.confirm(
              `Sheet: ${sheetConfig.sheetName}\n` +
              `第 ${batchIndex} 批已完成\n` +
              `是否继续导入第 ${batchIndex + 1} 批？`,
              '批次确认',
              {
                confirmButtonText: '继续',
                cancelButtonText: '停止',
                type: 'info'
              }
            );
          } catch {
            userCancelled = true;
            break;
          }
        }

        // 调用导入API
        try {
          const importData: MaterialImportBo = {
            projectId: props.projectId,
            batchNumber: `${batchNumber}-${sheetConfig.sheetName}-Batch${batchIndex + 1}`,
            shippingDate: currentDate,
            fileSource: `前端Excel解析-${sheetConfig.sheetName}`,
            remarks: `Sheet: ${sheetConfig.sheetName}, 第${batchIndex + 1}/${totalBatches}批, 本批${batchMaterials.length}条`,
            materialItems: batchMaterials.map((item: any) => ({
              ...item,
              sheetName: sheetConfig.sheetName
            }))
          };

          const response: any = await importParsedMaterialData(importData);
          const result = response.data || response;

          if (result.success) {
            totalSuccess += result.successRecords || 0;

            // 标记这批数据为已导入
            batchMaterials.forEach((item: any) => {
              item.imported = true;
              item.importedTime = new Date().toISOString();
              item.importBatchNumber = importData.batchNumber;
            });

            console.log(`✓ 第${batchIndex + 1}批导入成功: ${result.successRecords}条`);
          } else {
            totalFailed += result.failedRecords || 0;
          }

          await new Promise(resolve => setTimeout(resolve, 200));
        } catch (error: any) {
          totalFailed += batchMaterials.length;
          console.error(`✗ 第${batchIndex + 1}批导入失败:`, error);
        }
      }
    }

    // 显示结果
    if (totalSuccess > 0) {
      ElMessage.success(`成功导入 ${totalSuccess} 条数据！`);
      loadMaterialList();
    } else if (totalFailed > 0) {
      ElMessage.error(`导入失败 ${totalFailed} 条`);
    }

    if (userCancelled) {
      ElMessage.warning('用户取消了导入');
    }
  } catch (error: any) {
    console.error('导入失败:', error);
    ElMessage.error('导入失败: ' + (error.message || '未知错误'));
  } finally {
    submitting.value = false;
  }
};
```

### 步骤 3：优化 UI - 分区展示

#### 3.1 修改 Sheet 标签页，添加状态过滤

```vue
<el-tabs v-model="activeSheetTab" type="card" class="sheet-tabs">
  <el-tab-pane
    v-for="sheetGroup in sheetGroups"
    :key="sheetGroup.sheetName"
    :label="getSheetTabLabel(sheetGroup)"
    :name="sheetGroup.sheetName"
  >
    <!-- 数据过滤选项 -->
    <div class="data-filter-bar" style="margin-bottom: 16px;">
      <el-radio-group v-model="dataFilter" size="small">
        <el-radio-button value="all">全部 ({{ sheetGroup.materials.length }})</el-radio-button>
        <el-radio-button value="pending">待导入 ({{ getPendingCount(sheetGroup) }})</el-radio-button>
        <el-radio-button value="imported">已导入 ({{ getImportedCount(sheetGroup) }})</el-radio-button>
      </el-radio-group>
    </div>

    <el-table :data="getFilteredSheetData(sheetGroup)" ...>
      <!-- 添加导入状态列 -->
      <el-table-column label="导入状态" width="100" align="center" fixed="left">
        <template #default="{ row }">
          <el-tag v-if="row.imported" type="success" size="small">已导入</el-tag>
          <el-tag v-else type="warning" size="small">待导入</el-tag>
        </template>
      </el-table-column>

      <!-- 其他列 -->
      ...
    </el-table>
  </el-tab-pane>
</el-tabs>
```

#### 3.2 添加辅助方法

```typescript
// 数据过滤
const dataFilter = ref<'all' | 'pending' | 'imported'>('all');

// 获取Sheet标签文本
const getSheetTabLabel = (sheetGroup: any) => {
  const total = sheetGroup.materials.length;
  const pending = sheetGroup.materials.filter((m: any) => !m.imported).length;
  const imported = sheetGroup.materials.filter((m: any) => m.imported).length;

  return `${sheetGroup.sheetName} (${total}条: ${pending}待导入, ${imported}已导入)`;
};

// 获取待导入数量
const getPendingCount = (sheetGroup: any) => {
  return sheetGroup.materials.filter((m: any) => !m.imported).length;
};

// 获取已导入数量
const getImportedCount = (sheetGroup: any) => {
  return sheetGroup.materials.filter((m: any) => m.imported).length;
};

// 获取过滤后的数据
const getFilteredSheetData = (sheetGroup: any) => {
  const data = sheetGroup.materials;

  if (dataFilter.value === 'pending') {
    return data.filter((m: any) => !m.imported);
  }
  if (dataFilter.value === 'imported') {
    return data.filter((m: any) => m.imported);
  }
  return data; // 'all'
};
```

### 步骤 4：添加导入配置弹窗到模板

```vue
<template>
  <!-- 现有内容 -->
  ...

  <!-- 导入配置弹窗 -->
  <MaterialImportConfigDialog
    v-model:visible="importConfigDialog.visible"
    :sheet-groups="sheetGroups"
    @confirm="handleImportConfigConfirm"
  />
</template>
```

### 步骤 5：样式优化

```scss
<style scoped lang="scss">
.statistics-bar {
  margin-bottom: 15px;

  .el-tag {
    margin-right: 10px;
  }
}

.data-filter-bar {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 16px;
}

// 已导入数据行样式
:deep(.imported-row) {
  background-color: #f0f9ff;

  .el-table__cell {
    color: #909399;
  }
}
</style>
```

### 步骤 6：防重复导入逻辑

**关键点**：

1. 每个物料数据添加 `imported` 标识
2. 导入前过滤掉已导入的数据
3. 导入成功后立即标记为已导入
4. 切换文件或清空数据时重置状态

```typescript
// 清空数据时重置导入状态
const clearMaterialData = () => {
  materialData.value = [];
  uploadRef.value?.clearFiles();
};

// 替换文件时重置
const handleFileChange = (file: any) => {
  clearMaterialData();
  if (file.raw) {
    parseExcelFile(file.raw);
  }
};
```

## 功能特性

### 1. 导入配置弹窗

- ✅ Sheet 列表展示
- ✅ 显示每个 Sheet 的总数/待导入/已导入
- ✅ 可勾选要导入的 Sheet
- ✅ 可设置每批导入数量（20-100 条）
- ✅ 全局配置一键应用
- ✅ 预计批次自动计算

### 2. 状态管理

- ✅ 每条数据标记导入状态
- ✅ 导入成功后立即更新状态
- ✅ 支持按状态过滤显示
- ✅ 防止重复导入

### 3. UI 优化

- ✅ Sheet 标签页显示导入进度
- ✅ 数据表格显示导入状态
- ✅ 支持过滤：全部/待导入/已导入
- ✅ 已导入数据灰色显示

### 4. 批次控制

- ✅ 自定义批次大小（20-100 条）
- ✅ 开发模式批次确认
- ✅ 支持中途取消
- ✅ 显示批次进度

## 使用流程

### 1. 上传 Excel 文件

1. 点击"导入 Excel"按钮
2. 选择 Excel 文件
3. 等待解析完成
4. 查看数据预览

### 2. 配置导入

1. 点击"配置并导入"按钮
2. 弹出导入配置弹窗
3. 选择要导入的 Sheet
4. 设置每批导入数量
5. 查看预计批次
6. 点击"开始导入"

### 3. 导入进度

1. 系统按配置分批导入
2. 开发模式下每批确认
3. 实时显示导入进度
4. 导入成功后标记状态

### 4. 继续导入

1. 关闭弹窗后不清空数据
2. 再次点击"配置并导入"
3. 只显示待导入的数据
4. 继续导入剩余数据

## 注意事项

1. **防重复导入**：已导入的数据会被自动跳过
2. **状态持久化**：关闭弹窗不影响导入状态
3. **文件替换**：上传新文件会重置所有状态
4. **批次大小**：建议 20-50 条，避免单次过大
5. **开发模式**：每批都会确认，方便调试

## 测试建议

### 测试场景 1：基本导入

1. 上传包含 100 条数据的 Excel
2. 配置每批 20 条
3. 选择 2 个 Sheet 导入
4. 验证分批导入成功
5. 检查导入状态正确

### 测试场景 2：继续导入

1. 导入前 50 条数据
2. 关闭弹窗
3. 再次打开配置
4. 验证只显示后 50 条待导入
5. 继续导入剩余数据

### 测试场景 3：防重复导入

1. 导入全部数据
2. 不替换文件
3. 再次点击导入
4. 验证提示"没有待导入的数据"
5. 已导入数据不会重复提交

### 测试场景 4：文件替换

1. 导入部分数据
2. 上传新的 Excel 文件
3. 验证导入状态已重置
4. 可以正常导入新文件数据

## 更新日期

2025-10-27

## 作者

AI 助手
