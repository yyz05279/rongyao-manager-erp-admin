# 物料清单批量导入优化实现总结

## 项目概述

本次优化对海棠企业管理系统的物料清单批量导入功能进行了全面升级，实现了更灵活的导入配置、更清晰的状态管理和更友好的用户界面。

## 实现功能

### 1. 导入配置弹窗

**文件**: `src/views/erp/saltprocess/project/components/MaterialImportConfigDialog.vue`

#### 主要特性

- **Sheet 选择**: 用户可以自由选择要导入的 Sheet
- **批次大小配置**: 每个 Sheet 可以独立配置批次大小（20-100 条/批）
- **数据统计展示**:
  - 总数
  - 待导入数量
  - 已导入数量
- **智能默认选择**: 自动选中有待导入数据的 Sheet
- **全局配置**: 支持一键应用批次大小到所有 Sheet

#### 核心代码

```typescript
interface SheetConfig {
  sheetName: string;
  materialType: string;
  totalCount: number;
  pendingCount: number;
  importedCount: number;
  selected: boolean;
  batchSize: number;
  isFullyImported: boolean;
}

const initSheetConfigs = () => {
  sheetConfigs.value = props.sheetGroups.map(group => {
    const totalCount = group.materials.length;
    const importedCount = group.materials.filter((m: any) => m.imported).length;
    const pendingCount = totalCount - importedCount;
    const isFullyImported = pendingCount === 0;

    return {
      sheetName: group.sheetName,
      materialType: inferMaterialType(group.sheetName, group.materials[0]),
      totalCount,
      pendingCount,
      importedCount,
      selected: !isFullyImported, // 默认选中未完全导入的Sheet
      batchSize: 50,
      isFullyImported
    };
  });
};
```

### 2. 已导入/未导入数据状态管理

**文件**: `src/views/erp/saltprocess/project/components/MaterialDetail.vue`

#### 主要特性

- **导入状态标记**: 每条数据增加 `imported` 属性
- **状态计算属性**:

  ```typescript
  // 待导入数量
  const pendingCount = computed(() => {
    return materialData.value.filter(item => !(item as any).imported && !item.hasErrors).length;
  });

  // 已导入数量
  const importedCount = computed(() => {
    return materialData.value.filter(item => (item as any).imported).length;
  });
  ```

- **数据过滤**: 导入时自动过滤已导入数据
  ```typescript
  const validMaterials = group.materials.filter((item) => {
    const itemType = item.materialType || materialType;
    return itemType !== 'SHIPPING_INFO' &&
           !(item as any).imported &&
           !item.hasErrors;
  });
  ```

### 3. UI 优化 - 分区展示

#### 3.1 统计栏优化

在数据预览卡片中显示详细统计信息：

```vue
<div class="statistics-bar">
  <el-tag type="info">总计: {{ materialData.length }}</el-tag>
  <el-tag type="success">有效: {{ validCount }}</el-tag>
  <el-tag type="warning">待导入: {{ pendingCount }}</el-tag>
  <el-tag type="primary">已导入: {{ importedCount }}</el-tag>
  <el-tag type="danger" v-if="errorCount > 0">错误: {{ errorCount }}</el-tag>
</div>
```

#### 3.2 状态列

在数据预览表格中添加状态列，直观显示每条数据的状态：

```vue
<el-table-column label="状态" width="80" align="center">
  <template #default="{ row }">
    <el-tag v-if="row.imported" type="success" size="small">已导入</el-tag>
    <el-tag v-else-if="row.hasErrors" type="danger" size="small">错误</el-tag>
    <el-tag v-else type="warning" size="small">待导入</el-tag>
  </template>
</el-table-column>
```

#### 3.3 行样式区分

为已导入的行添加特殊样式：

```typescript
const getRowClassName = ({ row }: { row: any }) => {
  if (row.hasErrors) return 'error-row';
  if (row.hasWarnings) return 'warning-row';
  if ((row as any).imported) return 'imported-row';
  return '';
};
```

```scss
:deep(.imported-row) {
  background-color: #f0f9ff;
  opacity: 0.7;

  td {
    color: #909399 !important;
  }
}
```

### 4. 批次导入控制

#### 主要特性

- **灵活配置**: 每个 Sheet 独立配置批次大小
- **配置映射**: 使用 `batchSizeMap` 存储每个 Sheet 的批次配置

  ```typescript
  const processConfig = {
    selectedSheets: config.sheets.map((s: any) => s.sheetName),
    batchSizeMap: config.sheets.reduce((map: any, s: any) => {
      map[s.sheetName] = s.batchSize;
      return map;
    }, {})
  };
  ```

- **批次执行**: 按配置的大小分批上传

  ```typescript
  const batchSize = batchSizeMap[group.sheetName] || 50;
  const totalBatches = Math.ceil(validMaterials.length / batchSize);

  for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
    const start = batchIndex * batchSize;
    const end = Math.min(start + batchSize, validMaterials.length);
    const batchMaterials = validMaterials.slice(start, end);
    // 执行上传
  }
  ```

### 5. 防重复导入逻辑

#### 多层防护

1. **数据过滤**: 导入时自动过滤已导入数据

   ```typescript
   const validMaterials = group.materials.filter((item) => {
     return itemType !== 'SHIPPING_INFO' &&
            !(item as any).imported &&
            !item.hasErrors;
   });
   ```

2. **UI 提示**: 打开导入配置前检查

   ```typescript
   const openImportConfig = () => {
     if (errorCount.value > 0) {
       ElMessage.warning('请先修复所有错误数据后再导入');
       return;
     }

     if (pendingCount.value === 0) {
       ElMessage.info('没有待导入的数据，所有数据已导入完成');
       return;
     }

     importConfigDialog.value = true;
   };
   ```

3. **默认选择**: 配置弹窗默认只选中有待导入数据的 Sheet

   ```typescript
   selected: !isFullyImported, // 默认选中未完全导入的Sheet
   ```

4. **禁用已导入**: 已完全导入的 Sheet 不可选择
   ```vue
   <el-checkbox
     v-model="row.selected"
     :disabled="row.isFullyImported"
   />
   ```

## 技术实现亮点

### 1. 组件化设计

将导入配置功能独立为 `MaterialImportConfigDialog` 组件，提高代码复用性和可维护性。

### 2. 响应式状态管理

使用 Vue 3 的 Composition API，通过 `computed` 属性实时计算各种统计数据。

### 3. 批次控制灵活性

支持每个 Sheet 独立配置批次大小，满足不同数据量的导入需求。

### 4. 用户体验优化

- 清晰的状态标识（颜色、标签）
- 智能默认选择
- 防止重复导入
- 实时统计展示

### 5. 类型安全

使用 TypeScript 接口定义数据结构，提高代码健壮性。

## 使用流程

### 1. 上传 Excel 文件

用户选择包含物料清单的 Excel 文件，系统自动解析并按 Sheet 分组。

### 2. 查看数据预览

- 在统计栏查看总数、有效数、待导入数、已导入数
- 在表格中查看每条数据的详细信息和状态
- 已导入的数据以灰色半透明显示

### 3. 配置导入

点击"配置并导入"按钮，打开配置弹窗：

- 选择要导入的 Sheet（默认已选中有待导入数据的 Sheet）
- 为每个 Sheet 设置批次大小（20-100 条/批）
- 查看每个 Sheet 的待导入/已导入数量
- 点击"开始导入"

### 4. 导入执行

系统按配置分批上传数据：

- 自动跳过已导入数据
- 按设置的批次大小分批上传
- 上传成功后标记为已导入

### 5. 查看结果

- 查看导入结果统计
- 在物料清单中查看已导入数据

## 文件清单

### 新增文件

- `src/views/erp/saltprocess/project/components/MaterialImportConfigDialog.vue` - 导入配置弹窗组件

### 修改文件

- `src/views/erp/saltprocess/project/components/MaterialDetail.vue` - 主组件，增加状态管理和 UI 优化

## API 兼容性

本次优化完全兼容现有后端 API，无需后端修改：

- 使用现有的 `importParsedMaterialData` 接口
- 数据格式保持不变
- 批次控制在前端实现

## 性能优化

1. **分批上传**: 避免单次上传数据过多导致超时
2. **状态缓存**: 已导入数据保存在前端，避免重复上传
3. **按需渲染**: 使用 `lazy` 属性延迟渲染标签页内容
4. **深层响应式优化**: 使用 `shallowRef` 减少大数组的深层响应式开销

## 未来扩展方向

1. **导入进度条**: 实时显示导入进度
2. **断点续传**: 支持导入失败后从失败位置继续
3. **批量编辑**: 支持批量修改待导入数据
4. **导入历史**: 记录每次导入的详细信息
5. **导入模板**: 支持保存和加载导入配置模板

## 总结

本次优化大幅提升了物料清单批量导入功能的用户体验和系统可靠性：

- ✅ **灵活配置**: 支持自由选择 Sheet 和批次大小
- ✅ **状态管理**: 清晰区分已导入和未导入数据
- ✅ **防重复导入**: 多层防护确保数据不会重复导入
- ✅ **UI 优化**: 更直观的状态展示和更友好的交互
- ✅ **批次控制**: 灵活的批次大小配置，适应不同数据量
- ✅ **性能优化**: 分批上传，避免大数据量导致的性能问题

---

**开发日期**: 2025-01-27

**开发人员**: AI Assistant

**项目**: 海棠企业管理系统

**模块**: 化盐项目管理 - 物料清单批量导入
