# 物料清单数据映射修复说明

## 问题描述

项目物料清单接口返回了数据，但页面没有展示出来。经过分析发现是数据字段映射的问题。

## 问题分析

### 1. 数据结构不匹配

**后端返回的数据结构：**

```json
{
  "total": 7,
  "rows": [...],
  "code": 200,
  "msg": "查询成功"
}
```

**前端期望的数据结构：**

```typescript
{
  total: number,
  records: Array<...>
}
```

### 2. ID 字段不匹配

**后端返回：** `shippingListId`
**前端期望：** `id`

### 3. 状态和方式字段

后端已经返回了中文名称字段：

- `statusName`: "待发货"
- `shippingMethodName`: "卡车"

但前端还在尝试转换英文枚举值。

## 解决方案

### 1. 修复数据字段映射 (`index.vue`)

**修改位置：** `src/views/erp/saltprocess/shipping/index.vue`

```typescript
const getList = async () => {
  loading.value = true;
  try {
    const params = {
      ...queryParams,
      shippingDateStart: dateRange.value?.[0],
      shippingDateEnd: dateRange.value?.[1]
    };
    const response = await listShippingList(params);
    // 处理接口返回的数据结构
    const responseData: any = response.data;
    const data = responseData.rows || [];
    // 映射字段：shippingListId -> id
    shippingList.value = data.map((item: any) => ({
      ...item,
      id: item.shippingListId || item.id
    }));
    total.value = responseData.total || 0;
  } catch (error) {
    console.error('获取发货清单列表失败:', error);
    ElMessage.error('获取发货清单列表失败');
  } finally {
    loading.value = false;
  }
};
```

**关键修改点：**

1. 使用 `responseData.rows` 而不是 `response.data.records`
2. 将 `shippingListId` 映射为 `id` 字段
3. 添加错误日志输出，便于调试

### 2. 更新类型定义 (`types.ts`)

**修改位置：** `src/api/erp/saltprocess/shipping/types.ts`

```typescript
export interface ShippingListVO {
  id?: string;                        // 前端映射字段
  shippingListId?: string;            // 后端返回字段
  listCode: string;
  projectId: string;
  projectName: string;
  batchNumber: string;
  responsiblePerson: string;
  responsiblePersonId?: string;
  shippingDate: string;
  expectedDeliveryDate?: string;
  actualDeliveryDate?: string;
  status: ShippingStatus | string;    // 支持字符串类型
  statusName?: string;                // 状态名称（中文）
  shippingMethod: ShippingMethod | string;
  shippingMethodName?: string;        // 发货方式名称（中文）
  vehicleInfo?: string;
  driverInfo?: string;
  totalItems: number;
  totalWeight: number | string;       // 支持字符串类型
  totalVolume?: number | string;
  packingListPath?: string;
  photoPath?: string;
  remarks?: string;
  createTime: string;
  updateTime: string;
  createBy?: string;
  updateBy?: string;
  materialItems?: any;                // 物料明细
  statistics?: any;                   // 统计信息
}
```

**关键修改点：**

1. 同时支持 `id` 和 `shippingListId` 字段
2. 添加 `statusName` 和 `shippingMethodName` 字段
3. `status`、`shippingMethod` 支持字符串类型
4. `totalWeight`、`totalVolume` 支持字符串类型（后端返回 "0.00"）
5. 添加 `materialItems` 和 `statistics` 字段

### 3. 优化显示逻辑

**修改位置：** `src/views/erp/saltprocess/shipping/index.vue`

#### 3.1 状态显示优化

```vue
<el-table-column label="发货状态" prop="status" width="100" align="center">
  <template #default="{ row }">
    <el-tag :type="getStatusTagType(row.status)" size="small">
      {{ row.statusName || getStatusLabel(row.status) }}
    </el-tag>
  </template>
</el-table-column>
```

**优化说明：** 优先使用后端返回的 `statusName`，如果没有则转换 `status` 枚举值。

#### 3.2 发货方式显示优化

```vue
<el-table-column label="发货方式" prop="shippingMethod" width="100" align="center">
  <template #default="{ row }">
    {{ row.shippingMethodName || getShippingMethodLabel(row.shippingMethod) }}
  </template>
</el-table-column>
```

**优化说明：** 优先使用后端返回的 `shippingMethodName`。

#### 3.3 重量显示优化

```vue
<el-table-column label="总重量(kg)" prop="totalWeight" width="100" align="center">
  <template #default="{ row }">
    {{ typeof row.totalWeight === 'number' ? row.totalWeight.toFixed(2) : row.totalWeight || '0.00' }}
  </template>
</el-table-column>
```

**优化说明：** 处理数字和字符串两种类型的重量数据。

### 4. 修复选择和删除逻辑

```typescript
const handleSelectionChange = (selection: ShippingListVO[]) => {
  ids.value = selection
    .map(item => item.id || item.shippingListId)
    .filter((id): id is string => !!id);
  single.value = selection.length !== 1;
  multiple.value = !selection.length;
};

const handleDelete = async (row?: ShippingListVO) => {
  const deleteIds = row ? [(row.id || row.shippingListId)!] : ids.value;
  const names = row ? [row.listCode] : shippingList.value
    .filter(item => deleteIds.includes((item.id || item.shippingListId)!))
    .map(item => item.listCode);

  // ... 删除逻辑
};
```

**优化说明：** 同时支持 `id` 和 `shippingListId` 两个字段。

## 修复效果

### 修复前

- 接口返回数据，但页面表格为空
- 控制台无明显错误提示
- 数据无法正常显示

### 修复后

✅ 数据正常显示在表格中
✅ 状态和发货方式显示中文名称
✅ 重量数据正确显示
✅ 选择和删除功能正常工作
✅ 添加了错误日志，便于问题排查

## 测试建议

1. **基本显示测试**

   - 访问发货清单页面，确认数据正常加载
   - 检查表格各列数据是否正确显示
   - 验证状态标签和发货方式的中文显示

2. **交互功能测试**

   - 测试勾选记录功能
   - 测试批量删除功能
   - 测试单条记录删除功能
   - 测试查询和重置功能

3. **边界情况测试**
   - 测试空数据情况
   - 测试数据量较大的情况
   - 测试网络异常情况

## 潜在问题说明

### TypeScript Lint 警告

在 `index.vue` 中可能会看到以下 lint 警告：

```
Module 'ExcelImportDialog.vue' has no default export.
```

**说明：** 这是 TypeScript/Volar 的已知问题，`<script setup>` 语法会自动导出组件，运行时不会有问题。可以忽略此警告，或者在项目的 TypeScript 配置中调整。

## 最佳实践建议

### 1. API 接口规范化

建议后端和前端统一数据结构规范：

**推荐方案 A：** 后端使用 `records` 字段

```json
{
  "total": 7,
  "records": [...],
  "code": 200,
  "msg": "查询成功"
}
```

**推荐方案 B：** 前端适配 `rows` 字段（当前方案）

### 2. 字段命名统一

建议后端统一使用以下字段命名：

- 主键字段统一为 `id`（而不是 `shippingListId`、`recordId` 等）
- 状态字段只返回枚举值，由前端转换显示
- 或者同时返回 `status` 和 `statusName`，前端优先使用 `statusName`

### 3. 类型定义完善

前端类型定义应该严格匹配后端返回的数据结构，包括：

- 字段类型（number、string、number | string）
- 可选字段（使用 `?`）
- 枚举类型的字符串替代方案

### 4. 错误处理增强

```typescript
try {
  const response = await listShippingList(params);
  console.log('API响应:', response.data); // 开发环境日志
  // ... 处理数据
} catch (error) {
  console.error('API错误:', error);
  ElMessage.error(`获取列表失败: ${error.message || '未知错误'}`);
}
```

## 相关文件

- **页面组件：** `src/views/erp/saltprocess/shipping/index.vue`
- **类型定义：** `src/api/erp/saltprocess/shipping/types.ts`
- **API 接口：** `src/api/erp/saltprocess/shipping/index.ts`

## 更新日期

2025-10-27

## 作者

AI 助手（根据用户反馈修复）
