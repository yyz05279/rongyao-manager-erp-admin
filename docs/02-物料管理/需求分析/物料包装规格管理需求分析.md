# 物料包装规格管理需求分析

## 1. 业务场景

### 1.1 实际业务需求

**场景描述**：
- **进货**：物料以包装单位进货（如：500颗/袋、100个/箱）
- **出库**：物料以基础单位出库（如：100颗、50个）
- **需求**：系统需要支持包装规格与实际使用数量的转换

### 1.2 典型案例

#### 案例1：螺丝
```
进货信息：
- 物料名称：M6螺丝
- 包装规格：500颗/袋
- 进货数量：10袋
- 总数量：5000颗

出库信息：
- 出库数量：100颗（从某一袋中取出）
- 剩余数量：4900颗
```

#### 案例2：电缆
```
进货信息：
- 物料名称：电缆线
- 包装规格：100米/卷
- 进货数量：5卷
- 总长度：500米

出库信息：
- 出库长度：50米（从某一卷中取出）
- 剩余长度：450米
```

## 2. 字段设计方案

### 2.1 核心字段设计

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| **packageQuantity** | Integer | 包装数量（每包/每箱的数量） | 500 |
| **packageUnit** | String | 包装单位 | 袋、箱、卷 |
| **baseUnit** | String | 基础单位（最小计量单位） | 颗、个、米 |
| **packageWeight** | BigDecimal | 包装重量（单包重量，kg） | 2.5 |
| **packageVolume** | BigDecimal | 包装体积（单包体积，m³） | 0.05 |
| **totalPackages** | Integer | 总包装数（进货时的包数） | 10 |
| **totalQuantity** | BigDecimal | 总数量（基础单位） | 5000 |

### 2.2 字段关系

```
总数量 = 包装数量 × 总包装数
totalQuantity = packageQuantity × totalPackages

总重量 = 包装重量 × 总包装数
totalWeight = packageWeight × totalPackages

总体积 = 包装体积 × 总包装数
totalVolume = packageVolume × totalPackages
```

### 2.3 与现有字段的关系

| 现有字段 | 新字段 | 关系 |
|---------|--------|------|
| unit | packageUnit + baseUnit | unit 可以是包装单位或基础单位 |
| unitWeight | packageWeight | unitWeight 是单个物料的重量，packageWeight 是单包重量 |
| unitVolume | packageVolume | unitVolume 是单个物料的体积，packageVolume 是单包体积 |

## 3. 数据库设计

### 3.1 新增字段

```sql
ALTER TABLE erp_material
-- 包装规格相关
ADD COLUMN package_quantity INT DEFAULT NULL COMMENT '包装数量（每包/每箱的数量）',
ADD COLUMN package_unit VARCHAR(20) DEFAULT NULL COMMENT '包装单位（袋、箱、卷等）',
ADD COLUMN base_unit VARCHAR(20) DEFAULT NULL COMMENT '基础单位（颗、个、米等，最小计量单位）',
ADD COLUMN package_weight DECIMAL(10,2) DEFAULT NULL COMMENT '包装重量（单包重量，kg）',
ADD COLUMN package_volume DECIMAL(10,2) DEFAULT NULL COMMENT '包装体积（单包体积，m³）',

-- 进货信息（可选，用于记录初始进货信息）
ADD COLUMN total_packages INT DEFAULT NULL COMMENT '总包装数（进货时的包数）',
ADD COLUMN total_quantity DECIMAL(10,2) DEFAULT NULL COMMENT '总数量（基础单位）',
ADD COLUMN total_weight DECIMAL(10,2) DEFAULT NULL COMMENT '总重量（kg）',
ADD COLUMN total_volume DECIMAL(10,2) DEFAULT NULL COMMENT '总体积（m³）',

-- 批次信息
ADD COLUMN serial_number VARCHAR(100) DEFAULT NULL COMMENT '序列号/批次号',
ADD COLUMN production_date DATE DEFAULT NULL COMMENT '生产日期',
ADD COLUMN expiry_date DATE DEFAULT NULL COMMENT '过期日期（可选）';
```

### 3.2 索引设计

```sql
-- 添加索引
ALTER TABLE erp_material
ADD INDEX idx_serial_number (serial_number),
ADD INDEX idx_production_date (production_date),
ADD INDEX idx_package_unit (package_unit);
```

## 4. 数据模型设计

### 4.1 基础物料信息（erp_material）

```java
@Data
@TableName("erp_material")
public class ErpMaterial extends TenantEntity {
    
    // ========== 基础信息 ==========
    private String materialCode;      // 物料编码
    private String materialName;      // 物料名称
    private String specification;     // 规格型号
    private String materialType;      // 物料类型
    
    // ========== 包装规格 ==========
    private Integer packageQuantity;  // 包装数量（每包数量）
    private String packageUnit;       // 包装单位（袋、箱、卷）
    private String baseUnit;          // 基础单位（颗、个、米）
    private BigDecimal packageWeight; // 包装重量（单包重量）
    private BigDecimal packageVolume; // 包装体积（单包体积）
    
    // ========== 进货信息（可选） ==========
    private Integer totalPackages;    // 总包装数
    private BigDecimal totalQuantity; // 总数量（基础单位）
    private BigDecimal totalWeight;   // 总重量
    private BigDecimal totalVolume;   // 总体积
    
    // ========== 批次信息 ==========
    private String serialNumber;      // 序列号/批次号
    private LocalDate productionDate; // 生产日期
    private LocalDate expiryDate;     // 过期日期
    
    // ========== 原有字段 ==========
    private String unit;              // 单位（兼容旧数据）
    private BigDecimal unitWeight;    // 单重（单个物料重量）
    private BigDecimal unitVolume;    // 单体积（单个物料体积）
    private String manufacturer;      // 制造商
    private Boolean isFragile;        // 是否易碎
    private Boolean isHazardous;      // 是否危险品
}
```

### 4.2 字段使用说明

#### 场景1：有包装规格的物料（如螺丝）

```json
{
  "materialName": "M6螺丝",
  "specification": "304不锈钢",
  "materialType": "STANDARD_PARTS",
  
  // 包装规格
  "packageQuantity": 500,        // 每袋500颗
  "packageUnit": "袋",
  "baseUnit": "颗",
  "packageWeight": 2.5,          // 每袋2.5kg
  "packageVolume": 0.05,         // 每袋0.05m³
  
  // 进货信息
  "totalPackages": 10,           // 进货10袋
  "totalQuantity": 5000,         // 总共5000颗
  "totalWeight": 25,             // 总重25kg
  "totalVolume": 0.5,            // 总体积0.5m³
  
  // 批次信息
  "serialNumber": "SN20251112001",
  "productionDate": "2025-11-01"
}
```

#### 场景2：无包装规格的物料（如设备）

```json
{
  "materialName": "变频器",
  "specification": "380V 15KW",
  "materialType": "ELECTRICAL",
  
  // 不需要包装规格
  "unit": "台",
  "unitWeight": 45.5,            // 单台重量
  "unitVolume": 0.2,             // 单台体积
  
  // 进货信息（可选）
  "totalQuantity": 2,            // 进货2台
  "totalWeight": 91,             // 总重91kg
  "totalVolume": 0.4,            // 总体积0.4m³
  
  "manufacturer": "西门子",
  "serialNumber": "SN20251112002"
}
```

## 5. 业务逻辑设计

### 5.1 新增物料时的计算逻辑

```java
@Service
public class ErpMaterialServiceImpl {
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Boolean insertByBo(ErpMaterialBo bo) {
        ErpMaterial material = mapToEntity(bo);
        
        // 1. 生成物料编码
        if (StringUtils.isBlank(material.getMaterialCode())) {
            material.setMaterialCode(materialCodeGenerator.generate());
        }
        
        // 2. 计算总数量、总重量、总体积
        calculateTotals(material);
        
        // 3. 设置默认状态
        if (StringUtils.isBlank(material.getStatus())) {
            material.setStatus("ACTIVE");
        }
        
        // 4. 插入数据库
        boolean flag = baseMapper.insert(material) > 0;
        if (flag) {
            bo.setId(material.getId());
            bo.setMaterialCode(material.getMaterialCode());
            log.info("物料创建成功，ID: {}, 编码: {}", material.getId(), material.getMaterialCode());
        }
        return flag;
    }
    
    /**
     * 计算总数量、总重量、总体积
     */
    private void calculateTotals(ErpMaterial material) {
        // 如果有包装规格信息
        if (material.getPackageQuantity() != null && material.getTotalPackages() != null) {
            // 计算总数量 = 包装数量 × 总包装数
            BigDecimal totalQty = BigDecimal.valueOf(material.getPackageQuantity())
                .multiply(BigDecimal.valueOf(material.getTotalPackages()));
            material.setTotalQuantity(totalQty);
            
            // 计算总重量 = 包装重量 × 总包装数
            if (material.getPackageWeight() != null) {
                BigDecimal totalWt = material.getPackageWeight()
                    .multiply(BigDecimal.valueOf(material.getTotalPackages()));
                material.setTotalWeight(totalWt);
            }
            
            // 计算总体积 = 包装体积 × 总包装数
            if (material.getPackageVolume() != null) {
                BigDecimal totalVol = material.getPackageVolume()
                    .multiply(BigDecimal.valueOf(material.getTotalPackages()));
                material.setTotalVolume(totalVol);
            }
        }
        // 如果没有包装规格，但有单重单体积
        else if (material.getUnitWeight() != null && material.getTotalQuantity() != null) {
            // 计算总重量 = 单重 × 总数量
            BigDecimal totalWt = material.getUnitWeight()
                .multiply(material.getTotalQuantity());
            material.setTotalWeight(totalWt);
            
            // 计算总体积 = 单体积 × 总数量
            if (material.getUnitVolume() != null) {
                BigDecimal totalVol = material.getUnitVolume()
                    .multiply(material.getTotalQuantity());
                material.setTotalVolume(totalVol);
            }
        }
    }
}
```

### 5.2 出库时的处理逻辑

```java
/**
 * 出库处理
 */
public void processOutbound(Long materialId, BigDecimal outboundQuantity) {
    ErpMaterial material = baseMapper.selectById(materialId);
    
    // 检查库存
    if (material.getTotalQuantity().compareTo(outboundQuantity) < 0) {
        throw new ServiceException("库存不足");
    }
    
    // 更新总数量
    BigDecimal newQuantity = material.getTotalQuantity().subtract(outboundQuantity);
    material.setTotalQuantity(newQuantity);
    
    // 重新计算总包装数（如果有包装规格）
    if (material.getPackageQuantity() != null) {
        int newPackages = newQuantity.divide(
            BigDecimal.valueOf(material.getPackageQuantity()),
            0, RoundingMode.UP
        ).intValue();
        material.setTotalPackages(newPackages);
    }
    
    // 更新数据库
    baseMapper.updateById(material);
}
```

## 6. 前端接口定义

### 6.1 新增物料接口

```typescript
interface MaterialForm {
  // 基础信息
  materialName: string;
  materialType: string;
  specification?: string;
  
  // 包装规格（可选）
  packageQuantity?: number;      // 包装数量
  packageUnit?: string;          // 包装单位
  baseUnit?: string;             // 基础单位
  packageWeight?: number;        // 包装重量
  packageVolume?: number;        // 包装体积
  
  // 进货信息（可选）
  totalPackages?: number;        // 总包装数
  totalQuantity?: number;        // 总数量
  totalWeight?: number;          // 总重量
  totalVolume?: number;          // 总体积
  
  // 批次信息（可选）
  serialNumber?: string;         // 序列号
  productionDate?: string;       // 生产日期
  expiryDate?: string;           // 过期日期
  
  // 其他信息
  manufacturer?: string;
  isFragile?: boolean;
  isHazardous?: boolean;
}
```

### 6.2 请求示例

```json
{
  "materialName": "M6螺丝",
  "materialType": "STANDARD_PARTS",
  "specification": "304不锈钢",
  
  "packageQuantity": 500,
  "packageUnit": "袋",
  "baseUnit": "颗",
  "packageWeight": 2.5,
  "packageVolume": 0.05,
  
  "totalPackages": 10,
  "serialNumber": "SN20251112001",
  "productionDate": "2025-11-01",
  
  "manufacturer": "标准件厂",
  "isFragile": false,
  "isHazardous": false
}
```

## 7. 数据验证规则

### 7.1 必填字段验证

```java
@Data
public class ErpMaterialBo extends BaseEntity {
    
    @NotBlank(message = "物料名称不能为空", groups = {AddGroup.class})
    private String materialName;
    
    @NotBlank(message = "物料类型不能为空", groups = {AddGroup.class})
    private String materialType;
    
    // 包装规格字段（可选，但如果填写了packageQuantity，则packageUnit和baseUnit必填）
    private Integer packageQuantity;
    
    @NotBlank(message = "包装单位不能为空", groups = {PackageGroup.class})
    private String packageUnit;
    
    @NotBlank(message = "基础单位不能为空", groups = {PackageGroup.class})
    private String baseUnit;
}
```

### 7.2 业务逻辑验证

```java
/**
 * 验证包装规格数据的完整性
 */
private void validatePackageInfo(ErpMaterialBo bo) {
    // 如果填写了包装数量，则必须填写包装单位和基础单位
    if (bo.getPackageQuantity() != null) {
        if (StringUtils.isBlank(bo.getPackageUnit())) {
            throw new ServiceException("填写了包装数量，必须填写包装单位");
        }
        if (StringUtils.isBlank(bo.getBaseUnit())) {
            throw new ServiceException("填写了包装数量，必须填写基础单位");
        }
    }
    
    // 如果填写了总包装数，则必须填写包装数量
    if (bo.getTotalPackages() != null && bo.getPackageQuantity() == null) {
        throw new ServiceException("填写了总包装数，必须填写包装数量");
    }
}
```

## 8. 总结

### 8.1 核心字段

| 字段 | 必填 | 说明 |
|------|------|------|
| packageQuantity | 否 | 包装数量（每包数量） |
| packageUnit | 条件必填 | 包装单位（有packageQuantity时必填） |
| baseUnit | 条件必填 | 基础单位（有packageQuantity时必填） |
| packageWeight | 否 | 包装重量 |
| packageVolume | 否 | 包装体积 |
| totalPackages | 否 | 总包装数 |
| totalQuantity | 否 | 总数量（自动计算或手动填写） |
| totalWeight | 否 | 总重量（自动计算） |
| totalVolume | 否 | 总体积（自动计算） |
| serialNumber | 否 | 序列号/批次号 |
| productionDate | 否 | 生产日期 |

### 8.2 优势

1. ✅ 支持包装规格管理
2. ✅ 支持进货和出库的数量转换
3. ✅ 自动计算总数量、总重量、总体积
4. ✅ 支持批次管理（序列号、生产日期）
5. ✅ 兼容无包装规格的物料
6. ✅ 灵活的字段设计，可选填写

---

**文档版本**：v1.0  
**创建时间**：2025-11-12  
**创建人员**：海棠开发团队

