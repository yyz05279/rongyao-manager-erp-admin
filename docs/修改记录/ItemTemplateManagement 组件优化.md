# ItemTemplateManagement 组件优化说明

## 优化时间
2025-11-20

## 优化目标
优化子项模板编辑功能，区分"仅编辑基础信息"和"编辑物料数据"两种场景，避免用户在只修改基础信息时被强制要求重新上传物料数据。

## 优化内容

### 1. 新增响应式变量
**位置**: 第331行
```typescript
const updateMaterialData = ref(false); // 控制是否更新物料数据（仅编辑模式使用）
```

### 2. 改进表单验证规则
**位置**: 第353-376行
- 将 `itemRules` 从普通对象改为 `computed` 计算属性
- 实现动态验证逻辑：
  - **新增模式**: 物料必填
  - **编辑模式且开启更新物料**: 物料必填
  - **编辑模式且不更新物料**: 跳过物料验证

### 3. 优化编辑对话框UI
**位置**: 第149-169行
- 添加分隔线，明确区分"基础信息"和"物料数据配置"
- 在编辑模式下显示"更新物料数据"开关
- 添加提示信息，说明开关的作用
- 根据开关状态条件渲染物料配置区域

### 4. 修改编辑子项逻辑
**位置**: 第700-717行
- 在 `handleEditItem` 中默认设置 `updateMaterialData.value = false`
- 仍然加载物料数据用于显示，但不强制要求修改

### 5. 优化提交表单逻辑
**位置**: 第831-929行
- 区分两种提交场景：
  - **场景A**: 编辑模式且不更新物料 → 只更新基础信息，不同步物料变更
  - **场景B**: 新增模式或编辑且更新物料 → 验证物料并同步物料变更

### 6. 完善表单重置逻辑
**位置**: 第931-944行
- 在 `resetItemForm` 中重置 `updateMaterialData.value = false`

### 7. 新增开关变化处理方法
**位置**: 第987-997行
```typescript
const handleUpdateMaterialDataChange = (value: boolean) => {
  if (value) {
    // 开启更新物料数据时，触发表单验证
    itemFormRef.value?.validateField('materials');
  } else {
    // 关闭更新物料数据时，清除物料字段的验证错误
    itemFormRef.value?.clearValidate('materials');
  }
};
```

## 用户体验改进

### 编辑基础信息场景
1. 用户点击"编辑"按钮
2. 对话框打开，显示基础信息和物料数据
3. "更新物料数据"开关默认关闭
4. 物料配置区域被隐藏
5. 用户修改基础信息（名称、描述等）
6. 点击"确定"，只更新基础信息，保留原有物料数据

### 编辑物料数据场景
1. 用户点击"编辑"按钮
2. 对话框打开，显示基础信息和物料数据
3. 用户开启"更新物料数据"开关
4. 物料配置区域显示，可以添加/删除/修改物料
5. 点击"确定"，同时更新基础信息和物料数据

### 新增子项场景
1. 用户点击"添加子项"按钮
2. 对话框打开，不显示"更新物料数据"开关
3. 物料配置区域始终显示且必填
4. 用户必须至少添加一个物料才能提交

## 技术要点

### 动态表单验证
使用 `computed` 实现动态验证规则，根据编辑模式和开关状态自动调整验证逻辑。

### 条件渲染
使用 `v-if` 指令根据 `itemForm.id` 和 `updateMaterialData` 的值控制UI元素的显示/隐藏。

### 数据一致性
- 编辑模式下仍然加载物料数据用于显示
- 只有在用户明确开启"更新物料数据"时才进行物料同步
- 避免误操作导致物料数据丢失

## 兼容性说明

### 后端API兼容
- 不需要修改后端API
- 利用现有的更新接口，只是在前端控制是否同步物料数据

### 两种模式支持
- 支持原有子系统模板模式 (`useEquipmentSystemApi = false`)
- 支持设备系统模板模式 (`useEquipmentSystemApi = true`)

## 测试建议

### 测试场景1: 仅编辑基础信息
1. 编辑一个已有子项
2. 保持"更新物料数据"开关关闭
3. 修改子项名称、描述等基础信息
4. 提交表单
5. 验证：基础信息已更新，物料数据保持不变

### 测试场景2: 编辑物料数据
1. 编辑一个已有子项
2. 开启"更新物料数据"开关
3. 添加/删除/修改物料
4. 提交表单
5. 验证：基础信息和物料数据都已更新

### 测试场景3: 新增子项
1. 点击"添加子项"
2. 填写基础信息
3. 尝试不添加物料直接提交（应该提示错误）
4. 添加至少一个物料
5. 提交表单
6. 验证：新子项创建成功，包含物料数据

### 测试场景4: 开关切换
1. 编辑一个已有子项
2. 开启"更新物料数据"开关
3. 不添加物料
4. 尝试提交（应该提示错误）
5. 关闭"更新物料数据"开关
6. 提交表单（应该成功）

## 注意事项

1. **数据安全**: 关闭"更新物料数据"时，原有物料数据完全保留，不会被清空或修改
2. **用户提示**: 通过图标和文字清晰提示用户当前操作的影响范围
3. **表单验证**: 动态验证规则确保在不同场景下都有正确的验证逻辑
4. **向后兼容**: 不影响新增子项的原有流程

## 优化效果

✅ 区分了两种编辑场景，用户可以选择只更新基础信息
✅ 提供了明确的用户选择，避免误操作
✅ 保持了数据一致性，不会丢失原有物料数据
✅ 添加了适当的提示信息，用户体验更友好
✅ 不需要修改后端API，前端独立完成优化

