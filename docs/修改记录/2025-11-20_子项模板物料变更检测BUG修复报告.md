# 子项模板物料变更自动检测BUG修复报告

**日期**: 2025-11-20

**相关文件**: `src/views/erp/subsystem/item-template/index.vue`

---

## 1. 问题描述 (Bug Description)

在“修改子项”功能中，即使用户只修改了子项的基础信息（如：名称、描述等），没有对物料列表进行任何操作，系统仍然会错误地触发物料同步流程 (`syncMaterialChanges`)。

**预期行为**:
- 仅修改基础信息时，`haveMaterialsChanged` 函数应返回 `false`，系统只更新基础信息。

**实际行为**:
- `haveMaterialsChanged` 函数错误地返回 `true`，导致不必要的物料更新API调用。

## 2. 问题根源 (Root Cause Analysis)

通过在 `submitForm` 函数中添加调试日志，精确比对了提交前的“原始物料”和“当前物料”两个数组，发现问题根源在于 **数据类型不匹配**。

- **原始物料数据**: 从后端API加载时，`defaultQuantity` 字段的类型是 **字符串** (e.g., `"1.00"`)。
- **当前物料数据**: 在表单中，`el-input-number` 组件将 `defaultQuantity` 的值双向绑定为了 **数字** (e.g., `1`)。

在 `haveMaterialsChanged` 函数的比对逻辑中，`"1.00" !== 1` 的结果为 `true`，导致系统误判物料已被修改。

## 3. 解决方案 (Solution)

针对上述问题，对 `haveMaterialsChanged` 函数的比对逻辑进行了精确修正。

**核心修改**:

1.  **统一数据类型**: 在比对 `defaultQuantity` 字段前，使用 `Number()` 将原始值和当前值都强制转换为数字类型，消除了因类型不匹配导致的误判。

    ```javascript
    // before
    originalMaterial.defaultQuantity !== material.defaultQuantity

    // after
    const originalQty = Number(originalMaterial.defaultQuantity);
    const currentQty = Number(material.defaultQuantity);
    // ...
    originalQty !== currentQty
    ```

2.  **严谨的空值处理**: 对 `remarks` 字段的比对逻辑进行了优化，将 `null` 或 `undefined` 统一视为空字符串 `''` 进行比较，增加了比对的健壮性。

    ```javascript
    // before
    originalMaterial.remarks !== material.remarks

    // after
    const originalRemarks = originalMaterial.remarks || '';
    const currentRemarks = material.remarks || '';
    // ...
    originalRemarks !== currentRemarks
    ```

3.  **清理调试代码**: 在确认修复方案有效后，移除了所有用于调试的 `console.log` 语句，保持了代码的整洁。

## 4. 验证结果 (Verification)

- **场景一：仅修改基础信息**
  - **操作**: 修改子项名称，不修改物料。
  - **结果**: `haveMaterialsChanged` 返回 `false`，系统仅更新基础信息，未调用 `syncMaterialChanges`。**测试通过**。

- **场景二：修改物料信息**
  - **操作**: 修改物料的默认数量。
  - **结果**: `haveMaterialsChanged` 返回 `true`，系统更新基础信息，并成功调用 `syncMaterialChanges` 同步物料。**测试通过**。

- **场景三：新增/删除物料**
  - **操作**: 在物料列表中增加或删除一个物料。
  - **结果**: `haveMaterialsChanged` 返回 `true`，系统成功同步物料变更。**测试通过**。

