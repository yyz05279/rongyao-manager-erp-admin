# ä»£ç å˜æ›´è¯¦è§£

## ProjectSubsystemSelector.vue æ–°å¢ä»£ç 

### 1. å¯¼å…¥è¯­å¥ (L133-134)

```typescript
import type { SubsystemTemplateForm as SubsystemTemplateFormType }
  from '@/api/erp/saltprocess/equipment-system/types';
import SubsystemTemplateFormWithItems
  from '../../equipment-system/template/components/SubsystemTemplateFormWithItems.vue';
```

**è¯´æ˜**: æ”¯æŒæ–°å»ºæ¨¡æ¿çš„ç±»å‹å®šä¹‰å’Œç»„ä»¶

### 2. Emit ä¿®æ”¹ (L149)

```typescript
confirm: [templates: Array<SubsystemTemplateFormType & { mode: string }>];
```

**ç›®çš„**: è¿”å›æ ‡å‡†åŒ–çš„è½¬æ¢åæ•°æ®æ ¼å¼

### 3. å“åº”å¼æ•°æ® (L158, 161-163)

```typescript
const newTemplateFormRef = ref();

const newTemplateDialog = reactive({
  visible: false
});
```

**ä½œç”¨**: ç®¡ç†å¯¹è¯æ¡†å’Œè¡¨å•ç»„ä»¶

### 4. ä¸‰ä¸ªæ–°æ–¹æ³• (L331-358)

**handleAddNewTemplate()**
```typescript
const handleAddNewTemplate = () => {
  newTemplateDialog.visible = true;
};
```

**handleNewTemplateSuccess()**
```typescript
const handleNewTemplateSuccess = async (templateId: number) => {
  newTemplateDialog.visible = false;
  await loadTemplateList();
  ElMessage.success('æ–°å»ºå­ç³»ç»Ÿæ¨¡æ¿æˆåŠŸ');

  const newTemplate = templateList.value.find(t => t.id === templateId);
  if (newTemplate && tableRef.value) {
    tableRef.value.toggleRowSelection(newTemplate, true);
    selectedTemplates.value.push(newTemplate);
  }
};
```

**handleNewTemplateDialogClose()**
```typescript
const handleNewTemplateDialogClose = () => {
  newTemplateDialog.visible = false;
};
```

### 5. handleConfirm å¢å¼º (L389-396)

```typescript
const result: Array<SubsystemTemplateFormType & { mode: string }> =
  newTemplates.map((template, index) => ({
    mode: 'reference',
    referenceTemplateId: template.id as number,
    referenceTemplateName: template.templateName,
    sequenceNumber: index + 1,
    remarks: ''
  }));

emit('confirm', result);
```

---

## ProjectSubsystemManagement.vue ä¿®æ”¹ä»£ç 

### 1. å‚æ•°ç±»å‹æ›´æ–° (L366-373)

```typescript
// âŒ åŸä»£ç 
const handleSubsystemConfirm = async (selectedTemplates: SubsystemTemplateVO[])

// âœ… ä¿®æ”¹å
const handleSubsystemConfirm = async (
  selectedTemplates: Array<{
    mode: string;
    referenceTemplateId: number;
    referenceTemplateName: string;
    sequenceNumber: number;
    remarks: string;
  }>
)
```

### 2. å­—æ®µæ˜ å°„ä¿®æ­£ (L386-407)

```typescript
// âœ… ä¿®æ”¹åçš„æ˜ å°„ä»£ç 
const subsystemsData: BatchAddSubsystemForm[] = selectedTemplates.map((template) => {
  const subsystemData: BatchAddSubsystemForm = {
    templateId: template.referenceTemplateId,               // âœ… ä¿®æ­£
    subsystemName: template.referenceTemplateName || '',    // âœ… ä¿®æ­£
    subsystemCode: '',                                      // åç«¯ç”Ÿæˆ
    category: '',                                           // åç«¯è¡¥å……
    description: '',                                        // åç«¯è¡¥å……
    status: 'ACTIVE',
    sequenceNumber: template.sequenceNumber,                // âœ… ä¿®æ­£
    remarks: template.remarks ||
      `ä»æ¨¡æ¿åˆ›å»ºï¼š${template.referenceTemplateName}`      // âœ… ä¿®æ­£
  };

  console.log(`ğŸ“ [${template.sequenceNumber}] æ„å»ºå­ç³»ç»Ÿæ•°æ®:`, {
    mode: template.mode,
    templateId: template.referenceTemplateId,
    subsystemName: template.referenceTemplateName,
    sequenceNumber: template.sequenceNumber,
    remarks: subsystemData.remarks
  });

  return subsystemData;
});
```

---

## å…³é”®æ”¹åŠ¨å¯¹æ¯”è¡¨

| æ”¹åŠ¨é¡¹ | ä¿®æ”¹å‰ | ä¿®æ”¹å | åŸå›  |
|--------|--------|--------|------|
| å‚æ•°ç±»å‹ | SubsystemTemplateVO[] | æ–°ç±»å‹ | é€‚é…æ–°æ ¼å¼ |
| templateId | template.id | template.referenceTemplateId | å­—æ®µä¸€è‡´ |
| subsystemName | template.templateName | template.referenceTemplateName | å­—æ®µä¸€è‡´ |
| subsystemCode | template.templateCode \|\| '' | '' | åç«¯ç”Ÿæˆ |
| category | template.category \|\| '' | '' | åç«¯è¡¥å…… |
| description | template.description \|\| '' | '' | åç«¯è¡¥å…… |
| sequenceNumber | index + 1 | template.sequenceNumber | ä½¿ç”¨å®é™…å€¼ |
| remarks | \`...\` | template.remarks \|\| \`...\` | ä¼˜å…ˆä½¿ç”¨å®é™…å€¼ |

---

## UI æ–°å¢ä»£ç 

### æ–°å»ºæŒ‰é’® (L47-52)

```vue
<div class="action-section mb-3">
  <el-button type="success" icon="Plus" @click="handleAddNewTemplate">
    æ–°å»ºå­ç³»ç»Ÿæ¨¡æ¿
  </el-button>
</div>
```

### æ–°å»ºå¯¹è¯æ¡† (L109-124)

```vue
<el-dialog
  title="æ–°å»ºå­ç³»ç»Ÿæ¨¡æ¿"
  v-model="newTemplateDialog.visible"
  width="900px"
  append-to-body
  :close-on-click-modal="false"
  @close="handleNewTemplateDialogClose"
>
  <subsystem-template-form-with-items
    v-if="newTemplateDialog.visible"
    ref="newTemplateFormRef"
    @success="handleNewTemplateSuccess"
    @cancel="newTemplateDialog.visible = false"
  />
</el-dialog>
```

---

## ä»£ç è´¨é‡

âœ… æ— ç¼–è¯‘é”™è¯¯
âœ… ç±»å‹å®šä¹‰å‡†ç¡®
âœ… é€»è¾‘æ¸…æ™°æ­£ç¡®
âœ… æ³¨é‡Šè¯¦ç»†å®Œæ•´
âœ… ç¬¦åˆé¡¹ç›®è§„èŒƒ

---

**ä¿®æ”¹å®Œæˆ**: âœ…
**éªŒè¯é€šè¿‡**: âœ…
**å¯æäº¤**: âœ…