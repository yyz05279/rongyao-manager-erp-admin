# 代码同步详解

## 任务目标

将子系统模板新增功能从 SubsystemTemplateSelector.vue 同步到 ProjectSubsystemSelector.vue

## 修改文件

**文件路径**: `src/views/erp/saltprocess/equipment-system/components/ProjectSubsystemSelector.vue`  
**修改量**: +41 行代码

---

## 同步内容详细说明

### 1. 导入语句添加 (Line 133-134)

```typescript
// 新增导入
import type { SubsystemTemplateForm as SubsystemTemplateFormType } 
  from '@/api/erp/saltprocess/equipment-system/types';
import SubsystemTemplateFormWithItems 
  from '../../equipment-system/template/components/SubsystemTemplateFormWithItems.vue';
```

**用途**: 支持新建子系统模板功能的数据类型和组件

### 2. Emit 类型更新 (Line 149)

```typescript
// 修改前
confirm: [templates: SubsystemTemplateVO[]];

// 修改后
confirm: [templates: Array<SubsystemTemplateFormType & { mode: string }>];
```

**说明**: 返回的数据格式标准化，包含完整的模板信息

### 3. 响应式数据新增 (Line 158, 161-163)

```typescript
const newTemplateFormRef = ref();  // 新建表单引用

const newTemplateDialog = reactive({  // 新建对话框状态
  visible: false
});
```

**作用**: 管理新建对话框的显示/隐藏和表单组件引用

### 4. UI 组件添加

#### 操作按钮区 (Line 47-52)
```vue
<!-- 新建子系统模板按钮 -->
<div class="action-section mb-3">
  <el-button type="success" icon="Plus" @click="handleAddNewTemplate">
    新建子系统模板
  </el-button>
</div>
```

#### 嵌套对话框 (Line 109-124)
```vue
<!-- 新建子系统模板对话框 -->
<el-dialog
  v-model="newTemplateDialog.visible"
  title="新建子系统模板"
  width="900px"
  @close="handleNewTemplateDialogClose"
>
  <subsystem-template-form-with-items
    v-if="newTemplateDialog.visible"
    ref="newTemplateFormRef"
    @success="handleNewTemplateSuccess"
    @cancel="newTemplateDialog.visible = false"
  />
</el-dialog>
```

### 5. 业务方法新增 (Line 331-358)

#### handleAddNewTemplate()
- 功能: 打开新建对话框
- 代码简洁，仅一行业务逻辑

#### handleNewTemplateSuccess()
- 功能: 处理新建成功事件
- 包含: 关闭对话框 → 刷新列表 → 自动勾选 → 成功提示

#### handleNewTemplateDialogClose()
- 功能: 处理对话框关闭
- 清理对话框状态

### 6. handleConfirm() 增强 (Line 360-402)

```typescript
// 数据转换为标准格式
const result: Array<SubsystemTemplateFormType & { mode: string }> = 
  newTemplates.map((template, index) => ({
    mode: 'reference',
    referenceTemplateId: template.id as number,
    referenceTemplateName: template.templateName,
    sequenceNumber: index + 1,
    remarks: ''
  }));

emit('confirm', result);
```

**关键改进**:
- 保留原有防御性编程（过滤已添加模板）
- 新增数据格式转换
- 统一返回数据结构

---

## 返回数据格式

```typescript
{
  mode: 'reference',              // 模式标识
  referenceTemplateId: number,    // 模板ID
  referenceTemplateName: string,  // 模板名称
  sequenceNumber: number,         // 序列号
  remarks: string                 // 备注
}
```

---

## 关键特性

✅ 无需离开选择对话框即可新建模板  
✅ 新建完成自动刷新列表  
✅ 新建的模板自动被勾选  
✅ 数据格式统一标准化  

---

## 验证信息

- ✅ 编译无错误
- ✅ 类型检查通过
- ✅ 所有导入完整
- ✅ 功能完整性验证通过

