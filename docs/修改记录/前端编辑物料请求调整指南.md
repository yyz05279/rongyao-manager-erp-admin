# 前端编辑物料请求调整指南

## 概述

由于后端修复了参数验证问题，**前端需要调整编辑物料的请求方式**。

## 修改要点

### ❌ 旧的请求方式（会导致错误）

```javascript
// 错误：包含冗余字段
const updateMaterial = (projectItemId, materialId, data) => {
  const payload = {
    id: materialId,
    projectItemId: projectItemId,           // ❌ 不要传递
    projectSubsystemId: data.projectSubsystemId,  // ❌ 不要传递
    projectSystemId: data.projectSystemId,        // ❌ 不要传递
    projectId: data.projectId,                    // ❌ 不要传递
    materialCode: data.materialCode,
    materialName: data.materialName,
    quantity: data.quantity,
    // ... 其他字段
  };
  
  return fetch(`/erp/saltprocess/projectEquipmentSystem/item/${projectItemId}/materials/${materialId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
};
```

### ✅ 新的请求方式（正确）

```javascript
// 正确：只传递需要修改的字段
const updateMaterial = (projectItemId, materialId, updateData) => {
  // 构建请求体：只包含需要修改的字段
  const payload = {
    // 不要包含：id, projectItemId, projectSubsystemId, projectSystemId, projectId
    materialCode: updateData.materialCode,
    materialName: updateData.materialName,
    specification: updateData.specification,
    materialType: updateData.materialType,
    materialCategory: updateData.materialCategory,
    quantity: updateData.quantity,
    unit: updateData.unit,
    unitWeight: updateData.unitWeight,
    totalWeight: updateData.totalWeight,
    manufacturer: updateData.manufacturer,
    model: updateData.model,
    serialNumber: updateData.serialNumber,
    packageType: updateData.packageType,
    packageQuantity: updateData.packageQuantity,
    isFragile: updateData.isFragile,
    isHazardous: updateData.isHazardous,
    storageRequirement: updateData.storageRequirement,
    status: updateData.status,
    sequenceNumber: updateData.sequenceNumber,
    remarks: updateData.remarks,
    remarks1: updateData.remarks1,
    remarks2: updateData.remarks2
  };
  
  // 过滤掉undefined值
  Object.keys(payload).forEach(key => 
    payload[key] === undefined && delete payload[key]
  );
  
  return fetch(
    `/erp/saltprocess/projectEquipmentSystem/item/${projectItemId}/materials/${materialId}`,
    {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }
  );
};
```

## 关键变化

| 方面 | 旧方式 | 新方式 |
|------|-------|-------|
| 请求体中的id | 包含 | 不包含（使用路径参数） |
| projectItemId | 包含在请求体 | 不包含（使用路径参数） |
| projectSubsystemId | 包含在请求体 | 不包含（后端自动填充） |
| projectSystemId | 包含在请求体 | 不包含（后端自动填充） |
| projectId | 包含在请求体 | 不包含（后端自动填充） |
| 其他字段 | 包含 | 包含（只传递需要修改的） |

## 实现建议

### 方案1：使用工具函数过滤

```javascript
// 工具函数：过滤冗余字段
const filterRedundantFields = (data) => {
  const redundantFields = [
    'id',
    'projectItemId',
    'projectSubsystemId',
    'projectSystemId',
    'projectId',
    'createTime',
    'updateTime',
    'version'
  ];
  
  const filtered = { ...data };
  redundantFields.forEach(field => delete filtered[field]);
  
  // 过滤掉undefined和null值
  Object.keys(filtered).forEach(key => 
    (filtered[key] === undefined || filtered[key] === null) && delete filtered[key]
  );
  
  return filtered;
};

// 使用
const updateMaterial = (projectItemId, materialId, data) => {
  const payload = filterRedundantFields(data);
  
  return fetch(
    `/erp/saltprocess/projectEquipmentSystem/item/${projectItemId}/materials/${materialId}`,
    {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }
  );
};
```

### 方案2：使用对象解构

```javascript
const updateMaterial = (projectItemId, materialId, data) => {
  // 使用解构排除冗余字段
  const {
    id,
    projectItemId: _,
    projectSubsystemId: __,
    projectSystemId: ___,
    projectId: ____,
    createTime,
    updateTime,
    version,
    ...payload
  } = data;
  
  return fetch(
    `/erp/saltprocess/projectEquipmentSystem/item/${projectItemId}/materials/${materialId}`,
    {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }
  );
};
```

## 测试验证

### 测试用例1：编辑物料名称

**请求**：
```bash
curl -X PUT \
  'http://localhost/dev-api/erp/saltprocess/projectEquipmentSystem/item/1993565525317234689/materials/1993885356553797634' \
  -H 'Authorization: Bearer {token}' \
  -H 'Content-Type: application/json' \
  -d '{
    "materialName": "更新的物料名称"
  }'
```

**预期结果**：✓ 200 成功

### 测试用例2：编辑多个字段

**请求**：
```bash
curl -X PUT \
  'http://localhost/dev-api/erp/saltprocess/projectEquipmentSystem/item/1993565525317234689/materials/1993885356553797634' \
  -H 'Authorization: Bearer {token}' \
  -H 'Content-Type: application/json' \
  -d '{
    "materialCode": "MAT-NEW",
    "materialName": "新物料",
    "quantity": 10,
    "status": "READY"
  }'
```

**预期结果**：✓ 200 成功

### 测试用例3：包含冗余字段（应该被忽略）

**请求**：
```bash
curl -X PUT \
  'http://localhost/dev-api/erp/saltprocess/projectEquipmentSystem/item/1993565525317234689/materials/1993885356553797634' \
  -H 'Authorization: Bearer {token}' \
  -H 'Content-Type: application/json' \
  -d '{
    "projectItemId": 1993565525317234689,
    "materialName": "新物料"
  }'
```

**预期结果**：✓ 200 成功（冗余字段被忽略）

## 常见错误

### ❌ 错误1：传递null值的冗余字段

```javascript
// 错误
const payload = {
  projectItemId: null,  // ❌ 会导致验证失败
  materialName: "新物料"
};
```

### ❌ 错误2：传递undefined值

```javascript
// 错误
const payload = {
  projectSubsystemId: undefined,  // ❌ 会导致验证失败
  materialName: "新物料"
};
```

### ✅ 正确做法

```javascript
// 正确：不传递冗余字段
const payload = {
  materialName: "新物料"
};
```

## 迁移检查清单

- [ ] 检查所有编辑物料的API调用
- [ ] 移除请求体中的冗余字段
- [ ] 确保路径参数正确传递
- [ ] 测试编辑功能
- [ ] 验证数据是否正确更新
- [ ] 检查错误处理逻辑
- [ ] 更新相关文档

## 相关文件

- API文档：`docs/api/项目设备系统物料操作接口文档.md`
- 修复说明：`docs/fix/项目物料编辑接口参数验证修复.md`
- 后端修改：`ErpSaltProjectMaterialBo.java`

