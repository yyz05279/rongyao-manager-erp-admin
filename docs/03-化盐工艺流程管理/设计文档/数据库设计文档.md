# 化盐项目工艺流程管理模块 - 数据库设计文档

## 1. 数据库设计概述

### 1.1 设计原则

- **规范化设计**: 遵循第三范式，避免数据冗余
- **性能优化**: 合理设置索引，优化查询性能
- **扩展性**: 支持未来业务扩展和数据增长
- **一致性**: 遵循海棠ERP系统数据库设计规范
- **安全性**: 敏感数据加密存储，完善的权限控制

### 1.2 命名规范

- **表名**: 使用下划线分隔的小写字母，前缀`erp_salt_`
- **字段名**: 使用下划线分隔的小写字母
- **索引名**: `idx_表名_字段名`格式
- **外键名**: `fk_表名_字段名`格式
- **主键**: 统一使用`id`作为主键，类型为`BIGINT`

### 1.3 数据类型规范

- **主键ID**: `BIGINT AUTO_INCREMENT`
- **业务编码**: `VARCHAR(50)`，具有业务含义的唯一标识
- **金额**: `DECIMAL(15,2)`，精确到分
- **百分比**: `DECIMAL(5,2)`，如99.99%
- **时间戳**: `DATETIME`，精确到秒
- **JSON数据**: `JSON`类型，存储复杂结构数据
- **枚举值**: `TINYINT`，配合枚举类使用

## 2. 核心数据表设计

### 2.1 项目基础信息表 (erp_salt_project)

```sql
CREATE TABLE erp_salt_project (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '项目ID',
    project_code VARCHAR(50) NOT NULL UNIQUE COMMENT '项目编码',
    project_name VARCHAR(100) NOT NULL COMMENT '项目名称',
    project_type TINYINT NOT NULL COMMENT '项目类型：1-二元盐,2-三元盐,3-混合盐',
    customer_id BIGINT COMMENT '客户ID',
    customer_name VARCHAR(100) COMMENT '客户名称',
    contract_number VARCHAR(50) COMMENT '合同编号',
    total_amount DECIMAL(15,2) COMMENT '合同金额',
    currency VARCHAR(10) DEFAULT 'CNY' COMMENT '货币单位',
    
    planned_start_date DATE NOT NULL COMMENT '计划开始日期',
    planned_end_date DATE COMMENT '计划结束日期',
    actual_start_date DATE COMMENT '实际开始日期',
    actual_end_date DATE COMMENT '实际结束日期',
    
    project_manager_id BIGINT COMMENT '项目经理ID',
    project_manager_name VARCHAR(50) COMMENT '项目经理姓名',
    
    status TINYINT DEFAULT 1 COMMENT '项目状态：1-规划中,2-进行中,3-暂停,4-已完成,5-已取消',
    progress DECIMAL(5,2) DEFAULT 0.00 COMMENT '项目进度(%)',
    
    description TEXT COMMENT '项目描述',
    technical_requirements JSON COMMENT '技术要求',
    quality_standards JSON COMMENT '质量标准',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人ID',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    del_flag TINYINT DEFAULT 0 COMMENT '删除标志：0-正常,1-删除',
    version INT DEFAULT 0 COMMENT '版本号',
    
    -- 索引
    INDEX idx_project_code (project_code),
    INDEX idx_customer_id (customer_id),
    INDEX idx_status (status),
    INDEX idx_project_manager_id (project_manager_id),
    INDEX idx_planned_dates (planned_start_date, planned_end_date),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='化盐项目基础信息表';
```

### 2.2 熔盐罐预热任务表 (erp_salt_preheating_task)

```sql
CREATE TABLE erp_salt_preheating_task (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '任务ID',
    task_code VARCHAR(50) NOT NULL UNIQUE COMMENT '任务编码',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    
    tank_id VARCHAR(50) NOT NULL COMMENT '熔盐罐编号',
    tank_name VARCHAR(100) COMMENT '熔盐罐名称',
    tank_capacity DECIMAL(10,2) COMMENT '罐体容量(L)',
    
    planned_start_time DATETIME NOT NULL COMMENT '计划开始时间',
    planned_end_time DATETIME NOT NULL COMMENT '计划结束时间',
    actual_start_time DATETIME COMMENT '实际开始时间',
    actual_end_time DATETIME COMMENT '实际结束时间',
    
    target_temperature DECIMAL(8,2) NOT NULL COMMENT '目标温度(°C)',
    target_pressure DECIMAL(8,2) NOT NULL COMMENT '目标压力(MPa)',
    heating_rate DECIMAL(6,2) COMMENT '升温速率(°C/min)',
    
    status TINYINT DEFAULT 1 COMMENT '任务状态：1-已创建,2-进行中,3-已完成,4-失败,5-已取消',
    progress DECIMAL(5,2) DEFAULT 0.00 COMMENT '任务进度(%)',
    
    operator_id BIGINT NOT NULL COMMENT '操作员ID',
    operator_name VARCHAR(50) NOT NULL COMMENT '操作员姓名',
    
    equipment_status TINYINT DEFAULT 1 COMMENT '设备状态：1-正常,2-故障,3-维护',
    safety_status TINYINT DEFAULT 1 COMMENT '安全状态：1-安全,2-警告,3-危险',
    
    energy_consumption DECIMAL(10,2) COMMENT '总能耗(kWh)',
    cost_estimate DECIMAL(10,2) COMMENT '成本估算',
    
    remarks TEXT COMMENT '备注',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人ID',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    del_flag TINYINT DEFAULT 0 COMMENT '删除标志：0-正常,1-删除',
    version INT DEFAULT 0 COMMENT '版本号',
    
    -- 外键约束
    CONSTRAINT fk_preheating_project FOREIGN KEY (project_id) REFERENCES erp_salt_project(id),
    
    -- 索引
    INDEX idx_task_code (task_code),
    INDEX idx_project_id (project_id),
    INDEX idx_tank_id (tank_id),
    INDEX idx_status (status),
    INDEX idx_operator_id (operator_id),
    INDEX idx_planned_time (planned_start_time, planned_end_time),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='熔盐罐预热任务表';
```

### 2.3 预热数据记录表 (erp_salt_preheating_data)

```sql
CREATE TABLE erp_salt_preheating_data (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '记录ID',
    task_id BIGINT NOT NULL COMMENT '任务ID',
    
    record_time DATETIME NOT NULL COMMENT '记录时间',
    temperature DECIMAL(8,2) NOT NULL COMMENT '当前温度(°C)',
    pressure DECIMAL(8,2) NOT NULL COMMENT '当前压力(MPa)',
    heating_power DECIMAL(8,2) COMMENT '加热功率(kW)',
    
    equipment_status TINYINT NOT NULL COMMENT '设备状态：1-运行,2-停止,3-维护,4-故障',
    alarm_status TINYINT DEFAULT 0 COMMENT '报警状态：0-正常,1-警告,2-报警',
    
    energy_consumption DECIMAL(10,2) COMMENT '累计能耗(kWh)',
    efficiency_rate DECIMAL(5,2) COMMENT '效率(%)',
    
    operator_id BIGINT NOT NULL COMMENT '操作员ID',
    operator_name VARCHAR(50) NOT NULL COMMENT '操作员姓名',
    
    data_source TINYINT DEFAULT 1 COMMENT '数据来源：1-手工录入,2-自动采集',
    data_quality TINYINT DEFAULT 1 COMMENT '数据质量：1-正常,2-异常,3-估算',
    
    remarks TEXT COMMENT '备注',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    -- 外键约束
    CONSTRAINT fk_preheating_data_task FOREIGN KEY (task_id) REFERENCES erp_salt_preheating_task(id),
    
    -- 索引
    INDEX idx_task_id (task_id),
    INDEX idx_record_time (record_time),
    INDEX idx_temperature (temperature),
    INDEX idx_equipment_status (equipment_status),
    INDEX idx_operator_id (operator_id),
    INDEX idx_data_source (data_source),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预热数据记录表';
```

### 2.4 预热巡检记录表 (erp_salt_preheating_inspection)

```sql
CREATE TABLE erp_salt_preheating_inspection (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '巡检ID',
    inspection_code VARCHAR(50) NOT NULL UNIQUE COMMENT '巡检编码',
    task_id BIGINT NOT NULL COMMENT '任务ID',
    
    inspector_id BIGINT NOT NULL COMMENT '巡检员ID',
    inspector_name VARCHAR(50) NOT NULL COMMENT '巡检员姓名',
    inspection_time DATETIME NOT NULL COMMENT '巡检时间',
    
    inspection_type TINYINT NOT NULL COMMENT '巡检类型：1-定时巡检,2-专项检查,3-故障排查',
    overall_status TINYINT NOT NULL COMMENT '总体状态：1-正常,2-警告,3-异常',
    
    check_points_total INT DEFAULT 0 COMMENT '检查点总数',
    check_points_normal INT DEFAULT 0 COMMENT '正常检查点数',
    check_points_warning INT DEFAULT 0 COMMENT '警告检查点数',
    check_points_abnormal INT DEFAULT 0 COMMENT '异常检查点数',
    
    issues_count INT DEFAULT 0 COMMENT '问题数量',
    issues_description TEXT COMMENT '问题描述',
    recommendations TEXT COMMENT '处理建议',
    
    photos JSON COMMENT '巡检照片URLs',
    attachments JSON COMMENT '附件信息',
    
    next_inspection_time DATETIME COMMENT '下次巡检时间',
    
    remarks TEXT COMMENT '巡检备注',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人ID',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    del_flag TINYINT DEFAULT 0 COMMENT '删除标志：0-正常,1-删除',
    
    -- 外键约束
    CONSTRAINT fk_preheating_inspection_task FOREIGN KEY (task_id) REFERENCES erp_salt_preheating_task(id),
    
    -- 索引
    INDEX idx_inspection_code (inspection_code),
    INDEX idx_task_id (task_id),
    INDEX idx_inspector_id (inspector_id),
    INDEX idx_inspection_time (inspection_time),
    INDEX idx_overall_status (overall_status),
    INDEX idx_inspection_type (inspection_type),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预热巡检记录表';
```

### 2.5 巡检检查点记录表 (erp_salt_inspection_checkpoint)

```sql
CREATE TABLE erp_salt_inspection_checkpoint (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '检查点ID',
    inspection_id BIGINT NOT NULL COMMENT '巡检ID',
    
    checkpoint_code VARCHAR(50) NOT NULL COMMENT '检查点编码',
    checkpoint_name VARCHAR(100) NOT NULL COMMENT '检查点名称',
    checkpoint_category VARCHAR(50) COMMENT '检查点类别',
    
    check_method TINYINT COMMENT '检查方式：1-目视,2-测量,3-听音,4-触摸',
    standard_value VARCHAR(100) COMMENT '标准值',
    actual_value VARCHAR(100) COMMENT '实际值',
    unit VARCHAR(20) COMMENT '单位',
    
    status TINYINT NOT NULL COMMENT '检查状态：1-正常,2-警告,3-异常',
    deviation_rate DECIMAL(5,2) COMMENT '偏差率(%)',
    
    issue_description TEXT COMMENT '问题描述',
    cause_analysis TEXT COMMENT '原因分析',
    solution_suggestion TEXT COMMENT '解决建议',
    
    photos JSON COMMENT '检查点照片',
    
    remarks TEXT COMMENT '备注',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    -- 外键约束
    CONSTRAINT fk_checkpoint_inspection FOREIGN KEY (inspection_id) REFERENCES erp_salt_preheating_inspection(id),
    
    -- 索引
    INDEX idx_inspection_id (inspection_id),
    INDEX idx_checkpoint_code (checkpoint_code),
    INDEX idx_status (status),
    INDEX idx_checkpoint_category (checkpoint_category),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='巡检检查点记录表';
```

### 2.6 化盐任务表 (erp_salt_making_task)

```sql
CREATE TABLE erp_salt_making_task (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '任务ID',
    task_code VARCHAR(50) NOT NULL UNIQUE COMMENT '任务编码',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    
    batch_number VARCHAR(50) NOT NULL UNIQUE COMMENT '批次号',
    process_type TINYINT NOT NULL COMMENT '工艺类型：1-二元盐,2-三元盐',
    
    planned_start_time DATETIME NOT NULL COMMENT '计划开始时间',
    planned_end_time DATETIME NOT NULL COMMENT '计划结束时间',
    actual_start_time DATETIME COMMENT '实际开始时间',
    actual_end_time DATETIME COMMENT '实际结束时间',
    
    target_quantity DECIMAL(10,2) NOT NULL COMMENT '目标产量(kg)',
    actual_quantity DECIMAL(10,2) COMMENT '实际产量(kg)',
    yield_rate DECIMAL(5,2) COMMENT '产出率(%)',
    
    target_ratio JSON NOT NULL COMMENT '目标配比',
    actual_ratio JSON COMMENT '实际配比',
    
    quality_grade TINYINT COMMENT '质量等级：1-A级,2-B级,3-C级',
    quality_score DECIMAL(5,2) COMMENT '质量评分',
    
    status TINYINT DEFAULT 1 COMMENT '任务状态：1-已创建,2-进行中,3-已完成,4-失败,5-已取消',
    progress DECIMAL(5,2) DEFAULT 0.00 COMMENT '任务进度(%)',
    
    operator_id BIGINT NOT NULL COMMENT '操作员ID',
    operator_name VARCHAR(50) NOT NULL COMMENT '操作员姓名',
    
    total_cost DECIMAL(10,2) COMMENT '总成本',
    material_cost DECIMAL(10,2) COMMENT '原料成本',
    energy_cost DECIMAL(10,2) COMMENT '能源成本',
    labor_cost DECIMAL(10,2) COMMENT '人工成本',
    
    remarks TEXT COMMENT '备注',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人ID',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    del_flag TINYINT DEFAULT 0 COMMENT '删除标志：0-正常,1-删除',
    version INT DEFAULT 0 COMMENT '版本号',
    
    -- 外键约束
    CONSTRAINT fk_making_task_project FOREIGN KEY (project_id) REFERENCES erp_salt_project(id),
    
    -- 索引
    INDEX idx_task_code (task_code),
    INDEX idx_project_id (project_id),
    INDEX idx_batch_number (batch_number),
    INDEX idx_process_type (process_type),
    INDEX idx_status (status),
    INDEX idx_operator_id (operator_id),
    INDEX idx_planned_time (planned_start_time, planned_end_time),
    INDEX idx_quality_grade (quality_grade),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='化盐任务表';
```

## 3. 数据字典表设计

### 3.1 工艺参数模板表 (erp_salt_process_template)

```sql
CREATE TABLE erp_salt_process_template (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '模板ID',
    template_code VARCHAR(50) NOT NULL UNIQUE COMMENT '模板编码',
    template_name VARCHAR(100) NOT NULL COMMENT '模板名称',
    process_type TINYINT NOT NULL COMMENT '工艺类型：1-二元盐,2-三元盐',
    
    standard_ratio JSON NOT NULL COMMENT '标准配比',
    temperature_range JSON COMMENT '温度范围',
    pressure_range JSON COMMENT '压力范围',
    time_range JSON COMMENT '时间范围',
    
    quality_standards JSON COMMENT '质量标准',
    safety_requirements JSON COMMENT '安全要求',
    
    is_active TINYINT DEFAULT 1 COMMENT '是否启用：0-禁用,1-启用',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人ID',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    del_flag TINYINT DEFAULT 0 COMMENT '删除标志：0-正常,1-删除',
    
    -- 索引
    INDEX idx_template_code (template_code),
    INDEX idx_process_type (process_type),
    INDEX idx_is_active (is_active),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工艺参数模板表';
```

### 3.2 检查点标准表 (erp_salt_checkpoint_standard)

```sql
CREATE TABLE erp_salt_checkpoint_standard (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '标准ID',
    checkpoint_code VARCHAR(50) NOT NULL UNIQUE COMMENT '检查点编码',
    checkpoint_name VARCHAR(100) NOT NULL COMMENT '检查点名称',
    checkpoint_category VARCHAR(50) NOT NULL COMMENT '检查点类别',
    
    equipment_type VARCHAR(50) COMMENT '设备类型',
    check_method TINYINT COMMENT '检查方式：1-目视,2-测量,3-听音,4-触摸',
    check_frequency VARCHAR(50) COMMENT '检查频率',
    
    standard_value VARCHAR(100) COMMENT '标准值',
    tolerance_range VARCHAR(100) COMMENT '容差范围',
    unit VARCHAR(20) COMMENT '单位',
    
    warning_threshold VARCHAR(100) COMMENT '警告阈值',
    alarm_threshold VARCHAR(100) COMMENT '报警阈值',
    
    check_procedure TEXT COMMENT '检查程序',
    safety_notes TEXT COMMENT '安全注意事项',
    
    is_active TINYINT DEFAULT 1 COMMENT '是否启用：0-禁用,1-启用',
    
    -- 审计字段
    create_by BIGINT NOT NULL COMMENT '创建人ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by BIGINT COMMENT '更新人ID',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    del_flag TINYINT DEFAULT 0 COMMENT '删除标志：0-正常,1-删除',
    
    -- 索引
    INDEX idx_checkpoint_code (checkpoint_code),
    INDEX idx_checkpoint_category (checkpoint_category),
    INDEX idx_equipment_type (equipment_type),
    INDEX idx_is_active (is_active),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='检查点标准表';
```

## 4. 性能优化设计

### 4.1 分区表设计

对于数据量大的时间序列表，采用分区策略：

```sql
-- 预热数据记录表按月分区
ALTER TABLE erp_salt_preheating_data 
PARTITION BY RANGE (YEAR(create_time) * 100 + MONTH(create_time)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    PARTITION p202503 VALUES LESS THAN (202504),
    -- ... 继续添加分区
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 4.2 复合索引设计

```sql
-- 任务查询优化索引
CREATE INDEX idx_task_project_status_time ON erp_salt_preheating_task(project_id, status, planned_start_time);

-- 数据记录查询优化索引
CREATE INDEX idx_data_task_time_temp ON erp_salt_preheating_data(task_id, record_time, temperature);

-- 巡检记录查询优化索引
CREATE INDEX idx_inspection_task_time_status ON erp_salt_preheating_inspection(task_id, inspection_time, overall_status);
```

### 4.3 视图设计

```sql
-- 项目概览视图
CREATE VIEW v_salt_project_overview AS
SELECT 
    p.id,
    p.project_code,
    p.project_name,
    p.status,
    p.progress,
    COUNT(DISTINCT pt.id) as preheating_tasks,
    COUNT(DISTINCT mt.id) as making_tasks,
    COUNT(DISTINCT CASE WHEN pt.status = 3 THEN pt.id END) as completed_preheating,
    COUNT(DISTINCT CASE WHEN mt.status = 3 THEN mt.id END) as completed_making,
    COALESCE(SUM(mt.actual_quantity), 0) as total_production,
    COALESCE(AVG(mt.quality_score), 0) as avg_quality_score
FROM erp_salt_project p
LEFT JOIN erp_salt_preheating_task pt ON p.id = pt.project_id AND pt.del_flag = 0
LEFT JOIN erp_salt_making_task mt ON p.id = mt.project_id AND mt.del_flag = 0
WHERE p.del_flag = 0
GROUP BY p.id;

-- 实时监控数据视图
CREATE VIEW v_salt_realtime_monitor AS
SELECT 
    t.id as task_id,
    t.task_code,
    t.tank_id,
    t.status as task_status,
    d.temperature,
    d.pressure,
    d.heating_power,
    d.equipment_status,
    d.record_time,
    CASE 
        WHEN d.temperature >= t.target_temperature * 0.95 THEN 1
        WHEN d.temperature >= t.target_temperature * 0.8 THEN 2
        ELSE 3
    END as temperature_status
FROM erp_salt_preheating_task t
LEFT JOIN (
    SELECT 
        task_id,
        temperature,
        pressure,
        heating_power,
        equipment_status,
        record_time,
        ROW_NUMBER() OVER (PARTITION BY task_id ORDER BY record_time DESC) as rn
    FROM erp_salt_preheating_data
    WHERE del_flag = 0
) d ON t.id = d.task_id AND d.rn = 1
WHERE t.del_flag = 0 AND t.status = 2;
```

## 5. 数据安全设计

### 5.1 敏感数据加密

```sql
-- 创建加密函数
DELIMITER //
CREATE FUNCTION encrypt_sensitive_data(data TEXT) 
RETURNS TEXT
READS SQL DATA
DETERMINISTIC
BEGIN
    RETURN AES_ENCRYPT(data, 'haitang_erp_salt_key_2025');
END //

CREATE FUNCTION decrypt_sensitive_data(encrypted_data TEXT) 
RETURNS TEXT
READS SQL DATA
DETERMINISTIC
BEGIN
    RETURN AES_DECRYPT(encrypted_data, 'haitang_erp_salt_key_2025');
END //
DELIMITER ;
```

### 5.2 数据备份策略

```sql
-- 创建备份表结构
CREATE TABLE erp_salt_data_backup (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(100) NOT NULL,
    backup_date DATE NOT NULL,
    backup_type TINYINT NOT NULL COMMENT '1-全量,2-增量',
    backup_path VARCHAR(500) NOT NULL,
    backup_size BIGINT COMMENT '备份大小(字节)',
    status TINYINT DEFAULT 1 COMMENT '1-成功,2-失败',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据备份记录表';
```

## 6. 数据初始化脚本

### 6.1 基础数据初始化

```sql
-- 插入工艺参数模板
INSERT INTO erp_salt_process_template (template_code, template_name, process_type, standard_ratio, temperature_range, pressure_range, create_by) VALUES
('TPL_BINARY_001', '标准二元盐工艺', 1, '{"NaNO3": 60, "KNO3": 40}', '{"min": 220, "max": 250}', '{"min": 0.1, "max": 0.3}', 1),
('TPL_TERNARY_001', '标准三元盐工艺', 2, '{"NaNO3": 53, "KNO3": 40, "NaNO2": 7}', '{"min": 200, "max": 240}', '{"min": 0.1, "max": 0.3}', 1);

-- 插入检查点标准
INSERT INTO erp_salt_checkpoint_standard (checkpoint_code, checkpoint_name, checkpoint_category, equipment_type, check_method, standard_value, unit, create_by) VALUES
('CHK_TEMP_001', '罐体温度检查', '温度监控', '熔盐罐', 2, '220-250', '°C', 1),
('CHK_PRESS_001', '罐体压力检查', '压力监控', '熔盐罐', 2, '0.1-0.3', 'MPa', 1),
('CHK_SEAL_001', '密封性检查', '安全检查', '熔盐罐', 1, '无泄漏', '', 1),
('CHK_VALVE_001', '阀门状态检查', '设备检查', '管路系统', 1, '开关正常', '', 1);
```

## 7. 数据库维护

### 7.1 定期维护任务

```sql
-- 创建维护任务表
CREATE TABLE erp_salt_maintenance_task (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    task_name VARCHAR(100) NOT NULL,
    task_type TINYINT NOT NULL COMMENT '1-数据清理,2-索引重建,3-统计更新',
    schedule_expression VARCHAR(100) COMMENT 'Cron表达式',
    last_execution DATETIME,
    next_execution DATETIME,
    status TINYINT DEFAULT 1 COMMENT '1-启用,2-禁用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据库维护任务表';

-- 插入维护任务
INSERT INTO erp_salt_maintenance_task (task_name, task_type, schedule_expression) VALUES
('清理过期数据记录', 1, '0 2 * * 0'),
('重建索引', 2, '0 3 * * 0'),
('更新表统计信息', 3, '0 4 * * 0');
```

### 7.2 数据归档策略

```sql
-- 创建归档表
CREATE TABLE erp_salt_preheating_data_archive (
    LIKE erp_salt_preheating_data INCLUDING ALL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预热数据归档表';

-- 归档存储过程
DELIMITER //
CREATE PROCEDURE archive_old_data(IN archive_days INT)
BEGIN
    DECLARE archive_date DATE;
    SET archive_date = DATE_SUB(CURDATE(), INTERVAL archive_days DAY);
    
    -- 归档数据
    INSERT INTO erp_salt_preheating_data_archive 
    SELECT * FROM erp_salt_preheating_data 
    WHERE DATE(create_time) < archive_date;
    
    -- 删除原数据
    DELETE FROM erp_salt_preheating_data 
    WHERE DATE(create_time) < archive_date;
    
END //
DELIMITER ;
```

---

**文档版本**: v1.0  
**创建时间**: 2025年1月9日  
**维护团队**: 海棠ERP开发团队  
**审核状态**: 待审核
