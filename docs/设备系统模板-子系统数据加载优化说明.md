# 设备系统模板 - 子系统数据加载优化说明

## 优化背景

设备系统详情接口现在已经返回子系统的完整信息，包括：
- `id`: 子系统ID
- `subsystemName`: 子系统名称
- `referenceTemplateId`: 引用的模板ID（如果是引用模式）
- 其他完整的子系统信息

因此，前端不再需要通过 `referenceTemplateId` 额外调用 `/erp/subsystem/template/{id}` 接口来获取子系统名称。

## 优化内容

### 1. SubsystemTemplateManagement.vue

**优化前**：
```typescript
// 处理子系统模版数据(为引用模式的子系统获取名称)
const processSubsystemTemplates = async (templates: any[]) => {
  const subsystemTemplatesWithNames = await Promise.all(
    templates.map(async (item: any) => {
      const mode = item.referenceTemplateId ? 'reference' : 'create';
      let referenceTemplateName = undefined;

      if (mode === 'reference' && item.referenceTemplateId) {
        try {
          // ❌ 额外的API调用
          const templateRes = await getSubsystemTemplate(item.referenceTemplateId);
          referenceTemplateName = (templateRes.data as any).templateName;
        } catch (error) {
          console.error(`获取子系统模板名称失败 (ID: ${item.referenceTemplateId}):`, error);
        }
      }

      return {
        ...item,
        mode,
        referenceTemplateName
      };
    })
  );

  subsystemList.value = subsystemTemplatesWithNames;
};
```

**优化后**：
```typescript
// 处理子系统模版数据
// 注意：后端已经返回了完整的子系统信息（包括subsystemName），不需要额外调用API获取名称
const processSubsystemTemplates = async (templates: any[]) => {
  const subsystemTemplatesWithMode = templates.map((item: any) => {
    const mode = item.referenceTemplateId ? 'reference' : 'create';
    
    return {
      ...item,
      mode,
      // ✅ 直接使用后端返回的subsystemName
      referenceTemplateName: item.subsystemName
    };
  });

  subsystemList.value = subsystemTemplatesWithMode;
};
```

**移除的导入**：
```typescript
// ❌ 移除不再使用的导入
import { getSubsystemTemplate } from '@/api/erp/subsystem/template';
```

### 2. EquipmentSystemTemplateForm.vue

**优化前**：
```typescript
// 为每个引用的子系统模板获取名称
const subsystemTemplatesWithNames = await Promise.all(
  data.subsystemTemplates.map(async (item: any) => {
    const mode = item.referenceTemplateId ? 'reference' : 'create';
    let referenceTemplateName = undefined;

    if (mode === 'reference' && item.referenceTemplateId) {
      try {
        // ❌ 额外的API调用
        const templateRes = await getSubsystemTemplate(item.referenceTemplateId);
        referenceTemplateName = (templateRes.data as any).templateName;
      } catch (error) {
        console.error(`获取子系统模板名称失败 (ID: ${item.referenceTemplateId}):`, error);
      }
    }

    return {
      ...item,
      mode,
      referenceTemplateName
    };
  })
);
```

**优化后**：
```typescript
// 处理子系统模板数据：添加mode字段用于前端显示
// 注意：后端已经返回了完整的子系统信息（包括subsystemName），不需要额外调用API获取名称
const subsystemTemplatesWithMode = data.subsystemTemplates.map((item: any) => {
  const mode = item.referenceTemplateId ? 'reference' : 'create';
  
  return {
    ...item,
    mode,
    // ✅ 直接使用后端返回的subsystemName
    referenceTemplateName: item.subsystemName
  };
});
```

**移除的导入**：
```typescript
// ❌ 移除不再使用的导入
import { getSubsystemTemplate } from '@/api/erp/subsystem/template';
```

## 保留的功能

### 查看子系统详情

当用户点击"查看"按钮时，仍然会调用详情接口获取完整信息：

```typescript
// SubsystemTemplateManagement.vue
const handleViewSubsystem = (row: SubsystemTemplateForm & { mode?: string; referenceTemplateName?: string; id?: string | number }) => {
  if (row.id) {
    viewDialog.value.mode = 'reference';
    viewDialog.value.subsystemId = row.id;  // 使用子系统自己的ID
    viewDialog.value.subsystemName = row.subsystemName || row.referenceTemplateName || `ID: ${row.id}`;
    viewDialog.value.subsystemData = null;
    viewDialog.value.visible = true;
    // ✅ 这里会调用 /erp/saltprocess/equipmentSystemTemplate/subsystemTemplate/{subsystemId}
  }
};
```

## 优化效果

### 性能提升

**优化前**：
- 加载设备系统详情：1次API调用
- 加载每个子系统名称：N次API调用（N = 子系统数量）
- **总计**：1 + N 次API调用

**优化后**：
- 加载设备系统详情：1次API调用
- **总计**：1次API调用

**示例**：
- 如果一个设备系统有10个子系统，优化前需要11次API调用，优化后只需要1次
- **性能提升**：减少了90%的API调用

### 代码简化

1. **移除异步遍历**：从 `Promise.all` + `async/await` 改为简单的 `map`
2. **移除错误处理**：不再需要处理额外API调用的错误
3. **移除导入**：减少了不必要的依赖

## 后端数据结构

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": "1988835019686019073",
    "templateName": "固态处理厂",
    "subsystemTemplates": [
      {
        "id": "1989181462980583425",
        "systemTemplateId": "1988835019686019073",
        "referenceTemplateId": "1986698980897005569",  // 引用的模板ID
        "subsystemName": "粉碎机",  // ✅ 后端已返回名称
        "subsystemType": "MECHANICAL",
        "category": "机械",
        "sequenceNumber": 2,
        "status": "DRAFT",
        "remarks": ""
      }
    ]
  }
}
```

## 总结

✅ **优化完成**：
- 移除了不必要的API调用
- 简化了代码逻辑
- 提升了页面加载性能
- 保留了查看子系统详情的功能

✅ **影响范围**：
- `SubsystemTemplateManagement.vue`
- `EquipmentSystemTemplateForm.vue`

✅ **向后兼容**：
- 如果后端返回的数据中没有 `subsystemName`，会显示为 `undefined`
- 不会影响现有功能的正常运行

