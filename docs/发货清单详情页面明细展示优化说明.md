# 发货清单详情页面明细展示优化说明

## 📋 更新概述

**更新日期**: 2025-10-30  
**更新内容**: 将发货清单详情页面的明细展示改为导入弹窗样式，将所有删改操作移至编辑页面

## 🎯 更新目标

1. **优化展示体验**: 采用导入弹窗的展示样式，提供更好的数据可读性
2. **职责分离**: 详情页面仅用于查看，编辑页面负责所有增删改操作
3. **统一风格**: 保持系统内相似功能模块的展示风格一致性

## ✨ 主要变更

### 1. 明细展示方式优化

#### 变更前

- 使用单一表格展示所有明细
- 固定列结构，包含操作列（编辑、删除按钮）
- 表头包含"添加明细"按钮

#### 变更后

- **按设备名称前缀分组展示**：一比一复刻 Excel 导入弹窗的分组效果，按物品名称前缀（如"平面输送机"、"子输送"、"粉碎机"等）分组
- **动态列生成**：根据实际数据字段自动生成表格列
- **分组标题**：每个分组显示设备名称前缀和明细数量统计
- **移除操作**：删除了所有操作按钮（添加、编辑、删除）
- **移除无关列**：移除了"设备类型"、"特殊标识"等非 Excel 导入的列

### 2. 数据分组逻辑

```typescript
// 按设备名称前缀分组（仿Excel导入弹窗效果）
const groupedShippingItems = computed(() => {
  if (!shippingItems.value || shippingItems.value.length === 0) {
    return [];
  }

  // 按设备名称前缀分组
  const groups = new Map<string, ShippingItemVO[]>();

  shippingItems.value.forEach(item => {
    // 提取设备名称的前缀（如：平面输送机-输送主体 → 平面输送机）
    const groupName = extractGroupName(item.itemName);

    if (!groups.has(groupName)) {
      groups.set(groupName, []);
    }
    groups.get(groupName)!.push(item);
  });

  // 转换为数组格式
  return Array.from(groups.entries()).map(([groupName, items]) => ({
    groupName,
    items
  }));
});

/**
 * 从物品名称中提取分组名称
 * 例如：
 * - "平面输送机-输送主体" → "平面输送机"
 * - "子输送-卸料罩壳" → "子输送"
 * - "粉碎机-粉碎机本体" → "粉碎机"
 */
const extractGroupName = (itemName: string): string => {
  if (!itemName) return '其他';

  // 按"-"分割，取第一部分作为分组名称
  const parts = itemName.split('-');
  if (parts.length > 1) {
    return parts[0].trim();
  }

  // 如果没有"-"，尝试其他分隔符
  const otherParts = itemName.split(/[_|、]/).filter(p => p.trim());
  if (otherParts.length > 1) {
    return otherParts[0].trim();
  }

  // 如果都没有分隔符，返回原名称
  return itemName.trim();
};
```

### 3. 动态表格列配置

```typescript
interface TableColumn {
  label: string;
  prop: string;
  width: number;
  align: string;
  formatter?: (value: any) => string;
}

const getDetailTableColumns = (items: ShippingItemVO[]): TableColumn[] => {
  // 定义列配置（与Excel导入弹窗保持一致）
  return [
    { label: '序号', prop: 'index', width: 80, align: 'center' },
    { label: '物品名称', prop: 'itemName', width: 200, align: 'left' },
    { label: '规格型号', prop: 'specification', width: 150, align: 'left' },
    {
      label: '数量',
      prop: 'quantity',
      width: 100,
      align: 'center',
      formatter: (value) => value || '-'
    },
    { label: '单位', prop: 'unit', width: 80, align: 'center' },
    {
      label: '单重(kg)',
      prop: 'unitWeight',
      width: 120,
      align: 'center',
      formatter: (value) => value ? Number(value).toFixed(2) : '-'
    },
    {
      label: '总重(kg)',
      prop: 'totalWeight',
      width: 120,
      align: 'center',
      formatter: (value) => value ? Number(value).toFixed(2) : '-'
    },
    { label: '制造商', prop: 'manufacturer', width: 150, align: 'left' },
    { label: '型号', prop: 'model', width: 150, align: 'left' },
    { label: '包装方式', prop: 'packageType', width: 120, align: 'center' },
    { label: '备注', prop: 'remarks', width: 180, align: 'left' }
  ];
};
```

### 4. 模板结构

```vue
<!-- 按设备类型分组展示 -->
<div
  v-for="(group, index) in groupedShippingItems"
  :key="index"
  class="equipment-detail-section"
>
  <el-divider content-position="left">
    <div class="section-title">
      <el-icon><Box /></el-icon>
      <span>{{ group.groupName }}</span>
      <el-tag size="small" type="info" class="count-tag">
        共 {{ group.items.length }} 项
      </el-tag>
    </div>
  </el-divider>

  <!-- 动态表格 -->
  <el-table
    :data="group.items"
    border
    stripe
    size="default"
    max-height="500"
    class="equipment-detail-table"
  >
    <!-- 动态生成列 -->
  </el-table>
</div>
```

### 5. 样式优化

```scss
.equipment-detail-section {
  margin-bottom: 32px;

  .el-divider {
    margin: 24px 0 20px;

    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #303133;

      .el-icon {
        font-size: 18px;
        color: #409eff;
      }

      .count-tag {
        margin-left: 8px;
        font-weight: normal;
      }
    }
  }

  .equipment-detail-table {
    border-radius: 4px;
    overflow: hidden;
  }
}
```

## 🔄 删改操作流程

### 详情页面

- **查看明细**: 按设备类型分组展示所有明细信息
- **编辑入口**: 点击页面顶部的"编辑"按钮，跳转到编辑页面

### 编辑页面

编辑页面（`/saltprocess/shipping/edit/:id`）提供完整的明细操作功能：

1. **添加明细**

   - 点击"添加明细"按钮
   - 填写明细信息
   - 保存后添加到列表

2. **编辑明细**

   - 直接在表格单元格中编辑
   - 或点击"编辑"按钮打开对话框编辑

3. **删除明细**

   - 点击明细行的"删除"按钮
   - 确认后删除

4. **Excel 批量导入**
   - 点击"Excel 导入"按钮
   - 选择 Excel 文件
   - 批量导入明细数据

## 📊 设备名称前缀分组

系统通过提取物品名称的前缀进行分组，支持多种分隔符：

### 分隔符规则

- **主要分隔符**: `-`（连字符）
- **备选分隔符**: `_`（下划线）、`|`（竖线）、`、`（顿号）

### 分组示例

| 物品名称            | 提取的分组名称 |
| ------------------- | -------------- |
| 平面输送机-输送主体 | 平面输送机     |
| 平面输送机-紧固件   | 平面输送机     |
| 子输送-卸料罩壳     | 子输送         |
| 子输送-紧固件       | 子输送         |
| 粉碎机-粉碎机本体   | 粉碎机         |
| 粉碎机-油缸及油管   | 粉碎机         |
| 除尘系统-爬梯       | 除尘系统       |
| 钢平台-主工作台     | 钢平台         |

## 🔧 技术实现

### 组件导入

```typescript
import { Box } from '@element-plus/icons-vue';
```

### 删除的组件

- `ItemEditDialog`: 移除了详情页面的明细编辑对话框

### 删除的函数

- `handleAddItem`: 添加明细
- `handleEditItem`: 编辑明细
- `handleDeleteItem`: 删除明细
- `handleItemConfirm`: 明细确认保存

### 新增的计算属性

- `groupedShippingItems`: 按设备类型分组的明细数据

### 新增的工具函数

- `getDetailTableColumns`: 获取动态表格列配置
- `formatDetailCellValue`: 格式化单元格值

## 📸 效果展示

### 变更前

```
发货明细
[添加明细按钮]

┌────────────────────────────────────────────┐
│ 序号 │ 名称 │ 规格 │ 设备类型 │ ... │ 操作 │
│──────────────────────────────────────────  │
│  1   │ xxx  │ xxx  │ 机械     │ ... │ 编辑 删除 │
│  2   │ xxx  │ xxx  │ 电控     │ ... │ 编辑 删除 │
└────────────────────────────────────────────┘
```

### 变更后（一比一复刻 Excel 导入弹窗效果）

```
发货明细

━━━━━━━━━ 📦 平面输送机 - 共 2 项 ━━━━━━━━━
┌─────────────────────────────────────────┐
│ 序号 │ 名称          │ 规格 │ 数量 │ 重量  │
│───────────────────────────────────────  │
│  1   │ 平面输送机-输送主体 │ xxx │ 2  │ -   │
│  2   │ 平面输送机-紧固件   │ xxx │ 1  │ -   │
└─────────────────────────────────────────┘

━━━━━━━━━ 📦 子输送 - 共 2 项 ━━━━━━━━━
┌─────────────────────────────────────────┐
│ 序号 │ 名称        │ 规格 │ 数量 │ 重量  │
│───────────────────────────────────────  │
│  1   │ 子输送-卸料罩壳 │ xxx │ 2  │ -   │
│  2   │ 子输送-紧固件   │ xxx │ 1  │ -   │
└─────────────────────────────────────────┘

━━━━━━━━━ 📦 粉碎机 - 共 11 项 ━━━━━━━━━
┌─────────────────────────────────────────┐
│ 序号 │ 名称          │ 规格 │ 数量 │ 重量  │
│───────────────────────────────────────  │
│  1   │ 粉碎机-粉碎机本体 │ xxx │ 2  │ -   │
│  2   │ 粉碎机-油缸及油管 │ xxx │ 8  │ -   │
│  ...  ...
└─────────────────────────────────────────┘
```

## ✅ 优势总结

1. **一比一复刻 Excel 导入弹窗**: 按设备名称前缀分组，与 Excel 导入时的预览效果完全一致
2. **更清晰的数据组织**: 按实际设备名称分组（如"平面输送机"、"粉碎机"），更符合业务逻辑
3. **更好的可读性**:
   - 移除了操作按钮的干扰，专注于数据展示
   - 移除了"设备类型"等非 Excel 导入的列，保持数据纯净
4. **职责明确**: 详情页只读，编辑页可写，符合用户体验最佳实践
5. **统一的展示风格**: 与导入弹窗保持一致，提升系统整体一致性
6. **智能分组**: 自动识别多种分隔符（`-`, `_`, `|`, `、`），灵活提取设备名称前缀

## 🔍 相关文件

### 修改的文件

- `src/views/erp/saltprocess/shipping/detail.vue`: 详情页面
  - 模板部分：修改明细展示结构
  - 脚本部分：添加分组逻辑和动态列配置
  - 样式部分：添加分组展示样式

### 相关文件（未修改）

- `src/views/erp/saltprocess/shipping/form.vue`: 编辑页面（已有完整功能）
- `src/views/erp/saltprocess/shipping/index.vue`: 列表页面
- `src/views/erp/saltprocess/shipping/components/ItemEditDialog.vue`: 明细编辑对话框（仅在编辑页面使用）

## 📝 测试建议

### 功能测试

1. **查看详情页**

   - ✅ 明细按设备类型正确分组
   - ✅ 每个分组显示正确的数量
   - ✅ 表格列正确显示
   - ✅ 数据格式化正确（重量、数量等）
   - ✅ 特殊标识（易碎、危险）正确显示

2. **编辑功能测试**

   - ✅ 点击"编辑"按钮跳转到编辑页面
   - ✅ 编辑页面可以添加明细
   - ✅ 编辑页面可以修改明细
   - ✅ 编辑页面可以删除明细
   - ✅ 保存后返回详情页查看更新

3. **边界情况**
   - ✅ 无明细时显示空状态
   - ✅ 单一设备类型正常显示
   - ✅ 多个设备类型正确分组

### 样式测试

1. ✅ 分组标题样式正确
2. ✅ 表格样式正确
3. ✅ 响应式布局正常
4. ✅ 打印样式正常

## 🚀 后续优化建议

1. **合并单元格支持**: 如果同一设备下有相同的字段值，可以考虑合并显示
2. **自定义分组**: 允许用户选择按其他字段分组（如制造商、包装方式等）
3. **分组排序**: 支持分组的排序（按名称、数量等）
4. **导出优化**: 导出时保持分组结构

---

## 📞 联系方式

如有问题或建议，请联系开发团队。
