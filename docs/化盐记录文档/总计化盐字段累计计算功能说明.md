# äºŒå…ƒåŒ–ç›è®°å½•ç®¡ç† - åŠŸèƒ½è°ƒæ•´è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå¯¹äºŒå…ƒåŒ–ç›è®°å½•ç®¡ç†é¡µé¢è¿›è¡Œä»¥ä¸‹è°ƒæ•´ï¼š

1. **æ€»è®¡åŒ–ç›å­—æ®µ**ï¼šç§»é™¤å‰ç«¯ç´¯è®¡è®¡ç®—é€»è¾‘ï¼Œæ”¹ä¸ºä½¿ç”¨åå°è¿”å›çš„ç´¯ç§¯å€¼
2. **é…æ¯”é¢œè‰²æ˜¾ç¤º**ï¼šè°ƒæ•´ç¡é…¸é’ ï¼šç¡é…¸é’¾é…æ¯”çš„é¢œè‰²é€»è¾‘

## 1. æ€»è®¡åŒ–ç›å­—æ®µè°ƒæ•´

### è®¡ç®—å…¬å¼ï¼ˆåå°å®ç°ï¼‰

```
æ€»è®¡åŒ–ç›(t) = ç¡é…¸é’¾é‡é‡(kg) + ç¡é…¸é’ é‡é‡(kg) + ä¹‹å‰æ‰€æœ‰åŒ–ç›è®°å½•çš„ç´¯è®¡å€¼(kg)
```

**æ³¨æ„**: æœ€ç»ˆæ˜¾ç¤ºæ—¶ä¼šå°†kgè½¬æ¢ä¸ºå¨(t)ï¼Œä¿ç•™2ä½å°æ•°ã€‚

### å‰ç«¯å®ç°å˜æ›´

- **ç§»é™¤å‰ç«¯ç´¯è®¡è®¡ç®—é€»è¾‘**
- **ä½¿ç”¨åå°è¿”å›çš„`totalSaltWeight`å­—æ®µ**
- **ä¿ç•™å…¼å®¹æ€§å¤„ç†**ï¼šå¦‚æœåå°æœªè¿”å›ç´¯ç§¯å€¼ï¼Œåˆ™æ˜¾ç¤ºå½“å‰è®°å½•çš„é‡é‡

## 2. é…æ¯”é¢œè‰²æ˜¾ç¤ºè°ƒæ•´

### é¢œè‰²è§„åˆ™

- **ç»¿è‰²**ï¼šæ»¡è¶³6:4é…æ¯”ï¼ˆåå·®â‰¤2%ï¼‰
- **çº¢è‰²**ï¼šä¸æ»¡è¶³6:4é…æ¯”ï¼ˆåå·®>2%ï¼‰

### å®ç°é€»è¾‘

```typescript
const getRatioClass = (row: any) => {
  const nano3Weight = row.nano3ActualWeight || 0;
  const kno3Weight = row.kno3ActualWeight || 0;

  if (!nano3Weight && !kno3Weight) return '';

  const total = nano3Weight + kno3Weight;
  if (total === 0) return '';

  const nano3Ratio = nano3Weight / total;
  const targetRatio = 0.6; // ç›®æ ‡6:4é…æ¯”ä¸­çš„6
  const deviation = Math.abs(nano3Ratio - targetRatio);

  // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼šæ»¡è¶³6:4é…æ¯”ä½¿ç”¨ç»¿è‰²ï¼Œä¸æ»¡è¶³ä½¿ç”¨çº¢è‰²
  if (deviation <= 0.02) return 'text-success'; // åå·®åœ¨2%ä»¥å†…è®¤ä¸ºæ»¡è¶³6:4é…æ¯”ï¼Œä½¿ç”¨ç»¿è‰²
  return 'text-danger'; // ä¸æ»¡è¶³6:4é…æ¯”ï¼Œä½¿ç”¨çº¢è‰²
};
```

## ä¿®æ”¹å†…å®¹

### 1. åˆ—è¡¨é¡µé¢ä¿®æ”¹ (`src/views/erp/saltprocess/records/binary/index.vue`)

#### 1.1 ç§»é™¤å‰ç«¯ç´¯è®¡è®¡ç®—é€»è¾‘
```typescript
// ç§»é™¤å‰ç«¯ç´¯è®¡è®¡ç®—é€»è¾‘ï¼Œæ”¹ä¸ºä½¿ç”¨åå°è¿”å›çš„totalSaltWeightå­—æ®µ
```

#### 1.2 è¡¨æ ¼åˆ—æ¨¡æ¿è°ƒæ•´
```vue
<el-table-column label="æ€»è®¡åŒ–ç›(t)" width="110">
  <template #default="scope">
    {{ formatWeight(scope.row.totalSaltWeight || (scope.row.nano3ActualWeight + scope.row.kno3ActualWeight)) }}
  </template>
</el-table-column>
```

#### 1.3 é…æ¯”é¢œè‰²é€»è¾‘è°ƒæ•´
```typescript
const getRatioClass = (row: any) => {
  // ... è®¡ç®—é€»è¾‘
  // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼šæ»¡è¶³6:4é…æ¯”ä½¿ç”¨ç»¿è‰²ï¼Œä¸æ»¡è¶³ä½¿ç”¨çº¢è‰²
  if (deviation <= 0.02) return 'text-success'; // ç»¿è‰²
  return 'text-danger'; // çº¢è‰²
};
```

### 2. è¯¦æƒ…é¡µé¢ä¿®æ”¹ (`src/views/erp/saltprocess/records/binary/detail.vue`)

#### 2.1 æ•°æ®ç±»å‹è°ƒæ•´
```typescript
interface RecordData {
  recordCode: string;
  projectId: number;
  recordDate: string;
  shift: number;
  nano3ActualWeight: number;
  kno3ActualWeight: number;
  moltenSaltLevel?: number;
  moltenSaltTemperature?: number;
  gasConsumption?: number;
  powerConsumption?: number;
  staffCount?: number;
  recorderName?: string;
  remarks?: string;
  totalSaltWeight?: number; // æ€»è®¡åŒ–ç›é‡ï¼ˆåå°è®¡ç®—çš„ç´¯ç§¯å€¼ï¼‰
}
```

#### 2.2 ç§»é™¤å‰ç«¯è®¡ç®—é€»è¾‘
```typescript
// ç§»é™¤å‰ç«¯ç´¯è®¡è®¡ç®—é€»è¾‘ï¼Œæ”¹ä¸ºä½¿ç”¨åå°è¿”å›çš„totalSaltWeightå­—æ®µ
```

#### 2.3 æ˜¾ç¤ºæ¨¡æ¿è°ƒæ•´
```vue
<el-descriptions-item label="æ€»è®¡åŒ–ç›(t)">
  <div class="total-weight-display">
    {{ formatWeight(recordData.totalSaltWeight || (recordData.nano3ActualWeight + recordData.kno3ActualWeight)) }}å¨
  </div>
</el-descriptions-item>
```

#### 2.4 é…æ¯”é¢œè‰²é€»è¾‘è°ƒæ•´
```typescript
const getRatioClass = (record: RecordData): string => {
  // ... è®¡ç®—é€»è¾‘
  // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼šæ»¡è¶³6:4é…æ¯”ä½¿ç”¨ç»¿è‰²ï¼Œä¸æ»¡è¶³ä½¿ç”¨çº¢è‰²
  if (deviation <= 0.02) return 'ratio-normal';      // ç»¿è‰²
  return 'ratio-danger';                              // çº¢è‰²
};
```

### 3. APIç±»å‹å®šä¹‰è°ƒæ•´ (`src/api/erp/saltprocess/records/binary/types.ts`)

#### 3.1 æ·»åŠ totalSaltWeightå­—æ®µ
```typescript
export interface BinaryRecordVO {
  // ... å…¶ä»–å­—æ®µ
  ratioDeviation: number; // é…æ¯”åå·®(%)
  totalWeight: number; // æ€»é‡é‡(kg)
  totalSaltWeight?: number; // æ€»è®¡åŒ–ç›é‡(kg) - åŒ…å«ç´¯ç§¯å€¼ï¼Œç”±åå°è®¡ç®—
  // ... å…¶ä»–å­—æ®µ
}
```

## åå°APIè¦æ±‚

### 1. ç´¯ç§¯è®¡ç®—é€»è¾‘

åå°éœ€è¦åœ¨è¿”å›è®°å½•åˆ—è¡¨æ—¶ï¼Œè®¡ç®—æ¯æ¡è®°å½•çš„ç´¯ç§¯åŒ–ç›é‡ï¼š

```sql
-- ç¤ºä¾‹SQLé€»è¾‘ï¼ˆå…·ä½“å®ç°æ ¹æ®æ•°æ®åº“è€Œå®šï¼‰
SELECT
  *,
  (nano3_actual_weight + kno3_actual_weight +
   COALESCE((
     SELECT SUM(nano3_actual_weight + kno3_actual_weight)
     FROM binary_records b2
     WHERE b2.record_date < b1.record_date
        OR (b2.record_date = b1.record_date AND b2.start_time < b1.start_time)
   ), 0)
  ) as total_salt_weight
FROM binary_records b1
ORDER BY record_date, start_time;
```

### 2. æ•°æ®æ’åº

åå°è¿”å›æ•°æ®æ—¶åº”æŒ‰ç…§æ—¶é—´é¡ºåºæ’åˆ—ï¼Œç¡®ä¿ç´¯ç§¯è®¡ç®—çš„å‡†ç¡®æ€§ï¼š

1. **ä¸»è¦æ’åºå­—æ®µ**: `record_date` (è®°å½•æ—¥æœŸ)
2. **æ¬¡è¦æ’åºå­—æ®µ**: `start_time` (å¼€å§‹æ—¶é—´)
3. **æ’åºæ–¹å‘**: `ASC` (å‡åº)

## ç¤ºä¾‹æ•°æ®æ¼”ç¤º

å‡è®¾æœ‰ä»¥ä¸‹3æ¡è®°å½•ï¼ˆæŒ‰æ—¶é—´é¡ºåºï¼‰ï¼š

| åºå· | æ—¥æœŸ | ç­æ¬¡ | ç¡é…¸é’ (kg) | ç¡é…¸é’¾(kg) | å½“å‰é‡é‡(kg) | ç´¯è®¡é‡é‡(kg) | æ€»è®¡åŒ–ç›(t) | é…æ¯” | é…æ¯”é¢œè‰² |
|------|------|------|------------|------------|--------------|--------------|-------------|------|----------|
| 1 | 2024-12-01 | ç™½ç­ | 3600 | 2400 | 6000 | 0 | 6.00 | 6.0:4.0 | ğŸŸ¢ ç»¿è‰² |
| 2 | 2024-12-01 | å¤œç­ | 3580 | 2420 | 6000 | 6000 | 12.00 | 6.0:4.0 | ğŸŸ¢ ç»¿è‰² |
| 3 | 2024-12-02 | ç™½ç­ | 3500 | 2500 | 6000 | 12000 | 18.00 | 5.8:4.2 | ğŸ”´ çº¢è‰² |

### è®¡ç®—è¿‡ç¨‹è¯´æ˜ï¼š

**ç¬¬1æ¡è®°å½•**:
- å½“å‰é‡é‡ = 3600 + 2400 = 6000kg
- ä¹‹å‰ç´¯è®¡ = 0kg (ç¬¬ä¸€æ¡è®°å½•)
- æ€»è®¡åŒ–ç› = 6000kg = 6.00t
- é…æ¯” = 3600:(3600+2400) = 60% â‰ˆ 6:4 â†’ ç»¿è‰²

**ç¬¬2æ¡è®°å½•**:
- å½“å‰é‡é‡ = 3580 + 2420 = 6000kg
- ä¹‹å‰ç´¯è®¡ = 6000kg (ç¬¬1æ¡è®°å½•çš„é‡é‡)
- æ€»è®¡åŒ–ç› = 6000 + 6000 = 12000kg = 12.00t
- é…æ¯” = 3580:(3580+2420) = 59.7% â‰ˆ 6:4 â†’ ç»¿è‰²

**ç¬¬3æ¡è®°å½•**:
- å½“å‰é‡é‡ = 3500 + 2500 = 6000kg
- ä¹‹å‰ç´¯è®¡ = 6000 + 6000 = 12000kg (ç¬¬1ã€2æ¡è®°å½•çš„é‡é‡)
- æ€»è®¡åŒ–ç› = 6000 + 12000 = 18000kg = 18.00t
- é…æ¯” = 3500:(3500+2500) = 58.3% â‰  6:4 â†’ çº¢è‰²

## æ³¨æ„äº‹é¡¹

1. **åå°è®¡ç®—**: ç´¯ç§¯åŒ–ç›é‡ç”±åå°è®¡ç®—å¹¶è¿”å›ï¼Œç¡®ä¿è·¨é¡µé¢æ•°æ®çš„å‡†ç¡®æ€§
2. **æ•°æ®æ’åº**: åå°è¿”å›æ•°æ®æ—¶åº”æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼Œç¡®ä¿ç´¯è®¡è®¡ç®—çš„é€»è¾‘æ­£ç¡®
3. **å…¼å®¹æ€§å¤„ç†**: å‰ç«¯ä¿ç•™å…¼å®¹æ€§å¤„ç†ï¼Œå¦‚æœåå°æœªè¿”å›ç´¯ç§¯å€¼ï¼Œåˆ™æ˜¾ç¤ºå½“å‰è®°å½•é‡é‡
4. **é…æ¯”é¢œè‰²**: ç®€åŒ–ä¸ºç»¿è‰²ï¼ˆæ»¡è¶³6:4ï¼‰å’Œçº¢è‰²ï¼ˆä¸æ»¡è¶³6:4ï¼‰ä¸¤ç§çŠ¶æ€

## é—®é¢˜ä¿®å¤è®°å½•

### é—®é¢˜1ï¼šé…æ¯”æ˜¾ç¤ºNaN:NaN
**åŸå› **: formatRatioå‡½æ•°æ²¡æœ‰æ­£ç¡®å¤„ç†undefinedã€nullæˆ–NaNå€¼
**è§£å†³æ–¹æ¡ˆ**: æ·»åŠ ç±»å‹å®‰å…¨è½¬æ¢ `Number(value) || 0`

### é—®é¢˜2ï¼š6:4é…æ¯”æ˜¾ç¤ºçº¢è‰²
**åŸå› **: é…æ¯”è®¡ç®—é€»è¾‘é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**: ä¿®æ­£ç™¾åˆ†æ¯”åˆ°æ¯”ä¾‹çš„è½¬æ¢è®¡ç®—

## åç»­ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜æœºåˆ¶**: å¯¹äºç´¯è®¡è®¡ç®—ç»“æœå¯ä»¥è€ƒè™‘ç¼“å­˜ï¼Œå‡å°‘é‡å¤è®¡ç®—
2. **å®æ—¶æ›´æ–°**: å½“æœ‰æ–°è®°å½•æ·»åŠ æˆ–ä¿®æ”¹æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°ç›¸å…³è®°å½•çš„ç´¯è®¡å€¼
3. **æ•°æ®æ ¡éªŒ**: æ·»åŠ æ•°æ®æ ¡éªŒæœºåˆ¶ï¼Œç¡®ä¿ç´¯è®¡è®¡ç®—çš„å‡†ç¡®æ€§
4. **æ€§èƒ½ä¼˜åŒ–**: å¯¹äºå¤§é‡æ•°æ®ï¼Œè€ƒè™‘åˆ†é¡µæ—¶çš„ç´¯è®¡å€¼è®¡ç®—ç­–ç•¥

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. è®¿é—®äºŒå…ƒåŒ–ç›è®°å½•ç®¡ç†é¡µé¢ `/saltprocess/records/binary`
2. æ£€æŸ¥"æ€»è®¡åŒ–ç›(t)"åˆ—çš„æ˜¾ç¤ºå€¼ï¼ˆåº”æ˜¾ç¤ºåå°è®¡ç®—çš„ç´¯ç§¯å€¼ï¼‰
3. éªŒè¯ç¡é…¸é’ ï¼šç¡é…¸é’¾é…æ¯”çš„é¢œè‰²æ˜¾ç¤º
4. æµ‹è¯•åˆ†é¡µã€ç­›é€‰ç­‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸
5. æŸ¥çœ‹è¯¦æƒ…é¡µé¢çš„æ€»è®¡åŒ–ç›æ˜¾ç¤º

### é¢„æœŸç»“æœ
- **æ€»è®¡åŒ–ç›**: æ˜¾ç¤ºåå°è®¡ç®—çš„ç´¯ç§¯å€¼ï¼Œå¦‚æœåå°æœªè¿”å›åˆ™æ˜¾ç¤ºå½“å‰è®°å½•é‡é‡
- **é…æ¯”é¢œè‰²**: æ»¡è¶³6:4é…æ¯”æ˜¾ç¤ºç»¿è‰²ï¼Œä¸æ»¡è¶³æ˜¾ç¤ºçº¢è‰²
- **æ•°å€¼æ ¼å¼**: æ˜¾ç¤ºä¸ºå¨(t)å•ä½ï¼Œä¿ç•™2ä½å°æ•°
- **åŠŸèƒ½å®Œæ•´**: æ’åºã€ç­›é€‰ã€åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ

### åå°APIè¦æ±‚
- è¿”å›æ•°æ®ä¸­åŒ…å« `totalSaltWeight` å­—æ®µï¼ˆç´¯ç§¯åŒ–ç›é‡ï¼‰
- æ•°æ®æŒ‰ç…§ `record_date, start_time` å‡åºæ’åˆ—
- ç´¯ç§¯è®¡ç®—åŒ…å«è¯¥è®°å½•ä¹‹å‰çš„æ‰€æœ‰è®°å½•é‡é‡æ€»å’Œ
