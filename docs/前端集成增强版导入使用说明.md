# 前端集成增强版导入使用说明

## 一、概述

本文档说明如何在前端项目中使用新开发的图片批量上传API和增强版发货清单导入功能。

## 二、新增API接口

### 2.1 图片批量上传API

**文件位置**: `src/api/erp/common/upload/index.ts`

```typescript
import { uploadImages } from '@/api/erp/common/upload';

// 使用示例
const files = [file1, file2, file3]; // 最多9张
const bizType = 'shipping-photos'; // 或 'driver-license'

const response = await uploadImages(files, bizType);
const successUrls = response.data
  .filter(item => item.success)
  .map(item => item.fileUrl);
```

**支持的业务类型（BizType）**：
- `shipping-photos`: 发货照片
- `driver-license`: 司机驾照
- `other`: 其他业务类型

### 2.2 增强版发货清单导入API

**文件位置**: `src/api/erp/saltprocess/shipping/index.ts`

```typescript
import { importEnhancedShippingList } from '@/api/erp/saltprocess/shipping';
import type { EnhancedShippingImportRequest } from '@/api/erp/saltprocess/shipping';

// 构建请求数据
const importData: EnhancedShippingImportRequest = {
  // 基本信息
  projectId: '1001',
  batchNumber: '第一车',
  responsiblePersonId: 10001,
  shippingDate: '2025-10-29',
  
  // 车辆和司机信息（增强版字段）
  vehiclePlate: '苏NHA923',
  vehicleDescription: '17.5米车',
  driverName: '李猛',
  driverPhone: '18036946111',
  
  // 图片URL列表（已上传到服务器）
  shippingPhotoUrls: ['/shipping-photos/2025-10-29/xxx.jpg'],
  driverLicensePhotoUrls: ['/driver-license/2025-10-29/yyy.jpg'],
  
  // 设备明细
  shippingItems: [
    {
      sequenceNo: 1,
      equipmentName: '化盐系统固态处理厂设备',
      subItemName: '第一车',
      quantity: 1,
      unit: '套',
      weight: 13.5,
      equipmentType: 'MECHANICAL'
    }
  ]
};

// 调用API
const response = await importEnhancedShippingList(importData);
if (response.data.success) {
  console.log('导入成功，清单编号:', response.data.listCode);
}
```

## 三、增强版导入对话框

**组件位置**: `src/views/erp/saltprocess/shipping/components/EnhancedShippingImportDialog.vue`

### 3.1 功能特点

1. **Excel解析**：
   - 自动解析"设备发货时间"sheet
   - 支持多个车次明细sheet（第一车、第二车等）
   - 智能处理合并单元格

2. **数据提取**：
   - 自动解析车牌号（如：苏NHA923）
   - 自动解析司机姓名和电话
   - 日期格式转换（Excel → yyyy-MM-dd）

3. **图片上传**：
   - 支持批量上传发货照片（最多9张）
   - 支持上传司机驾照（1张）
   - 实时预览和管理

4. **数据验证**：
   - 必填项检查（项目、负责人、批次号）
   - 数据格式验证
   - 智能错误提示

### 3.2 使用方法

```vue
<template>
  <EnhancedShippingImportDialog
    v-model:visible="importDialogVisible"
    @success="handleImportSuccess"
  />
</template>

<script setup>
import { ref } from 'vue';
import EnhancedShippingImportDialog from './components/EnhancedShippingImportDialog.vue';

const importDialogVisible = ref(false);

const handleImportSuccess = (result) => {
  console.log('导入成功:', result);
  // 刷新列表等操作
};
</script>
```

## 四、完整导入流程

增强版导入对话框内部实现了完整的导入流程：

```
1. 上传Excel文件
   ↓
2. 解析Excel数据
   - 设备发货时间
   - 车次明细
   - 车辆和司机信息
   ↓
3. 配置导入信息
   - 选择项目
   - 选择负责人
   - 填写批次号
   ↓
4. 上传图片
   - 发货照片（可选，最多9张）
   - 司机驾照（可选，1张）
   ↓
5. 确认导入
   - 图片上传到服务器
   - 数据格式转换
   - 调用API保存
   ↓
6. 导入完成
   - 显示成功消息
   - 返回清单编号
```

## 五、数据格式说明

### 5.1 Excel格式要求

#### Sheet 1: 设备发货时间

| 列名 | 说明 | 示例 |
|------|------|------|
| 序号 | 序号 | 1 |
| 名称 | 设备名称 | 化盐系统固态处理厂设备 |
| 明细 | 明细说明 | 第一车 |
| 发货时间 | 发货日期 | 2025-02-13 |
| 车辆信息 | 车牌号 + 描述 | 苏NHA923 17.5米车 |
| 司机姓名及电话 | 姓名 + 手机 | 李猛 18036946111 |

#### Sheet 2+: 车次明细（如"第一车"）

| 列名 | 说明 | 示例 |
|------|------|------|
| 序号 | 序号 | 1 |
| 名称 | 设备名称 | 平面输送机 |
| 分项 | 子项名称 | 输送主体 |
| 数量 | 数量 | 2 |
| 单位 | 单位 | 套 |
| 重量 | 重量（吨） | 1.5 |
| 备注 | 备注信息 | 需防雨 |

### 5.2 数据解析规则

1. **车辆信息解析**：
   - 正则表达式提取车牌号
   - 剩余部分作为车辆描述

2. **司机信息解析**：
   - 正则表达式提取手机号（1开头的11位数字）
   - 剩余部分作为司机姓名

3. **日期格式转换**：
   - Excel数字日期 → yyyy-MM-dd
   - 支持多种日期字符串格式

4. **合并单元格处理**：
   - 自动填充合并区域的所有单元格
   - 可视化展示合并效果

## 六、类型定义

### 6.1 增强版发货清单表单

```typescript
interface EnhancedShippingListForm {
  // 基本信息
  projectId: string;
  batchNumber: string;
  responsiblePersonId: string;
  shippingDate: string;
  shippingMethod?: string;
  
  // 兼容旧版字段
  vehicleInfo?: string;
  driverInfo?: string;
  
  // 增强版字段
  vehiclePlate?: string;              // 车牌号
  vehicleDescription?: string;        // 车辆描述
  driverName?: string;                // 司机姓名
  driverPhone?: string;               // 司机电话
  shippingPhotoUrls?: string[];       // 发货照片URL列表
  driverLicensePhotoUrls?: string[];  // 司机驾照照片URL列表
  
  // 设备明细
  items: ShippingItemForm[];
}
```

### 6.2 增强版设备明细

```typescript
interface EnhancedShippingItemForm {
  sequenceNo?: number | string;      // 序号
  equipmentName: string;              // 设备名称
  subItemName?: string;               // 子项名称
  quantity: number | string;          // 数量
  unit: string;                       // 单位
  weight?: number | string;           // 重量（吨）
  specification?: string;             // 规格
  equipmentType?: string;             // 设备类型
  remarks1?: string;                  // 备注1
  remarks?: string;                   // 备注2
}
```

## 七、配置说明

### 7.1 环境变量

```bash
# .env.development
VITE_APP_BASE_API=http://localhost:8080
VITE_USE_MOCK=true  # 使用Mock数据（开发环境）
```

### 7.2 Mock数据开关

在开发环境中，默认使用Mock数据。Mock实现位于：
- `src/api/erp/saltprocess/shipping/mock-service.ts`
- `src/api/erp/common/upload/` (需要添加Mock实现)

## 八、注意事项

1. **图片上传限制**：
   - 发货照片：最多9张
   - 司机驾照：1张
   - 单个文件最大10MB
   - 支持格式：jpg、png、gif、bmp、webp

2. **数据验证**：
   - 项目、负责人、批次号为必填项
   - 发货日期自动从Excel提取
   - 设备类型自动推断

3. **错误处理**：
   - 图片上传失败不影响其他图片
   - 部分数据解析失败会显示警告
   - 导入失败会显示详细错误信息

4. **性能优化**：
   - 图片上传使用批量接口
   - 大文件自动压缩（TODO）
   - 断点续传支持（TODO）

## 九、常见问题

### Q1: 图片上传失败怎么办？

A: 
1. 检查文件大小是否超过10MB
2. 检查文件格式是否支持
3. 查看浏览器控制台错误信息
4. 检查网络连接

### Q2: Excel解析不正确？

A: 
1. 确认Sheet名称正确（"设备发货时间"、"第一车"等）
2. 检查列名是否与模板一致
3. 查看合并单元格是否正确
4. 检查日期格式

### Q3: 车牌号和司机电话没有解析出来？

A: 
1. 确认车辆信息格式：`苏NHA923 17.5米车`
2. 确认司机信息格式：`李猛 18036946111`
3. 电话号码必须是1开头的11位数字

### Q4: 如何切换到真实API？

A: 修改`.env.development`：
```bash
VITE_USE_MOCK=false
```

## 十、技术支持

如有问题，请联系开发团队或查看：
- [发货清单增强版接口使用文档.md](./发货清单增强版接口使用文档.md)
- [Excel数据解析优化说明.md](./Excel数据解析优化说明.md)
- [Excel合并单元格处理方案.md](./Excel合并单元格处理方案.md)

