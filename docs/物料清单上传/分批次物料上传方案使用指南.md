# 分批次物料上传方案使用指南

## 一、方案概述

### 1.1 业务场景

在实际项目中，物料清单数据量往往很大（如 227 条），需要分多次上传。为了准确统计整个批次的物料信息，我们引入了**预上传批次管理方案**。

### 1.2 核心流程（三步法）

```
步骤1：获取预上传ID
   ↓
   调用创建批次接口 → 获取批次ID（预上传ID）

步骤2：分批上传物料（携带预上传ID）
   ↓
   第1次上传 → 传入预上传ID
   第2次上传 → 传入预上传ID
   第N次上传 → 传入预上传ID

步骤3：获取统计数据（使用预上传ID）
   ↓
   调用统计接口 → 查询完整统计数据
```

### 1.3 核心概念

- **预上传 ID（批次 ID）**：标识一个完整上传任务的唯一 ID，用于关联多次分批上传
- **上传批次（Upload Batch）**：一个逻辑上完整的上传任务，包含多次实际上传操作
- **跨批次统计**：通过预上传 ID 汇总所有相关上传的统计数据

### 1.4 方案优势

✅ **准确统计**：跨批次汇总，准确统计物料种类、新增/匹配数量  
✅ **灵活分批**：支持任意次数的分批上传  
✅ **实时追踪**：每次上传后实时更新批次统计  
✅ **状态管理**：完整的批次生命周期管理

---

## 二、完整业务流程

### 2.1 核心三步流程

#### ⭐ 步骤 1：获取预上传 ID

**接口**：`POST /erp/material/upload-batch`

**作用**：创建一个上传批次，获取预上传 ID（批次 ID）

```bash
# 请求
POST /erp/material/upload-batch
{
    "batchName": "淮安项目物料上传-批次1",
    "projectId": "1001",
    "projectName": "淮安项目",
    "responsiblePerson": "张三"
}

# 响应
{
    "code": 200,
    "data": 1234567890  ← 这就是预上传ID
}
```

---

#### ⭐ 步骤 2：分批上传物料（携带预上传 ID）

**接口**：`POST /erp/material/import/data`

**作用**：上传物料清单，传入预上传 ID 进行关联

**第 1 次上传**：

```bash
POST /erp/material/import/data
{
    "uploadBatchId": 1234567890,  ← 传入预上传ID
    "projectId": "1001",
    "materialItems": [...50条数据]
}

# 响应（单次统计）
{
    "uniqueMaterialCount": 47,
    "newProductRecords": 47,
    "matchedProductRecords": 0
}
```

**第 2 次上传**：

```bash
POST /erp/material/import/data
{
    "uploadBatchId": 1234567890,  ← 继续传入同一个预上传ID
    "projectId": "1001",
    "materialItems": [...50条数据]
}

# 响应（单次统计）
{
    "uniqueMaterialCount": 50,
    "newProductRecords": 3,
    "matchedProductRecords": 47
}
```

**第 N 次上传**：重复步骤 2，每次都传入同一个预上传 ID

---

#### ⭐ 步骤 3：获取统计数据（使用预上传 ID）

**接口**：`GET /erp/material/upload-batch/{预上传ID}/statistics`

**作用**：查询整个批次的汇总统计数据

```bash
# 请求
GET /erp/material/upload-batch/1234567890/statistics

# 响应（完整统计）
{
    "totalUploadedRecords": 227,    ← 总共上传227条
    "uniqueMaterialCount": 50,       ← 去重后50种物料
    "newMaterialRecords": 50,        ← 新建50种
    "matchedMaterialRecords": 50,    ← 匹配50种
    "totalWeight": 15432.5,
    "totalVolume": 123.45
}
```

---

### 2.2 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                     分批次上传完整流程                        │
└─────────────────────────────────────────────────────────────┘

步骤1：获取预上传ID
    ↓
    POST /erp/material/upload-batch
    ↓
获取预上传ID：1234567890 ✓
    ↓
步骤2：分批上传物料（传入预上传ID）
    ↓
第1次上传：POST /erp/material/import/data
    { "uploadBatchId": 1234567890, ... }
    返回：47种物料
    ↓
第2次上传：POST /erp/material/import/data
    { "uploadBatchId": 1234567890, ... }
    返回：新增3种，匹配47种
    ↓
第N次上传...
    ↓
步骤3：获取统计数据（使用预上传ID）
    ↓
    GET /erp/material/upload-batch/1234567890/statistics
    ↓
返回完整统计：227条记录，50种物料 ✓
    ↓
（可选）完成批次
    PUT /erp/material/upload-batch/1234567890/complete
```

---

## 三、API 接口详解

### 3.1 【步骤 1】获取预上传 ID

**接口地址**：`POST /erp/material/upload-batch`

**功能说明**：创建一个上传批次，返回预上传 ID（批次 ID），用于后续所有分批上传的关联。

**请求参数**：

```json
{
    "batchName": "淮安项目物料上传-批次1",
    "projectId": "1001",
    "projectName": "淮安项目",
    "responsiblePerson": "张三",
    "remarks": "第一批次物料上传，预计上传5次，共227条数据"
}
```

**字段说明**：

| 字段名            | 类型   | 必填 | 说明                     |
| ----------------- | ------ | ---- | ------------------------ |
| batchName         | String | 是   | 批次名称                 |
| projectId         | String | 是   | 项目 ID                  |
| projectName       | String | 否   | 项目名称                 |
| responsiblePerson | String | 否   | 负责人                   |
| remarks           | String | 否   | 备注（如预计上传次数等） |

**返回示例**：

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": 1234567890 // ⭐ 预上传ID（批次ID）- 请保存此ID
}
```

**重要提示**：

- ⭐ **必须先调用此接口获取预上传 ID**
- 📝 请保存返回的预上传 ID，后续所有上传都需要使用
- 🔗 同一批次的所有上传必须使用同一个预上传 ID

---

### 3.2 【步骤 2】上传物料清单（携带预上传 ID）

**接口地址**：`POST /erp/material/import/data`

**功能说明**：上传物料清单数据，必须传入预上传 ID 进行关联，支持多次上传。

**请求参数**：

```json
{
    "uploadBatchId": 1234567890, // ⭐ 必传：步骤1获取的预上传ID
    "projectId": "1001",
    "batchNumber": "第一车",
    "responsiblePerson": "张三",
    "materialItems": [
        {
            "materialName": "电动机",
            "specification": "380V 5.5KW",
            "quantity": 2,
            "unit": "台"
        }
        // ... 更多物料
    ]
}
```

**关键字段说明**：

| 字段名        | 类型   | 必填  | 说明                              |
| ------------- | ------ | ----- | --------------------------------- |
| uploadBatchId | Long   | ⭐ 是 | 预上传 ID（步骤 1 返回的批次 ID） |
| projectId     | String | 是    | 项目 ID                           |
| materialItems | Array  | 是    | 物料明细列表                      |

**返回示例**（单次上传统计）：

```json
{
    "code": 200,
    "msg": "物料清单导入成功",
    "data": {
        "success": true,
        "totalRecords": 50,           // 本次上传50条记录
        "successRecords": 50,
        "failedRecords": 0,
        "uniqueMaterialCount": 47,    // 本次上传47种不同物料
        "newProductRecords": 47,      // 本次新建47种物料
        "matchedProductRecords": 0    // 本次匹配0种物料
    }
}
```

**返回字段说明**：

| 字段名                | 说明                         | 统计范围 |
| --------------------- | ---------------------------- | -------- |
| totalRecords          | 本次上传的总记录数           | 单次     |
| uniqueMaterialCount   | 本次上传中不同的物料种类数   | 单次     |
| newProductRecords     | 本次上传中新建的物料数       | 单次     |
| matchedProductRecords | 本次上传中匹配到已有的物料数 | 单次     |

**重要提示**：

- ⭐ **必须传入 uploadBatchId**（步骤 1 获取的预上传 ID）
- 🔁 支持多次调用，每次都使用同一个预上传 ID
- 📊 返回的是**单次上传**的统计，要查看完整统计请使用步骤 3

---

### 3.3 【步骤 3】获取统计数据（使用预上传 ID）

**接口地址**：`GET /erp/material/upload-batch/{预上传ID}/statistics`

**功能说明**：使用预上传 ID 查询整个批次的完整统计数据（跨批次汇总）。

**请求参数**：

| 参数名    | 位置 | 类型 | 必填  | 说明                              |
| --------- | ---- | ---- | ----- | --------------------------------- |
| 预上传 ID | 路径 | Long | ⭐ 是 | 步骤 1 返回的预上传 ID（批次 ID） |

**请求示例**：

```bash
GET /erp/material/upload-batch/1234567890/statistics
```

**返回示例**（完整批次统计）：

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "shippingListId": 1234567890,
        "listCode": "BATCH-1730620800000",
        "projectId": "1001",
        "projectName": "淮安项目",
        "batchNumber": "BATCH-1730620800000",
        "totalUploadedRecords": 227,    // ⭐ 所有批次总计227条记录
        "uniqueMaterialCount": 50,       // ⭐ 所有批次去重后50种物料
        "newMaterialRecords": 50,        // ⭐ 新建50种物料
        "matchedMaterialRecords": 50,    // ⭐ 匹配50种物料
        "materialTypeStats": [
            {
                "materialType": "GENERAL",
                "typeName": "通用物料",
                "count": 200,
                "percentage": 88.11
            }
        ],
        "fileSourceStats": [
            {
                "fileName": "淮安项目物料汇总表.xlsx",
                "sheetName": "Sheet1",
                "recordCount": 150
            }
        ],
        "totalWeight": 15432.5,
        "totalVolume": 123.45
    }
}
```

**返回字段说明**：

| 字段名                 | 说明               | 统计范围    |
| ---------------------- | ------------------ | ----------- |
| totalUploadedRecords   | 总共上传的记录数   | ⭐ 完整批次 |
| uniqueMaterialCount    | 去重后的物料种类数 | ⭐ 完整批次 |
| newMaterialRecords     | 新建的物料数       | ⭐ 完整批次 |
| matchedMaterialRecords | 匹配到已有的物料数 | ⭐ 完整批次 |
| totalWeight            | 总重量             | ⭐ 完整批次 |
| totalVolume            | 总体积             | ⭐ 完整批次 |

**重要提示**：

- ⭐ **使用步骤 1 获取的预上传 ID**作为路径参数
- 📊 返回的是**完整批次**的统计（跨所有上传的汇总）
- 🔍 与步骤 2 返回的单次统计不同，这里是所有上传的累计结果

---

### 3.4 查询批次详情

**接口地址**：`GET /erp/material/upload-batch/{batchId}`

**返回示例**：

```json
{
    "code": 200,
    "msg": "操作成功",
    "data": {
        "id": 1234567890,
        "batchCode": "BATCH-1730620800000",
        "batchName": "淮安项目物料上传-批次1",
        "projectId": "1001",
        "projectName": "淮安项目",
        "batchStatus": "UPLOADING",
        "batchStatusName": "上传中",
        "totalUploads": 3, // 已上传3次
        "totalRecords": 150, // 总计150条记录
        "successRecords": 150,
        "failedRecords": 0,
        "uniqueMaterialCount": 50,
        "newMaterialCount": 50,
        "matchedMaterialCount": 50,
        "shippingListIds": [1001, 1002, 1003],
        "responsiblePerson": "张三",
        "startTime": "2025-11-03 10:00:00",
        "endTime": null,
        "duration": null,
        "remarks": "第一批次物料上传"
    }
}
```

---

### 3.5 完成批次上传

**接口地址**：`PUT /erp/material/upload-batch/{batchId}/complete`

**说明**：标记批次上传已完成，记录结束时间

**返回示例**：

```json
{
    "code": 200,
    "msg": "操作成功"
}
```

---

### 3.6 取消批次上传

**接口地址**：`PUT /erp/material/upload-batch/{batchId}/cancel`

**说明**：取消批次上传

**返回示例**：

```json
{
    "code": 200,
    "msg": "操作成功"
}
```

---

## 四、完整使用示例

### 4.1 场景：淮安项目物料上传（227 条数据，分 5 次上传）

#### ⭐ 步骤 1：获取预上传 ID

**目标**：创建上传批次，获取预上传 ID

```bash
curl -X POST "http://localhost:8080/erp/material/upload-batch" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "batchName": "淮安项目物料上传-20251103",
    "projectId": "1001",
    "projectName": "淮安项目",
    "responsiblePerson": "张三",
    "remarks": "第一批次物料上传，预计上传5次，共227条数据"
  }'
```

**响应**：

```json
{
    "code": 200,
    "data": 1234567890 // ⭐ 预上传ID - 请保存此ID
}
```

**✅ 完成**：获得预上传 ID = `1234567890`

---

#### ⭐ 步骤 2：分批上传物料（携带预上传 ID）

**目标**：分多次上传物料清单，每次都传入预上传 ID

##### 第 1 次上传（50 条，47 种物料）

```bash
curl -X POST "http://localhost:8080/erp/material/import/data" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "uploadBatchId": 1234567890,  ⭐ 传入预上传ID
    "projectId": "1001",
    "batchNumber": "第一车",
    "materialItems": [...]  // 50条数据
  }'
```

**响应（单次统计）**：

```json
{
    "code": 200,
    "data": {
        "uniqueMaterialCount": 47,      // 本次47种
        "newProductRecords": 47,        // 本次新建47种
        "matchedProductRecords": 0      // 本次匹配0种
    }
}
```

**✅ 第 1 次上传完成**：新建 47 种物料

---

##### 第 2 次上传（50 条，47 种已有+3 种新）

```bash
curl -X POST "http://localhost:8080/erp/material/import/data" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "uploadBatchId": 1234567890,  ⭐ 继续传入同一个预上传ID
    "projectId": "1001",
    "batchNumber": "第二车",
    "materialItems": [...]  // 50条数据
  }'
```

**响应（单次统计）**：

```json
{
    "code": 200,
    "data": {
        "uniqueMaterialCount": 50,      // 本次50种
        "newProductRecords": 3,         // 本次新建3种
        "matchedProductRecords": 47     // 本次匹配47种
    }
}
```

**✅ 第 2 次上传完成**：新建 3 种，累计 50 种物料

---

##### 第 3-5 次上传（127 条）

每次上传都传入相同的 `uploadBatchId: 1234567890`，系统会自动关联和更新批次统计。

**✅ 所有上传完成**：共上传 5 次，227 条记录

---

#### ⭐ 步骤 3：获取统计数据（使用预上传 ID）

**目标**：查询完整批次的汇总统计

```bash
curl -X GET "http://localhost:8080/erp/material/upload-batch/1234567890/statistics" \
  -H "Authorization: Bearer {token}"
```

**响应（完整统计）**：

```json
{
    "code": 200,
    "data": {
        "totalUploadedRecords": 227,    // ⭐ 所有批次总计227条
        "uniqueMaterialCount": 50,       // ⭐ 去重后50种物料
        "newMaterialRecords": 50,        // ⭐ 新建50种
        "matchedMaterialRecords": 50,    // ⭐ 匹配50种
        "totalWeight": 15432.5,
        "totalVolume": 123.45
    }
}
```

**✅ 获取完整统计成功**：227 条记录，50 种物料

---

#### （可选）完成批次上传

```bash
curl -X PUT "http://localhost:8080/erp/material/upload-batch/1234567890/complete" \
  -H "Authorization: Bearer {token}"
```

**响应**：

```json
{
    "code": 200,
    "msg": "操作成功"
}
```

---

## 五、前端集成示例

### 5.1 Vue3 + TypeScript 完整示例（三步法）

```typescript
import { ref, computed } from "vue";
import {
    createUploadBatch,
    uploadMaterialList,
    getBatchStatistics,
    completeBatch,
} from "@/api/material";

// 批次上传组件
export default {
    setup() {
        const preUploadId = ref<number | null>(null);  // ⭐ 预上传ID
        const uploadCount = ref(0);
        const totalFiles = ref(0);
        const uploading = ref(false);

        // ⭐ 步骤1：获取预上传ID
        const createBatch = async () => {
            try {
                const res = await createUploadBatch({
                    batchName:
                        "淮安项目物料上传-" + new Date().toLocaleDateString(),
                    projectId: "1001",
                    projectName: "淮安项目",
                    responsiblePerson: "张三",
                });

                preUploadId.value = res.data;  // ⭐ 保存预上传ID
                console.log("✅ 步骤1完成 - 预上传ID:", preUploadId.value);
                return preUploadId.value;
            } catch (error) {
                console.error("❌ 获取预上传ID失败:", error);
                throw error;
            }
        };

        // ⭐ 步骤2：上传物料（携带预上传ID）
        const uploadFile = async (file: File) => {
            if (!preUploadId.value) {
                throw new Error("请先获取预上传ID（步骤1）");
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("projectId", "1001");
            formData.append("uploadBatchId", String(preUploadId.value));  // ⭐ 传入预上传ID

            const res = await uploadMaterialList(formData);
            uploadCount.value++;

            console.log(`✅ 第${uploadCount.value}次上传完成（单次统计）:`, {
                uniqueMaterialCount: res.data.uniqueMaterialCount,
                newProductRecords: res.data.newProductRecords,
                matchedProductRecords: res.data.matchedProductRecords,
            });

            return res.data;
        };

        // ⭐ 批量上传多个文件（完整三步法）
        const uploadMultipleFiles = async (files: File[]) => {
            uploading.value = true;
            totalFiles.value = files.length;
            uploadCount.value = 0;

            try {
                // ⭐ 步骤1：获取预上传ID
                await createBatch();
                console.log("✅ 步骤1完成 - 已获取预上传ID");

                // ⭐ 步骤2：分批上传物料（携带预上传ID）
                for (const file of files) {
                    await uploadFile(file);
                }
                console.log("✅ 步骤2完成 - 已完成所有批次上传");

                // ⭐ 步骤3：获取统计数据（使用预上传ID）
                const statistics = await getBatchStatistics(preUploadId.value!);
                console.log("✅ 步骤3完成 - 完整批次统计:", {
                    totalUploadedRecords: statistics.data.totalUploadedRecords,
                    uniqueMaterialCount: statistics.data.uniqueMaterialCount,
                    newMaterialRecords: statistics.data.newMaterialRecords,
                });

                // （可选）完成批次
                await completeBatch(preUploadId.value!);
                console.log("✅ 批次上传全部完成");

                return statistics.data;
            } catch (error) {
                console.error("❌ 批量上传失败:", error);
                throw error;
            } finally {
                uploading.value = false;
            }
        };

        // 上传进度
        const uploadProgress = computed(() => {
            if (totalFiles.value === 0) return 0;
            return Math.round((uploadCount.value / totalFiles.value) * 100);
        });

        return {
            preUploadId,      // ⭐ 预上传ID
            uploadCount,
            totalFiles,
            uploading,
            uploadProgress,
            createBatch,      // ⭐ 步骤1
            uploadFile,       // ⭐ 步骤2
            uploadMultipleFiles,  // ⭐ 完整三步法
        };
    },
};
```

### 5.2 使用示例

```vue
<template>
    <div class="upload-batch-container">
        <h3>分批次上传物料清单</h3>

        <!-- 上传区域 -->
        <el-upload
            ref="uploadRef"
            :auto-upload="false"
            :on-change="handleFileChange"
            multiple
            accept=".xlsx,.xls"
        >
            <el-button type="primary">选择Excel文件</el-button>
        </el-upload>

        <!-- 上传按钮 -->
        <el-button
            type="success"
            :loading="uploading"
            :disabled="files.length === 0"
            @click="startUpload"
        >
            开始批量上传
        </el-button>

        <!-- 上传进度 -->
        <div v-if="uploading" class="upload-progress">
            <el-progress
                :percentage="uploadProgress"
                :format="formatProgress"
            />
            <p>已上传：{{ uploadCount }} / {{ totalFiles }} 个文件</p>
        </div>

        <!-- 批次统计 -->
        <div v-if="batchStatistics" class="batch-statistics">
            <h4>批次统计信息</h4>
            <el-descriptions :column="2" border>
                <el-descriptions-item label="批次ID">
                    {{ batchStatistics.shippingListId }}
                </el-descriptions-item>
                <el-descriptions-item label="批次编号">
                    {{ batchStatistics.listCode }}
                </el-descriptions-item>
                <el-descriptions-item label="总上传记录">
                    {{ batchStatistics.totalUploadedRecords }}
                </el-descriptions-item>
                <el-descriptions-item label="物料种类">
                    {{ batchStatistics.uniqueMaterialCount }}
                </el-descriptions-item>
                <el-descriptions-item label="新建物料">
                    {{ batchStatistics.newMaterialRecords }}
                </el-descriptions-item>
                <el-descriptions-item label="匹配物料">
                    {{ batchStatistics.matchedMaterialRecords }}
                </el-descriptions-item>
            </el-descriptions>
        </div>
    </div>
</template>

<script setup lang="ts">
import { ref } from "vue";
import { ElMessage } from "element-plus";

const files = ref<File[]>([]);
const batchStatistics = ref(null);

const handleFileChange = (file: any) => {
    files.value.push(file.raw);
};

const startUpload = async () => {
    try {
        const statistics = await uploadMultipleFiles(files.value);
        batchStatistics.value = statistics;

        ElMessage.success(
            `批量上传完成！共${statistics.totalUploadedRecords}条记录，${statistics.uniqueMaterialCount}种物料`
        );
    } catch (error) {
        ElMessage.error("批量上传失败");
    }
};

const formatProgress = (percentage: number) => {
    return `${percentage}%`;
};
</script>
```

---

## 六、数据库表结构

### 6.1 erp_material_upload_batch 表

```sql
CREATE TABLE `erp_material_upload_batch` (
    `id` BIGINT(20) NOT NULL COMMENT '主键ID',
    `batch_code` VARCHAR(100) NOT NULL COMMENT '批次编码（唯一）',
    `batch_name` VARCHAR(200) NOT NULL COMMENT '批次名称',
    `project_id` VARCHAR(50) NOT NULL COMMENT '项目ID',
    `project_name` VARCHAR(200) DEFAULT NULL COMMENT '项目名称',
    `batch_status` VARCHAR(20) DEFAULT 'PREPARING' COMMENT '批次状态',
    `total_uploads` INT(11) DEFAULT 0 COMMENT '总上传次数',
    `total_records` INT(11) DEFAULT 0 COMMENT '总记录数',
    `success_records` INT(11) DEFAULT 0 COMMENT '成功记录数',
    `failed_records` INT(11) DEFAULT 0 COMMENT '失败记录数',
    `unique_material_count` INT(11) DEFAULT 0 COMMENT '不同的物料种类数量',
    `new_material_count` INT(11) DEFAULT 0 COMMENT '新建物料数量',
    `matched_material_count` INT(11) DEFAULT 0 COMMENT '匹配物料数量',
    `shipping_list_ids` TEXT DEFAULT NULL COMMENT '关联的发货清单ID列表',
    `responsible_person` VARCHAR(100) DEFAULT NULL COMMENT '负责人',
    `start_time` DATETIME DEFAULT NULL COMMENT '开始时间',
    `end_time` DATETIME DEFAULT NULL COMMENT '结束时间',
    `remarks` VARCHAR(1000) DEFAULT NULL COMMENT '备注',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_batch_code` (`batch_code`),
    KEY `idx_project_id` (`project_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='物料上传批次表';
```

---

## 七、注意事项

### 7.1 ⭐ 三步法核心要点

**步骤 1：获取预上传 ID**

- ✅ 必须首先调用创建批次接口获取预上传 ID
- 📝 保存预上传 ID，后续步骤都需要使用
- 🔒 一个完整的上传任务使用同一个预上传 ID

**步骤 2：分批上传物料**

- ✅ 每次上传都必须传入预上传 ID（uploadBatchId 字段）
- 🔁 可以多次调用，每次都使用同一个预上传 ID
- 📊 返回的是单次上传统计

**步骤 3：获取统计数据**

- ✅ 使用预上传 ID 查询完整批次统计
- 📈 返回的是跨所有上传的汇总数据
- ⏱️ 可随时调用，实时查看当前累计统计

### 7.2 预上传 ID 的使用规范

✅ **正确使用**：

- 分批次上传时必须使用预上传 ID
- 同一批次的所有上传使用同一个预上传 ID
- 先获取预上传 ID，再开始上传
- 上传完成后使用预上传 ID 获取统计

❌ **错误使用**：

- ❌ 未获取预上传 ID 就开始上传
- ❌ 不同项目混用同一个预上传 ID
- ❌ 每次上传使用不同的预上传 ID
- ❌ 忘记在上传时传入预上传 ID

### 7.3 统计数据的区别

**步骤 2 返回（单次统计）**：

| 特点     | 说明                   |
| -------- | ---------------------- |
| 统计范围 | 仅当前这一次上传       |
| 适用场景 | 查看本次上传情况       |
| 返回时机 | 每次调用上传接口时返回 |

**步骤 3 返回（完整统计）**：

| 特点     | 说明                   |
| -------- | ---------------------- |
| 统计范围 | 整个批次所有上传的汇总 |
| 适用场景 | 查看完整批次数据       |
| 返回时机 | 调用统计接口时返回     |

### 7.4 批次状态流转

```
⭐ 步骤1：PREPARING (准备中)
    ↓ 获取预上传ID成功

⭐ 步骤2：UPLOADING (上传中)
    ↓ 第1次上传
    ↓ 第2次上传
    ↓ 第N次上传

⭐ 步骤3：查询统计
    ↓ 确认上传完成

COMPLETED (已完成)
```

---

## 八、常见问题

### Q1：为什么要先获取预上传 ID？

**答**：预上传 ID 是关联所有分批上传的唯一标识。

- ⭐ 步骤 1 获取预上传 ID，作为整个批次的标识
- 🔗 步骤 2 所有上传都通过这个 ID 关联起来
- 📊 步骤 3 通过这个 ID 查询完整统计

**如果不获取预上传 ID**：

- ❌ 无法关联多次上传
- ❌ 无法查询完整批次统计
- ❌ 每次上传都是独立的，无法汇总

### Q2：上传时必须传入预上传 ID 吗？

**答**：看场景而定。

✅ **需要传入预上传 ID 的场景**：

- 分批次上传（推荐使用三步法）
- 需要查询完整批次统计
- 需要追踪上传进度

❌ **可以不传的场景**：

- 单次完整上传
- 不需要批次统计

### Q3：如果忘记预上传 ID 怎么办？

**答**：可以通过批次列表接口查询：

```bash
GET /erp/material/upload-batch/list?projectId=1001
```

返回所有批次列表，找到对应的批次 ID。

### Q4：什么时候调用步骤 3 获取统计？

**答**：可以随时调用，建议场景：

- ✅ 每次上传后，查看当前累计统计
- ✅ 所有上传完成后，获取最终统计
- ✅ 需要向用户展示进度时

**实时性**：每次上传成功后，批次统计会自动更新。

### Q5：单次统计和完整统计有什么区别？

**答**：

| 对比项   | 步骤 2 返回（单次统计） | 步骤 3 返回（完整统计）           |
| -------- | ----------------------- | --------------------------------- |
| 统计范围 | 本次上传                | 整个批次所有上传                  |
| 获取方式 | 上传接口自动返回        | 调用统计接口                      |
| 适用场景 | 查看本次上传情况        | 查看完整批次数据                  |
| 示例     | 本次上传 47 种物料      | 累计上传 50 种物料（跨 5 次上传） |

### Q6：可以修改批次信息吗？

**答**：批次创建后：

- ✅ 可以修改：批次名称、负责人、备注等
- ❌ 不能修改：统计数据（系统自动计算）
- ❌ 不能修改：预上传 ID（唯一标识）

### Q7：上传失败了怎么办？

**答**：

1. **继续使用同一个预上传 ID 重新上传**

   - 系统会自动关联
   - 统计数据会正确累加

2. **如果需要重新开始**
   - 调用取消批次接口
   - 重新走三步法流程

---

## 九、总结

### 9.1 核心三步法回顾

```
⭐ 步骤1：获取预上传ID
   POST /erp/material/upload-batch
   → 获取批次ID（预上传ID）

⭐ 步骤2：分批上传物料（携带预上传ID）
   POST /erp/material/import/data
   { "uploadBatchId": 预上传ID, ... }
   → 多次调用，每次传入同一个预上传ID

⭐ 步骤3：获取统计数据（使用预上传ID）
   GET /erp/material/upload-batch/{预上传ID}/statistics
   → 查询完整批次汇总统计
```

### 9.2 方案特点

1. **简单明了**：三步法流程清晰，易于理解和实现
2. **灵活高效**：支持任意次数的分批上传
3. **统计准确**：实时查询数据库，跨批次汇总准确
4. **状态可追溯**：完整记录每个批次的上传历史
5. **易于集成**：API 设计简洁，前端集成方便

### 9.3 适用场景

✅ **大批量数据分批上传**

- 数据量大，需要分多次上传
- 例如：227 条数据分 5 次上传

✅ **需要跨批次统计**

- 需要查看所有上传的汇总数据
- 例如：累计上传了多少种物料

✅ **需要追踪上传进度**

- 需要实时查看上传进度
- 例如：已上传 3/5 批次

✅ **需要管理上传历史**

- 需要记录和管理上传批次
- 例如：查询历史上传记录

### 9.4 快速上手

```typescript
// 1️⃣ 获取预上传ID
const { data: preUploadId } = await createUploadBatch({ ... });

// 2️⃣ 分批上传（携带预上传ID）
await uploadMaterialList({ uploadBatchId: preUploadId, ... });
await uploadMaterialList({ uploadBatchId: preUploadId, ... });

// 3️⃣ 获取统计数据
const { data: statistics } = await getBatchStatistics(preUploadId);
console.log('总计:', statistics.totalUploadedRecords, '条');
console.log('物料:', statistics.uniqueMaterialCount, '种');
```

---

**文档版本**：v2.0.0（三步法版本）  
**更新日期**：2025-11-03  
**维护团队**：海棠开发团队

**重要提示**：

- ⭐ 分批上传必须使用三步法
- 📝 保存好预上传 ID，贯穿整个流程
- 🔄 步骤 2 可多次调用，步骤 3 随时可查
