# 图片访问路径配置说明

## 概述

本文档说明海棠 ERP 系统中图片上传和访问的路径配置规则。

## 后端返回的图片路径格式

后端文件上传接口返回的`fileUrl`格式为：

```
/shipping-photos/2025-10-30/1761791383184_0aa6aaff.jpg
/driver-license/2025-10-30/1761791383100_6e61a2ae.jpg
```

**注意：路径以`/`开头，但不包含`/upload`前缀。**

## 前端访问图片的配置

### 开发环境 (使用代理)

前端开发环境通常配置了 API 代理，例如：

```javascript
// vite.config.ts 或 vue.config.js
proxy: {
  '/dev-api': {
    target: 'http://localhost:8080',
    changeOrigin: true,
    rewrite: (path) => path.replace(/^\/dev-api/, '')
  }
}
```

**图片访问方式：**

```vue
<template>
    <!-- 方式1: 直接在模板中拼接 -->
    <el-image :src="`/dev-api/upload${item.fileUrl}`" />

    <!-- 方式2: 使用计算属性 -->
    <el-image :src="getImageUrl(item.fileUrl)" />
</template>

<script setup>
const getImageUrl = (url) => {
    if (!url) return "";
    return `/dev-api/upload${url}`;
};
</script>
```

**完整 URL 示例：**

```
前端请求: /dev-api/upload/shipping-photos/2025-10-30/xxx.jpg
代理转发: http://localhost:8080/upload/shipping-photos/2025-10-30/xxx.jpg
```

### 生产环境 (不使用代理)

生产环境下，前端和后端部署在同一域名或使用 Nginx 转发。

**图片访问方式：**

```vue
<template>
    <!-- 方式1: 直接拼接 -->
    <el-image :src="`/upload${item.fileUrl}`" />

    <!-- 方式2: 使用环境变量 -->
    <el-image :src="getImageUrl(item.fileUrl)" />
</template>

<script setup>
const getImageUrl = (url) => {
    if (!url) return "";
    const baseUrl = import.meta.env.VITE_UPLOAD_BASE_URL || "/upload";
    return `${baseUrl}${url}`;
};
</script>
```

**完整 URL 示例：**

```
访问地址: /upload/shipping-photos/2025-10-30/xxx.jpg
```

### 统一的图片 URL 工具函数 (推荐)

创建一个统一的工具函数来处理图片 URL：

```typescript
// utils/image.ts
/**
 * 获取图片完整访问URL
 * @param url 后端返回的图片相对路径
 * @returns 完整的图片访问URL
 */
export function getImageUrl(url: string): string {
    if (!url) return "";

    // 如果已经是完整URL，直接返回
    if (url.startsWith("http://") || url.startsWith("https://")) {
        return url;
    }

    // 开发环境使用代理
    if (import.meta.env.DEV) {
        return `/dev-api/upload${url}`;
    }

    // 生产环境
    return `/upload${url}`;
}

/**
 * 批量获取图片URL列表
 * @param urls 后端返回的图片路径列表
 * @returns 完整的图片访问URL列表
 */
export function getImageUrls(urls: string[]): string[] {
    if (!urls || urls.length === 0) return [];
    return urls.map((url) => getImageUrl(url));
}
```

**使用示例：**

```vue
<template>
    <div class="image-preview">
        <el-image
            v-for="(url, index) in imageUrls"
            :key="index"
            :src="url"
            :preview-src-list="imageUrls"
        />
    </div>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { getImageUrls } from "@/utils/image";

interface Props {
    shippingPhotoUrls?: string[];
}

const props = defineProps<Props>();

// 转换图片URL
const imageUrls = computed(() => {
    return getImageUrls(props.shippingPhotoUrls || []);
});
</script>
```

## 后端静态资源映射配置

后端已配置静态资源映射：

```java
// ResourcesConfig.java
@Override
public void addResourceHandlers(ResourceHandlerRegistry registry) {
    registry.addResourceHandler("/upload/**")
            .addResourceLocations("file:" + uploadPath + File.separator)
            .setCachePeriod(3600);
}
```

**说明：**

-   请求路径：`/upload/**`
-   文件系统路径：`file:/项目根目录/upload/`
-   缓存时间：3600 秒（1 小时）

## 安全配置

后端已配置允许公开访问上传的图片：

```yaml
# application.yml
security:
    excludes:
        - /upload/** # 允许公开访问上传文件
```

## 常见问题

### Q1: 图片返回 404 错误

**可能原因：**

1. 文件不存在
2. 路径拼接错误（出现重复的`/upload/upload/`）
3. 静态资源映射未生效

**解决方案：**

1. 检查文件是否真实存在：`ls -la /项目根目录/upload/...`
2. 检查 URL 拼接是否正确，确保只有一个`/upload`
3. 检查应用日志中是否有"静态资源映射配置完成"的日志

### Q2: 开发环境图片加载正常，生产环境 404

**可能原因：**

1. 生产环境未正确处理图片 URL 前缀
2. Nginx 配置问题

**解决方案：**

1. 确保使用统一的`getImageUrl`工具函数
2. 检查生产环境的 Nginx 配置：

```nginx
location /upload/ {
    proxy_pass http://backend:8080/upload/;
}
```

### Q3: 图片路径中出现两个 upload

**错误示例：**

```
/dev-api/upload/upload/shipping-photos/...
```

**原因：**
后端返回的 URL 已包含`/upload`前缀，前端又添加了一次。

**解决方案：**
后端现已修改为不包含`/upload`前缀，前端统一添加前缀。

## 技术架构说明

```
┌─────────────────────────────────────────────────────┐
│              前端 (Vue3 + Element Plus)              │
├─────────────────────────────────────────────────────┤
│  开发环境                    │  生产环境              │
│  /dev-api/upload/xxx.jpg    │  /upload/xxx.jpg      │
└────────────┬────────────────┴──────────┬────────────┘
             │                           │
        Vite Dev Proxy              Nginx转发
             │                           │
             ▼                           ▼
┌─────────────────────────────────────────────────────┐
│          Spring Boot 后端 (端口8080)                 │
├─────────────────────────────────────────────────────┤
│  静态资源映射: /upload/** → file:./upload/          │
└─────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────┐
│        文件系统: /项目根目录/upload/                  │
│        ├── shipping-photos/                         │
│        │   └── 2025-10-30/                          │
│        │       └── xxx.jpg                          │
│        └── driver-license/                          │
│            └── 2025-10-30/                          │
│                └── xxx.jpg                          │
└─────────────────────────────────────────────────────┘
```

## 总结

1. **后端返回**: `/shipping-photos/2025-10-30/xxx.jpg` (不含`/upload`前缀)
2. **前端开发环境**: `/dev-api/upload` + 后端返回的路径
3. **前端生产环境**: `/upload` + 后端返回的路径
4. **推荐使用**: 统一的`getImageUrl`工具函数处理所有图片 URL

---

**更新时间**: 2025-10-30  
**维护人员**: 海棠开发团队
