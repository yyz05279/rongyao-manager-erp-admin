# å­ç³»ç»Ÿç‰©æ–™ç¼–è¾‘æ¥å£ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨å­ç³»ç»Ÿæ¨¡æ¿è¯¦æƒ…é¡µé¢ä¸­ç¼–è¾‘ç‰©æ–™æ—¶ï¼Œéœ€è¦ç¡®ä¿ `templateId` å§‹ç»ˆè®¾ç½®ä¸ºå½“å‰å­ç³»ç»Ÿæ¨¡æ¿çš„ IDï¼Œä»¥ä¿è¯æ•°æ®éš”ç¦»åŸåˆ™ã€‚

## ğŸ¯ ä¿®å¤ç›®æ ‡

æ ¹æ®ã€Šå­ç³»ç»Ÿç‰©æ–™æŸ¥è¯¢ API å¯¹æ¥æ–‡æ¡£ã€‹çš„è¦æ±‚ï¼Œç¡®ä¿ï¼š

- âœ… åœ¨å­ç³»ç»Ÿæ¨¡æ¿è¯¦æƒ…é¡µé¢ä¿®æ”¹ç‰©æ–™æ—¶ï¼Œåªå½±å“è¯¥å­ç³»ç»Ÿçš„ç‰©æ–™ï¼ˆ`template_id` = å­ç³»ç»Ÿæ¨¡æ¿ IDï¼‰
- âœ… ä¸ä¼šæ„å¤–ä¿®æ”¹æ¨¡æ¿ç‰©æ–™ï¼ˆ`template_id` = NULLï¼‰æˆ–å…¶ä»–å­ç³»ç»Ÿçš„ç‰©æ–™
- âœ… æ•°æ®éš”ç¦»åŸåˆ™å¾—åˆ°ä¸¥æ ¼éµå®ˆ

## ğŸ”§ ä¿®å¤å†…å®¹

### æ–‡ä»¶ï¼š`src/views/erp/subsystem/template/components/ItemTemplateManagement.vue`

#### 1. ä¿®æ”¹ `handleEditMaterial` å‡½æ•°ï¼ˆç¬¬ 538-547 è¡Œï¼‰

**ä¿®æ”¹å‰ï¼š**

```typescript
// ç¼–è¾‘ç‰©æ–™
const handleEditMaterial = (row: SubsystemMaterialTemplateVO) => {
  resetMaterialForm();
  Object.assign(materialForm, row);
  materialEditDialog.visible = true;
};
```

**ä¿®æ”¹åï¼š**

```typescript
// ç¼–è¾‘ç‰©æ–™
const handleEditMaterial = (row: SubsystemMaterialTemplateVO) => {
  resetMaterialForm();
  Object.assign(materialForm, row);
  // âœ… ç¡®ä¿templateIdå§‹ç»ˆä¸ºå½“å‰å­ç³»ç»Ÿæ¨¡æ¿IDï¼Œä¿è¯æ•°æ®éš”ç¦»
  materialForm.templateId = props.templateId;
  // âœ… ç¡®ä¿itemTemplateIdæ­£ç¡®è®¾ç½®
  materialForm.itemTemplateId = selectedItemId.value!;
  materialEditDialog.visible = true;
};
```

**ä¿®å¤è¯´æ˜ï¼š**

- æ˜¾å¼è®¾ç½® `templateId` ä¸ºå½“å‰å­ç³»ç»Ÿæ¨¡æ¿ IDï¼ˆ`props.templateId`ï¼‰
- æ˜¾å¼è®¾ç½® `itemTemplateId` ä¸ºå½“å‰é€‰ä¸­çš„å­é¡¹ IDï¼ˆ`selectedItemId.value`ï¼‰
- ç¡®ä¿å³ä½¿ `row` ä¸­çš„æ•°æ®ä¸æ­£ç¡®ï¼Œä¹Ÿèƒ½ä¿è¯æ•°æ®éš”ç¦»

#### 2. ä¿®æ”¹ `resetMaterialForm` å‡½æ•°ï¼ˆç¬¬ 590-602 è¡Œï¼‰

**ä¿®æ”¹å‰ï¼š**

```typescript
// é‡ç½®ç‰©æ–™è¡¨å•
const resetMaterialForm = () => {
  materialForm.id = undefined;
  materialForm.materialId = 0;
  materialForm.materialName = '';
  materialForm.defaultQuantity = 1;
  materialForm.isRequired = true;
  materialForm.remarks = '';
  materialFormRef.value?.clearValidate();
};
```

**ä¿®æ”¹åï¼š**

```typescript
// é‡ç½®ç‰©æ–™è¡¨å•
const resetMaterialForm = () => {
  materialForm.id = undefined;
  // âœ… é‡ç½®æ—¶ä¿ç•™å…³è”IDï¼Œç¡®ä¿æ•°æ®éš”ç¦»
  materialForm.templateId = props.templateId;
  materialForm.itemTemplateId = selectedItemId.value || 0;
  materialForm.materialId = 0;
  materialForm.materialName = '';
  materialForm.defaultQuantity = 1;
  materialForm.isRequired = true;
  materialForm.remarks = '';
  materialFormRef.value?.clearValidate();
};
```

**ä¿®å¤è¯´æ˜ï¼š**

- åœ¨é‡ç½®è¡¨å•æ—¶ï¼Œä¿ç•™ `templateId` å’Œ `itemTemplateId` çš„æ­£ç¡®å€¼
- ç¡®ä¿è¡¨å•é‡ç½®åï¼Œå…³è” ID ä¸ä¼šä¸¢å¤±
- ä¸ºåç»­çš„æ–°å¢æˆ–ç¼–è¾‘æ“ä½œæä¾›æ­£ç¡®çš„å…³è”ä¸Šä¸‹æ–‡

## ğŸ”„ å·¥ä½œæµç¨‹

### ç¼–è¾‘ç‰©æ–™æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ç‚¹å‡»ç¼–è¾‘ç‰©æ–™] --> B[è°ƒç”¨handleEditMaterial]
    B --> C[resetMaterialForm: é‡ç½®è¡¨å•]
    C --> D[è®¾ç½®templateId = props.templateId]
    D --> E[è®¾ç½®itemTemplateId = selectedItemId]
    E --> F[Object.assign: å¤åˆ¶rowæ•°æ®]
    F --> G[å†æ¬¡ç¡®ä¿templateIdå’ŒitemTemplateId]
    G --> H[æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†]
    H --> I[ç”¨æˆ·ä¿®æ”¹æ•°æ®]
    I --> J[æäº¤: submitMaterialEditForm]
    J --> K[è°ƒç”¨updateMaterialTemplate]
    K --> L[åç«¯æ›´æ–°ç‰©æ–™, ä½¿ç”¨æ­£ç¡®çš„templateId]
```

### æ•°æ®éš”ç¦»ä¿è¯

```typescript
// ç‰©æ–™æ•°æ®ç»“æ„
{
  id: "1986586568717946881",
  templateId: "1985928480973324290",  // âœ… å…³é”®å­—æ®µï¼šå­ç³»ç»Ÿæ¨¡æ¿ID
  itemTemplateId: "1986239297161666561",
  materialId: "1985570844872421378",
  // ... å…¶ä»–å­—æ®µ
}

// ç¼–è¾‘æ—¶ç¡®ä¿
materialForm.templateId = props.templateId  // âœ… å§‹ç»ˆä½¿ç”¨å½“å‰å­ç³»ç»Ÿæ¨¡æ¿ID
```

## âœ… éªŒè¯è¦ç‚¹

### 1. æ•°æ®éš”ç¦»éªŒè¯

**åœºæ™¯ï¼šæœ‰ä¸¤ä¸ªå­ç³»ç»Ÿæ¨¡æ¿ A å’Œ Bï¼Œéƒ½åŒ…å«ç›¸åŒçš„å­é¡¹"æ¡¥æ¶æ”¯æ¶"**

1. åœ¨å­ç³»ç»Ÿæ¨¡æ¿ A çš„è¯¦æƒ…é¡µé¢ä¸­ï¼š

   - æŸ¥çœ‹å­é¡¹"æ¡¥æ¶æ”¯æ¶"çš„ç‰©æ–™
   - ç¼–è¾‘ç‰©æ–™"æ§½å¼æ¡¥æ¶"ï¼Œä¿®æ”¹æ•°é‡ä¸º 20 ä¸ª
   - ä¿å­˜æˆåŠŸ

2. åœ¨å­ç³»ç»Ÿæ¨¡æ¿ B çš„è¯¦æƒ…é¡µé¢ä¸­ï¼š
   - æŸ¥çœ‹å­é¡¹"æ¡¥æ¶æ”¯æ¶"çš„ç‰©æ–™
   - ç‰©æ–™"æ§½å¼æ¡¥æ¶"çš„æ•°é‡åº”è¯¥ä¿æŒåŸå€¼
   - âœ… éªŒè¯ï¼šA çš„ä¿®æ”¹ä¸å½±å“ B

### 2. åç«¯æ—¥å¿—éªŒè¯

**ç¼–è¾‘ç‰©æ–™æ—¶çš„æ—¥å¿—ï¼š**

```log
ã€ç‰©æ–™æ¨¡æ¿æ›´æ–°ã€‘id=xxx, templateId=1985928480973324290, itemTemplateId=xxx
ã€SQLã€‘UPDATE erp_subsystem_material_template
      SET default_quantity = ?, ...
      WHERE id = ? AND template_id = 1985928480973324290
```

**å…³é”®ç‚¹ï¼š**

- `template_id` åœ¨ SQL çš„ WHERE æ¡ä»¶ä¸­
- ç¡®ä¿åªæ›´æ–°å½“å‰å­ç³»ç»Ÿçš„ç‰©æ–™è®°å½•

### 3. å‰ç«¯è°ƒè¯•éªŒè¯

**åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ï¼š**

```javascript
// ç¼–è¾‘ç‰©æ–™å‰æ£€æŸ¥
console.log('props.templateId:', props.templateId);
console.log('selectedItemId:', selectedItemId.value);

// æäº¤æ—¶æ£€æŸ¥
console.log('materialForm:', materialForm);
// åº”è¯¥è¾“å‡ºï¼š
// {
//   id: "...",
//   templateId: "1985928480973324290",  // âœ… æ­£ç¡®çš„å­ç³»ç»Ÿæ¨¡æ¿ID
//   itemTemplateId: "...",
//   ...
// }
```

## ğŸ“Š ç›¸å…³æ¥å£

### æŸ¥è¯¢æ¥å£

```typescript
// æŸ¥è¯¢å­ç³»ç»Ÿç‰©æ–™ï¼ˆå¸¦templateIdå‚æ•°ï¼‰
GET /erp/subsystem/material-template/list-by-item/{itemTemplateId}?templateId={templateId}
```

### æ›´æ–°æ¥å£

```typescript
// æ›´æ–°ç‰©æ–™æ¨¡æ¿
PUT /erp/subsystem/material-template

// è¯·æ±‚ä½“
{
  "id": "1986586568717946881",
  "templateId": "1985928480973324290",  // âœ… å¿…é¡»æ­£ç¡®è®¾ç½®
  "itemTemplateId": "1986239297161666561",
  "materialId": "1985570844872421378",
  "defaultQuantity": 20,
  "isRequired": true,
  "remarks": ""
}
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### Beforeï¼ˆä¿®å¤å‰ï¼‰

- âŒ ä¾èµ–äº `row` æ•°æ®ä¸­çš„ `templateId`
- âŒ å¦‚æœ `row` æ•°æ®ä¸æ­£ç¡®ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®éš”ç¦»å¤±æ•ˆ
- âŒ é‡ç½®è¡¨å•æ—¶ï¼Œå…³è” ID å¯èƒ½ä¸¢å¤±

### Afterï¼ˆä¿®å¤åï¼‰

- âœ… æ˜¾å¼è®¾ç½® `templateId` ä¸ºå½“å‰å­ç³»ç»Ÿæ¨¡æ¿ ID
- âœ… æ˜¾å¼è®¾ç½® `itemTemplateId` ä¸ºå½“å‰é€‰ä¸­çš„å­é¡¹ ID
- âœ… é‡ç½®è¡¨å•æ—¶ï¼Œä¿ç•™å…³è” ID
- âœ… ç¡®ä¿æ•°æ®éš”ç¦»åŸåˆ™å¾—åˆ°ä¸¥æ ¼éµå®ˆ

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ··æ·†ä¸¤ç§åœºæ™¯ï¼š**

   - å­ç³»ç»Ÿæ¨¡æ¿è¯¦æƒ…é¡µé¢ï¼šä¿®æ”¹ç‰©æ–™æ¨¡æ¿ï¼ˆ`template_id` = å­ç³»ç»Ÿæ¨¡æ¿ IDï¼‰
   - å­é¡¹æ¨¡æ¿ç®¡ç†é¡µé¢ï¼šä¿®æ”¹æ¨¡æ¿ç‰©æ–™ï¼ˆ`template_id` = NULLï¼‰

2. **å§‹ç»ˆä½¿ç”¨æ­£ç¡®çš„ APIï¼š**

   - å­ç³»ç»Ÿæ¨¡æ¿ç‰©æ–™ï¼šä½¿ç”¨ `material-template.ts` ä¸­çš„ API
   - å­ç³»ç»Ÿå®ä¾‹ç‰©æ–™ï¼šä½¿ç”¨ `index.ts` ä¸­çš„ `updateSubsystemMaterial`

3. **ç¡®ä¿å‚æ•°ä¼ é€’ï¼š**
   - æŸ¥è¯¢æ—¶ï¼šå¿…é¡»ä¼ é€’ `templateId` å‚æ•°
   - ä¿®æ”¹æ—¶ï¼šå¿…é¡»åœ¨è¡¨å•æ•°æ®ä¸­åŒ…å« `templateId` å­—æ®µ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å­ç³»ç»Ÿç‰©æ–™æŸ¥è¯¢ API å¯¹æ¥æ–‡æ¡£](./å­ç³»ç»Ÿç‰©æ–™æŸ¥è¯¢APIå¯¹æ¥æ–‡æ¡£.md)
- [å­ç³»ç»Ÿç‰©æ–™å¢åˆ æ”¹æ“ä½œæ•°æ®éš”ç¦»ä¿®å¤](./å­ç³»ç»Ÿç‰©æ–™å¢åˆ æ”¹æ“ä½œæ•°æ®éš”ç¦»ä¿®å¤.md)

## ğŸ” ä»£ç ä½ç½®

- **æ–‡ä»¶è·¯å¾„**: `src/views/erp/subsystem/template/components/ItemTemplateManagement.vue`
- **ä¿®æ”¹å‡½æ•°**:
  - `handleEditMaterial` (ç¬¬ 538-547 è¡Œ)
  - `resetMaterialForm` (ç¬¬ 590-602 è¡Œ)
- **API æ–‡ä»¶**: `src/api/erp/subsystem/material-template.ts`

---

**ä¿®å¤æ—¥æœŸ**: 2025-11-07  
**ä¿®å¤äººå‘˜**: æµ·æ£ å¼€å‘å›¢é˜Ÿ  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
