# 子项模板新增流程优化说明

## 修改日期

2025 年 11 月 6 日

## 修改目标

优化子系统模板中添加子项模板的业务流程，实现"新增子项模板后自动关联到子系统模板"的功能。

## 修改内容

### 1. API 接口增强 (src/api/erp/subsystem/template.ts)

**新增接口：**

#### addItemToTemplate

- **功能**: 将已存在的子项模板关联到子系统模板
- **路径**: POST `/erp/subsystem/template/{templateId}/items`
- **说明**: 自动同步子项的物料到子系统物料表
- **参数**:
  ```typescript
  {
    itemTemplateId: number;      // 子项模板ID
    quantity?: number;            // 数量（可选）
    sequenceNumber?: number;      // 排序号（可选）
    isRequired?: boolean;         // 是否必需（可选）
    remarks?: string;             // 备注（可选）
  }
  ```

#### batchAddItemsToTemplate

- **功能**: 批量将子项模板关联到子系统模板
- **路径**: POST `/erp/subsystem/template/{templateId}/items/batch`
- **参数**: 关联配置数据数组

### 2. 子项模板接口优化 (src/api/erp/subsystem/item-template.ts)

**修改内容：**

- 修改 `addItemTemplate` 接口返回类型
- **修改前**: `AxiosPromise<void>`
- **修改后**: `AxiosPromise<number>`
- **原因**: 接口返回创建的子项模板 ID，用于后续关联操作

### 3. 子项选择器组件优化 (src/views/erp/subsystem/template/components/ItemTemplateSelectorDialog.vue)

#### 3.1 导入新增接口

```typescript
import { addItemToTemplate } from '@/api/erp/subsystem/template';
```

#### 3.2 submitItemForm 函数增强

在选择器中的"新增子项模板"按钮对应的表单提交函数中，实现两步流程：

**业务流程：**

1. **步骤 1**: 创建独立的子项模板

   - 调用 `addItemTemplate` 接口
   - 传入子项基本信息（不包含 templateId）
   - 获取返回的子项模板 ID

2. **步骤 2**: 关联子项模板到子系统模板

   - 调用 `addItemToTemplate` 接口
   - 传入子系统模板 ID 和新创建的子项模板 ID
   - 系统自动同步子项的物料配置

3. **步骤 3**: 刷新列表
   - 刷新选择器中的子项列表
   - 触发 refresh 事件刷新父组件列表

**代码实现：**

```typescript
const submitItemForm = async () => {
  try {
    await itemFormRef.value?.validate();

    itemDialog.loading = true;

    // 步骤1: 创建子项模板（独立的公司级子项模板）
    const createData = {
      itemName: itemForm.itemName,
      itemType: itemForm.itemType,
      description: itemForm.description,
      defaultQuantity: itemForm.defaultQuantity,
      unit: itemForm.unit,
      isRequired: itemForm.isRequired,
      remarks: itemForm.remarks
    };

    const createResponse = await addItemTemplate(createData);
    const newItemTemplateId = createResponse.data;

    // 步骤2: 将新创建的子项模板关联到当前子系统模板
    await addItemToTemplate(props.templateId, {
      itemTemplateId: newItemTemplateId,
      quantity: itemForm.defaultQuantity || 1,
      isRequired: itemForm.isRequired ?? true,
      remarks: itemForm.remarks
    });

    ElMessage.success('新增子项模板并关联成功');

    itemDialog.visible = false;

    // 步骤3: 刷新列表
    loadItemList();
    emit('refresh');
  } catch (error) {
    if (error !== false) {
      ElMessage.error('保存失败');
    }
  } finally {
    itemDialog.loading = false;
  }
};
```

#### 3.3 类型修复

修复了`isAdded`函数的类型问题：

```typescript
const isAdded = (row: SubsystemItemTemplateVO): boolean => {
  return props.existingItemIds.includes(Number(row.id));
};
```

## 业务流程对比

### 修改前

1. 点击"添加子项"按钮
2. 打开子项选择器对话框
3. 从已有的子项模板库中选择子项
4. 确认选择，关联到子系统模板

### 修改后

1. 点击"添加子项"按钮
2. 打开子项选择器对话框
3. 在选择器中点击"新增子项模板"按钮
4. 填写子项模板表单信息
5. 提交表单
   - 系统自动创建子项模板
   - 系统自动关联到当前子系统模板
   - 系统自动同步物料配置
   - 刷新子项列表和选择器列表
6. 完成（可继续选择其他子项或直接确定）

## 优势

1. **流程简化**: 一步完成创建和关联，减少操作步骤
2. **数据一致性**: 自动关联确保数据完整性
3. **用户友好**: 直观的表单操作，降低使用门槛
4. **错误处理**: 统一的错误处理机制
5. **调试友好**: 添加详细的日志输出

## 注意事项

1. 新增子项模板时不需要传入 `templateId`，因为是创建独立的公司级子项模板
2. 创建成功后会自动获取新的子项模板 ID
3. 使用该 ID 调用关联接口，将子项模板绑定到当前子系统模板
4. 关联时会自动同步子项的物料配置到子系统物料表

## 兼容性

- 修改不影响现有的编辑子项模板功能
- 保留了原有的子项选择器组件（可用于其他场景）
- 所有接口遵循后端 API v2.0 规范

## 测试建议

1. 测试新增子项模板功能
2. 验证子项模板是否正确创建
3. 验证子项模板是否正确关联到子系统模板
4. 验证物料配置是否正确同步
5. 测试编辑子项模板功能是否正常
6. 测试删除子项模板功能是否正常

## 相关文档

- [子系统模板子项和物料管理 API 文档](./子系统模板子项和物料管理API文档.md)
- [子系统管理模块使用指南](./子系统管理模块使用指南.md)
