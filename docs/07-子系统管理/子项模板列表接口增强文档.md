# 子项模板列表接口增强功能文档

## 修改概述

为 `/erp/subsystem/item-template/list` 接口新增了 `templateId` 参数支持和 `isAdded` 标记字段。当传入子系统模板 ID 时，接口会返回所有子项模板，并通过 `isAdded` 字段标记哪些子项已经添加到该模板中。前端可以根据此标记字段来勾选已添加的子项。

## 接口信息

### 基本信息

-   **接口路径**: `/erp/subsystem/item-template/list`
-   **请求方法**: `GET`
-   **权限要求**: `erp:subsystem:template:list`

### 请求参数

| 参数名称   | 参数类型 | 是否必填 | 说明                                      |
| ---------- | -------- | -------- | ----------------------------------------- |
| pageNum    | Integer  | 否       | 页码，默认为 1                            |
| pageSize   | Integer  | 否       | 每页数量，默认为 10                       |
| templateId | Long     | 否       | 子系统模板 ID，用于筛选与该模板关联的子项 |
| itemCode   | String   | 否       | 子项编号（模糊查询）                      |
| itemName   | String   | 否       | 子项名称（模糊查询）                      |
| itemType   | String   | 否       | 子项类型（精确查询）                      |
| isRequired | Boolean  | 否       | 是否必需（精确查询）                      |

### 返回结果

```json
{
    "code": 200,
    "msg": "查询成功",
    "rows": [
        {
            "id": 1,
            "itemCode": "ITEM-00001",
            "itemName": "控制器模块",
            "itemType": "组件",
            "specification": "PLC-200",
            "description": "可编程逻辑控制器",
            "defaultQuantity": 1,
            "unit": "个",
            "isRequired": true,
            "sequenceNumber": 10,
            "remarks": "",
            "createTime": "2025-01-01 10:00:00",
            "updateTime": "2025-01-01 10:00:00",
            "isAdded": true
        },
        {
            "id": 2,
            "itemCode": "ITEM-00002",
            "itemName": "电源模块",
            "itemType": "组件",
            "specification": "PS-500W",
            "description": "500W开关电源",
            "defaultQuantity": 1,
            "unit": "个",
            "isRequired": true,
            "sequenceNumber": 20,
            "remarks": "",
            "createTime": "2025-01-01 10:00:00",
            "updateTime": "2025-01-01 10:00:00",
            "isAdded": false
        }
    ],
    "total": 2
}
```

**字段说明**：

-   `isAdded`: 布尔类型，表示该子项是否已添加到指定的子系统模板中
    -   只有当请求参数中传入 `templateId` 时，该字段才有意义
    -   `true` 表示该子项已添加到指定模板
    -   `false` 表示该子项未添加到指定模板
    -   如果请求中未传入 `templateId`，该字段为 `null`

## 使用场景

### 场景一：查询所有子项模板（不传 templateId）

当不传入 `templateId` 参数时，接口返回所有子项模板的列表，`isAdded` 字段为 `null`。适用于子项模板管理页面。

**请求示例**：

```http
GET /erp/subsystem/item-template/list?pageNum=1&pageSize=10
```

**返回数据特点**：

-   返回所有子项模板
-   `isAdded` 字段为 `null`

### 场景二：查询并标记特定子系统模板的关联子项（传入 templateId）

当传入 `templateId` 参数时，接口返回所有子项模板，并通过 `isAdded` 字段标记哪些子项已添加到该模板。适用于子系统模板管理页面中为模板选择子项的场景。

**请求示例**：

```http
GET /erp/subsystem/item-template/list?pageNum=1&pageSize=10&templateId=1234567890
```

**返回数据特点**：

-   返回所有子项模板（不筛选）
-   `isAdded=true` 的子项表示已添加到该模板
-   `isAdded=false` 的子项表示未添加到该模板
-   前端可根据 `isAdded` 字段来勾选已添加的子项

### 场景三：结合其他条件搜索并标记

可以同时使用 `templateId` 和其他查询条件（如 `itemName`）进行搜索，并标记已添加的子项。

**请求示例**：

```http
GET /erp/subsystem/item-template/list?pageNum=1&pageSize=10&templateId=1234567890&itemName=控制器
```

**返回数据特点**：

-   返回名称包含"控制器"的所有子项模板
-   `isAdded` 字段标记这些子项是否已添加到指定模板

## 实现原理

### 数据查询逻辑

1. **查询子项模板数据**：

    - 根据查询条件（itemCode、itemName、itemType、isRequired）查询 `erp_subsystem_item_template` 表
    - 返回所有符合条件的子项模板（不进行 templateId 筛选）

2. **标记已添加的子项**（当传入 templateId 时）：

    - 查询 `erp_subsystem_template_item_rel` 关联表，获取所有与该模板关联的子项 ID 列表
    - 遍历查询结果，对比子项 ID 是否在关联列表中
    - 设置每个子项的 `isAdded` 字段：在关联列表中的为 `true`，否则为 `false`

3. **不传入 templateId 时**：
    - 直接查询 `erp_subsystem_item_template` 表，返回所有子项模板
    - `isAdded` 字段保持为 `null`

### 核心代码

**查询列表方法**：

```java
@Override
public TableDataInfo<ErpSubsystemItemTemplateVo> queryPageList(ErpSubsystemItemTemplateBo bo, PageQuery pageQuery) {
    LambdaQueryWrapper<ErpSubsystemItemTemplate> lqw = buildQueryWrapper(bo);
    Page<ErpSubsystemItemTemplate> page = baseMapper.selectPage(pageQuery.build(), lqw);

    // 手动转换 Entity 到 VO
    Page<ErpSubsystemItemTemplateVo> voPage = new Page<>();
    voPage.setCurrent(page.getCurrent());
    voPage.setSize(page.getSize());
    voPage.setTotal(page.getTotal());

    List<ErpSubsystemItemTemplateVo> voList = ErpSubsystemItemTemplateConvert.INSTANCE.toVo(page.getRecords());

    // 如果传入了templateId，标记已添加的子项
    if (ObjectUtil.isNotEmpty(bo.getTemplateId())) {
        markAddedItems(voList, bo.getTemplateId());
    }

    voPage.setRecords(voList);

    return TableDataInfo.build(voPage);
}
```

**标记方法**：

```java
/**
 * 标记已添加到指定模板的子项
 *
 * @param voList     子项VO列表
 * @param templateId 子系统模板ID
 */
private void markAddedItems(List<ErpSubsystemItemTemplateVo> voList, Long templateId) {
    if (voList == null || voList.isEmpty()) {
        return;
    }

    // 查询该模板已关联的所有子项ID
    LambdaQueryWrapper<ErpSubsystemTemplateItemRel> relLqw = Wrappers.lambdaQuery();
    relLqw.eq(ErpSubsystemTemplateItemRel::getTemplateId, templateId);

    ErpSubsystemTemplateItemRelMapper relMapper =
            SpringUtils.getBean(ErpSubsystemTemplateItemRelMapper.class);

    List<ErpSubsystemTemplateItemRel> relList = relMapper.selectList(relLqw);

    if (ObjectUtil.isEmpty(relList)) {
        log.info("模板ID[{}]未添加任何子项，所有子项标记为未添加", templateId);
        voList.forEach(vo -> vo.setIsAdded(false));
        return;
    }

    // 提取已添加的子项ID集合
    List<Long> addedItemIds = relList.stream()
            .map(ErpSubsystemTemplateItemRel::getItemTemplateId)
            .toList();

    log.info("模板ID[{}]已添加{}个子项，开始标记", templateId, addedItemIds.size());

    // 标记每个子项是否已添加
    voList.forEach(vo -> {
        boolean isAdded = addedItemIds.contains(vo.getId());
        vo.setIsAdded(isAdded);
    });
}
```

**查询条件构建**：

```java
private LambdaQueryWrapper<ErpSubsystemItemTemplate> buildQueryWrapper(ErpSubsystemItemTemplateBo bo) {
    LambdaQueryWrapper<ErpSubsystemItemTemplate> lqw = Wrappers.lambdaQuery();

    // 注意：templateId 仅用于标记，不用于筛选数据
    lqw.like(ObjectUtil.isNotEmpty(bo.getItemCode()), ErpSubsystemItemTemplate::getItemCode, bo.getItemCode());
    lqw.like(ObjectUtil.isNotEmpty(bo.getItemName()), ErpSubsystemItemTemplate::getItemName, bo.getItemName());
    lqw.eq(ObjectUtil.isNotEmpty(bo.getItemType()), ErpSubsystemItemTemplate::getItemType, bo.getItemType());
    lqw.eq(ObjectUtil.isNotEmpty(bo.getIsRequired()), ErpSubsystemItemTemplate::getIsRequired, bo.getIsRequired());
    lqw.orderByAsc(ErpSubsystemItemTemplate::getSequenceNumber);
    lqw.orderByDesc(ErpSubsystemItemTemplate::getCreateTime);
    return lqw;
}
```

## 数据库设计

### 涉及的数据表

1. **erp_subsystem_item_template** - 子项模板表

    - 存储子项的基本信息（编号、名称、规格等）

2. **erp_subsystem_template_item_rel** - 子系统模板与子项关联表
    - 存储子系统模板和子项之间的多对多关系
    - 主要字段：`template_id`（子系统模板 ID）、`item_template_id`（子项模板 ID）

### 关系说明

```
erp_subsystem_template (子系统模板)
         |
         | 1:N
         |
erp_subsystem_template_item_rel (关联表)
         |
         | N:1
         |
erp_subsystem_item_template (子项模板)
```

## 前端对接指南

### Vue3 + TypeScript 示例

```typescript
import request from "@/utils/request";

/**
 * 查询子项模板列表（支持通过模板ID筛选）
 */
export interface ItemTemplateQuery {
    pageNum?: number;
    pageSize?: number;
    templateId?: number; // 子系统模板ID（可选）
    itemCode?: string; // 子项编号
    itemName?: string; // 子项名称
    itemType?: string; // 子项类型
    isRequired?: boolean; // 是否必需
}

export interface ItemTemplateVO {
    id: number;
    itemCode: string;
    itemName: string;
    itemType?: string;
    specification?: string;
    description?: string;
    defaultQuantity: number;
    unit: string;
    isRequired: boolean;
    sequenceNumber: number;
    remarks?: string;
    createTime: string;
    updateTime: string;
    isAdded?: boolean; // 是否已添加到指定模板（仅当传入templateId时有值）
}

/**
 * 查询子项模板列表
 */
export function listItemTemplate(query: ItemTemplateQuery) {
    return request({
        url: "/erp/subsystem/item-template/list",
        method: "get",
        params: query,
    });
}

// 使用示例1：查询所有子项模板
const getAllItems = async () => {
    const response = await listItemTemplate({
        pageNum: 1,
        pageSize: 10,
    });
    console.log(response.rows);
    // 所有子项的 isAdded 字段为 null
};

// 使用示例2：查询并标记特定子系统模板的关联子项
const getTemplateItemsWithMark = async (templateId: number) => {
    const response = await listItemTemplate({
        pageNum: 1,
        pageSize: 10,
        templateId: templateId,
    });

    // 返回所有子项，但带有 isAdded 标记
    const addedItems = response.rows.filter((item) => item.isAdded);
    const notAddedItems = response.rows.filter((item) => !item.isAdded);

    console.log("已添加的子项：", addedItems);
    console.log("未添加的子项：", notAddedItems);
};

// 使用示例3：结合其他条件搜索并标记
const searchItemsWithMark = async (templateId: number, keyword: string) => {
    const response = await listItemTemplate({
        pageNum: 1,
        pageSize: 10,
        templateId: templateId,
        itemName: keyword,
    });

    // 搜索结果中带有 isAdded 标记
    console.log(response.rows);
};
```

### 页面集成示例

#### 示例 1：带勾选功能的子项选择对话框

```vue
<template>
    <el-dialog
        v-model="dialogVisible"
        title="选择子项模板"
        width="80%"
        @close="handleClose"
    >
        <!-- 查询条件 -->
        <el-form :model="queryParams" inline>
            <el-form-item label="子项名称">
                <el-input
                    v-model="queryParams.itemName"
                    placeholder="请输入子项名称"
                    clearable
                />
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="handleQuery" icon="Search"
                    >查询</el-button
                >
                <el-button @click="handleReset" icon="Refresh">重置</el-button>
            </el-form-item>
        </el-form>

        <!-- 数据表格（带勾选） -->
        <el-table
            ref="tableRef"
            :data="itemList"
            border
            @selection-change="handleSelectionChange"
        >
            <!-- 勾选列 -->
            <el-table-column
                type="selection"
                width="55"
                :selectable="checkSelectable"
            />

            <el-table-column prop="itemCode" label="子项编号" width="120" />
            <el-table-column prop="itemName" label="子项名称" min-width="150" />
            <el-table-column prop="itemType" label="子项类型" width="100" />
            <el-table-column
                prop="specification"
                label="规格型号"
                min-width="120"
            />
            <el-table-column
                prop="defaultQuantity"
                label="默认数量"
                width="100"
            />
            <el-table-column prop="unit" label="单位" width="80" />

            <!-- 状态标记列 -->
            <el-table-column label="状态" width="100">
                <template #default="{ row }">
                    <el-tag v-if="row.isAdded" type="success">已添加</el-tag>
                    <el-tag v-else type="info">未添加</el-tag>
                </template>
            </el-table-column>
        </el-table>

        <!-- 分页 -->
        <el-pagination
            v-model:current-page="queryParams.pageNum"
            v-model:page-size="queryParams.pageSize"
            :total="total"
            :page-sizes="[10, 20, 50, 100]"
            layout="total, sizes, prev, pager, next, jumper"
            @size-change="handleQuery"
            @current-change="handleQuery"
        />

        <!-- 对话框底部按钮 -->
        <template #footer>
            <el-button @click="dialogVisible = false">取消</el-button>
            <el-button type="primary" @click="handleConfirm">确定</el-button>
        </template>
    </el-dialog>
</template>

<script setup lang="ts">
import { ref, watch, nextTick } from "vue";
import {
    listItemTemplate,
    ItemTemplateQuery,
    ItemTemplateVO,
} from "@/api/erp/subsystem/itemTemplate";
import { ElMessage } from "element-plus";

// 接收父组件传入的 templateId
const props = defineProps<{
    modelValue: boolean; // 对话框显示状态
    templateId: number; // 子系统模板ID
}>();

const emit = defineEmits<{
    "update:modelValue": [value: boolean];
    confirm: [selectedIds: number[]]; // 返回选中的子项ID列表
}>();

const dialogVisible = ref(false);
const tableRef = ref();
const itemList = ref<ItemTemplateVO[]>([]);
const total = ref(0);
const selectedItems = ref<ItemTemplateVO[]>([]);

const queryParams = ref<ItemTemplateQuery>({
    pageNum: 1,
    pageSize: 10,
    templateId: props.templateId, // 传入templateId以获取标记
    itemName: "",
});

// 监听对话框显示状态
watch(
    () => props.modelValue,
    (val) => {
        dialogVisible.value = val;
        if (val) {
            getList();
        }
    }
);

watch(dialogVisible, (val) => {
    emit("update:modelValue", val);
});

/** 查询列表 */
const getList = async () => {
    const response = await listItemTemplate(queryParams.value);
    itemList.value = response.rows;
    total.value = response.total;

    // 查询完成后，自动勾选已添加的子项
    await nextTick();
    autoSelectAddedItems();
};

/** 自动勾选已添加的子项 */
const autoSelectAddedItems = () => {
    if (!tableRef.value) return;

    // 清空之前的选择
    tableRef.value.clearSelection();

    // 勾选 isAdded 为 true 的行
    itemList.value.forEach((item) => {
        if (item.isAdded) {
            tableRef.value.toggleRowSelection(item, true);
        }
    });
};

/** 勾选状态变化 */
const handleSelectionChange = (selection: ItemTemplateVO[]) => {
    selectedItems.value = selection;
};

/** 控制行是否可勾选（可选功能） */
const checkSelectable = (row: ItemTemplateVO) => {
    // 所有行都可以勾选
    return true;

    // 如果只允许勾选未添加的子项，可以使用：
    // return !row.isAdded;
};

/** 查询按钮操作 */
const handleQuery = () => {
    queryParams.value.pageNum = 1;
    getList();
};

/** 重置按钮操作 */
const handleReset = () => {
    queryParams.value.itemName = "";
    handleQuery();
};

/** 确认选择 */
const handleConfirm = () => {
    if (selectedItems.value.length === 0) {
        ElMessage.warning("请至少选择一个子项");
        return;
    }

    // 返回选中的子项ID列表
    const selectedIds = selectedItems.value.map((item) => item.id);
    emit("confirm", selectedIds);

    dialogVisible.value = false;
};

/** 关闭对话框 */
const handleClose = () => {
    // 清空查询条件
    queryParams.value.itemName = "";
    queryParams.value.pageNum = 1;
};
</script>

<style scoped>
.el-pagination {
    margin-top: 20px;
    text-align: right;
}
</style>
```

#### 示例 2：在父组件中使用

```vue
<template>
    <div class="subsystem-template-detail">
        <el-button type="primary" @click="openItemSelector">添加子项</el-button>

        <!-- 子项选择对话框 -->
        <ItemSelectorDialog
            v-model="showItemSelector"
            :template-id="currentTemplateId"
            @confirm="handleItemsConfirm"
        />
    </div>
</template>

<script setup lang="ts">
import { ref } from "vue";
import ItemSelectorDialog from "./ItemSelectorDialog.vue";
import { addItemsToTemplate } from "@/api/erp/subsystem/template";
import { ElMessage } from "element-plus";

const showItemSelector = ref(false);
const currentTemplateId = ref(1234567890); // 当前子系统模板ID

/** 打开子项选择对话框 */
const openItemSelector = () => {
    showItemSelector.value = true;
};

/** 处理子项选择确认 */
const handleItemsConfirm = async (selectedIds: number[]) => {
    try {
        // 调用API将选中的子项添加到模板
        await addItemsToTemplate({
            templateId: currentTemplateId.value,
            itemTemplateIds: selectedIds,
        });

        ElMessage.success("子项添加成功");

        // 刷新页面数据
        // refreshData();
    } catch (error) {
        ElMessage.error("子项添加失败");
    }
};
</script>
```

## 测试用例

### 测试脚本

可以使用以下 curl 命令进行测试：

```bash
# 测试1：查询所有子项模板
curl -X GET "http://localhost:8080/erp/subsystem/item-template/list?pageNum=1&pageSize=10" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试2：查询特定模板的关联子项
curl -X GET "http://localhost:8080/erp/subsystem/item-template/list?pageNum=1&pageSize=10&templateId=1234567890" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试3：结合名称筛选
curl -X GET "http://localhost:8080/erp/subsystem/item-template/list?pageNum=1&pageSize=10&templateId=1234567890&itemName=控制器" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 日志输出

当传入 `templateId` 参数时，系统会输出以下日志：

```
INFO  - 模板ID[1234567890]已添加3个子项，开始标记
```

或者当该模板没有关联子项时：

```
INFO  - 模板ID[1234567890]未添加任何子项，所有子项标记为未添加
```

## 注意事项

1. **参数兼容性**：`templateId` 参数是可选的，不传该参数时接口行为保持原样，确保向后兼容

2. **标记而非筛选**：当传入 `templateId` 时，接口返回所有子项（不进行筛选），仅通过 `isAdded` 字段标记已添加状态

3. **性能考虑**：
   - 当传入 `templateId` 时，会额外查询关联表进行标记
   - 建议在关联表的 `template_id` 字段上建立索引以提高查询性能
   - 标记操作在内存中进行，性能损耗较小

4. **前端展示建议**：
   - 可以在表格中显示"已添加"/"未添加"标签
   - 自动勾选 `isAdded=true` 的行
   - 支持用户修改勾选状态（取消已添加的、新增未添加的）

5. **空结果处理**：如果传入的 `templateId` 在关联表中没有记录，所有子项的 `isAdded` 都标记为 `false`

6. **排序规则**：结果按 `sequenceNumber` 升序、`createTime` 降序排列

7. **分页注意**：由于返回所有数据（不筛选），分页仍然有效，但 `isAdded` 标记会在每一页都正确显示

## 修改文件清单

### 1. 后端修改

#### VO 类
- **文件**：`ErpSubsystemItemTemplateVo.java`
- **修改**：新增 `isAdded` 字段，用于标记子项是否已添加到指定模板

#### Service 实现类
- **文件**：`ErpSubsystemItemTemplateServiceImpl.java`
- **修改内容**：
  1. `queryPageList` 方法：新增标记逻辑
  2. 新增 `markAddedItems` 私有方法：实现标记功能
  3. `buildQueryWrapper` 方法：移除筛选逻辑，改为只返回所有数据

#### 导入依赖
- **文件**：`ErpSubsystemItemTemplateServiceImpl.java`
- **新增**：`ErpSubsystemTemplateItemRel` 实体类导入

### 2. 前端修改建议

#### API 接口定义
- **文件**：`itemTemplate.ts`
- **修改**：`ItemTemplateVO` 接口新增 `isAdded?: boolean` 字段

#### 页面组件
- **建议新增**：`ItemSelectorDialog.vue` - 带勾选功能的子项选择对话框
- **核心功能**：
  1. 支持传入 `templateId` 参数
  2. 自动勾选已添加的子项
  3. 显示"已添加"/"未添加"状态标签
  4. 返回用户选中的子项ID列表

## 功能特点

1. **向后兼容**：不传 `templateId` 时，接口行为与原来完全一致
2. **灵活性高**：前端可以自由选择是否传入 `templateId` 参数
3. **用户体验好**：通过标记而非筛选，用户可以看到所有可选子项及其状态
4. **实现简单**：在Service层通过内存标记实现，无需修改SQL或Mapper

## 典型应用场景

### 场景：子系统模板管理页面 - 添加子项功能

1. 用户点击"添加子项"按钮
2. 弹出子项选择对话框
3. 对话框调用接口时传入当前模板的 `templateId`
4. 接口返回所有子项，并标记已添加的子项
5. 前端自动勾选 `isAdded=true` 的行
6. 用户可以：
   - 取消已添加的子项（删除关联）
   - 勾选未添加的子项（新增关联）
7. 用户点击确定后，前端根据勾选状态调用相应的添加/删除接口

## 版本信息

-   **修改时间**：2025-01-07
-   **修改人**：开发团队
-   **版本号**：v1.2
-   **功能类型**：增强功能（标记而非筛选）
