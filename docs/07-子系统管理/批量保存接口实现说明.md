# 子项模板物料批量保存接口 - 前端实现说明

## 实现概述

根据接口文档 `子项模板物料批量保存接口文档.md`，已完成前端API接口的实现。

## 实现内容

### 1. 类型定义 (`src/api/erp/subsystem/types.ts`)

新增了两个TypeScript接口类型：

#### BatchSaveMaterialsRequest
批量保存请求参数类型，包含三个字段：
- `toDelete`: 待删除的物料ID列表
- `toUpdate`: 待更新的物料列表
- `toInsert`: 待新增的物料列表（不包含id字段）

```typescript
export interface BatchSaveMaterialsRequest {
  toDelete: Array<string | number>;
  toUpdate: SubsystemMaterialTemplateForm[];
  toInsert: Omit<SubsystemMaterialTemplateForm, 'id'>[];
}
```

#### BatchSaveMaterialsResponse
批量保存响应结果类型，包含操作统计和错误信息：
- `deleteCount`: 成功删除的数量
- `updateCount`: 成功更新的数量
- `insertCount`: 成功新增的数量
- `errors`: 错误信息列表

```typescript
export interface BatchSaveMaterialsResponse {
  deleteCount: number;
  updateCount: number;
  insertCount: number;
  errors: string[];
}
```

### 2. API接口函数 (`src/api/erp/subsystem/item-template.ts`)

新增了 `batchSaveMaterials` 函数：

```typescript
export const batchSaveMaterials = (
  itemTemplateId: string | number,
  data: BatchSaveMaterialsRequest
): AxiosPromise<BatchSaveMaterialsResponse> => {
  return request({
    url: `/erp/subsystem/item-template/${itemTemplateId}/materials/batch-save`,
    method: 'post',
    data
  });
};
```

**特点：**
- 支持 `string | number` 类型的ID，避免雪花算法长整数精度丢失
- 使用POST方法，路径参数传递子项模板ID
- 请求体包含批量操作数据
- 返回详细的操作结果统计

### 3. 使用示例 (`docs/07-子系统管理/批量保存接口-前端使用示例.vue`)

提供了完整的Vue 3组件示例，展示如何使用该接口：

**示例场景：**
1. 删除2个物料
2. 更新1个物料的配置
3. 新增2个物料

**关键代码：**
```typescript
import { batchSaveMaterials } from '@/api/erp/subsystem/item-template';
import type { BatchSaveMaterialsRequest } from '@/api/erp/subsystem/types';

const response = await batchSaveMaterials(itemTemplateId, {
  toDelete: ['1991410308442198000', '1991410308442198001'],
  toUpdate: [{ id: '1991410308442198002', ... }],
  toInsert: [{ materialId: 100002, ... }]
});
```

## 技术要点

### 1. 类型安全
- 使用TypeScript严格类型定义
- 利用 `Omit` 工具类型确保新增数据不包含id字段
- 所有ID字段支持 `string | number` 类型

### 2. 精度处理
- 雪花算法生成的ID使用字符串传输
- 避免JavaScript Number类型的精度丢失问题
- 示例代码中明确标注使用字符串的原因

### 3. 错误处理
- 接口支持部分成功场景
- 返回详细的错误信息列表
- 前端可根据errors数组判断是否有失败项

### 4. 事务一致性
- 后端在一个事务中执行所有操作
- 执行顺序：删除 -> 更新 -> 新增
- 确保数据一致性

## 使用建议

### 1. 在编辑页面中的应用

建议维护三个响应式数组来跟踪变更：

```typescript
const deletedMaterialIds = ref<Array<string | number>>([]);
const modifiedMaterials = ref<any[]>([]);
const newMaterials = ref<any[]>([]);
```

### 2. 变更检测

只提交实际修改过的数据，减少不必要的更新操作：

```typescript
// 检测物料是否被修改
const isModified = (material: any) => {
  return material.defaultQuantity !== originalQuantity ||
         material.isRequired !== originalIsRequired;
};
```

### 3. 用户反馈

根据响应结果给用户明确的反馈：

```typescript
if (errors && errors.length > 0) {
  ElMessage.warning(`保存完成，但有${errors.length}个错误`);
  console.error('错误详情：', errors);
} else {
  ElMessage.success('保存成功');
}
```

## 接口规范

- **接口路径**: `POST /erp/subsystem/item-template/{itemTemplateId}/materials/batch-save`
- **权限要求**: `erp:subsystem:template:edit`
- **请求方式**: POST
- **内容类型**: application/json

## 文件清单

1. `src/api/erp/subsystem/types.ts` - 类型定义
2. `src/api/erp/subsystem/item-template.ts` - API接口函数
3. `docs/07-子系统管理/批量保存接口-前端使用示例.vue` - 使用示例
4. `docs/07-子系统管理/批量保存接口实现说明.md` - 本文档

## 版本信息

- **实现日期**: 2025-11-21
- **实现者**: Augment Agent
- **基于文档**: 子项模板物料批量保存接口文档 v1.0

## 后续工作

建议在实际的子项模板编辑页面中集成此接口，替代原有的单个操作接口，提升用户体验和数据一致性。

