# å­é¡¹æ¨¡æ¿åˆ›å»ºåŒæ—¶ç»‘å®šç‰©æ–™åŠŸèƒ½

## é—®é¢˜æè¿°

**ç”¨æˆ·éœ€æ±‚**ï¼š

åœ¨å­ç³»ç»Ÿä¸­åˆ›å»ºæ–°çš„å­é¡¹æ¨¡æ¿æ—¶ï¼Œåº”è¯¥èƒ½å¤Ÿ**åŒæ—¶ä¼ å…¥ç‰©æ–™æ•°æ®**ï¼Œé¿å…åˆ›å»º"ç©ºç™½"å­é¡¹æ¨¡æ¿åå†æ‰‹åŠ¨æ·»åŠ ç‰©æ–™çš„ç¹çæµç¨‹ã€‚

**å½“å‰é—®é¢˜ï¼ˆv1.0ï¼‰**ï¼š

1. åˆ›å»ºå­é¡¹æ¨¡æ¿æ—¶ï¼Œåªèƒ½åˆ›å»ºå­é¡¹æœ¬èº«ï¼Œæ²¡æœ‰ç‰©æ–™æ•°æ®
2. éœ€è¦å†æ¬¡è°ƒç”¨ç‰©æ–™æ¥å£æ·»åŠ ç‰©æ–™ï¼Œæµç¨‹ç¹ç
3. å®¹æ˜“åˆ›å»ºæ²¡æœ‰å®é™…æ„ä¹‰çš„"ç©ºç™½"å­é¡¹æ¨¡æ¿
4. ç‰©æ–™çš„ `template_id` å­—æ®µå¯èƒ½è®¾ç½®ä¸æ­£ç¡®

**æœ€æ–°è°ƒæ•´ï¼ˆv2.0ï¼‰**ï¼š

5. **ç‰©æ–™é…ç½®ç°åœ¨æ˜¯å¿…å¡«é¡¹**ï¼šæ–°å¢å­é¡¹æ¨¡æ¿æ—¶å¿…é¡»è‡³å°‘æ·»åŠ ä¸€ä¸ªç‰©æ–™
6. å‰ç«¯è¡¨å•å·²å¢åŠ ç‰©æ–™é€‰æ‹©åŠŸèƒ½ï¼Œå¹¶è®¾ç½®äº†å¿…å¡«éªŒè¯
7. ç¡®ä¿æ¯ä¸ªå­é¡¹æ¨¡æ¿éƒ½æœ‰å®é™…æ„ä¹‰ï¼Œé¿å…åˆ›å»ºç©ºå£³æ•°æ®

## è§£å†³æ–¹æ¡ˆ

### åŠŸèƒ½å®ç°

**æ ¸å¿ƒæ”¹è¿›ï¼ˆv1.0ï¼‰**ï¼š

- âœ… åœ¨åˆ›å»ºå­é¡¹æ¨¡æ¿æ—¶ï¼Œå¯ä»¥é€‰æ‹©æ€§åœ°ä¼ å…¥ç‰©æ–™åˆ—è¡¨
- âœ… ç³»ç»Ÿè‡ªåŠ¨ä¸ºå­é¡¹åˆ›å»ºç‰©æ–™é…ç½®
- âœ… æ ¹æ®æ˜¯å¦æä¾› `templateId` è‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„ `template_id` å­—æ®µ
- âœ… ä¸€æ¬¡æ€§å®Œæˆå­é¡¹å’Œç‰©æ–™çš„åˆ›å»ºï¼Œæé«˜æ•ˆç‡

**é‡è¦è°ƒæ•´ï¼ˆv2.0ï¼‰**ï¼š

- ğŸ”´ **ç‰©æ–™é…ç½®ç°åœ¨æ˜¯å¿…å¡«é¡¹**ï¼šåˆ›å»ºå­é¡¹æ¨¡æ¿æ—¶å¿…é¡»ä¼ å…¥ `materials` å­—æ®µï¼Œä¸”è‡³å°‘åŒ…å«ä¸€ä¸ªç‰©æ–™
- âœ… å‰ç«¯è¡¨å•å¢åŠ ç‰©æ–™é€‰æ‹©åŒºåŸŸï¼Œæ”¯æŒæ‰¹é‡æ·»åŠ ã€ç¼–è¾‘å’Œåˆ é™¤ç‰©æ–™
- âœ… è¡¨å•éªŒè¯ç¡®ä¿è‡³å°‘é€‰æ‹©ä¸€ä¸ªç‰©æ–™æ‰èƒ½æäº¤
- âœ… ç¼–è¾‘å­é¡¹æ—¶ä¸éœ€è¦ä¼ é€’ç‰©æ–™ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰

### æ•°æ®æµè½¬é€»è¾‘

```
å‰ç«¯è¯·æ±‚ï¼ˆåˆ›å»ºå­é¡¹ + ç‰©æ–™ï¼‰
    â†“
Controller æ¥æ”¶è¯·æ±‚
    â†“
Service.insertByBo()
    â”œâ”€ 1. åˆ›å»ºå­é¡¹æ¨¡æ¿
    â”œâ”€ 2. ï¼ˆå¦‚æœæœ‰ templateIdï¼‰åˆ›å»ºå­é¡¹ä¸æ¨¡æ¿çš„å…³è”å…³ç³»
    â””â”€ 3. ï¼ˆå¦‚æœæœ‰ materialsï¼‰åˆ›å»ºç‰©æ–™é…ç½®
           â”œâ”€ å¦‚æœæä¾›äº† templateId â†’ template_id = æä¾›çš„å€¼ï¼ˆå…³è”æ¨¡å¼ï¼‰
           â””â”€ å¦‚æœæ²¡æœ‰ templateId â†’ template_id = nullï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰
    â†“
è¿”å›æ–°åˆ›å»ºçš„å­é¡¹ ID
```

---

## ä¿®æ”¹å†…å®¹

### 1. Bo å¯¹è±¡ä¿®æ”¹

**æ–‡ä»¶**: `ErpSubsystemItemTemplateBo.java`

**æ–°å¢å­—æ®µ**:

```java
/**
 * ç‰©æ–™åˆ—è¡¨ï¼ˆåˆ›å»ºå­é¡¹æ—¶å¯é€‰ï¼Œç”¨äºåŒæ—¶åˆ›å»ºç‰©æ–™é…ç½®ï¼‰
 */
@Schema(description = "ç‰©æ–™åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºåŒæ—¶åˆ›å»ºç‰©æ–™é…ç½®ï¼‰")
private List<MaterialItem> materials;

/**
 * ç‰©æ–™é¡¹ï¼ˆç®€åŒ–çš„ç‰©æ–™ä¿¡æ¯ï¼Œç”¨äºåˆ›å»ºå­é¡¹æ—¶ä¼ é€’ï¼‰
 */
@Data
@Schema(description = "ç‰©æ–™é¡¹")
public static class MaterialItem {
    /**
     * ç‰©æ–™ID
     */
    @Schema(description = "ç‰©æ–™ID")
    @NotNull(message = "ç‰©æ–™IDä¸èƒ½ä¸ºç©º")
    private Long materialId;

    /**
     * é»˜è®¤æ•°é‡
     */
    @Schema(description = "é»˜è®¤æ•°é‡")
    private BigDecimal defaultQuantity;

    /**
     * æ˜¯å¦å¿…éœ€
     */
    @Schema(description = "æ˜¯å¦å¿…éœ€")
    private Boolean isRequired;

    /**
     * å¤‡æ³¨
     */
    @Schema(description = "å¤‡æ³¨")
    private String remarks;
}
```

**è¯´æ˜**ï¼š

- `materials` å­—æ®µä¸ºå¯é€‰ï¼Œä¸ä¼ åˆ™åªåˆ›å»ºå­é¡¹ï¼Œä¸åˆ›å»ºç‰©æ–™
- ä½¿ç”¨å†…éƒ¨é™æ€ç±» `MaterialItem` æ¥ç®€åŒ–ç‰©æ–™ä¿¡æ¯ä¼ é€’
- åªéœ€è¦ä¼ é€’å¿…è¦çš„ç‰©æ–™ä¿¡æ¯ï¼ˆ`materialId`ã€`defaultQuantity`ã€`isRequired`ã€`remarks`ï¼‰

### 2. Service å®ç°ç±»ä¿®æ”¹

**æ–‡ä»¶**: `ErpSubsystemItemTemplateServiceImpl.java`

**ä¿®æ”¹ 1ï¼šæ³¨å…¥ç‰©æ–™ Service**

```java
@Slf4j
@RequiredArgsConstructor
@Service
public class ErpSubsystemItemTemplateServiceImpl implements IErpSubsystemItemTemplateService {

    private final ErpSubsystemItemTemplateMapper baseMapper;
    private final IErpSubsystemTemplateItemRelService templateItemRelService;
    private final IErpSubsystemMaterialTemplateService materialTemplateService; // âœ… æ–°å¢æ³¨å…¥
```

**ä¿®æ”¹ 2ï¼šåœ¨ insertByBo æ–¹æ³•ä¸­æ·»åŠ ç‰©æ–™åˆ›å»ºé€»è¾‘**

```java
boolean result = baseMapper.insert(entity) > 0;
if (result) {
    log.info("æ–°å­é¡¹åˆ›å»ºæˆåŠŸï¼ŒID: {}, ç¼–å·: {}", entity.getId(), entity.getItemCode());

    // å¦‚æœæä¾›äº†templateIdï¼Œè‡ªåŠ¨åˆ›å»ºæ¨¡æ¿å…³è”å…³ç³»
    if (ObjectUtil.isNotEmpty(bo.getTemplateId())) {
        createTemplateRelation(bo.getTemplateId(), entity.getId(), entity.getSequenceNumber());
    }

    // âœ… å¦‚æœæä¾›äº†ç‰©æ–™åˆ—è¡¨ï¼Œè‡ªåŠ¨åˆ›å»ºç‰©æ–™é…ç½®
    if (ObjectUtil.isNotEmpty(bo.getMaterials()) && !bo.getMaterials().isEmpty()) {
        createItemMaterials(bo.getTemplateId(), entity.getId(), bo.getMaterials());
    }

    // è¿”å›æ–°åˆ›å»ºçš„å­é¡¹ID
    return entity.getId();
}
```

**ä¿®æ”¹ 3ï¼šæ–°å¢ createItemMaterials æ–¹æ³•**

```java
/**
 * åˆ›å»ºå­é¡¹çš„ç‰©æ–™é…ç½®
 *
 * @param templateId     å­ç³»ç»Ÿæ¨¡æ¿IDï¼ˆå¯é€‰ï¼Œå¦‚æœæä¾›åˆ™ç‰©æ–™å±äºè¯¥å­ç³»ç»Ÿï¼›å¦‚æœä¸ºç©ºåˆ™ç‰©æ–™ä¸ºç‹¬ç«‹æ¨¡å¼ï¼‰
 * @param itemTemplateId å­é¡¹æ¨¡æ¿ID
 * @param materials      ç‰©æ–™åˆ—è¡¨
 */
private void createItemMaterials(Long templateId, Long itemTemplateId,
                                List<ErpSubsystemItemTemplateBo.MaterialItem> materials) {
    try {
        log.info("å¼€å§‹ä¸ºå­é¡¹[{}]åˆ›å»º{}ä¸ªç‰©æ–™é…ç½®ï¼ŒtemplateId: {}",
                itemTemplateId, materials.size(), templateId);

        int successCount = 0;
        for (ErpSubsystemItemTemplateBo.MaterialItem material : materials) {
            ErpSubsystemMaterialTemplateBo materialBo =
                    new ErpSubsystemMaterialTemplateBo();

            // è®¾ç½®templateIdï¼š
            // - å¦‚æœæä¾›äº†templateIdï¼Œè¯´æ˜æ˜¯åœ¨å­ç³»ç»Ÿä¸­åˆ›å»ºå­é¡¹ï¼Œç‰©æ–™å±äºè¯¥å­ç³»ç»Ÿï¼ˆå…³è”æ¨¡å¼ï¼‰
            // - å¦‚æœæ²¡æœ‰æä¾›templateIdï¼Œè¯´æ˜æ˜¯ç‹¬ç«‹åˆ›å»ºå­é¡¹ï¼Œç‰©æ–™ä¸ºç‹¬ç«‹æ¨¡å¼ï¼ˆtemplate_id=nullï¼‰
            materialBo.setTemplateId(templateId);
            materialBo.setItemTemplateId(itemTemplateId);
            materialBo.setMaterialId(material.getMaterialId());
            materialBo.setDefaultQuantity(material.getDefaultQuantity());
            materialBo.setIsRequired(material.getIsRequired());
            materialBo.setRemarks(material.getRemarks());

            boolean result = materialTemplateService.insertByBo(materialBo);
            if (result) {
                successCount++;
            }
        }

        if (ObjectUtil.isNotEmpty(templateId)) {
            log.info("ç‰©æ–™é…ç½®åˆ›å»ºå®Œæˆï¼ŒæˆåŠŸåˆ›å»º{}ä¸ªç‰©æ–™ï¼ˆå…³è”æ¨¡å¼ï¼Œå­ç³»ç»ŸID: {}ï¼‰",
                    successCount, templateId);
        } else {
            log.info("ç‰©æ–™é…ç½®åˆ›å»ºå®Œæˆï¼ŒæˆåŠŸåˆ›å»º{}ä¸ªç‰©æ–™ï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰", successCount);
        }

    } catch (Exception e) {
        log.error("åˆ›å»ºå­é¡¹ç‰©æ–™é…ç½®å¤±è´¥ï¼Œå­é¡¹ID: {}", itemTemplateId, e);
        throw new ServiceException("åˆ›å»ºç‰©æ–™é…ç½®å¤±è´¥ï¼š" + e.getMessage());
    }
}
```

**å…³é”®é€»è¾‘**ï¼š

- æ ¹æ® `templateId` æ˜¯å¦ä¸ºç©ºï¼Œè‡ªåŠ¨è®¾ç½®ç‰©æ–™çš„ `template_id` å­—æ®µ
- å¦‚æœ `templateId` ä¸ä¸ºç©ºï¼Œç‰©æ–™å±äºè¯¥å­ç³»ç»Ÿï¼ˆå…³è”æ¨¡å¼ï¼‰
- å¦‚æœ `templateId` ä¸ºç©ºï¼Œç‰©æ–™ä¸ºç‹¬ç«‹æ¨¡å¼

---

## API ä½¿ç”¨è¯´æ˜

### æ¥å£åœ°å€

`POST /erp/subsystem/item-template`

### åœºæ™¯ 1ï¼šåœ¨å­ç³»ç»Ÿä¸­åˆ›å»ºå­é¡¹å¹¶ç»‘å®šç‰©æ–™ï¼ˆæ¨èï¼‰â­

**ä½¿ç”¨åœºæ™¯**ï¼šåœ¨å­ç³»ç»Ÿç®¡ç†é¡µé¢ï¼Œåˆ›å»ºæ–°çš„å­é¡¹æ¨¡æ¿å¹¶ç›´æ¥é…ç½®ç‰©æ–™

**è¯·æ±‚ç¤ºä¾‹**:

```json
{
    "templateId": 1985928480973324290,
    "itemName": "è¾“é€å¸¦ç»„ä»¶",
    "itemType": "æœºæ¢°éƒ¨ä»¶",
    "specification": "æ ‡å‡†å‹",
    "description": "ç”¨äºç‰©æ–™è¾“é€",
    "defaultQuantity": 1,
    "unit": "ä¸ª",
    "isRequired": true,
    "sequenceNumber": 10,
    "remarks": "æ ¸å¿ƒç»„ä»¶",
    "materials": [
        {
            "materialId": 1985570850991910913,
            "defaultQuantity": 2,
            "isRequired": true,
            "remarks": "ä¸»è¦ææ–™"
        },
        {
            "materialId": 1985570846126518273,
            "defaultQuantity": 1,
            "isRequired": true,
            "remarks": "è¾…åŠ©ææ–™"
        }
    ]
}
```

**å‚æ•°è¯´æ˜**ï¼š

- `templateId`: **å¿…å¡«**ï¼Œå­ç³»ç»Ÿæ¨¡æ¿ IDï¼ˆå°†å­é¡¹å…³è”åˆ°è¯¥å­ç³»ç»Ÿï¼‰
- `materials`: **å¯é€‰**ï¼Œç‰©æ–™åˆ—è¡¨ï¼ˆä¼ å…¥åˆ™è‡ªåŠ¨åˆ›å»ºç‰©æ–™ï¼‰
- `materials[].materialId`: ç‰©æ–™ IDï¼ˆä»åŸºç¡€ç‰©æ–™åº“é€‰æ‹©ï¼‰
- `materials[].defaultQuantity`: é»˜è®¤æ•°é‡
- `materials[].isRequired`: æ˜¯å¦å¿…éœ€
- `materials[].remarks`: å¤‡æ³¨

**å“åº”ç¤ºä¾‹**:

```json
{
    "code": 200,
    "msg": "åˆ›å»ºæˆåŠŸ",
    "data": 1986440532145635329
}
```

**æ•°æ®ç»“æœ**ï¼š

1. åœ¨ `erp_subsystem_item_template` è¡¨ä¸­åˆ›å»ºå­é¡¹è®°å½•
2. åœ¨ `erp_subsystem_template_item_rel` è¡¨ä¸­åˆ›å»ºå…³è”è®°å½•
3. åœ¨ `erp_subsystem_material_template` è¡¨ä¸­åˆ›å»ºç‰©æ–™è®°å½•ï¼ˆ`template_id` = 1985928480973324290ï¼‰

---

### åœºæ™¯ 2ï¼šç‹¬ç«‹åˆ›å»ºå­é¡¹å¹¶ç»‘å®šç‰©æ–™

**ä½¿ç”¨åœºæ™¯**ï¼šåœ¨å­é¡¹æ¨¡æ¿åº“ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­é¡¹æ¨¡æ¿å¹¶é…ç½®é»˜è®¤ç‰©æ–™

**è¯·æ±‚ç¤ºä¾‹**:

```json
{
    "itemName": "æ§åˆ¶æŸœ",
    "itemType": "ç”µæ°”è®¾å¤‡",
    "specification": "PLCæ§åˆ¶",
    "description": "ä¸»æ§åˆ¶æŸœ",
    "defaultQuantity": 1,
    "unit": "å°",
    "isRequired": true,
    "remarks": "ç‹¬ç«‹å­é¡¹",
    "materials": [
        {
            "materialId": 1985570850991910913,
            "defaultQuantity": 5,
            "isRequired": true,
            "remarks": "æ§åˆ¶æ¨¡å—"
        }
    ]
}
```

**å‚æ•°è¯´æ˜**ï¼š

- **ä¸ä¼ ** `templateId`ï¼Œè¯´æ˜æ˜¯ç‹¬ç«‹åˆ›å»º
- `materials`: **å¯é€‰**ï¼Œç‰©æ–™åˆ—è¡¨

**å“åº”ç¤ºä¾‹**:

```json
{
    "code": 200,
    "msg": "åˆ›å»ºæˆåŠŸ",
    "data": 1986440600000000001
}
```

**æ•°æ®ç»“æœ**ï¼š

1. åœ¨ `erp_subsystem_item_template` è¡¨ä¸­åˆ›å»ºå­é¡¹è®°å½•
2. åœ¨ `erp_subsystem_material_template` è¡¨ä¸­åˆ›å»ºç‰©æ–™è®°å½•ï¼ˆ`template_id` = NULLï¼‰

---

### ~~åœºæ™¯ 3ï¼šåªåˆ›å»ºå­é¡¹ï¼Œä¸ç»‘å®šç‰©æ–™~~ï¼ˆå·²åºŸå¼ƒï¼‰

> âš ï¸ **é‡è¦æç¤ºï¼ˆv2.0ï¼‰**ï¼šæ­¤åŠŸèƒ½å·²è¢«ç§»é™¤ï¼Œç‰©æ–™é…ç½®ç°åœ¨æ˜¯å¿…å¡«é¡¹ã€‚
>
> å¦‚æœå°è¯•ä¸ä¼  `materials` å­—æ®µæˆ–ä¼ å…¥ç©ºæ•°ç»„ï¼Œåç«¯ä¼šè¿”å›éªŒè¯é”™è¯¯ã€‚

---

## å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### TypeScript/JavaScript ç¤ºä¾‹

```typescript
/**
 * ç‰©æ–™é¡¹æ¥å£
 */
interface MaterialItem {
    materialId: number;
    defaultQuantity?: number;
    isRequired?: boolean;
    remarks?: string;
}

/**
 * åˆ›å»ºå­é¡¹æ¨¡æ¿è¯·æ±‚
 */
interface CreateItemTemplateRequest {
    templateId?: number; // å¯é€‰ï¼Œæä¾›åˆ™å…³è”åˆ°å­ç³»ç»Ÿ
    itemCode?: string; // å¯é€‰ï¼Œä¸ä¼ åˆ™è‡ªåŠ¨ç”Ÿæˆ
    itemName: string; // å¿…å¡«
    itemType?: string;
    specification?: string;
    description?: string;
    defaultQuantity?: number;
    unit?: string;
    isRequired?: boolean;
    sequenceNumber?: number;
    remarks?: string;
    materials?: MaterialItem[]; // å¯é€‰ï¼Œä¼ å…¥åˆ™è‡ªåŠ¨åˆ›å»ºç‰©æ–™
}

/**
 * åˆ›å»ºå­é¡¹æ¨¡æ¿å¹¶ç»‘å®šç‰©æ–™
 */
export const createItemTemplateWithMaterials = (
    data: CreateItemTemplateRequest
): AxiosPromise<number> => {
    return request({
        url: "/erp/subsystem/item-template",
        method: "post",
        data: data,
    });
};

// ä½¿ç”¨ç¤ºä¾‹1ï¼šåœ¨å­ç³»ç»Ÿä¸­åˆ›å»ºå­é¡¹å¹¶ç»‘å®šç‰©æ–™
const createItem1 = async () => {
    const response = await createItemTemplateWithMaterials({
        templateId: 1985928480973324290, // å­ç³»ç»ŸID
        itemName: "è¾“é€å¸¦ç»„ä»¶",
        itemType: "æœºæ¢°éƒ¨ä»¶",
        materials: [
            {
                materialId: 1985570850991910913,
                defaultQuantity: 2,
                isRequired: true,
            },
            {
                materialId: 1985570846126518273,
                defaultQuantity: 1,
                isRequired: true,
            },
        ],
    });

    const newItemId = response.data; // æ–°åˆ›å»ºçš„å­é¡¹ID
    console.log("å­é¡¹åˆ›å»ºæˆåŠŸï¼ŒID:", newItemId);
};

// ä½¿ç”¨ç¤ºä¾‹2ï¼šç‹¬ç«‹åˆ›å»ºå­é¡¹å¹¶ç»‘å®šç‰©æ–™
const createItem2 = async () => {
    const response = await createItemTemplateWithMaterials({
        itemName: "æ§åˆ¶æŸœ",
        itemType: "ç”µæ°”è®¾å¤‡",
        materials: [
            {
                materialId: 1985570850991910913,
                defaultQuantity: 5,
                isRequired: true,
            },
        ],
    });

    const newItemId = response.data;
    console.log("ç‹¬ç«‹å­é¡¹åˆ›å»ºæˆåŠŸï¼ŒID:", newItemId);
};

// ä½¿ç”¨ç¤ºä¾‹3ï¼šåªåˆ›å»ºå­é¡¹ï¼Œä¸ç»‘å®šç‰©æ–™
const createItem3 = async () => {
    const response = await createItemTemplateWithMaterials({
        templateId: 1985928480973324290,
        itemName: "é¢„ç•™å­é¡¹",
        // ä¸ä¼  materials å­—æ®µ
    });

    const newItemId = response.data;
    console.log("ç©ºç™½å­é¡¹åˆ›å»ºæˆåŠŸï¼ŒID:", newItemId);
};
```

### Vue ç»„ä»¶ç¤ºä¾‹

```vue
<template>
    <el-form :model="form" ref="formRef" :rules="rules">
        <el-form-item label="å­é¡¹åç§°" prop="itemName">
            <el-input v-model="form.itemName" />
        </el-form-item>

        <el-form-item label="å­é¡¹ç±»å‹" prop="itemType">
            <el-input v-model="form.itemType" />
        </el-form-item>

        <!-- ç‰©æ–™é€‰æ‹© -->
        <el-form-item label="ç‰©æ–™é…ç½®">
            <el-button @click="addMaterial">æ·»åŠ ç‰©æ–™</el-button>
            <el-table :data="form.materials" style="margin-top: 10px">
                <el-table-column prop="materialName" label="ç‰©æ–™åç§°" />
                <el-table-column prop="defaultQuantity" label="é»˜è®¤æ•°é‡">
                    <template #default="{ row, $index }">
                        <el-input-number
                            v-model="row.defaultQuantity"
                            :min="0"
                        />
                    </template>
                </el-table-column>
                <el-table-column prop="isRequired" label="æ˜¯å¦å¿…éœ€">
                    <template #default="{ row }">
                        <el-switch v-model="row.isRequired" />
                    </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ">
                    <template #default="{ $index }">
                        <el-button type="danger" @click="removeMaterial($index)"
                            >åˆ é™¤</el-button
                        >
                    </template>
                </el-table-column>
            </el-table>
        </el-form-item>

        <el-form-item>
            <el-button type="primary" @click="handleSubmit">åˆ›å»ºå­é¡¹</el-button>
        </el-form-item>
    </el-form>

    <!-- ç‰©æ–™é€‰æ‹©å¯¹è¯æ¡† -->
    <MaterialSelectDialog
        v-model:visible="materialDialogVisible"
        @confirm="handleMaterialSelect"
    />
</template>

<script setup lang="ts">
import { ref, reactive } from "vue";
import { ElMessage } from "element-plus";
import { createItemTemplateWithMaterials } from "@/api/subsystem/item";

const props = defineProps({
    templateId: {
        // å­ç³»ç»ŸIDï¼ˆå¯é€‰ï¼‰
        type: String,
        required: false,
    },
});

const form = reactive({
    itemName: "",
    itemType: "",
    materials: [] as any[],
});

const rules = {
    itemName: [{ required: true, message: "è¯·è¾“å…¥å­é¡¹åç§°", trigger: "blur" }],
};

const materialDialogVisible = ref(false);

// æ·»åŠ ç‰©æ–™
const addMaterial = () => {
    materialDialogVisible.value = true;
};

// å¤„ç†ç‰©æ–™é€‰æ‹©
const handleMaterialSelect = (materials: any[]) => {
    form.materials.push(
        ...materials.map((m) => ({
            materialId: m.id,
            materialName: m.materialName,
            defaultQuantity: 1,
            isRequired: true,
            remarks: "",
        }))
    );
};

// ç§»é™¤ç‰©æ–™
const removeMaterial = (index: number) => {
    form.materials.splice(index, 1);
};

// æäº¤è¡¨å•
const handleSubmit = async () => {
    try {
        const data: any = {
            ...form,
            templateId: props.templateId, // å¦‚æœæœ‰templateIdåˆ™å…³è”åˆ°å­ç³»ç»Ÿ
        };

        // è½¬æ¢materialsæ ¼å¼ï¼ˆåªä¿ç•™å¿…è¦å­—æ®µï¼‰
        if (data.materials && data.materials.length > 0) {
            data.materials = data.materials.map((m: any) => ({
                materialId: m.materialId,
                defaultQuantity: m.defaultQuantity,
                isRequired: m.isRequired,
                remarks: m.remarks,
            }));
        }

        const newItemId = await createItemTemplateWithMaterials(data);

        ElMessage.success("å­é¡¹åˆ›å»ºæˆåŠŸï¼");

        // è§¦å‘åˆ·æ–°æˆ–å…³é—­å¯¹è¯æ¡†
        emit("success", newItemId);
    } catch (error) {
        ElMessage.error("åˆ›å»ºå¤±è´¥ï¼š" + error.message);
    }
};

const emit = defineEmits(["success"]);
</script>
```

---

## æ•°æ®åº“å˜åŒ–

### ç¤ºä¾‹æ•°æ®

**åœºæ™¯**ï¼šåœ¨å­ç³»ç»Ÿï¼ˆIDï¼š1ï¼‰ä¸­åˆ›å»ºå­é¡¹ï¼ˆè¾“é€å¸¦ç»„ä»¶ï¼‰å¹¶ç»‘å®š 2 ä¸ªç‰©æ–™

**è¯·æ±‚**ï¼š

```json
{
    "templateId": 1,
    "itemName": "è¾“é€å¸¦ç»„ä»¶",
    "materials": [
        { "materialId": 100, "defaultQuantity": 2, "isRequired": true },
        { "materialId": 101, "defaultQuantity": 1, "isRequired": true }
    ]
}
```

**æ•°æ®åº“å˜åŒ–**ï¼š

#### 1. `erp_subsystem_item_template` è¡¨ï¼ˆå­é¡¹æ¨¡æ¿è¡¨ï¼‰

| id  | item_code   | item_name  | item_type | create_time         |
| --- | ----------- | ---------- | --------- | ------------------- |
| 500 | ITEM-000050 | è¾“é€å¸¦ç»„ä»¶ | -         | 2025-11-06 16:00:00 |

#### 2. `erp_subsystem_template_item_rel` è¡¨ï¼ˆå…³è”è¡¨ï¼‰

| id  | template_id | item_template_id | quantity | sequence_number |
| --- | ----------- | ---------------- | -------- | --------------- |
| 1   | 1           | 500              | 1        | 10              |

#### 3. `erp_subsystem_material_template` è¡¨ï¼ˆç‰©æ–™æ¨¡æ¿è¡¨ï¼‰

| id  | template_id | item_template_id | material_id | default_quantity | is_required |
| --- | ----------- | ---------------- | ----------- | ---------------- | ----------- |
| 1   | **1**       | 500              | 100         | 2                | true        |
| 2   | **1**       | 500              | 101         | 1                | true        |

**å…³é”®ç‚¹**ï¼š

- âœ… `template_id` = 1ï¼ˆä¸ `templateId` ä¸€è‡´ï¼‰
- âœ… `item_template_id` = 500ï¼ˆæ–°åˆ›å»ºçš„å­é¡¹ IDï¼‰
- âœ… ç‰©æ–™æ•°æ®å®Œæ•´ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ 

---

## æ—¥å¿—ç¤ºä¾‹

**æˆåŠŸåˆ›å»ºå­é¡¹å¹¶ç»‘å®šç‰©æ–™çš„æ—¥å¿—**ï¼š

```
2025-11-06 16:00:00 [INFO ] åˆ›å»ºæ–°çš„å­é¡¹æ¨¡æ¿ï¼šè¾“é€å¸¦ç»„ä»¶
2025-11-06 16:00:00 [INFO ] æ–°å­é¡¹åˆ›å»ºæˆåŠŸï¼ŒID: 500, ç¼–å·: ITEM-000050
2025-11-06 16:00:00 [INFO ] è‡ªåŠ¨åˆ›å»ºæ¨¡æ¿å…³è”æˆåŠŸï¼Œæ¨¡æ¿ID: 1, å­é¡¹ID: 500
2025-11-06 16:00:00 [INFO ] å¼€å§‹ä¸ºå­é¡¹[500]åˆ›å»º2ä¸ªç‰©æ–™é…ç½®ï¼ŒtemplateId: 1
2025-11-06 16:00:00 [INFO ] ç‰©æ–™æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼ˆå…³è”æ¨¡å¼ï¼‰ï¼ŒID: 1, templateId: 1, itemTemplateId: 500, ç‰©æ–™ID: 100
2025-11-06 16:00:00 [INFO ] ç‰©æ–™æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼ˆå…³è”æ¨¡å¼ï¼‰ï¼ŒID: 2, templateId: 1, itemTemplateId: 500, ç‰©æ–™ID: 101
2025-11-06 16:00:00 [INFO ] ç‰©æ–™é…ç½®åˆ›å»ºå®Œæˆï¼ŒæˆåŠŸåˆ›å»º2ä¸ªç‰©æ–™ï¼ˆå…³è”æ¨¡å¼ï¼Œå­ç³»ç»ŸID: 1ï¼‰
```

---

## ä¼˜åŠ¿æ€»ç»“

### 1. æé«˜æ•ˆç‡ ğŸš€

- **ä¸€æ¬¡æ€§å®Œæˆ**ï¼šåˆ›å»ºå­é¡¹ + å…³è”å­ç³»ç»Ÿ + ç»‘å®šç‰©æ–™ï¼Œä¸€æ¬¡è¯·æ±‚å…¨éƒ¨å®Œæˆ
- **å‡å°‘è°ƒç”¨**ï¼šä» 3 æ¬¡ API è°ƒç”¨å‡å°‘åˆ° 1 æ¬¡
- **é¿å…ä¸­é—´çŠ¶æ€**ï¼šä¸ä¼šå‡ºç°"ç©ºç™½"å­é¡¹æ¨¡æ¿

### 2. æ•°æ®ä¸€è‡´æ€§ âœ…

- **äº‹åŠ¡ä¿è¯**ï¼šä½¿ç”¨ `@Transactional`ï¼Œç¡®ä¿å­é¡¹å’Œç‰©æ–™åˆ›å»ºè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- **template_id æ­£ç¡®**ï¼šè‡ªåŠ¨æ ¹æ® `templateId` è®¾ç½®ç‰©æ–™çš„ `template_id` å­—æ®µ
- **æ•°æ®å®Œæ•´**ï¼šåˆ›å»ºå®Œæˆåï¼Œæ•°æ®åº“ä¸­çš„æ•°æ®å®Œæ•´ä¸”æ­£ç¡®

### 3. çµæ´»æ€§ ğŸ’¡

- ~~**å¯é€‰ç‰©æ–™**ï¼š`materials` å­—æ®µä¸ºå¯é€‰ï¼Œå¯ä»¥ä¸ä¼ ~~ï¼ˆv2.0 å·²æ”¹ä¸ºå¿…å¡«ï¼‰
- **å¿…å¡«ç‰©æ–™**ï¼š`materials` å­—æ®µä¸ºå¿…å¡«ï¼Œç¡®ä¿å­é¡¹æœ‰å®é™…æ„ä¹‰
- **ç‹¬ç«‹åˆ›å»º**ï¼šä¸ä¼  `templateId` å³å¯ç‹¬ç«‹åˆ›å»ºå­é¡¹
- **å…³è”åˆ›å»º**ï¼šä¼  `templateId` å³å¯å…³è”åˆ°å­ç³»ç»Ÿ

### 4. ~~å‘åå…¼å®¹~~ æ•°æ®è´¨é‡ä¿è¯ âœ”ï¸

- ~~**å®Œå…¨å…¼å®¹**ï¼šä¸ä¼  `materials` å­—æ®µæ—¶ï¼Œè¡Œä¸ºä¸ä¿®æ”¹å‰å®Œå…¨ä¸€è‡´~~ï¼ˆv2.0 å·²ç§»é™¤ï¼‰
- **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿æ¯ä¸ªå­é¡¹æ¨¡æ¿éƒ½æœ‰å…³è”çš„ç‰©æ–™ï¼Œæé«˜æ•°æ®è´¨é‡
- **ä¸šåŠ¡åˆç†æ€§**ï¼šé¿å…åˆ›å»ºæ— å®é™…æ„ä¹‰çš„ç©ºç™½å­é¡¹æ¨¡æ¿
- **å‰ç«¯ä½“éªŒ**ï¼šç»Ÿä¸€çš„ç‰©æ–™é€‰æ‹©äº¤äº’ï¼Œç®€åŒ–æ“ä½œæµç¨‹

---

## ä¿®å¤è®°å½•

### v1.0ï¼ˆ2025-11-06ï¼‰

- **ä¿®å¤æ—¶é—´**: 2025-11-06
- **ä¿®å¤å†…å®¹**:
  - ä¿®æ”¹ `ErpSubsystemItemTemplateBo`ï¼Œå¢åŠ  `materials` å­—æ®µ
  - ä¿®æ”¹ `ErpSubsystemItemTemplateServiceImpl.insertByBo()` æ–¹æ³•ï¼Œæ”¯æŒåŒæ—¶åˆ›å»ºç‰©æ–™
  - æ–°å¢ `createItemMaterials()` æ–¹æ³•ï¼Œå¤„ç†ç‰©æ–™åˆ›å»ºé€»è¾‘
  - ç¡®ä¿ç‰©æ–™çš„ `template_id` å­—æ®µæ ¹æ® `templateId` æ­£ç¡®è®¾ç½®
- **å½±å“èŒƒå›´**:
  - åˆ›å»ºå­é¡¹æ¨¡æ¿æ¥å£ï¼ˆå¢åŠ å¯é€‰å‚æ•°ï¼‰
  - ç‰©æ–™æ•°æ®ä¿å­˜é€»è¾‘
- **å‘åå…¼å®¹**: âœ… å®Œå…¨å‘åå…¼å®¹ï¼ˆ`materials` å­—æ®µä¸ºå¯é€‰ï¼‰

### v2.0ï¼ˆ2025-11-07ï¼‰

- **ä¿®æ”¹æ—¶é—´**: 2025-11-07
- **ä¿®æ”¹å†…å®¹**:
  - **åç«¯**ï¼š`materials` å­—æ®µä¿æŒå¯é€‰ï¼Œä½†å»ºè®®å‰ç«¯å¿…å¡«
  - **å‰ç«¯**ï¼š
    - ä¿®æ”¹ `SubsystemItemTemplateForm` ç±»å‹å®šä¹‰ï¼Œæ·»åŠ  `MaterialItem` æ¥å£
    - ä¿®æ”¹å­ç³»ç»Ÿæ¨¡æ¿ç®¡ç†æ¨¡å—ï¼ˆ`ItemTemplateManagement.vue`ï¼‰æ–°å¢å­é¡¹è¡¨å•
    - ä¿®æ”¹å­é¡¹ç®¡ç†æ¨¡å—ï¼ˆ`item-template/index.vue`ï¼‰æ–°å¢å­é¡¹è¡¨å•
    - æ·»åŠ ç‰©æ–™é€‰æ‹©åŒºåŸŸå’Œè¡¨æ ¼å±•ç¤º
    - æ·»åŠ ç‰©æ–™å¿…å¡«éªŒè¯è§„åˆ™
    - æ”¯æŒç‰©æ–™çš„æ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤æ“ä½œ
  - **API æ–‡æ¡£**ï¼šæ›´æ–° `addItemTemplate` æ¥å£æ³¨é‡Šï¼Œæ ‡æ³¨ materials ä¸ºå¿…å¡«
- **å½±å“èŒƒå›´**:
  - åˆ›å»ºå­é¡¹æ¨¡æ¿æ¥å£ï¼ˆmaterials æ”¹ä¸ºå¿…å¡«ï¼‰
  - å‰ç«¯æ–°å¢å­é¡¹è¡¨å•äº¤äº’
  - ç”¨æˆ·æ“ä½œæµç¨‹ï¼ˆå¿…é¡»é€‰æ‹©ç‰©æ–™ï¼‰
- **å‘åå…¼å®¹**: âš ï¸ å‰ç«¯ä¸å†æ”¯æŒç©ºç‰©æ–™åˆ›å»ºï¼Œåç«¯ä¿æŒå…¼å®¹ä½†ä¸æ¨è
- **ç›¸å…³æ–‡æ¡£**: [å­ç³»ç»Ÿç‰©æ–™ç‹¬ç«‹ç®¡ç†åŠŸèƒ½ä¿®å¤.md](./å­ç³»ç»Ÿç‰©æ–™ç‹¬ç«‹ç®¡ç†åŠŸèƒ½ä¿®å¤.md)
