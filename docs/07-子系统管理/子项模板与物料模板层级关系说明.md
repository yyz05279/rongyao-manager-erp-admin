# 子项模板与物料模板层级关系说明

## 文档概述

本文档说明子项模板与物料模板的正确层级关系，以及为什么物料模板应该作为子项模板的附属功能，而不是独立的菜单。

## 层级关系

### 正确的层级结构

```
子系统模板
  └─ 子项模板
      └─ 物料模板（附属）
```

### 数据关系说明

1. **子系统模板**：定义子系统的整体结构

   - 包含多个子项模板
   - 作为模板可以被项目实例化

2. **子项模板**：子系统的组成部分

   - 属于某个子系统模板
   - 每个子项有特定的功能和用途
   - 需要关联物料清单

3. **物料模板**：子项所需的物料
   - **必须关联到具体的子项**
   - 不能独立存在
   - 数量、规格等信息与子项绑定

## 为什么物料不能独立管理

### 业务逻辑层面

1. **物料的依附性**

   - 物料是为了完成某个子项而存在的
   - 离开子项，物料失去了业务意义
   - 物料的数量和规格是针对特定子项的

2. **实际使用场景**
   - 用户在设计子项时，同时会考虑需要哪些物料
   - 查看子项时，必然需要查看其物料清单
   - 管理子项时，自然需要调整物料配置

### 数据模型层面

```typescript
// 子项模板包含物料列表
interface SubsystemItemTemplate {
  id: number;
  itemCode: string;
  itemName: string;
  templateId: number;  // 所属子系统模板
  materials: SubsystemMaterialTemplate[];  // 关联的物料
}

// 物料模板必须指定所属子项
interface SubsystemMaterialTemplate {
  id: number;
  itemTemplateId: number;  // 必须字段：所属子项
  materialId: number;       // 关联基础物料库
  materialName: string;     // 物料名称（从基础物料库获取，只读）
  materialCode: string;     // 物料编号（从基础物料库获取，只读）
  specification: string;    // 规格（从基础物料库获取，只读）
  unit: string;             // 单位（从基础物料库获取，只读）
  quantity: number;         // 数量（可编辑）
  remark?: string;          // 备注（可编辑）
  // ... 其他属性
}
```

从数据模型可以看出：

- 物料必须通过 `itemTemplateId` 关联到子项
- 子项可以直接包含物料列表
- 物料是子项的组成部分

## 菜单设计

### 推荐方案（当前采用）

```
子系统管理（一级目录）
  ├── 子系统列表
  ├── 子系统模板
  └── 子项模板管理
      └── 物料管理（在子项详情中）
```

**优势**：

- ✅ 层级清晰，符合业务逻辑
- ✅ 操作便捷，减少页面跳转
- ✅ 数据一致性强
- ✅ 权限管理简单

### 不推荐方案

```
子系统管理（一级目录）
  ├── 子系统列表
  ├── 子系统模板
  ├── 子项模板管理
  └── 物料模板管理（独立菜单）❌
```

**问题**：

- ❌ 层级关系不清晰
- ❌ 增加菜单复杂度
- ❌ 用户需要在多个页面间跳转
- ❌ 物料与子项的关系不直观

## 实现方案

### 前端实现

#### 1. 子项模板列表页面

```vue
<template>
  <div class="item-template-list">
    <!-- 子项列表 -->
    <el-table :data="itemList">
      <el-table-column prop="itemName" label="子项名称" />
      <el-table-column prop="itemCode" label="子项编号" />
      <el-table-column label="操作">
        <template #default="{ row }">
          <!-- 编辑子项 -->
          <el-button
            type="primary"
            link
            @click="handleEdit(row)"
            v-hasPermi="['erp:subsystem:template:edit']"
          >
            编辑
          </el-button>

          <!-- 管理物料 -->
          <el-button
            type="primary"
            link
            @click="handleManageMaterial(row)"
            v-hasPermi="['erp:subsystem:template:material:query']"
          >
            物料管理
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

#### 2. 子项详情/编辑对话框

```vue
<template>
  <el-dialog title="子项详情" v-model="dialogVisible">
    <!-- 子项基本信息 -->
    <el-form :model="itemForm">
      <el-form-item label="子项名称">
        <el-input v-model="itemForm.itemName" />
      </el-form-item>
      <!-- ... 其他字段 -->
    </el-form>

    <!-- 物料清单 -->
    <el-divider>物料清单</el-divider>
    <el-table :data="itemForm.materials">
      <el-table-column prop="materialCode" label="物料编号" width="120" />
      <el-table-column prop="materialName" label="物料名称" min-width="150" />
      <el-table-column prop="specification" label="规格" width="120" />
      <el-table-column prop="unit" label="单位" width="80" />
      <el-table-column prop="quantity" label="数量" width="100" />
      <el-table-column prop="remark" label="备注" min-width="120" show-overflow-tooltip />
      <el-table-column label="操作" width="150" fixed="right">
        <template #default="{ row }">
          <el-button
            type="primary"
            link
            @click="handleEditMaterial(row)"
            v-hasPermi="['erp:subsystem:template:material:edit']"
          >
            编辑数量
          </el-button>
          <el-button
            type="danger"
            link
            @click="handleDeleteMaterial(row)"
            v-hasPermi="['erp:subsystem:template:material:remove']"
          >
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 添加物料按钮 -->
    <el-button
      type="primary"
      @click="handleAddMaterial"
      v-hasPermi="['erp:subsystem:template:material:add']"
    >
      添加物料
    </el-button>
  </el-dialog>

  <!-- 物料编辑对话框 -->
  <el-dialog title="编辑物料数量" v-model="materialDialogVisible" width="500px">
    <el-form :model="materialForm" label-width="100px">
      <!-- 物料基本信息（只读显示） -->
      <el-form-item label="物料编号">
        <el-input v-model="materialForm.materialCode" disabled />
      </el-form-item>
      <el-form-item label="物料名称">
        <el-input v-model="materialForm.materialName" disabled />
      </el-form-item>
      <el-form-item label="规格">
        <el-input v-model="materialForm.specification" disabled />
      </el-form-item>
      <el-form-item label="单位">
        <el-input v-model="materialForm.unit" disabled />
      </el-form-item>

      <!-- 可编辑字段 -->
      <el-form-item label="数量" required>
        <el-input-number
          v-model="materialForm.quantity"
          :min="0"
          :precision="2"
          controls-position="right"
        />
      </el-form-item>
      <el-form-item label="备注">
        <el-input
          v-model="materialForm.remark"
          type="textarea"
          :rows="3"
          maxlength="200"
          show-word-limit
        />
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="materialDialogVisible = false">取消</el-button>
      <el-button type="primary" @click="handleSaveMaterial">保存</el-button>
    </template>
  </el-dialog>
</template>
```

### API 设计

```typescript
// 子项模板 API
export const getItemTemplate = (id: number): AxiosPromise<SubsystemItemTemplateVO> => {
  return request({
    url: `/erp/subsystem/item-template/${id}`,
    method: 'get'
  });
};

// 获取子项的物料列表
export const getItemMaterials = (itemTemplateId: number): AxiosPromise<SubsystemMaterialTemplateVO[]> => {
  return request({
    url: `/erp/subsystem/item-template/${itemTemplateId}/materials`,
    method: 'get'
  });
};

// 为子项添加物料
export const addMaterialToItem = (itemTemplateId: number, data: SubsystemMaterialTemplateForm): AxiosPromise<void> => {
  return request({
    url: `/erp/subsystem/item-template/${itemTemplateId}/materials`,
    method: 'post',
    data
  });
};

// 更新子项的物料（只能修改数量、备注等关联信息）
export const updateItemMaterial = (materialId: number, data: SubsystemMaterialTemplateForm): AxiosPromise<void> => {
  return request({
    url: `/erp/subsystem/material-template/${materialId}`,
    method: 'put',
    data  // 只包含 quantity、remark 等可编辑字段
  });
};

// 删除子项的物料
export const deleteItemMaterial = (materialId: number): AxiosPromise<void> => {
  return request({
    url: `/erp/subsystem/material-template/${materialId}`,
    method: 'delete'
  });
};
```

### 物料编辑规则说明

#### 数据结构定义

```typescript
// 物料模板表单 - 新增时使用
interface SubsystemMaterialTemplateForm {
  itemTemplateId: number;  // 所属子项ID（必填）
  materialId: number;      // 物料ID（必填，从物料库选择）
  quantity: number;        // 数量（必填）
  remark?: string;         // 备注（可选）
}

// 物料模板更新表单 - 编辑时使用
interface SubsystemMaterialTemplateUpdateForm {
  id: number;              // 物料模板ID（必填）
  quantity: number;        // 数量（可编辑）
  remark?: string;         // 备注（可编辑）
  // 注意：materialId 不可修改，如需更换物料，应删除后重新添加
}
```

#### 编辑限制说明

**可编辑字段**：

- ✅ `quantity`：数量 - 表示该子项需要多少数量的物料
- ✅ `remark`：备注 - 针对该子项使用该物料的特殊说明

**不可编辑字段**（来自基础物料库，只读）：

- ❌ `materialId`：物料 ID - 如需更换物料，请删除后重新添加
- ❌ `materialCode`：物料编号 - 从物料库获取
- ❌ `materialName`：物料名称 - 从物料库获取
- ❌ `specification`：规格 - 从物料库获取
- ❌ `unit`：单位 - 从物料库获取
- ❌ 其他物料基本信息 - 如需修改，请到"物料管理"模块进行

#### 业务逻辑

1. **为什么不能修改物料基本信息？**

   - 物料基本信息统一维护在"物料管理"模块
   - 确保同一物料在不同地方使用时信息一致
   - 避免数据不一致和管理混乱

2. **如何更换物料？**

   - 删除当前物料关联
   - 重新从物料库选择并添加新物料
   - 不支持直接替换，确保操作可追溯

3. **为什么可以修改数量？**
   - 数量是与具体子项相关的信息
   - 不同子项对同一物料的需求数量可能不同
   - 数量是业务配置的核心内容

```

## 权限配置

### 菜单权限

只需要配置子项模板管理菜单：

| 菜单名称     | 权限标识                      | 菜单类型 |
| ------------ | ----------------------------- | -------- |
| 子项模板管理 | `erp:subsystem:template:list` | 菜单 (C) |

### 按钮权限

在子项模板管理菜单下配置按钮权限：

#### 子项操作权限

| 按钮名称 | 权限标识                        | 说明         |
| -------- | ------------------------------- | ------------ |
| 子项查询 | `erp:subsystem:template:query`  | 查询子项列表 |
| 子项新增 | `erp:subsystem:template:add`    | 新增子项     |
| 子项修改 | `erp:subsystem:template:edit`   | 修改子项     |
| 子项删除 | `erp:subsystem:template:remove` | 删除子项     |
| 子项导出 | `erp:subsystem:template:export` | 导出子项     |

#### 物料操作权限（附属于子项）

| 按钮名称 | 权限标识                                 | 说明                                       |
| -------- | ---------------------------------------- | ------------------------------------------ |
| 物料查询 | `erp:subsystem:template:material:query`  | 查看子项物料列表                           |
| 物料新增 | `erp:subsystem:template:material:add`    | 为子项添加物料（从物料库选择）             |
| 物料修改 | `erp:subsystem:template:material:edit`   | 修改物料数量和备注（不能修改物料基本信息） |
| 物料删除 | `erp:subsystem:template:material:remove` | 从子项中删除物料关联                       |
| 物料导出 | `erp:subsystem:template:material:export` | 导出子项的物料清单                         |

**重要说明**：
- "物料修改"权限只允许修改数量、备注等关联信息
- 物料的基本信息（名称、编号、规格、单位等）来自物料库，不可在此修改
- 如需修改物料基本信息，需要到"物料管理"模块进行，需要相应的物料管理权限

## 用户操作流程

### 场景 1：创建子项并配置物料

1. 用户进入"子项模板管理"页面
2. 点击"新增"按钮，创建新子项
3. 填写子项基本信息（名称、编号等）
4. 在同一页面/对话框中，点击"添加物料"
5. 从物料库中选择物料，设置数量
6. 保存子项（包括关联的物料）

### 场景 2：查看子项的物料清单

1. 用户进入"子项模板管理"页面
2. 在子项列表中找到目标子项
3. 点击"查看详情"或"物料管理"
4. 在子项详情中查看物料清单

### 场景 3：修改子项的物料数量

1. 用户进入"子项模板管理"页面
2. 点击子项的"物料管理"或"查看详情"
3. 在物料列表中找到要修改的物料
4. 点击"编辑数量"按钮
5. 在弹出的对话框中：
   - 查看物料基本信息（物料名称、编号、规格、单位等，灰色显示，不可编辑）
   - 修改数量（必填）
   - 修改备注（可选）
6. 点击"保存"完成修改

**注意**：如需更换物料，应先删除当前物料，再重新添加新物料。

## 与原方案的对比

### 原方案（独立物料管理页面）

**操作流程**：

1. 进入"子项模板管理" → 查看子项
2. 记住子项信息
3. 切换到"物料模板管理"页面
4. 筛选该子项的物料
5. 进行物料操作

**问题**：

- 需要在两个页面间切换
- 上下文丢失，需要记忆信息
- 操作步骤多，效率低

### 新方案（集成物料管理）

**操作流程**：

1. 进入"子项模板管理"
2. 点击子项的"物料管理"
3. 直接在子项上下文中操作物料

**优势**：

- 一个页面完成所有操作
- 上下文清晰，不需要切换
- 操作步骤少，效率高

## 总结

### 核心原则

> **物料模板是子项模板的组成部分，不应该独立管理**

### 设计要点

1. **业务优先**：设计应该符合业务逻辑
2. **用户体验**：减少页面跳转，提高操作效率
3. **数据一致性**：确保物料始终与子项关联
4. **权限清晰**：物料权限作为子项权限的延伸

### 实施建议

1. **前端开发**：在子项详情/编辑页面中集成物料管理功能
2. **API 设计**：提供基于子项的物料操作接口
3. **权限配置**：将物料权限配置在子项模板管理下
4. **用户培训**：向用户说明物料在子项中管理的逻辑

## 相关文档

- [子系统管理模块使用指南](./子系统管理模块使用指南.md)
- [子系统管理模块完整 API 文档](./子系统管理模块完整API文档.md)
- [菜单权限配置图解](./菜单权限配置图解.md)

## 文档信息

| 项目     | 信息       |
| -------- | ---------- |
| 文档版本 | v1.0       |
| 创建日期 | 2025-11-05 |
| 最后更新 | 2025-11-05 |
| 作者     | haitang    |
| 状态     | 正式发布   |

---

**注意事项**：

- 本文档说明了推荐的设计方案，实际实现可根据具体需求调整
- 如需独立的物料管理页面用于特殊场景（如批量操作），可以保留但不作为主要入口
- 建议在前端实现中，提供多种物料管理的入口方式，但主要入口应该是在子项详情中
```
