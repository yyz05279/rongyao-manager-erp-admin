# 子项模板物料删除接口文档

## 修复说明

**问题**: 原接口 `DELETE /erp/subsystem/item-template/{itemTemplateId}/materials/{ids}` 存在以下问题：

1. 路径参数 `{ids}` 定义为数组，但实际调用时传入单个 ID 导致解析失败
2. 返回通用错误消息 "操作失败"，无法定位具体问题
3. 缺少详细的日志记录

**修复方案**:

-   新增单个删除接口，支持删除单个物料
-   保留批量删除接口，支持一次删除多个物料
-   改进错误消息，提供详细的失败原因
-   添加完整的日志记录

---

## API 接口

### 1. 删除单个物料

**接口地址**: `DELETE /erp/subsystem/item-template/{itemTemplateId}/materials/{id}`

**请求参数**:

-   `itemTemplateId` (路径参数, Long, 必填): 子项模板 ID
-   `id` (路径参数, Long, 必填): 物料模板 ID

**成功响应**:

```json
{
    "code": 200,
    "msg": "删除成功",
    "data": null
}
```

**失败响应**:

```json
{
    "code": 500,
    "msg": "删除失败：物料不存在或已被删除",
    "data": null
}
```

**异常响应**:

```json
{
    "code": 500,
    "msg": "删除失败：[具体错误信息]",
    "data": null
}
```

---

### 2. 批量删除物料（推荐）

**接口地址**: `DELETE /erp/subsystem/item-template/{itemTemplateId}/materials`

**请求参数**:

-   `itemTemplateId` (路径参数, Long, 必填): 子项模板 ID
-   请求体（Request Body, JSON）:

```json
{
    "ids": [1986701662441382000, 1991405647429603300, 1991405647429603301],
    "reason": "批量清理（可选）",
    "force": false
}
```

**成功响应**:

```json
{
    "code": 200,
    "msg": "成功删除3个物料",
    "data": null
}
```

**失败响应**:

```json
{
    "code": 500,
    "msg": "删除失败：部分或全部物料不存在",
    "data": null
}
```

> 说明：出于 URL 长度限制与扩展性考虑，批量删除改为在请求体中传递 ID 列表。

---

## 前端调用示例

### TypeScript API 定义

```typescript
// src/api/erp/subsystem/itemTemplate.ts

import request from "@/utils/request";

/**
 * 删除单个子项模板物料
 * @param itemTemplateId 子项模板ID
 * @param materialId 物料模板ID
 */
export const deleteItemMaterial = (
    itemTemplateId: number,
    materialId: number
) => {
    return request({
        url: `/erp/subsystem/item-template/${itemTemplateId}/materials/${materialId}`,
        method: "delete",
    });
};

/**
 * 批量删除子项模板物料
 * @param itemTemplateId 子项模板ID
 * @param materialIds 物料模板ID数组
 */
export const batchDeleteItemMaterials = (
    itemTemplateId: number,
    materialIds: number[]
) => {
    return request({
        url: `/erp/subsystem/item-template/${itemTemplateId}/materials/batch/${materialIds.join(
            ","
        )}`,
        method: "delete",
    });
};
```

### Vue 组件使用示例

```vue
<template>
    <div>
        <!-- 单个删除按钮 -->
        <el-button
            type="danger"
            size="small"
            @click="handleDelete(row.itemTemplateId, row.id)"
        >
            删除
        </el-button>

        <!-- 批量删除按钮 -->
        <el-button
            type="danger"
            :disabled="multipleSelection.length === 0"
            @click="handleBatchDelete"
        >
            批量删除
        </el-button>
    </div>
</template>

<script setup lang="ts">
import { ref } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import {
    deleteItemMaterial,
    batchDeleteItemMaterials,
} from "@/api/erp/subsystem/itemTemplate";

const multipleSelection = ref<any[]>([]);
const itemTemplateId = ref<number>(1986239297161666561);

// 单个删除
const handleDelete = (templateId: number, materialId: number) => {
    ElMessageBox.confirm("确认删除该物料吗？", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
    }).then(() => {
        deleteItemMaterial(templateId, materialId)
            .then((response) => {
                ElMessage.success(response.msg || "删除成功");
                getList(); // 刷新列表
            })
            .catch((error) => {
                ElMessage.error(error.msg || "删除失败");
            });
    });
};

// 批量删除
const handleBatchDelete = () => {
    const ids = multipleSelection.value.map((item) => item.id);
    ElMessageBox.confirm(`确认删除选中的 ${ids.length} 个物料吗？`, "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning",
    }).then(() => {
        batchDeleteItemMaterials(itemTemplateId.value, ids)
            .then((response) => {
                ElMessage.success(response.msg || "删除成功");
                getList(); // 刷新列表
            })
            .catch((error) => {
                ElMessage.error(error.msg || "删除失败");
            });
    });
};
</script>
```

---

## cURL 测试示例

### 删除单个物料

```bash
curl -X DELETE \
  'http://localhost:8080/erp/subsystem/item-template/1986239297161666561/materials/1991405647429603300' \
  -H 'Content-Type: application/json'
```

### 批量删除物料

```bash
curl -X DELETE \
  'http://localhost:8080/erp/subsystem/item-template/1986239297161666561/materials/batch/1991405647429603300,1991405647429603301,1991405647429603302' \
  -H 'Content-Type: application/json'
```

---

## 测试脚本

运行测试脚本验证修复：

```bash
./scripts/test-delete-item-material-fix.sh
```

---

## 日志输出示例

### 成功删除

```
2025-11-20 16:42:33 [XNIO-1 task-2] INFO  c.h.e.c.s.ErpSubsystemItemTemplateController - 删除子项物料成功，itemTemplateId: 1986239297161666561, materialId: 1991405647429603300
```

### 删除失败（物料不存在）

```
2025-11-20 16:42:33 [XNIO-1 task-2] WARN  c.h.e.c.s.ErpSubsystemItemTemplateController - 删除子项物料失败，物料不存在或已被删除，itemTemplateId: 1986239297161666561, materialId: 9999999999999999999
```

### 批量删除成功

```
2025-11-20 16:42:33 [XNIO-1 task-2] INFO  c.h.e.c.s.ErpSubsystemItemTemplateController - 批量删除子项物料成功，itemTemplateId: 1986239297161666561, 删除数量: 3
```

---

## 注意事项

1. **权限要求**: 需要 `erp:subsystem:template:remove` 权限
2. **ID 格式**: 批量删除时，多个 ID 使用逗号分隔，不要有空格
3. **错误处理**: 前端应正确处理错误消息，向用户展示具体的失败原因
4. **日志追踪**: 所有删除操作都会记录日志，便于问题追踪
