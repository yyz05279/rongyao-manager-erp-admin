# 子系统模板表单组件修改说明

## 修改概述

**修改日期：** 2025-01-20  
**修改版本：** v1.1  
**相关文档：** `ERP 子系统模板修改基础信息API 文档.md`

## 修改目标

根据后端 API v1.1 规范，修改子系统模板表单组件，实现基础信息修改功能，避免重复添加子项的问题。

## 修改内容

### 1. API 接口层修改

**文件：** `/src/api/erp/subsystem/template.ts`

#### 1.1 更新 `updateSubsystemTemplate` 接口注释

```typescript
/**
 * 修改子系统模板基础信息 ⭐️ v1.1 修复后
 * 功能说明：
 * - ✅ 仅更新模板的基础信息字段（名称、描述、备注、状态等）
 * - ❌ 不处理子项列表（即使传入items字段也会被忽略）
 * - 🎯 适用场景：更新模板名称、添加备注、修改描述等基础信息维护操作
 * 
 * 注意事项：
 * 1. 必须传入 id 字段
 * 2. 只会更新传入的字段，未传入的字段保持不变
 * 3. 不会影响已有的子项列表
 */
```

#### 1.2 新增 `updateSubsystemTemplateItems` 接口

```typescript
/**
 * 更新子系统模板子项列表 ⭐️ v1.1 新增接口
 * 功能说明：
 * - ✅ 专门用于更新模板的子项配置
 * - ❌ 不影响模板的基础信息
 * - 🎯 适用场景：添加/修改子项、调整子项顺序、设置子项数量等
 * 
 * 注意事项：
 * 1. 此操作会替换模板的所有子项（全量更新）
 * 2. 如果需要增量更新，请先查询现有子项，然后合并后再提交
 * 3. 传入空数组会清空所有子项
 */
export const updateSubsystemTemplateItems = (
  templateId: string | number,
  items: Array<{
    itemTemplateId: number;
    quantity?: number;
    sequenceNumber?: number;
    isRequired?: boolean;
    remarks?: string;
  }>
): AxiosPromise<void> => {
  return request({
    url: `/erp/subsystem/template/${templateId}/items`,
    method: 'put',
    data: items
  });
};
```

### 2. 表单组件层修改

**文件：** `/src/views/erp/subsystem/template/components/SubsystemTemplateForm.vue`

#### 2.1 添加组件说明注释

在 `<script setup>` 标签后添加详细的组件功能说明，明确组件的职责范围。

#### 2.2 修改 `submitForm` 函数

**修改前：**
```typescript
if (form.id) {
  await updateSubsystemTemplate(form);
  ElMessage.success('修改成功');
}
```

**修改后：**
```typescript
if (form.id) {
  // 编辑模式：仅更新基础信息
  // 构建基础信息对象，确保不包含子项列表
  const baseInfo: SubsystemTemplateForm = {
    id: form.id,
    templateCode: form.templateCode,
    templateName: form.templateName,
    category: form.category,
    description: form.description,
    isStandard: form.isStandard,
    version: form.version,
    status: form.status,
    sourceProjectId: form.sourceProjectId,
    relatedProductId: form.relatedProductId,
    remarks: form.remarks
    // 注意：不传入 items 字段
  };
  
  await updateSubsystemTemplate(baseInfo);
  ElMessage.success('修改成功');
}
```

#### 2.3 改进错误处理

```typescript
catch (error: any) {
  console.error('提交失败:', error);
  // 提供更详细的错误信息
  const errorMessage = error?.response?.data?.msg || error?.message || '操作失败';
  ElMessage.error(errorMessage);
}
```

## 功能说明

### 组件职责

**SubsystemTemplateForm 组件负责：**
- ✅ 子系统模板基础信息的新增
- ✅ 子系统模板基础信息的编辑
- ❌ 不负责子项列表的管理

**基础信息包括：**
- 模板编号（自动生成）
- 模板名称
- 分类
- 版本号
- 状态（草稿/启用/停用/归档）
- 是否标准模板
- 描述信息
- 备注信息

### API 调用规范

1. **新增模板：** `POST /erp/subsystem/template`
   - 可以同时传入子项列表（items字段）
   - 一次性创建模板和子项

2. **编辑基础信息：** `PUT /erp/subsystem/template`
   - 仅更新基础信息
   - 不影响已有的子项列表
   - items字段会被后端忽略

3. **更新子项列表：** `PUT /erp/subsystem/template/{id}/items`
   - 由独立的子项管理组件调用
   - 全量更新子项列表
   - 不影响基础信息

## 测试验证

### 测试场景 1：新增模板
1. 打开新增模板对话框
2. 填写基础信息
3. 提交表单
4. 验证模板创建成功

### 测试场景 2：编辑基础信息
1. 选择一个已有模板进行编辑
2. 修改模板名称、描述或备注
3. 提交表单
4. 验证基础信息更新成功
5. **重点验证：** 子项列表没有被重复添加

### 测试场景 3：错误处理
1. 尝试提交空的模板名称
2. 验证表单验证提示正确
3. 模拟网络错误
4. 验证错误提示信息清晰

## 注意事项

1. **接口分离：** 基础信息更新和子项更新已分离为两个独立接口
2. **向后兼容：** 新增模式仍然支持同时传入子项列表
3. **职责明确：** 此表单组件仅负责基础信息维护
4. **类型安全：** 使用 TypeScript 确保类型正确
5. **错误处理：** 提供详细的错误信息反馈

## 相关文件

- API 文档：`/docs/07-子系统管理/ERP 子系统模板修改基础信息API 文档.md`
- API 接口：`/src/api/erp/subsystem/template.ts`
- 表单组件：`/src/views/erp/subsystem/template/components/SubsystemTemplateForm.vue`
- 类型定义：`/src/api/erp/subsystem/types.ts`

