# 子项模板物料批量保存接口文档

## 接口概述

**接口名称**：批量保存子项模板物料（统一处理增删改）

**接口路径**：`POST /erp/subsystem/item-template/{itemTemplateId}/materials/batch-save`

**接口说明**：在一个事务中完成删除、更新、新增操作，确保数据一致性。适用于编辑页面的保存场景。

**权限要求**：`erp:subsystem:template:edit`

---

## 请求参数

### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| itemTemplateId | Long | 是 | 子项模板ID |

### 请求体（JSON）

```json
{
  "toDelete": [1991410308442198000, 1991410308442198001],
  "toUpdate": [
    {
      "id": 1991410308442198002,
      "materialId": 100001,
      "defaultQuantity": 5,
      "isRequired": true,
      "remarks": "更新后的备注"
    }
  ],
  "toInsert": [
    {
      "materialId": 100002,
      "defaultQuantity": 3,
      "isRequired": false,
      "remarks": "新增的物料"
    }
  ]
}
```

### 请求体字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| toDelete | Long[] | 是 | 待删除的ID列表（可以为空数组） |
| toUpdate | Object[] | 是 | 待更新的物料数据列表（可以为空数组） |
| toInsert | Object[] | 是 | 待新增的物料数据列表（可以为空数组） |

**toUpdate/toInsert 对象字段**：

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 更新时必填 | 物料模板ID（新增时不需要） |
| materialId | Long | 是 | 物料ID |
| defaultQuantity | BigDecimal | 是 | 默认数量 |
| isRequired | Boolean | 是 | 是否必需 |
| remarks | String | 否 | 备注 |

---

## 响应结果

### 成功响应（全部成功）

```json
{
  "code": 200,
  "msg": "保存成功：删除2个，更新1个，新增1个，错误0个",
  "data": {
    "deleteCount": 2,
    "updateCount": 1,
    "insertCount": 1,
    "errors": []
  }
}
```

### 成功响应（部分失败）

```json
{
  "code": 200,
  "msg": "保存完成：删除2个，更新1个，新增0个，错误1个",
  "data": {
    "deleteCount": 2,
    "updateCount": 1,
    "insertCount": 0,
    "errors": [
      "新增失败（索引0）: 物料ID不存在"
    ]
  }
}
```

### 失败响应

```json
{
  "code": 500,
  "msg": "保存失败：子项模板ID不能为空",
  "data": null
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | Integer | 响应码（200成功，500失败） |
| msg | String | 响应消息 |
| data | Object | 批量保存结果对象 |
| data.deleteCount | Integer | 成功删除的数量 |
| data.updateCount | Integer | 成功更新的数量 |
| data.insertCount | Integer | 成功新增的数量 |
| data.errors | String[] | 错误信息列表 |

---

## 业务逻辑

### 执行顺序

1. **删除操作**：先删除 toDelete 列表中的记录
2. **更新操作**：再更新 toUpdate 列表中的记录
3. **新增操作**：最后新增 toInsert 列表中的记录

### 事务保证

- 所有操作在一个事务中执行
- 如果发生异常，整个事务回滚
- 单个操作失败不会中断整个流程，会收集错误信息

### 数据校验

- 删除时校验记录是否存在、是否属于该子项模板
- 更新时校验ID是否存在、是否有权限修改
- 新增时校验物料ID是否存在、数据是否合法

---

## 使用示例

### cURL 示例

```bash
curl -X POST 'http://localhost:8080/erp/subsystem/item-template/1986239297161666600/materials/batch-save' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer YOUR_TOKEN' \
  -d '{
    "toDelete": [1991410308442198000],
    "toUpdate": [{
      "id": 1991410308442198002,
      "materialId": 100001,
      "defaultQuantity": 5,
      "isRequired": true
    }],
    "toInsert": [{
      "materialId": 100002,
      "defaultQuantity": 3,
      "isRequired": false
    }]
  }'
```

### 前端调用示例

参见 `docs/api/批量保存接口-前端使用示例.vue`

---

## 注意事项

1. **ID格式**：建议前端使用字符串传输雪花ID，避免JavaScript精度丢失
2. **临时ID**：前端新增数据可以使用负数作为临时ID（如 -Date.now()）
3. **变更检测**：前端应实现变更检测，只提交实际修改过的数据
4. **错误处理**：部分失败时应展示详细的错误信息给用户
5. **事务一致性**：所有操作在一个事务中，要么全部成功，要么全部回滚

---

**文档版本**: v1.0  
**创建时间**: 2025-11-20  
**作者**: Augment Agent

