# 物料清单分页功能实现说明

## 问题描述

物料清单接口返回了 20 条数据，但页面只显示 10 条，无法查看剩余的数据。

## 问题原因

1. **后端分页限制**：API 请求参数 `pageSize` 设置为 10，导致只返回 10 条数据
2. **前端缺少分页组件**：已导入物料列表的表格没有分页控制器
3. **数据未分页处理**：前端显示所有数据时没有进行分页切片

## 解决方案

### 1. 增加 API 请求数据量

**文件**：`src/views/erp/saltprocess/project/components/MaterialDetail.vue`

**修改**：第 398-402 行

```typescript
// 修改前 ❌
const listQuery = ref<MaterialQuery>({
  pageNum: 1,
  pageSize: 10,  // 只请求10条
  projectId: props.projectId
});

// 修改后 ✅
const listQuery = ref<MaterialQuery>({
  pageNum: 1,
  pageSize: 1000,  // 一次性加载所有数据，前端自己分页
  projectId: props.projectId
});
```

### 2. 添加分页状态变量

**位置**：第 380-384 行

```typescript
// 已导入物料列表的分页相关
const importedSheetPageSize = ref(50); // 每页显示50条
const importedSheetPageMap = ref<Record<string, number>>({}); // 每个Sheet的当前页码
const currentImportedSheetPage = ref(1); // 当前Sheet的页码
const currentImportedSheetTotal = ref(0); // 当前Sheet的总记录数
```

### 3. 实现分页数据切片

**函数**：`updateCurrentImportedSheetData`

```typescript
// 更新当前已导入Sheet的显示数据（带分页）
const updateCurrentImportedSheetData = () => {
  requestAnimationFrame(() => {
    const group = importedSheetGroups.value.find(
      g => g.sheetName === activeImportedSheetTab.value
    );

    if (!group) {
      currentImportedSheetData.value = [];
      currentImportedSheetTotal.value = 0;
      currentImportedSheetPage.value = 1;
      return;
    }

    // 更新总记录数
    currentImportedSheetTotal.value = group.materials.length;

    // 获取当前Sheet的页码
    const page = importedSheetPageMap.value[activeImportedSheetTab.value] || 1;
    currentImportedSheetPage.value = page;

    // 计算分页切片
    const start = (page - 1) * importedSheetPageSize.value;
    const end = start + importedSheetPageSize.value;

    // 切片数据
    const newData = group.materials.slice(start, end);
    currentImportedSheetData.value = newData;
  });
};
```

### 4. 添加分页事件处理

**函数**：`handleImportedSheetPagination`

```typescript
// 已导入物料Sheet分页处理
const handleImportedSheetPagination = () => {
  // 更新当前sheet的分页页码
  importedSheetPageMap.value[activeImportedSheetTab.value] = currentImportedSheetPage.value;
  // 更新显示数据
  updateCurrentImportedSheetData();
};
```

### 5. 初始化 Sheet 分页状态

**位置**：`watch(importedSheetGroups, ...)`

```typescript
watch(
  importedSheetGroups,
  (newGroups) => {
    if (newGroups.length > 0) {
      // 初始化每个Sheet的分页映射
      newGroups.forEach(group => {
        if (!importedSheetPageMap.value[group.sheetName]) {
          importedSheetPageMap.value[group.sheetName] = 1;
        }
      });

      // ... 其他逻辑
    }
  },
  { immediate: true }
);
```

### 6. 添加分页组件到模板

**位置**：第 220-227 行

```vue
<el-table
  v-if="activeImportedSheetTab === (group.sheetName || '未分组')"
  v-loading="loading"
  :data="currentImportedSheetData"
  style="width: 100%"
  border
>
  <!-- 表格列... -->
</el-table>

<!-- 分页组件 -->
<pagination
  v-if="currentImportedSheetTotal > importedSheetPageSize"
  v-model:page="currentImportedSheetPage"
  v-model:limit="importedSheetPageSize"
  :total="currentImportedSheetTotal"
  @pagination="handleImportedSheetPagination"
/>
```

### 7. 修正序号显示

**位置**：第 193-197 行

```vue
<!-- 修改前 ❌ -->
<el-table-column type="index" label="序号" width="60" align="center" />

<!-- 修改后 ✅ -->
<el-table-column label="序号" width="60" align="center">
  <template #default="{ $index }">
    {{ (currentImportedSheetPage - 1) * importedSheetPageSize + $index + 1 }}
  </template>
</el-table-column>
```

## 功能特点

### 1. 独立分页

每个 Sheet 标签页**独立维护自己的分页状态**：

- 切换标签页时，记住每个 Sheet 的当前页码
- 回到之前的标签页，停留在上次查看的页码

### 2. 自动显示/隐藏

分页组件**智能显示**：

- 数据 ≤ 50 条：不显示分页
- 数据 > 50 条：显示分页控制器

### 3. 正确的序号

分页后序号**连续且正确**：

- 第 1 页：1, 2, 3, ..., 50
- 第 2 页：51, 52, 53, ..., 100

### 4. 性能优化

使用 `requestAnimationFrame` 和 `shallowRef`：

- 避免阻塞 UI 渲染
- 减少响应式开销
- 提升切换流畅度

## 使用示例

### 场景 1：查看 20 条数据

1. **上传 Excel**，导入 20 条物料数据
2. **页面显示**：标签页显示"电控设备汇总 (20)"
3. **表格展示**：显示前 50 条（实际只有 20 条，全部显示）
4. **分页状态**：不显示分页组件（因为 20 < 50）

### 场景 2：查看 100 条数据

1. **上传 Excel**，导入 100 条物料数据
2. **页面显示**：标签页显示"电控设备汇总 (100)"
3. **表格展示**：显示第 1-50 条
4. **分页控件**：显示"共 100 条，第 1 页 / 共 2 页"
5. **点击下一页**：显示第 51-100 条

### 场景 3：多 Sheet 切换

1. **电控设备汇总**：20 条数据，第 1 页
2. **切换到机械设备汇总**：60 条数据，第 1 页
3. **点击下一页**：显示第 51-60 条
4. **切换回电控设备汇总**：仍然停留在第 1 页

## 配置说明

### 调整每页显示数量

修改 `importedSheetPageSize` 的值：

```typescript
const importedSheetPageSize = ref(50); // 改为你需要的值，如: 20, 100
```

### 调整 API 请求数量

修改 `listQuery.pageSize` 的值：

```typescript
const listQuery = ref<MaterialQuery>({
  pageNum: 1,
  pageSize: 1000, // 根据项目数据量调整
  projectId: props.projectId
});
```

**注意**：

- `pageSize` 要足够大，能包含所有数据
- 如果数据量特别大（>10000 条），建议改为后端分页

## 测试验证

### 测试步骤

1. **清空现有数据**（可选）
2. **上传 Excel 文件**（包含 20+条数据）
3. **等待导入完成**
4. **查看物料列表**
5. **验证分页功能**：
   - 数据 > 50 条时显示分页
   - 点击分页按钮正常切换
   - 序号连续正确
   - 切换标签页记住页码

### 预期结果

- ✅ 所有数据都能查看
- ✅ 分页控制器正常工作
- ✅ 序号正确显示
- ✅ 标签页切换流畅
- ✅ 分页状态独立维护

## 注意事项

### 1. 数据量限制

当前方案适用于数据量 < 10000 条的场景。如果项目物料数据可能超过 10000 条，建议：

- 改为后端分页
- 修改 `loadMaterialList` 函数支持真实分页参数
- 添加搜索/筛选功能减少数据量

### 2. 性能考虑

- 使用 `shallowRef` 减少响应式开销
- 使用 `requestAnimationFrame` 优化渲染
- 使用 `slice` 进行内存切片（高效）

### 3. 用户体验

- 每页 50 条是平衡点（不太多也不太少）
- 分页控件自动显示/隐藏
- 切换标签页时有加载动画
- 序号连续，符合用户预期

## 相关文件

- **主文件**：`src/views/erp/saltprocess/project/components/MaterialDetail.vue`
- **分页组件**：项目通用 `Pagination` 组件

## 更新日期

2025-10-27

## 修复人员

AI 助手
