# 物料明细页面汇总接口集成说明

## 修改概述

根据《物料汇总统计功能开发完成报告》，对项目详情弹窗的物料明细页面进行了以下调整：

### 1. 接口切换

- **原接口**: `/erp/saltprocess/material/list` - 显示物料明细数据
- **新接口**: `/erp/saltprocess/material/summary` - 显示物料汇总数据

### 2. 数据展示变化

#### 调整前

- 显示每个批次的物料明细
- 相同物料的不同批次分别显示
- 支持删除单条物料明细

#### 调整后

- 显示物料汇总统计（不区分批次）
- 相同物料自动合并，显示汇总数量
- 显示批次数量统计
- 只读展示，无编辑/删除操作

### 3. 主要修改内容

#### 3.1 API 文件修改

**文件**: `src/api/erp/saltprocess/material/types.ts`

添加了新的类型定义：

```typescript
/**
 * 物料汇总统计VO
 */
export interface MaterialSummaryVO {
  itemCode?: string;
  itemName: string;           // 物料名称
  specification?: string;     // 规格型号
  equipmentType?: string;     // 设备类型
  quantity: number;           // 汇总数量（所有批次累加）
  unit: string;              // 单位
  batchCount: number;        // 批次数量
  manufacturer?: string;      // 制造商
  model?: string;            // 型号
  // ... 其他字段
}

/**
 * 物料汇总查询参数
 */
export interface MaterialSummaryQuery {
  projectId: number;
  sheetName?: string;
  pageNum?: number;
  pageSize?: number;
}
```

**文件**: `src/api/erp/saltprocess/material/index.ts`

添加了新的接口函数：

```typescript
/**
 * 查询项目物料汇总列表（按物料分组，不区分批次）
 */
export function listMaterialSummary(
  query: MaterialSummaryQuery
): AxiosPromise<{ rows: MaterialSummaryVO[]; total: number }> {
  return request({
    url: '/erp/saltprocess/material/summary',
    method: 'get',
    params: query
  });
}
```

#### 3.2 组件修改

**文件**: `src/views/erp/saltprocess/project/components/MaterialDetail.vue`

##### 导入调整

```typescript
// 移除未使用的导入
- import { parseTime } from '@/utils/ruoyi';
- import { deleteMaterial, updateMaterialItem, batchUpdateMaterialItems } from '@/api/erp/saltprocess/material';
- import { WarningFilled, Upload } from '@element-plus/icons-vue';

// 改用汇总接口
+ import { listMaterialSummary } from '@/api/erp/saltprocess/material';
+ import type { MaterialSummaryVO, MaterialSummaryQuery } from '@/api/erp/saltprocess/material/types';
```

##### 数据类型调整

```typescript
// 物料列表改为汇总数据类型
- const materialList = shallowRef<MaterialVO[]>([]);
+ const materialList = shallowRef<MaterialSummaryVO[]>([]);

// 查询参数改为汇总查询类型
- const listQuery = ref<MaterialQuery>({
+ const listQuery = ref<MaterialSummaryQuery>({
    pageNum: 1,
    pageSize: 50,
-   projectId: props.projectId
+   projectId: Number(props.projectId)
  });
```

##### 接口调用调整

```typescript
/**
 * 加载物料汇总列表
 */
const loadMaterialList = async (sheetName?: string) => {
  loading.value = true;
  try {
    const query: MaterialSummaryQuery = {
      ...listQuery.value,
      sheetName: sheetName || undefined
    };

-   const response = await listMaterial(query);
+   const response = await listMaterialSummary(query);

    const data = response.data || response;
    materialList.value = data.rows || [];
    listTotal.value = data.total || 0;
  } catch (error) {
-   ElMessage.error('获取物料列表失败');
+   ElMessage.error('获取物料汇总列表失败');
  } finally {
    loading.value = false;
  }
};
```

##### 表格列调整

```vue
<el-table :data="materialList" border>
  <el-table-column type="index" label="序号" width="60" />
- <el-table-column prop="materialName" label="物料名称" />
+ <el-table-column prop="itemName" label="物料名称" />
  <el-table-column prop="specification" label="规格型号" />
- <el-table-column prop="quantity" label="数量" />
+ <el-table-column prop="quantity" label="汇总数量">
+   <template #default="{ row }">
+     <el-tag type="success" size="large">{{ row.quantity }} {{ row.unit }}</el-tag>
+   </template>
+ </el-table-column>
+ <el-table-column prop="batchCount" label="批次数">
+   <template #default="{ row }">
+     <el-tag type="info" size="small">{{ row.batchCount }}</el-tag>
+   </template>
+ </el-table-column>
+ <el-table-column prop="equipmentType" label="设备类型" />
- <el-table-column prop="materialType" label="物料类型" />
- <el-table-column prop="remarks1" label="备注1" />
- <el-table-column prop="createTime" label="创建时间" />
- <el-table-column label="操作">
-   <template #default="{ row }">
-     <el-button @click="handleDelete(row)">删除</el-button>
-   </template>
- </el-table-column>
+ <el-table-column prop="model" label="型号" />
</el-table>
```

#### 3.3 UI 文案调整

##### 卡片标题

```vue
<!-- 物料汇总卡片 -->
<el-card>
  <template #header>
    <div class="card-header">
      <div>
-       <span>物料清单</span>
+       <span>物料汇总统计</span>
+       <el-tag type="success" size="small">不区分批次，相同物料自动合并</el-tag>
      </div>
      <el-button icon="Refresh" @click="handleRefreshMaterialList">刷新</el-button>
    </div>
  </template>
</el-card>
```

##### 数据预览提示

```vue
<el-card class="preview-card">
  <template #header>
    <div class="card-header">
      <div>
        <span>数据预览 (共{{ totalCountExcludingShipping }}条物料记录)</span>
+       <el-tag type="info" size="small">导入后会自动合并相同物料的数量</el-tag>
      </div>
      <!-- 操作按钮 -->
    </div>
  </template>
</el-card>
```

##### 成功消息提示

```typescript
// Excel 解析成功
- ElMessage.success(`成功解析 ${materialCount} 条物料记录`);
+ ElMessage.success(`成功解析 ${materialCount} 条物料记录，导入后会自动合并相同物料的数量`);

// 数据导入成功
- ElMessage.success('数据导入成功!');
+ ElMessage.success('数据导入成功！相同物料已自动合并数量');

- ElMessage.success(`成功导入 ${totalSuccess} 条数据!`);
+ ElMessage.success(`成功导入 ${totalSuccess} 条数据！相同物料已自动合并数量`);
```

#### 3.4 重复数据展示调整

##### 调整前

显示完整的重复物料明细列表，包括：

- 已存在物料信息
- 每次重复上传的详细数据
- 单个更新按钮
- 全部更新按钮
- 批量合并同步按钮

##### 调整后

简化为一条提示信息：

```vue
<!-- 重复物料提示（已隐藏详细列表，会自动合并） -->
<div v-if="importResult.skippedRecords > 0">
  <el-alert type="success" :closable="false">
    <template #title>
      <div style="display: flex; align-items: center;">
        <el-icon><InfoFilled /></el-icon>
        <span>检测到 {{ importResult.skippedRecords }} 条重复物料，系统已自动合并相同物料的数量</span>
      </div>
    </template>
  </el-alert>
</div>
```

#### 3.5 功能移除

移除了以下功能和函数：

- `handleDelete()` - 删除物料明细
- `handleUpdateSingleItem()` - 更新单个重复物料
- `handleUpdateAllDuplicates()` - 更新所有重复物料
- `handleBatchSyncDuplicates()` - 批量合并同步
- `calculateTotalDuplicateQuantity()` - 计算重复项总数量
- `calculateAccumulatedQuantity()` - 计算累加后的数量
- `calculateTotalDuplicatesCount()` - 计算重复项总条数
- `isItemUpdated()` - 检查物料是否已更新
- 相关的状态变量: `batchSyncing`, `updatedItemIds`

### 4. 汇总规则说明

根据后端实现，物料汇总按以下字段进行分组：

- 物料名称（`itemName`）
- 规格型号（`specification`）
- 设备类型（`equipmentType`）
- 制造商（`manufacturer`）
- 型号（`model`）
- 单位（`unit`）

**注意**：

- 批次号（`batchNumber`）不参与分组
- 数量（`quantity`）会进行累加汇总
- 相同物料的不同批次会被合并

### 5. 前后端联调说明

#### 接口路径

```
GET /erp/saltprocess/material/summary
```

#### 请求参数

| 参数名    | 类型    | 必填 | 说明                             |
| --------- | ------- | ---- | -------------------------------- |
| projectId | Long    | 是   | 项目 ID                          |
| sheetName | String  | 否   | Sheet 名称（用于过滤特定工作表） |
| pageNum   | Integer | 否   | 页码，默认 1                     |
| pageSize  | Integer | 否   | 每页数量，默认 10                |

#### 响应示例

```json
{
  "code": 200,
  "msg": "操作成功",
  "rows": [
    {
      "itemName": "plc控制柜",
      "specification": "见图纸及清单",
      "equipmentType": "AUXILIARY",
      "quantity": 3,
      "unit": "套",
      "batchCount": 2,
      "manufacturer": "西门子",
      "model": "S7-1200"
    }
  ],
  "total": 1
}
```

### 6. 测试要点

#### 功能测试

1. ✅ 物料汇总列表正常展示
2. ✅ 相同物料自动合并显示
3. ✅ 批次数量统计正确
4. ✅ 按 Sheet 分组展示正常
5. ✅ 分页功能正常
6. ✅ 导入后提示信息正确
7. ✅ 重复物料提示正常显示

#### UI 测试

1. ✅ 表格列显示正确（汇总数量、批次数）
2. ✅ 提示标签显示正确
3. ✅ 重复数据提示简洁明了
4. ✅ 无编辑/删除按钮

#### 数据验证

1. ✅ 汇总数量 = 所有批次数量之和
2. ✅ 批次数量统计正确
3. ✅ Sheet 分组数据准确

### 7. 注意事项

1. **不支持编辑和删除**：物料汇总是只读数据，如需修改需要通过发货清单模块操作
2. **批次信息隐藏**：批次详情不在项目详情中展示，需要在发货清单模块查看
3. **数量自动合并**：系统会自动将相同物料的数量进行累加
4. **权限控制**：查询需要 `erp:material:item:list` 权限

## 修改文件清单

- ✅ `src/api/erp/saltprocess/material/types.ts` - 添加汇总类型定义
- ✅ `src/api/erp/saltprocess/material/index.ts` - 添加汇总接口函数
- ✅ `src/views/erp/saltprocess/project/components/MaterialDetail.vue` - 组件主要修改
- ✅ `docs/物料明细页面汇总接口集成说明.md` - 本文档

## 完成时间

**2025 年 10 月 28 日**

---

**备注**：本次修改已通过 Lint 检查，无错误或警告。
